<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Trivia - Search Tool</title>
    <script src="/js/components/autoload-banner.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #FFCC00;
            margin-top: 60px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .search-input {
            font-size: 18px;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: calc(100% - 34px);
            margin-bottom: 16px;
            box-sizing: border-box;
        }
        
        .search-button {
            background: #333;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }
        
        .option-group {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        
        .results-table th, .results-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        
        .results-table th {
            background: #f8f9fa;
        }
        
        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .link-btn {
            color: #007bff;
            text-decoration: none;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Evil Trivia Search Tool</h1>
        
        <!-- Authentication Required -->
        <div id="auth-required" class="card hidden">
            <h2>üîí Admin Access Required</h2>
            <p>You need admin privileges to use this search tool.</p>
            <a href="/pages/account.html" class="search-button">Go to Account</a>
        </div>
        
        <!-- Main Interface -->
        <div id="main-interface" class="hidden">
            <!-- Search Section -->
            <div class="card">
                <input type="text" id="search-input" class="search-input" 
                       placeholder="Enter search term (e.g., apple, *app*, app?, X Y X for variables)">
                
                <div class="options-grid">
                    <div class="option-group">
                        <h3>üéØ Search Modes</h3>
                        <div class="checkbox-group">
                            <input type="checkbox" id="crossword-mode">
                            <label for="crossword-mode">Crossword Mode (? ignores spaces)</label>
                </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="variable-mode">
                            <label for="variable-mode">Variable Mode (X Y X pattern matching)</label>
                    </div>
                    </div>
                    
                    <div class="option-group">
                        <h3>üìÅ Data Sources</h3>
                        <div id="files-container">
                            <div class="loading">Loading files...</div>
                    </div>
                        </div>
                    </div>

                <button id="search-btn" class="search-button">üîç Search</button>
            </div>
            
            <!-- Collection Box -->
            <div class="card">
                <h3>üìã Collected Terms (<span id="collection-count">0</span>)</h3>
                <div id="collection-items" style="min-height: 100px; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                    Click the + button next to search results to add terms here
                </div>
                <div style="margin-top: 12px;">
                    <button id="copy-collection" class="search-button">üìã Copy All</button>
                    <button id="clear-collection" class="search-button" style="background: #dc3545;">üóëÔ∏è Clear</button>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="card hidden">
                <div id="results-count">0 results</div>
                <div id="results-container"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, limit, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebasestorage.app",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        const db = getDatabase(app); // For user authentication only

        // Global state
        let availableFiles = [];
        let collectedTerms = [];

        // DOM elements
        const authRequired = document.getElementById('auth-required');
        const mainInterface = document.getElementById('main-interface');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const crosswordMode = document.getElementById('crossword-mode');
        const variableMode = document.getElementById('variable-mode');
        const filesContainer = document.getElementById('files-container');
        const resultsSection = document.getElementById('results-section');
        const resultsCount = document.getElementById('results-count');
        const resultsContainer = document.getElementById('results-container');
        const collectionItems = document.getElementById('collection-items');
        const collectionCount = document.getElementById('collection-count');
        
        // Check if user is admin
        async function checkAdminAccess(user) {
            try {
                const userSnapshot = await get(ref(db, `users/${user.uid}`));
                if (!userSnapshot.exists()) {
                    return false;
                }
                
                const userData = userSnapshot.val();
                
                // Check both legacy and new role formats
                return userData.role === 'admin' || 
                       (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin'));
            } catch (error) {
                console.error('Error checking admin access:', error);
                return false;
            }
        }

        // Authentication check
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is signed in:", user.uid);
                
                const isAdmin = await checkAdminAccess(user);
                
                if (isAdmin) {
                    console.log("Admin access granted");
                    authRequired.classList.add('hidden');
                    mainInterface.classList.remove('hidden');
                    await loadAvailableFiles();
                    } else {
                    console.log("User is not admin");
                    authRequired.classList.remove('hidden');
                    mainInterface.classList.add('hidden');
                }
            } else {
                console.log("User is not signed in");
                authRequired.classList.remove('hidden');
                mainInterface.classList.add('hidden');
            }
        });

        // Load available files from Firestore using proper discovery
        async function loadAvailableFiles() {
            try {
                console.log('Discovering all available files in Firestore...');
                
                // Use multiple sampling approaches to find all files
                const fileSet = new Set();
                const toolsCollection = collection(firestore, 'tools');
                
                // Strategy 1: Sample from different parts of the collection
                const sampleQueries = [
                    query(toolsCollection, limit(500)),
                    query(toolsCollection, where('score', '>=', 90), limit(100)),
                    query(toolsCollection, where('score', '>=', 50), limit(100)),
                    query(toolsCollection, where('score', '>=', 10), limit(100))
                ];
                
                for (const q of sampleQueries) {
                    try {
                        const snapshot = await getDocs(q);
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.file) {
                                fileSet.add(data.file);
                            }
                        });
                    } catch (error) {
                        console.warn('Sample query failed:', error);
                    }
                }
                
                // Strategy 2: Known files as fallback/supplement
                const knownFiles = ['RankedWiki_txt', 'RankedWiktionary_txt', 'ScrabbleDict_txt', 'jeopardy_wordlist_txt'];
                knownFiles.forEach(file => fileSet.add(file));
                
                if (fileSet.size > 0) {
                    availableFiles = Array.from(fileSet).sort();
                    console.log(`Found ${availableFiles.length} files:`, availableFiles);
                } else {
                    console.log('No files found, using fallback');
                    availableFiles = knownFiles;
                }
                
                displayFileOptions();
            } catch (error) {
                console.error('Error loading files:', error);
                // Fallback to known files
                availableFiles = ['RankedWiki_txt', 'RankedWiktionary_txt', 'ScrabbleDict_txt', 'jeopardy_wordlist_txt'];
                displayFileOptions();
            }
        }

        function displayFileOptions() {
            filesContainer.innerHTML = '';
            availableFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'checkbox-group';
                div.innerHTML = `
                    <input type="checkbox" id="file-${file}" value="${file}" checked>
                    <label for="file-${file}">${file.replace(/_/g, ' ')}</label>
                `;
                filesContainer.appendChild(div);
            });
        }

        // Wildcard to regex conversion
        function wildcardToRegex(pattern) {
            if (variableMode.checked) {
                return createVariableRegex(pattern);
            }
            
            let regexPattern = pattern.replace(/[.+^${}()|[\]\\]/g, '\\$&');
            regexPattern = regexPattern.replace(/\*/g, '.*');
            
            if (crosswordMode.checked) {
                regexPattern = regexPattern.replace(/\?/g, '[A-Za-z]');
                    } else {
                regexPattern = regexPattern.replace(/\?/g, '.');
            }
            
            return new RegExp(`^${regexPattern}$`, 'i');
        }

        function createVariableRegex(pattern) {
            const variables = new Map();
            let groupCounter = 1;
            let regexPattern = '^';
            
            for (let i = 0; i < pattern.length; i++) {
                const char = pattern[i];
                
                if (/[A-Za-z]/.test(char)) {
                    const upperChar = char.toUpperCase();
                    
                    if (variables.has(upperChar)) {
                        regexPattern += `\\${variables.get(upperChar)}`;
                    } else {
                        variables.set(upperChar, groupCounter);
                        regexPattern += '(.)';
                        groupCounter++;
                    }
                } else if (char === ' ' && crosswordMode.checked) {
                    continue;
                } else {
                    regexPattern += char.replace(/[.+^${}()|[\]\\]/g, '\\$&');
                }
            }
            
            regexPattern += '$';
            return new RegExp(regexPattern, 'i');
        }
        
        // Collection management
        function addToCollection(term) {
            if (!collectedTerms.includes(term)) {
                collectedTerms.push(term);
                updateCollectionDisplay();
            }
        }

        function updateCollectionDisplay() {
            collectionCount.textContent = collectedTerms.length;
            
            if (collectedTerms.length === 0) {
                collectionItems.innerHTML = 'Click the + button next to search results to add terms here';
                return;
            }
            
            collectionItems.innerHTML = collectedTerms.map((term, index) => 
                `<div style="display: flex; justify-content: space-between; padding: 4px 0;">
                    <span>${term}</span>
                    <button onclick="removeFromCollection(${index})" style="color: red; background: none; border: none; cursor: pointer;">√ó</button>
                </div>`
            ).join('');
        }

        function removeFromCollection(index) {
            collectedTerms.splice(index, 1);
            updateCollectionDisplay();
        }

        function copyCollection() {
            if (collectedTerms.length === 0) {
                alert('No terms to copy');
                return;
            }
            
            const text = collectedTerms.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert(`Copied ${collectedTerms.length} terms!`);
            });
        }

        // Search functionality
        async function performSearch() {
                const searchTerm = searchInput.value.trim();
                if (!searchTerm) {
                    alert('Please enter a search term');
                    return;
                }
                
            const selectedFiles = availableFiles.filter(file => {
                    const checkbox = document.getElementById(`file-${file}`);
                return checkbox && checkbox.checked;
                });
                
                if (selectedFiles.length === 0) {
                alert('Please select at least one data source');
                    return;
                }
                
            searchBtn.textContent = 'üîç Searching...';
            searchBtn.disabled = true;
            resultsSection.classList.remove('hidden');
            resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                const results = await searchFirestore(searchTerm, selectedFiles);
                displayResults(results);
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `<div style="color: red; padding: 20px;">Search error: ${error.message}</div>`;
            } finally {
                searchBtn.textContent = 'üîç Search';
                searchBtn.disabled = false;
            }
        }

                async function searchFirestore(searchTerm, selectedFiles) {
            console.log('üîç High-performance search for:', searchTerm, 'across', selectedFiles.length, 'files');
            const results = [];
            const regex = wildcardToRegex(searchTerm);
            
            // Use Promise.all for parallel file searching
            const searchPromises = selectedFiles.map(fileName => searchSingleFile(fileName, searchTerm, regex));
            
            try {
                const fileResults = await Promise.all(searchPromises);
                
                // Combine all results
                for (const fileResult of fileResults) {
                    results.push(...fileResult);
                }
                
                // Sort by score and return top results
                const sortedResults = results
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 100);
                
                console.log(`üéØ Found ${sortedResults.length} results from ${results.length} total matches`);
                return sortedResults;
                
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        }
        
        async function searchSingleFile(fileName, searchTerm, regex) {
            console.log(`üîç Searching ${fileName}...`);
            const results = [];
            
            try {
                const toolsCollection = collection(firestore, 'tools');
                
                // Strategy: Search high-score documents first for better results
                const scoreLevels = [
                    { min: 80, max: 100, limit: 1000 },
                    { min: 50, max: 79, limit: 800 },
                    { min: 20, max: 49, limit: 600 },
                    { min: 1, max: 19, limit: 400 }
                ];
                
                for (const level of scoreLevels) {
                    if (results.length >= 50) break; // Stop when we have enough results
                    
                    try {
                        const q = query(
                            toolsCollection,
                            where('file', '==', fileName),
                            where('score', '>=', level.min),
                            where('score', '<=', level.max),
                            limit(level.limit)
                        );
                        
                        const snapshot = await getDocs(q);
                        console.log(`  üìä Score ${level.min}-${level.max}: ${snapshot.size} docs`);
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.term && regex.test(data.term)) {
                                results.push({
                                    term: data.term,
                                    parentheses: data.parentheses || '',
                                    score: data.score || 0,
                                    file: data.file
                                });
                            }
                        });
                        
                    } catch (error) {
                        console.warn(`Score range ${level.min}-${level.max} failed:`, error);
                        // Continue with other score ranges
                    }
                }
                
                console.log(`‚úÖ ${fileName}: ${results.length} matches`);
                return results;
                
            } catch (error) {
                console.error(`‚ùå Error searching ${fileName}:`, error);
                return [];
            }
        }

        function displayResults(results) {
            resultsCount.textContent = `${results.length} results`;
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div>No results found</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'results-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Score</th>
                        <th>Term</th>
                        <th>Notes</th>
                        <th>Wikipedia</th>
                        <th>Dictionary</th>
                        <th>Google</th>
                        <th>Add</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.map(result => `
                        <tr>
                            <td><strong>${result.score}</strong></td>
                            <td><strong>${result.term}</strong></td>
                            <td>${result.parentheses}</td>
                            <td><a href="https://en.wikipedia.org/wiki/${encodeURIComponent(result.term.replace(/ /g, '_'))}" target="_blank" class="link-btn">üìñ Wiki</a></td>
                            <td><a href="https://www.merriam-webster.com/dictionary/${encodeURIComponent(result.term)}" target="_blank" class="link-btn">üìö Dict</a></td>
                            <td><a href="https://www.google.com/search?q=${encodeURIComponent(result.term)}" target="_blank" class="link-btn">üîç Google</a></td>
                            <td><button class="add-btn" onclick="addToCollection('${result.term.replace(/'/g, "\\'")}')">+</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            resultsContainer.innerHTML = '';
                resultsContainer.appendChild(table);
        }
        
        // Event listeners
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        document.getElementById('copy-collection').addEventListener('click', copyCollection);
        document.getElementById('clear-collection').addEventListener('click', () => {
            collectedTerms = [];
            updateCollectionDisplay();
        });

        // Make functions global
        window.addToCollection = addToCollection;
        window.removeFromCollection = removeFromCollection;
    </script>
</body>
</html> 
