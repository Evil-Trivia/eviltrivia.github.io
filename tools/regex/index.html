<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Trivia - Regex Tool</title>
    <script src="/js/components/autoload-banner.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #FFCC00;
            margin-top: 60px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .content-box {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .auth-container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            margin: 40px auto;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .auth-container h2 {
            margin-top: 0;
            color: #333;
        }
        
        .auth-container p {
            margin-bottom: 20px;
            color: #666;
        }
        
        .auth-btn {
            display: inline-block;
            background-color: #000;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        /* New styles for the regex tool */
        .search-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-row {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            font-size: 16px;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex: 1;
        }
        
        .search-button {
            font-size: 16px;
            padding: 12px 25px;
        }
        
        .file-select {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .file-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Manual file input styles */
        .file-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            margin-top: 15px;
        }
        
        .manual-file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .manual-file-list .file-checkbox {
            margin-bottom: 5px;
        }
        
        #manual-files {
            margin-top: 10px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th {
            background-color: #f2f2f2;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .results-container {
            margin-top: 20px;
        }
        
        .load-more {
            display: block;
            margin: 20px auto;
            background-color: #000;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }
        
        .loading:after {
            content: "";
            width: 20px;
            height: 20px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #000;
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-message {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .wild-card-info {
            margin-top: 10px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        
        .wild-card-info h3 {
            margin-top: 0;
        }
        
        .wild-card-info ul {
            margin-bottom: 0;
        }
        
        .error-message {
            color: #d9534f;
            background-color: #f8d7da;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .result-count {
            font-weight: bold;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Regex Tool</h1>
        
        <!-- Authentication Required Screen -->
        <div id="auth-screen" class="auth-container hidden">
            <h2>Access Required</h2>
            <p>You need admin privileges to access this page.</p>
            <a href="/account" class="auth-btn">Go to Account Page</a>
        </div>
        
        <!-- Tool Interface -->
        <div id="tool-screen" class="hidden">
            <div class="content-box">
                <h2>Search Terms</h2>
                
                <div class="wild-card-info">
                    <h3>Wildcard Options:</h3>
                    <ul>
                        <li><strong>apple</strong> - Exact match (not case sensitive)</li>
                        <li><strong>*apple*</strong> - Contains "apple" anywhere in the term</li>
                        <li><strong>apple*</strong> - Begins with "apple"</li>
                        <li><strong>*apple</strong> - Ends with "apple"</li>
                        <li><strong>?</strong> - Matches any single character (e.g., "apple?" could match "apples")</li>
                    </ul>
                </div>
                
                <div class="search-container">
                    <div class="search-row">
                        <input type="text" id="search-input" class="search-input" placeholder="Enter search term (e.g., apple, *apple*, a?ple)">
                        <button id="search-button" class="search-button">Search</button>
                    </div>
                    
                    <div>
                        <h3>Select Files:</h3>
                        <div id="file-select" class="file-select">
                            <p>Loading available files...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-box">
                <h2>Search Results</h2>
                <div id="results-container" class="results-container">
                    <p class="no-results">Enter a search term and select files to see results.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebasestorage.app",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const toolScreen = document.getElementById('tool-screen');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const fileSelectContainer = document.getElementById('file-select');
        const resultsContainer = document.getElementById('results-container');
        
        // Global variables
        let availableFiles = [];
        let lastLoadedItems = {};
        const resultsPerPage = 50;
        let userIsAdmin = false;
        
        // Check if user is admin
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    // Get user data
                    const snapshot = await db.ref(`users/${user.uid}`).once('value');
                    const userData = snapshot.val() || {};
                    
                    // Check for admin role - in both new roles array and old role field
                    const isAdmin = 
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin')) ||
                        (userData.role === 'admin');
                    
                    if (isAdmin) {
                        // User is admin, show tool interface
                        authScreen.classList.add('hidden');
                        toolScreen.classList.remove('hidden');
                        userIsAdmin = true;
                        
                        // Load available files
                        loadAvailableFiles();
                    } else {
                        // User does not have access
                        authScreen.classList.remove('hidden');
                        toolScreen.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    authScreen.classList.remove('hidden');
                    toolScreen.classList.add('hidden');
                }
            } else {
                // User is not signed in
                authScreen.classList.remove('hidden');
                toolScreen.classList.add('hidden');
            }
        });
        
        // Load available files from Firebase
        async function loadAvailableFiles() {
            try {
                // Set a timeout for the loading process
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Loading timed out')), 10000); // 10 second timeout
                });
                
                // Use a shallow query to only get the file names, not the entire data
                const dataPromise = db.ref('tools').once('value', snapshot => {
                    return snapshot.key;
                });
                
                // Race the data fetch against the timeout
                const snapshot = await Promise.race([dataPromise, timeoutPromise]);
                const tools = snapshot.val() || {};
                
                // Get filenames
                availableFiles = Object.keys(tools);
                
                // Display file checkboxes
                if (availableFiles.length > 0) {
                    fileSelectContainer.innerHTML = '';
                    
                    availableFiles.forEach(file => {
                        const fileCheckbox = document.createElement('div');
                        fileCheckbox.className = 'file-checkbox';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `file-${file}`;
                        checkbox.value = file;
                        
                        const label = document.createElement('label');
                        label.htmlFor = `file-${file}`;
                        label.textContent = file;
                        
                        fileCheckbox.appendChild(checkbox);
                        fileCheckbox.appendChild(label);
                        fileSelectContainer.appendChild(fileCheckbox);
                    });
                    
                    // If only one file, check it by default
                    if (availableFiles.length === 1) {
                        document.getElementById(`file-${availableFiles[0]}`).checked = true;
                    }
                } else {
                    showManualFileInput();
                }
            } catch (error) {
                console.error('Error loading available files:', error);
                
                // Show manual file input form
                showManualFileInput();
            }
        }
        
        // Display manual file input when automatic loading fails
        function showManualFileInput() {
            fileSelectContainer.innerHTML = `
                <div class="error-message">
                    <strong>Could not load files automatically.</strong> Please specify file names below:
                </div>
                <div id="manual-files">
                    <div class="file-input-row">
                        <input type="text" class="search-input" placeholder="Enter file name (e.g., RankedWiki.txt)" value="RankedWiki.txt">
                        <button class="search-button add-file-btn">Add File</button>
                    </div>
                    <div class="manual-file-list">
                        <!-- Files will be added here -->
                    </div>
                </div>
            `;
            
            // Add event listener for the "Add File" button
            const addFileBtn = fileSelectContainer.querySelector('.add-file-btn');
            const fileInput = fileSelectContainer.querySelector('.file-input-row input');
            const fileList = fileSelectContainer.querySelector('.manual-file-list');
            
            addFileBtn.addEventListener('click', () => {
                const fileName = fileInput.value.trim();
                if (fileName) {
                    // Add to availableFiles array if not already there
                    if (!availableFiles.includes(fileName)) {
                        availableFiles.push(fileName);
                        
                        // Create checkbox for the file
                        const fileCheckbox = document.createElement('div');
                        fileCheckbox.className = 'file-checkbox';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `file-${fileName}`;
                        checkbox.value = fileName;
                        checkbox.checked = true; // Check it by default
                        
                        const label = document.createElement('label');
                        label.htmlFor = `file-${fileName}`;
                        label.textContent = fileName;
                        
                        fileCheckbox.appendChild(checkbox);
                        fileCheckbox.appendChild(label);
                        fileList.appendChild(fileCheckbox);
                        
                        // Clear input
                        fileInput.value = '';
                    } else {
                        alert(`File "${fileName}" is already in the list`);
                    }
                } else {
                    alert('Please enter a file name');
                }
            });
            
            // Also allow pressing Enter to add a file
            fileInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addFileBtn.click();
                }
            });
            
            // Add RankedWiki.txt as the default file if input is pre-filled
            if (fileInput.value.trim()) {
                addFileBtn.click();
            }
        }
        
        // Convert wildcard pattern to regex
        function wildcardToRegex(pattern) {
            // Escape special regex characters except * and ?
            let regexPattern = pattern.replace(/[.+^${}()|[\]\\]/g, '\\$&');
            
            // Convert * to regex .*
            regexPattern = regexPattern.replace(/\*/g, '.*');
            
            // Convert ? to regex .
            regexPattern = regexPattern.replace(/\?/g, '.');
            
            // Create case-insensitive regex
            return new RegExp(`^${regexPattern}$`, 'i');
        }
        
        // Search for terms
        async function searchTerms() {
            if (!userIsAdmin) {
                alert('You need admin privileges to perform searches.');
                return;
            }
            
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            // Get selected files
            const selectedFiles = [];
            availableFiles.forEach(file => {
                const checkbox = document.getElementById(`file-${file}`);
                if (checkbox && checkbox.checked) {
                    selectedFiles.push(file);
                }
            });
            
            if (selectedFiles.length === 0) {
                alert('Please select at least one file');
                return;
            }
            
            // Show loading
            resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
            
            // Reset last loaded items
            lastLoadedItems = {};
            selectedFiles.forEach(file => {
                lastLoadedItems[file] = null;
            });
            
            // Create regex pattern from search term
            const regexPattern = wildcardToRegex(searchTerm);
            
            // Search in selected files
            let allResults = [];
            
            try {
                for (const file of selectedFiles) {
                    const results = await searchInFile(file, regexPattern);
                    allResults = allResults.concat(results);
                }
                
                // Sort by score (descending)
                allResults.sort((a, b) => b.score - a.score);
                
                // Display results
                displayResults(allResults, false);
            } catch (error) {
                console.error('Error searching terms:', error);
                
                // Set more specific error message based on the error type
                if (error.code === 'PERMISSION_DENIED') {
                    resultsContainer.innerHTML = `
                        <div class="error-message">
                            <strong>Permission denied:</strong> Your Firebase security rules do not allow reading from the 'tools' path.
                            Update your rules to allow read access to the 'tools' path for admin users.
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = `
                        <div class="error-message">
                            <strong>Error searching terms:</strong> ${error.message || 'Unknown error'}
                        </div>
                    `;
                }
            }
        }
        
        // Search in a specific file
        async function searchInFile(filename, regexPattern) {
            const results = [];
            
            try {
                // Set a timeout for the search
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error(`Search in ${filename} timed out`)), 15000); // 15 second timeout
                });
                
                // Query for scores in the file
                const dataPromise = db.ref(`tools/${filename}`).once('value');
                
                // Race the data fetch against the timeout
                const scoresSnapshot = await Promise.race([dataPromise, timeoutPromise]);
                const scores = scoresSnapshot.val() || {};
                
                // For each score
                for (const scoreVal in scores) {
                    if (scores.hasOwnProperty(scoreVal)) {
                        const terms = scores[scoreVal];
                        
                        // For each term ID
                        for (const termId in terms) {
                            if (terms.hasOwnProperty(termId)) {
                                const termData = terms[termId];
                                
                                // Skip items without term property or not matching pattern
                                if (!termData.term) continue;
                                
                                // Check if term matches regex pattern
                                if (regexPattern.test(termData.term)) {
                                    results.push({
                                        term: termData.term,
                                        parentheses: termData.parentheses || '',
                                        score: parseInt(scoreVal, 10),
                                        filename: filename,
                                        termId: termId
                                    });
                                }
                            }
                        }
                    }
                }
                
                return results;
            } catch (error) {
                console.error(`Error searching in file ${filename}:`, error);
                
                // Return an empty array but add a "special" result to indicate error
                if (error.code === 'PERMISSION_DENIED') {
                    return [{
                        term: `Error: Permission denied for ${filename}`,
                        parentheses: 'Please update Firebase security rules',
                        score: 0,
                        filename: filename,
                        termId: 'error',
                        isError: true
                    }];
                } else if (error.message && error.message.includes('timed out')) {
                    return [{
                        term: `Error: Search timed out for ${filename}`,
                        parentheses: 'The database query took too long',
                        score: 0,
                        filename: filename,
                        termId: 'error',
                        isError: true
                    }];
                } else {
                    return [{
                        term: `Error searching in ${filename}`,
                        parentheses: error.message || 'Unknown error',
                        score: 0,
                        filename: filename,
                        termId: 'error',
                        isError: true
                    }];
                }
            }
        }
        
        // Display search results
        function displayResults(results, isLoadMore) {
            if (!isLoadMore) {
                resultsContainer.innerHTML = '';
            }
            
            if (results.length === 0 && !isLoadMore) {
                resultsContainer.innerHTML = '<p class="no-results">No results found. Try a different search term.</p>';
                return;
            }
            
            // Check if all results are errors
            const errorResults = results.filter(r => r.isError);
            if (errorResults.length === results.length) {
                const errorHtml = errorResults.map(err => 
                    `<div class="error-message">
                        <strong>${err.term}</strong><br>
                        ${err.parentheses}
                    </div>`
                ).join('');
                
                resultsContainer.innerHTML = `
                    <p class="no-results">Encountered errors while searching:</p>
                    ${errorHtml}
                `;
                return;
            }
            
            // Filter out error results for normal display
            const validResults = results.filter(r => !r.isError);
            
            // Create table if it doesn't exist
            let table = document.getElementById('results-table');
            
            if (!table) {
                table = document.createElement('table');
                table.id = 'results-table';
                table.className = 'results-table';
                
                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                const headers = ['Score', 'Term', 'Parenthetical'];
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                tbody.id = 'results-tbody';
                table.appendChild(tbody);
                
                resultsContainer.appendChild(table);
            }
            
            // Get or create table body
            const tbody = document.getElementById('results-tbody');
            
            // Display results (limited to resultsPerPage)
            const displayCount = Math.min(validResults.length, resultsPerPage);
            
            // Add count of results
            if (!isLoadMore) {
                const totalCount = document.createElement('div');
                totalCount.className = 'result-count';
                totalCount.textContent = `Found ${validResults.length} result${validResults.length !== 1 ? 's' : ''}`;
                resultsContainer.insertBefore(totalCount, table);
                
                // If there were errors, also show a warning
                if (errorResults.length > 0) {
                    const errorWarning = document.createElement('div');
                    errorWarning.className = 'error-message';
                    errorWarning.innerHTML = `<strong>Note:</strong> Some files had errors and were excluded from results.`;
                    resultsContainer.insertBefore(errorWarning, table);
                }
            }
            
            for (let i = 0; i < displayCount; i++) {
                const result = validResults[i];
                
                const row = document.createElement('tr');
                
                // Score cell
                const scoreCell = document.createElement('td');
                scoreCell.textContent = result.score;
                row.appendChild(scoreCell);
                
                // Term cell
                const termCell = document.createElement('td');
                termCell.textContent = result.term;
                row.appendChild(termCell);
                
                // Parenthetical cell
                const parenthesesCell = document.createElement('td');
                parenthesesCell.textContent = result.parentheses || '';
                row.appendChild(parenthesesCell);
                
                tbody.appendChild(row);
            }
            
            // Add "Load More" button if there are more results
            if (validResults.length > resultsPerPage) {
                // Remove existing load more button if any
                const existingButton = document.getElementById('load-more-button');
                if (existingButton) {
                    existingButton.remove();
                }
                
                const remainingResults = validResults.slice(resultsPerPage);
                
                const loadMoreButton = document.createElement('button');
                loadMoreButton.id = 'load-more-button';
                loadMoreButton.className = 'load-more';
                loadMoreButton.textContent = `Load More (${remainingResults.length} more results)`;
                
                loadMoreButton.addEventListener('click', () => {
                    displayResults(remainingResults, true);
                });
                
                resultsContainer.appendChild(loadMoreButton);
            }
        }
        
        // Event listeners
        searchButton.addEventListener('click', searchTerms);
        
        // Allow Enter key to trigger search
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchTerms();
            }
        });
    </script>
</body>
</html> 