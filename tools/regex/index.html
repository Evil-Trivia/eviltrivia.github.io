<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Trivia - Regex Tool</title>
    <script src="/js/components/autoload-banner.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #FFCC00;
            margin-top: 60px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .content-box {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .auth-container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            margin: 40px auto;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .auth-container h2 {
            margin-top: 0;
            color: #333;
        }
        
        .auth-container p {
            margin-bottom: 20px;
            color: #666;
        }
        
        .auth-btn {
            display: inline-block;
            background-color: #000;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        /* New styles for the regex tool */
        .search-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-row {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            font-size: 16px;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex: 1;
        }
        
        .search-button {
            font-size: 16px;
            padding: 12px 25px;
            background-color: #000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .file-select {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .file-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Manual file input styles */
        .file-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            margin-top: 15px;
        }
        
        .manual-file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .manual-file-list .file-checkbox {
            margin-bottom: 5px;
        }
        
        #manual-files {
            margin-top: 10px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th {
            background-color: #f2f2f2;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .results-container {
            margin-top: 20px;
        }
        
        .load-more {
            display: block;
            margin: 20px auto;
            background-color: #000;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }
        
        .loading:after {
            content: "";
            width: 20px;
            height: 20px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #000;
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-message {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .wild-card-info {
            margin-top: 10px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        
        .wild-card-info h3 {
            margin-top: 0;
        }
        
        .wild-card-info ul {
            margin-bottom: 0;
        }
        
        .error-message {
            color: #d9534f;
            background-color: #f8d7da;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .result-count {
            font-weight: bold;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Regex Tool</h1>
        
        <!-- Authentication Required Screen -->
        <div id="auth-screen" class="auth-container hidden">
            <h2>Access Required</h2>
            <p>You need admin privileges to access this page.</p>
            <a href="/account" class="auth-btn">Go to Account Page</a>
        </div>
        
        <!-- Tool Interface -->
        <div id="tool-screen" class="hidden">
            <div class="content-box">
                <h2>Search Terms</h2>
                
                <div class="wild-card-info">
                    <h3>Wildcard Options:</h3>
                    <ul>
                        <li><strong>apple</strong> - Exact match (not case sensitive)</li>
                        <li><strong>*apple*</strong> - Contains "apple" anywhere in the term</li>
                        <li><strong>apple*</strong> - Begins with "apple"</li>
                        <li><strong>*apple</strong> - Ends with "apple"</li>
                        <li><strong>?</strong> - Matches any single character (e.g., "apple?" could match "apples")</li>
                    </ul>
                </div>
                
                <div class="search-container">
                    <div class="search-row">
                        <input type="text" id="search-input" class="search-input" placeholder="Enter search term (e.g., apple, *apple*, a?ple)">
                        <button id="search-button" class="search-button">Search</button>
                    </div>
                    
                    <div>
                        <h3>Select Files:</h3>
                        <div id="file-select" class="file-select">
                            <p>Loading available files...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-box">
                <h2>Search Results</h2>
                <div id="results-container" class="results-container">
                    <p class="no-results">Enter a search term and select files to see results.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebasestorage.app",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const toolScreen = document.getElementById('tool-screen');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const fileSelectContainer = document.getElementById('file-select');
        const resultsContainer = document.getElementById('results-container');
        
        // Global variables
        let availableFiles = [];
        let lastLoadedItems = {};
        const resultsPerPage = 50;
        let userIsAdmin = false;
        // Track search state for pagination
        let currentSearchState = {
            searchTerm: '',
            pattern: null,
            selectedFiles: [],
            fileIndex: 0,
            scoreRanges: [],
            scoreRangeIndex: 0,
            currentScore: 0,
            hasMoreResults: false,
            resultsFound: 0
        };
        
        // Check if user is admin
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    // Get user data
                    const snapshot = await db.ref(`users/${user.uid}`).once('value');
                    const userData = snapshot.val() || {};
                    
                    // Check for admin role - in both new roles array and old role field
                    const isAdmin = 
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin')) ||
                        (userData.role === 'admin');
                    
                    if (isAdmin) {
                        // User is admin, show tool interface
                        authScreen.classList.add('hidden');
                        toolScreen.classList.remove('hidden');
                        userIsAdmin = true;
                        
                        // Try to load file names from tools branch
                        loadToolsFileNames();
                    } else {
                        // User does not have access
                        authScreen.classList.remove('hidden');
                        toolScreen.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    authScreen.classList.remove('hidden');
                    toolScreen.classList.add('hidden');
                }
            } else {
                // User is not signed in
                authScreen.classList.remove('hidden');
                toolScreen.classList.add('hidden');
            }
        });
        
        // Load file names directly from the tools branch
        async function loadToolsFileNames() {
            try {
                // First try to get just the keys to avoid a large payload
                const snapshot = await db.ref('tools').once('value');
                if (snapshot.exists()) {
                    // Get just the branch names (which are the file names)
                    const fileNames = Object.keys(snapshot.val() || {});
                    
                    if (fileNames.length > 0) {
                        // Successfully got file names
                        availableFiles = fileNames;
                        showFileSelectionInterface(fileNames);
                        return;
                    }
                }
                
                // If we couldn't get file names or there were none, show manual input
                showManualFileInput();
            } catch (error) {
                console.error('Error loading tool file names:', error);
                showManualFileInput();
            }
        }
        
        // Show file selection interface with checkboxes
        function showFileSelectionInterface(fileNames) {
            // Create the file selection interface HTML
            let html = `
                <div class="info-message">
                    <strong>File Selection:</strong> Select the database files you want to search through.
                </div>
            `;
            
            // Create a checkbox for each file
            fileNames.forEach(fileName => {
                html += `
                    <div class="file-checkbox">
                        <input type="checkbox" id="file-${fileName}" value="${fileName}" checked>
                        <label for="file-${fileName}">${fileName}</label>
                    </div>
                `;
            });
            
            // Update the file select container
            fileSelectContainer.innerHTML = html;
        }
        
        // Display manual file input
        function showManualFileInput() {
            fileSelectContainer.innerHTML = `
                <div class="info-message">
                    <strong>File Selection:</strong> Add the database files you want to search through.
                    <p>Common files: <code>RankedWiki_txt</code>, <code>RankedWiktionary_txt</code>, <code>ScrabbleDict_txt</code>, <code>jeopardy_wordlist_txt</code></p>
                </div>
                <div class="error-message" style="background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;">
                    Could not load files automatically. Please specify file names below.
                </div>
                <div id="manual-files">
                    <div class="file-input-row">
                        <input type="text" class="search-input" placeholder="Enter file name (e.g., RankedWiki_txt)" value="RankedWiki_txt">
                        <button class="search-button add-file-btn">Add File</button>
                    </div>
                    <div class="manual-file-list">
                        <!-- Files will be added here -->
                    </div>
                </div>
            `;
            
            // Add event listener for the "Add File" button
            const addFileBtn = fileSelectContainer.querySelector('.add-file-btn');
            const fileInput = fileSelectContainer.querySelector('.file-input-row input');
            const fileList = fileSelectContainer.querySelector('.manual-file-list');
            
            addFileBtn.addEventListener('click', () => {
                const fileName = fileInput.value.trim();
                if (fileName) {
                    // Add to availableFiles array if not already there
                    if (!availableFiles.includes(fileName)) {
                        availableFiles.push(fileName);
                        
                        // Create checkbox for the file
                        const fileCheckbox = document.createElement('div');
                        fileCheckbox.className = 'file-checkbox';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `file-${fileName}`;
                        checkbox.value = fileName;
                        checkbox.checked = true; // Check it by default
                        
                        const label = document.createElement('label');
                        label.htmlFor = `file-${fileName}`;
                        label.textContent = fileName;
                        
                        fileCheckbox.appendChild(checkbox);
                        fileCheckbox.appendChild(label);
                        fileList.appendChild(fileCheckbox);
                        
                        // Clear input
                        fileInput.value = '';
                    } else {
                        alert(`File "${fileName}" is already in the list`);
                    }
                } else {
                    alert('Please enter a file name');
                }
            });
            
            // Also allow pressing Enter to add a file
            fileInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addFileBtn.click();
                }
            });
            
            // Add RankedWiki.txt as the default file if input is pre-filled
            if (fileInput.value.trim()) {
                addFileBtn.click();
            }
        }
        
        // Convert wildcard pattern to regex
        function wildcardToRegex(pattern) {
            // Escape special regex characters except * and ?
            let regexPattern = pattern.replace(/[.+^${}()|[\]\\]/g, '\\$&');
            
            // Convert * to regex .*
            regexPattern = regexPattern.replace(/\*/g, '.*');
            
            // Convert ? to regex .
            regexPattern = regexPattern.replace(/\?/g, '.');
            
            // Create case-insensitive regex
            return new RegExp(`^${regexPattern}$`, 'i');
        }
        
        // Search for terms
        async function searchTerms(continueSearch = false) {
            if (!userIsAdmin) {
                alert('You need admin privileges to perform searches.');
                return;
            }
            
            // If not continuing a previous search, start a new one
            if (!continueSearch) {
                const searchTerm = searchInput.value.trim();
                
                if (!searchTerm) {
                    alert('Please enter a search term');
                    return;
                }
                
                // Get selected files
                const selectedFiles = [];
                availableFiles.forEach(file => {
                    const checkbox = document.getElementById(`file-${file}`);
                    if (checkbox && checkbox.checked) {
                        // Fix file names that incorrectly use dots instead of underscores
                        let correctedFileName = file;
                        if (file.includes('.') && !file.includes('_')) {
                            correctedFileName = file.replace(/\./g, '_');
                            console.warn(`File name contains dots, attempting to use ${correctedFileName} instead`);
                        }
                        selectedFiles.push(correctedFileName);
                    }
                });
                
                if (selectedFiles.length === 0) {
                    alert('Please select at least one file');
                    return;
                }
                
                // Define the score ranges for the search (highest to lowest)
                const scoreRanges = [
                    { min: 90, max: 100 }, // Highest scores first
                    { min: 80, max: 89 },
                    { min: 70, max: 79 },
                    { min: 60, max: 69 },
                    { min: 50, max: 59 },
                    { min: 40, max: 49 },
                    { min: 30, max: 39 },
                    { min: 20, max: 29 },
                    { min: 10, max: 19 },
                    { min: 0, max: 9 }
                ];
                
                // Create regex pattern from search term
                const regexPattern = wildcardToRegex(searchTerm);
                
                // Initialize search state
                currentSearchState = {
                    searchTerm: searchTerm,
                    pattern: regexPattern,
                    selectedFiles: selectedFiles,
                    fileIndex: 0,
                    scoreRanges: scoreRanges,
                    scoreRangeIndex: 0,
                    currentScore: scoreRanges[0].max,
                    hasMoreResults: false,
                    resultsFound: 0,
                    allResults: [],
                    errors: []
                };
            }
            
            // Show loading
            if (!continueSearch) {
                resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
            } else {
                // If continuing, update or create the loading indicator for additional results
                let loadingElem = document.getElementById('loading-more');
                if (!loadingElem) {
                    loadingElem = document.createElement('div');
                    loadingElem.id = 'loading-more';
                    loadingElem.className = 'loading';
                    loadingElem.textContent = 'Loading more results...';
                    resultsContainer.appendChild(loadingElem);
                }
            }
            
            try {
                // Start or continue the search process
                const results = await searchBatch();
                
                // Display results, indicating if this is a continuation of a previous search
                displayResults(results, continueSearch);
            } catch (error) {
                console.error('Error searching terms:', error);
                
                // Set more specific error message based on the error type
                if (error.code === 'PERMISSION_DENIED') {
                    resultsContainer.innerHTML = `
                        <div class="error-message">
                            <strong>Permission denied:</strong> Your Firebase security rules do not allow reading from the 'tools' path.
                            Update your rules to allow read access to the 'tools' path for admin users.
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = `
                        <div class="error-message">
                            <strong>Error searching terms:</strong> ${error.message || 'Unknown error'}
                        </div>
                    `;
                }
            }
        }
        
        // Search in batches until we find enough results or exhaust the search space
        async function searchBatch() {
            const results = [];
            const errors = [];
            
            // 30 second timeout for the entire batch
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error(`Search timed out`)), 30000);
            });
            
            try {
                const searchPromise = (async () => {
                    // Continue from where we left off
                    let {selectedFiles, fileIndex, scoreRanges, scoreRangeIndex, currentScore} = currentSearchState;
                    
                    // Loop through files
                    while (fileIndex < selectedFiles.length) {
                        const filename = selectedFiles[fileIndex];
                        
                        // Check if file exists (only on first file access)
                        if (scoreRangeIndex === 0 && currentScore === scoreRanges[0].max) {
                            try {
                                const fileExists = await checkFileExists(filename);
                                if (!fileExists) {
                                    // File doesn't exist, add error and skip to next file
                                    if (filename.includes('.')) {
                                        const correctedName = filename.replace(/\./g, '_');
                                        errors.push({
                                            term: `Error: File not found: ${filename}`,
                                            parentheses: `Files use underscores, not dots. Did you mean "${correctedName}"?`,
                                            score: 0,
                                            filename: filename,
                                            termId: 'error',
                                            isError: true
                                        });
                                    } else {
                                        errors.push({
                                            term: `Error: File not found: ${filename}`,
                                            parentheses: 'This file does not exist in the database. Available files: RankedWiki_txt, RankedWiktionary_txt, ScrabbleDict_txt, jeopardy_wordlist_txt',
                                            score: 0,
                                            filename: filename,
                                            termId: 'error',
                                            isError: true
                                        });
                                    }
                                    fileIndex++;
                                    continue;
                                }
                            } catch (error) {
                                console.error(`Error checking if file exists: ${filename}`, error);
                                errors.push({
                                    term: `Error checking file: ${filename}`,
                                    parentheses: error.message || 'Unknown error',
                                    score: 0,
                                    filename: filename,
                                    termId: 'error',
                                    isError: true
                                });
                                fileIndex++;
                                continue;
                            }
                        }
                        
                        // Loop through score ranges
                        while (scoreRangeIndex < scoreRanges.length) {
                            const range = scoreRanges[scoreRangeIndex];
                            
                            // Loop through scores in the current range
                            while (currentScore >= range.min) {
                                try {
                                    // Search for one score at a time
                                    const scoreResults = await searchScore(filename, currentScore, currentSearchState.pattern);
                                    results.push(...scoreResults);
                                    
                                    // Update total results found
                                    currentSearchState.resultsFound += scoreResults.length;
                                    
                                    // If we have enough results, stop searching
                                    if (currentSearchState.resultsFound >= resultsPerPage) {
                                        // Remember where we left off
                                        currentSearchState.currentScore = currentScore - 1;
                                        
                                        // Check if there could be more results
                                        currentSearchState.hasMoreResults = true;
                                        
                                        // Return the current batch
                                        return results;
                                    }
                                } catch (error) {
                                    console.error(`Error searching score ${currentScore} in ${filename}:`, error);
                                    // Just skip this score and continue
                                }
                                
                                // Move to next score
                                currentScore--;
                            }
                            
                            // Move to next range
                            scoreRangeIndex++;
                            if (scoreRangeIndex < scoreRanges.length) {
                                currentScore = scoreRanges[scoreRangeIndex].max;
                            }
                        }
                        
                        // Reset for next file
                        fileIndex++;
                        scoreRangeIndex = 0;
                        if (scoreRanges.length > 0) {
                            currentScore = scoreRanges[0].max;
                        }
                    }
                    
                    // If we get here, we've exhausted all search options
                    currentSearchState.hasMoreResults = false;
                    
                    return results;
                })();
                
                // Race the search against the timeout
                const batchResults = await Promise.race([searchPromise, timeoutPromise]);
                
                // Add any errors we encountered
                if (errors.length > 0) {
                    // Add errors to the front of the results
                    batchResults.unshift(...errors);
                    
                    // Also track them in the search state
                    if (!currentSearchState.errors) {
                        currentSearchState.errors = [];
                    }
                    currentSearchState.errors.push(...errors);
                }
                
                return batchResults;
            } catch (error) {
                console.error('Error in search batch:', error);
                
                // Return whatever results we had plus the error
                const errorResult = {
                    term: `Error during search`,
                    parentheses: error.message || 'Unknown error',
                    score: 0,
                    termId: 'error',
                    isError: true
                };
                
                results.push(errorResult);
                return results;
            }
        }
        
        // Check if a file exists in the database
        async function checkFileExists(filename) {
            try {
                const snapshot = await db.ref(`tools/${filename}`).limitToFirst(1).once('value');
                return snapshot.exists();
            } catch (error) {
                console.error(`Error checking if file exists: ${filename}`, error);
                throw error;
            }
        }
        
        // Search a specific score in a file
        async function searchScore(filename, score, regexPattern) {
            try {
                const snapshot = await db.ref(`tools/${filename}/${score}`).once('value');
                const terms = snapshot.val() || {};
                const results = [];
                
                // For each term ID
                for (const termId in terms) {
                    if (terms.hasOwnProperty(termId)) {
                        const termData = terms[termId];
                        
                        // Skip items without term property
                        if (!termData.term) continue;
                        
                        // Check if term matches regex pattern
                        if (regexPattern.test(termData.term)) {
                            results.push({
                                term: termData.term,
                                parentheses: termData.parentheses || '',
                                score: score,
                                filename: filename,
                                termId: termId
                            });
                        }
                    }
                }
                
                return results;
            } catch (error) {
                console.error(`Error searching score ${score} in ${filename}:`, error);
                throw error;
            }
        }
        
        // Display search results
        function displayResults(results, isLoadMore) {
            // Remove loading more indicator if it exists
            const loadingMore = document.getElementById('loading-more');
            if (loadingMore) {
                loadingMore.remove();
            }
            
            if (!isLoadMore) {
                resultsContainer.innerHTML = '';
            }
            
            if (results.length === 0 && !isLoadMore) {
                resultsContainer.innerHTML = '<p class="no-results">No results found. Try a different search term.</p>';
                return;
            }
            
            // Check if all results are errors
            const errorResults = results.filter(r => r.isError);
            if (errorResults.length === results.length && !isLoadMore) {
                const errorHtml = errorResults.map(err => 
                    `<div class="error-message" style="margin-bottom: 10px;">
                        <strong>${err.term}</strong><br>
                        ${err.parentheses}
                    </div>`
                ).join('');
                
                resultsContainer.innerHTML = `
                    <p class="no-results">Encountered errors while searching:</p>
                    ${errorHtml}
                    <div class="info-message" style="margin-top: 20px;">
                        <strong>Suggestions:</strong>
                        <ul>
                            <li>Try using more specific search terms (e.g., use 'science' instead of '*s*')</li>
                            <li>Make sure the file name is correct and uses underscores, not dots (e.g., 'RankedWiki_txt' not 'RankedWiki.txt')</li>
                            <li>Available files: RankedWiki_txt, RankedWiktionary_txt, ScrabbleDict_txt, jeopardy_wordlist_txt</li>
                            <li>Break large searches into smaller ones</li>
                        </ul>
                    </div>
                `;
                return;
            }
            
            // Filter out error results for normal display
            const validResults = results.filter(r => !r.isError);
            
            // If we're loading more and there are only errors in this batch, show a message
            if (isLoadMore && validResults.length === 0 && errorResults.length > 0) {
                const errorWarning = document.createElement('div');
                errorWarning.className = 'error-message';
                errorWarning.style.backgroundColor = '#fff3cd';
                errorWarning.style.color = '#856404';
                errorWarning.style.border = '1px solid #ffeeba';
                errorWarning.innerHTML = `<strong>Note:</strong> No additional results found. There were errors accessing some data.`;
                resultsContainer.appendChild(errorWarning);
                return;
            }
            
            // Create table if it doesn't exist
            let table = document.getElementById('results-table');
            
            if (!table) {
                table = document.createElement('table');
                table.id = 'results-table';
                table.className = 'results-table';
                
                // Create header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                // Include all columns, including placeholders for future implementation
                const headers = ['Score', 'Term', 'Parenthetical', 'Wikipedia Link', 'Merriam Webster Link', 'Trivia Archive Results'];
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                tbody.id = 'results-tbody';
                table.appendChild(tbody);
                
                resultsContainer.appendChild(table);
            }
            
            // Get or create table body
            const tbody = document.getElementById('results-tbody');
            
            // If this is a continued search, we'll append to the existing table
            // If it's a new search, we've already cleared the results container above
            
            // Add count of results if this is the first batch
            if (!isLoadMore) {
                const totalCount = document.createElement('div');
                totalCount.className = 'result-count';
                totalCount.id = 'result-count';
                totalCount.textContent = `Found ${validResults.length} result${validResults.length !== 1 ? 's' : ''}`;
                resultsContainer.insertBefore(totalCount, table);
                
                // If there were errors, also show a warning
                if (errorResults.length > 0) {
                    const errorWarning = document.createElement('div');
                    errorWarning.className = 'error-message';
                    errorWarning.style.backgroundColor = '#fff3cd';
                    errorWarning.style.color = '#856404';
                    errorWarning.style.border = '1px solid #ffeeba';
                    errorWarning.innerHTML = `<strong>Note:</strong> Some files had errors and were excluded from results.`;
                    resultsContainer.insertBefore(errorWarning, table);
                }
            } else {
                // If we're loading more, update the count
                const totalCount = document.getElementById('result-count');
                if (totalCount) {
                    const currentCount = parseInt(totalCount.textContent.match(/\d+/)[0], 10);
                    const newCount = currentCount + validResults.length;
                    totalCount.textContent = `Found ${newCount} result${newCount !== 1 ? 's' : ''}`;
                }
            }
            
            // Display valid results
            for (const result of validResults) {
                const row = document.createElement('tr');
                
                // Score cell
                const scoreCell = document.createElement('td');
                scoreCell.textContent = result.score;
                row.appendChild(scoreCell);
                
                // Term cell
                const termCell = document.createElement('td');
                termCell.textContent = result.term;
                row.appendChild(termCell);
                
                // Parenthetical cell
                const parenthesesCell = document.createElement('td');
                parenthesesCell.textContent = result.parentheses || '';
                row.appendChild(parenthesesCell);
                
                // Wikipedia Link (placeholder)
                const wikiCell = document.createElement('td');
                wikiCell.textContent = 'Coming soon';
                row.appendChild(wikiCell);
                
                // Merriam Webster Link (placeholder)
                const mwCell = document.createElement('td');
                mwCell.textContent = 'Coming soon';
                row.appendChild(mwCell);
                
                // Trivia Archive (placeholder)
                const triviaCell = document.createElement('td');
                triviaCell.textContent = 'Coming soon';
                row.appendChild(triviaCell);
                
                tbody.appendChild(row);
            }
            
            // Show "Load More" button if there are potentially more results
            // Remove existing button first
            const existingButton = document.getElementById('load-more-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            if (currentSearchState.hasMoreResults) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.id = 'load-more-button';
                loadMoreButton.className = 'load-more';
                loadMoreButton.textContent = 'Load More Results';
                
                loadMoreButton.addEventListener('click', () => {
                    // Continue the search from where we left off
                    searchTerms(true);
                });
                
                resultsContainer.appendChild(loadMoreButton);
            }
        }
        
        // Event listeners
        searchButton.addEventListener('click', searchTerms);
        
        // Allow Enter key to trigger search
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchTerms();
            }
        });
    </script>
</body>
</html> 