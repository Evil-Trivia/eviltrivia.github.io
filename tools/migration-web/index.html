<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Large File Migration Tool - Evil Trivia</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .card-body {
            padding: 20px;
        }

        .status-display {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            min-height: 50px;
            border: 2px solid #e9ecef;
        }

        .status-info { background: #e7f3ff; border-color: #007bff; color: #004085; }
        .status-success { background: #d4edda; border-color: #28a745; color: #155724; }
        .status-warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .status-error { background: #f8d7da; border-color: #dc3545; color: #721c24; }

        .file-upload-area {
            border: 3px dashed #007bff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #0056b3;
            background: #e7f3ff;
        }

        .file-upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 15px;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }

        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #bd2130; }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .file-list {
            margin: 20px 0;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 5px 0;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #495057;
        }

        .file-size {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .file-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #e7f3ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }

        .hidden { display: none; }

        .auth-section {
            text-align: center;
            padding: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .instructions {
            background: #e7f3ff;
            border: 1px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .instructions h3 {
            color: #007bff;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Large File Migration Tool</h1>
            <p>Upload and migrate your huge JSON files to Firestore with intelligent chunking</p>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="card">
            <div class="card-header">
                <h2>üîê Authentication Required</h2>
            </div>
            <div class="card-body auth-section">
                <p>Please sign in with your admin account to access the migration tool.</p>
                <button id="sign-in-btn" class="btn">Sign In with Google</button>
            </div>
        </div>

        <!-- Migration Tool Section -->
        <div id="migration-section" class="hidden">
            <!-- Instructions -->
            <div class="card instructions">
                <h3>üìã How to Use This Tool</h3>
                <ol>
                    <li><strong>Export your data:</strong> Use Firebase CLI to export each file:
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">firebase database:get /tools/RankedWiki_txt --output RankedWiki_txt.json</pre>
                    </li>
                    <li><strong>Upload files:</strong> Drag and drop or click to select your exported JSON files</li>
                    <li><strong>Start migration:</strong> Click "Start Migration" and watch the progress</li>
                    <li><strong>Monitor progress:</strong> Real-time updates show exactly what's happening</li>
                </ol>
                <p><strong>üí° This tool handles massive files by processing them in small chunks, avoiding memory issues!</strong></p>
            </div>

            <!-- File Upload -->
            <div class="card">
                <div class="card-header">
                    <h2>üìÅ Upload JSON Files</h2>
                </div>
                <div class="card-body">
                    <div class="file-upload-area" id="upload-area">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Drop your JSON files here or click to browse</h3>
                        <p>Supports multiple large files (RankedWiki_txt.json, etc.)</p>
                        <input type="file" id="file-input" class="file-input" multiple accept=".json">
                    </div>
                    
                    <div id="file-list" class="file-list hidden">
                        <h4>Selected Files:</h4>
                        <div id="files-container"></div>
                    </div>
                </div>
            </div>

            <!-- Migration Controls -->
            <div class="card">
                <div class="card-header">
                    <h2>‚öôÔ∏è Migration Controls</h2>
                </div>
                <div class="card-body">
                    <button id="start-migration" class="btn btn-success" disabled>Start Migration</button>
                    <button id="pause-migration" class="btn btn-warning hidden">Pause Migration</button>
                    <button id="clear-files" class="btn btn-danger">Clear Files</button>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill">
                                <div class="progress-text" id="progress-text">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Display -->
            <div class="card">
                <div class="card-header">
                    <h2>üìä Migration Status</h2>
                </div>
                <div class="card-body">
                    <div id="status-display" class="status-display status-info">Ready to start migration...</div>
                    
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="stat-terms">0</div>
                            <div class="stat-label">Terms Migrated</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat-files">0</div>
                            <div class="stat-label">Files Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat-batches">0</div>
                            <div class="stat-label">Batches Processed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat-errors">0</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.appspot.com",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const migrationSection = document.getElementById('migration-section');
        const signInBtn = document.getElementById('sign-in-btn');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const filesContainer = document.getElementById('files-container');
        const startMigrationBtn = document.getElementById('start-migration');
        const pauseMigrationBtn = document.getElementById('pause-migration');
        const clearFilesBtn = document.getElementById('clear-files');
        const statusDisplay = document.getElementById('status-display');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        // Stats elements
        const statTerms = document.getElementById('stat-terms');
        const statFiles = document.getElementById('stat-files');
        const statBatches = document.getElementById('stat-batches');
        const statErrors = document.getElementById('stat-errors');

        // State
        let selectedFiles = [];
        let migrationInProgress = false;
        let migrationPaused = false;
        let userIsAdmin = false;
        let migrationStats = {
            terms: 0,
            files: 0,
            batches: 0,
            errors: 0
        };

        // Authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Check if user is admin (you can modify this check)
                userIsAdmin = user.uid === 'h19MlFLygMdKES2bFVMhg2I377A3';
                
                if (userIsAdmin) {
                    authSection.classList.add('hidden');
                    migrationSection.classList.remove('hidden');
                    updateStatus('‚úÖ Authenticated as admin. Ready to migrate!', 'success');
                } else {
                    updateStatus('‚ùå Admin privileges required for migration', 'error');
                }
            } else {
                authSection.classList.remove('hidden');
                migrationSection.classList.add('hidden');
            }
        });

        signInBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider);
        });

        // File Upload Handling
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            const jsonFiles = files.filter(file => file.name.endsWith('.json'));
            
            if (jsonFiles.length === 0) {
                updateStatus('‚ùå Please select JSON files only', 'error');
                return;
            }

            selectedFiles = [...selectedFiles, ...jsonFiles];
            displayFiles();
            startMigrationBtn.disabled = selectedFiles.length === 0;
            
            updateStatus(`üìÅ Added ${jsonFiles.length} JSON file(s). Total: ${selectedFiles.length}`, 'success');
        }

        function displayFiles() {
            if (selectedFiles.length === 0) {
                fileList.classList.add('hidden');
                return;
            }

            fileList.classList.remove('hidden');
            filesContainer.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-status status-pending" id="status-${index}">Pending</div>
                `;
                filesContainer.appendChild(fileItem);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Migration Logic
        startMigrationBtn.addEventListener('click', startMigration);
        pauseMigrationBtn.addEventListener('click', pauseMigration);
        clearFilesBtn.addEventListener('click', clearFiles);

        function clearFiles() {
            selectedFiles = [];
            displayFiles();
            startMigrationBtn.disabled = true;
            updateStatus('üóëÔ∏è Files cleared', 'info');
            resetStats();
        }

        function pauseMigration() {
            migrationPaused = !migrationPaused;
            pauseMigrationBtn.textContent = migrationPaused ? 'Resume Migration' : 'Pause Migration';
            updateStatus(migrationPaused ? '‚è∏Ô∏è Migration paused' : '‚ñ∂Ô∏è Migration resumed', 'warning');
        }

        async function startMigration() {
            if (!userIsAdmin) {
                updateStatus('‚ùå Admin privileges required', 'error');
                return;
            }

            migrationInProgress = true;
            startMigrationBtn.disabled = true;
            pauseMigrationBtn.classList.remove('hidden');
            
            updateStatus('üöÄ Starting migration...', 'info');
            resetStats();

            try {
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    
                    // Update file status
                    const statusElement = document.getElementById(`status-${i}`);
                    statusElement.textContent = 'Processing';
                    statusElement.className = 'file-status status-processing';
                    
                    updateStatus(`üìÇ Processing ${file.name} (${i + 1}/${selectedFiles.length})...`, 'info');
                    
                    const result = await processFile(file, i);
                    
                    if (result.success) {
                        statusElement.textContent = 'Completed';
                        statusElement.className = 'file-status status-completed';
                        migrationStats.files++;
                    } else {
                        statusElement.textContent = 'Failed';
                        statusElement.className = 'file-status status-failed';
                        migrationStats.errors++;
                    }
                    
                    updateStats();
                    updateProgress((i + 1) / selectedFiles.length * 100);
                }

                // Save migration summary
                await firestore.collection('migration-info').doc('web-migration').set({
                    migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    totalTerms: migrationStats.terms,
                    totalBatches: migrationStats.batches,
                    filesProcessed: migrationStats.files,
                    errors: migrationStats.errors,
                    migrationSource: 'web-interface',
                    version: '1.0'
                });

                updateStatus('üéâ Migration completed successfully!', 'success');

            } catch (error) {
                console.error('Migration error:', error);
                updateStatus(`‚ùå Migration failed: ${error.message}`, 'error');
            } finally {
                migrationInProgress = false;
                startMigrationBtn.disabled = false;
                pauseMigrationBtn.classList.add('hidden');
            }
        }

        async function processFile(file, fileIndex) {
            try {
                updateStatus(`üìñ Reading ${file.name}...`, 'info');
                
                // Read file as text
                const text = await readFileAsText(file);
                
                updateStatus(`üîç Parsing JSON data...`, 'info');
                const data = JSON.parse(text);
                
                const baseFileName = file.name.replace('.json', '');
                let fileTermCount = 0;
                
                // Process each score level
                const scores = Object.keys(data).filter(key => !isNaN(parseInt(key)));
                updateStatus(`üìä Processing ${scores.length} score levels in ${file.name}...`, 'info');
                
                for (const score of scores) {
                    if (migrationPaused) {
                        while (migrationPaused) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    
                    const scoreNum = parseInt(score, 10);
                    const scoreData = data[score];
                    
                    if (!scoreData || typeof scoreData !== 'object') continue;
                    
                    const termIds = Object.keys(scoreData);
                    
                    // Process in small batches
                    const BATCH_SIZE = 25; // Very small batches for web interface
                    
                    for (let i = 0; i < termIds.length; i += BATCH_SIZE) {
                        if (migrationPaused) {
                            while (migrationPaused) {
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                        
                        const batch = firestore.batch();
                        const batchTermIds = termIds.slice(i, i + BATCH_SIZE);
                        let batchSize = 0;
                        
                        for (const termId of batchTermIds) {
                            const termData = scoreData[termId];
                            
                            if (!termData || !termData.term || typeof termData.term !== 'string') {
                                continue;
                            }
                            
                            const docData = {
                                term: termData.term,
                                termLower: termData.term.toLowerCase(),
                                parentheses: termData.parentheses || '',
                                score: scoreNum,
                                file: baseFileName,
                                originalTermId: termId,
                                termLength: termData.term.length,
                                firstLetter: termData.term.charAt(0).toLowerCase(),
                                lastLetter: termData.term.charAt(termData.term.length - 1).toLowerCase(),
                                migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                migrationSource: 'web-upload'
                            };
                            
                            const docId = `${baseFileName}_${score}_${termId}`;
                            const docRef = firestore.collection('tools').doc(docId);
                            batch.set(docRef, docData);
                            
                            batchSize++;
                            fileTermCount++;
                            migrationStats.terms++;
                        }
                        
                        if (batchSize > 0) {
                            await batch.commit();
                            migrationStats.batches++;
                            
                            // Update progress every few batches
                            if (migrationStats.batches % 5 === 0) {
                                updateStats();
                                updateStatus(`üíæ ${file.name}: ${fileTermCount.toLocaleString()} terms processed...`, 'info');
                            }
                            
                            // Small delay to avoid overwhelming Firestore
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }
                }
                
                updateStatus(`‚úÖ ${file.name}: ${fileTermCount.toLocaleString()} terms migrated`, 'success');
                return { success: true, terms: fileTermCount };
                
            } catch (error) {
                console.error(`Error processing ${file.name}:`, error);
                updateStatus(`‚ùå Error processing ${file.name}: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        function updateStatus(message, type = 'info') {
            statusDisplay.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            statusDisplay.className = `status-display status-${type}`;
        }

        function updateProgress(percent) {
            progressFill.style.width = `${percent}%`;
            progressText.textContent = `${Math.round(percent)}%`;
        }

        function updateStats() {
            statTerms.textContent = migrationStats.terms.toLocaleString();
            statFiles.textContent = migrationStats.files.toLocaleString();
            statBatches.textContent = migrationStats.batches.toLocaleString();
            statErrors.textContent = migrationStats.errors.toLocaleString();
        }

        function resetStats() {
            migrationStats = { terms: 0, files: 0, batches: 0, errors: 0 };
            updateStats();
            updateProgress(0);
        }
    </script>
</body>
</html>
