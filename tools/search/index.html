<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Trivia - Search Archive</title>
    <script src="/js/components/autoload-banner.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FFCC00;
            --secondary-color: #000;
            --background-white: #fff;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-color);
            margin-top: 60px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .search-container {
            background-color: var(--background-white);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            width: 100%;
            box-sizing: border-box;
        }
        
        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            width: 100%;
            align-items: flex-end;
        }
        
        .search-input-wrapper {
            flex-grow: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-input-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: var(--transition);
            font-family: inherit;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            display: none;
            padding: 4px;
            border-radius: 4px;
        }
        
        .search-clear:hover {
            background-color: #f0f0f0;
        }
        
        .search-clear.visible {
            display: block;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            font-family: inherit;
        }
        
        button:hover:not(:disabled) {
            background-color: #333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .filter-section {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .filter-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        
        select {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition);
            background-color: white;
        }
        
        select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        
        .results-container {
            background-color: var(--background-white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .results-count {
            font-weight: 600;
            color: var(--text-color);
            font-size: 18px;
        }
        
        .search-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 16px;
            font-size: 14px;
            color: #666;
        }
        
        .search-time {
            font-style: italic;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .results-table th, .results-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }
        
        .results-table th {
            background-color: #f8f9fa;
            color: var(--text-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }
        
        .results-table th:hover {
            background-color: #e9ecef;
        }
        
        .results-table th.sortable::after {
            content: ' ‚ÜïÔ∏è';
            font-size: 12px;
            opacity: 0.5;
        }
        
        .results-table th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }
        
        .results-table th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }
        
        .results-table tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .question-text {
            max-width: 250px;
            min-height: 30px;
            max-height: 100px;
            white-space: normal;
            line-height: 1.4;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        .instruction-text {
            max-width: 200px;
            min-height: 30px;
            max-height: 80px;
            white-space: normal;
            line-height: 1.4;
            word-wrap: break-word;
            overflow: hidden;
            font-style: italic;
            color: #666;
        }
        
        .highlighted {
            background-color: #fff3cd;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .media-cell {
            max-width: 220px;
            min-width: 180px;
        }
        
        .media-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .image-preview {
            width: 180px;
            height: 120px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            object-fit: cover;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .image-preview:hover {
            transform: scale(1.02);
            border-color: var(--secondary-color);
        }
        
        .audio-player {
            width: 180px;
            height: 50px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .media-link {
            font-size: 11px;
            color: #666;
            text-decoration: none;
            padding: 3px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            text-align: center;
            transition: var(--transition);
            display: block;
            margin-top: 4px;
        }
        
        .media-link:hover {
            background: #e9ecef;
            text-decoration: none;
        }
        
        .auth-container {
            background-color: var(--background-white);
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            margin: 40px auto;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .auth-container h2 {
            margin-top: 0;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .auth-container p {
            margin-bottom: 24px;
            color: #666;
            line-height: 1.6;
        }
        
        .auth-btn {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .hidden {
            display: none;
        }

        .search-help {
            margin-top: 12px;
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .search-help code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results, .end-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }
        
        .load-more {
            text-align: center;
            margin-top: 24px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .index-status {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
        
        .round-name {
            font-style: italic;
            color: #666;
            font-size: 11px;
        }
        
        /* Image Modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .image-modal.show {
            display: flex;
        }
        
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        .image-modal .close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 1001;
        }
        
        /* Round Details Modal */
        .round-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .round-modal.show {
            display: flex;
        }
        
        .round-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .round-modal-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid #eee;
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            z-index: 1001;
        }
        
        .round-modal-header h2 {
            margin: 0 0 12px 0;
            color: var(--text-color);
            font-size: 24px;
        }
        
        .round-modal-header .drive-link {
            display: inline-block;
            background-color: #4285f4;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 8px;
            transition: var(--transition);
        }
        
        .round-modal-header .drive-link:hover {
            background-color: #3367d6;
            transform: translateY(-1px);
        }
        
        .round-modal-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .round-modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .round-modal-body {
            padding: 24px;
        }
        
        .round-questions {
            display: grid;
            gap: 20px;
        }
        
        .question-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            background: #f9f9f9;
        }
        
        .question-item .question-number {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .question-item .question {
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .question-item .answer {
            color: #2e7d32;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .question-item .media-preview {
            margin-top: 12px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 12px;
            }
            
            .search-container, .results-container {
                padding: 16px;
                border-radius: 8px;
            }
            
            .search-row {
                flex-direction: column;
                gap: 12px;
            }
            
            .filter-section {
                flex-direction: column;
                gap: 12px;
            }
            
            .filter-group {
                width: 100%;
                min-width: auto;
            }
            
            .results-table {
                font-size: 12px;
            }
            
            .results-table th, .results-table td {
                padding: 6px 4px;
            }
            
            .question-text {
                max-width: 150px;
            }
            
            .instruction-text {
                max-width: 120px;
            }
            
            .media-cell {
                max-width: 120px;
                min-width: 100px;
            }
            
            .image-preview {
                width: 100px;
                height: 70px;
            }
            
            .audio-player {
                width: 100px;
                height: 40px;
            }
            
            .round-modal-content {
                width: 95%;
                max-height: 95%;
            }
            
            .round-modal-header {
                padding: 16px;
            }
            
            .round-modal-body {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Enhanced Trivia Archive Search</h1>
        
        <!-- Authentication Required Screen -->
        <div id="auth-screen" class="auth-container hidden">
            <h2>üîê Access Required</h2>
            <p>You need admin or tools privileges to access this search interface.</p>
            <a href="/account" class="auth-btn">Go to Account Page</a>
        </div>
        
        <!-- Search Interface -->
        <div id="search-screen" class="hidden">
            <div class="search-container">
                <div class="search-row">
                    <div class="search-input-wrapper">
                        <label class="search-input-label">Search questions, answers, and more...</label>
                        <input type="text" id="search-query" placeholder="Try: 'music', 'visual round', 'washington', etc.">
                        <button class="search-clear" id="search-clear" title="Clear search">√ó</button>
                    </div>
                    <button id="search-btn">
                        <span class="search-btn-text">Search</span>
                        <span class="loading-spinner hidden" id="search-spinner"></span>
                    </button>
                </div>
                
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="round-type-filter">Round Type</label>
                        <select id="round-type-filter">
                            <option value="">All Round Types</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="format-filter">Format</label>
                        <select id="format-filter">
                            <option value="">All Formats</option>
                        </select>
                    </div>
                </div>
                
                <div class="search-help">
                    <strong>Pro tips:</strong> Use <code>*</code> for wildcards, <code>"exact phrase"</code> for exact matches. Click column headers to sort results. <strong>Click any question row to see all questions from that round!</strong>
                </div>
            </div>
            
            <!-- Index Building Status -->
            <div id="index-status" class="index-status">
                <div>Building search index...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div id="progress-text">Preparing search engine...</div>
            </div>
            
            <div class="results-container">
                <div class="results-header">
                    <div class="results-count">Ready to search <span id="total-questions">0</span> questions</div>
                    <button id="clear-btn">Clear Results</button>
                </div>
                
                <div class="search-stats hidden" id="search-stats">
                    <div>
                        <span id="results-count">0</span> results found
                    </div>
                    <div class="search-time" id="search-time"></div>
                </div>
                
                <div class="table-responsive">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="triviaNumber">Trivia #</th>
                                <th class="sortable" data-sort="triviaDate">Date</th>
                                <th class="sortable" data-sort="round">Round</th>
                                <th class="sortable" data-sort="roundName">Round Name</th>
                                <th class="sortable" data-sort="roundType">Round Type</th>
                                <th class="sortable" data-sort="format">Format</th>
                                <th class="sortable" data-sort="roundInstruction">Instruction</th>
                                <th class="sortable" data-sort="question">Question</th>
                                <th class="sortable" data-sort="answer">Answer</th>
                                <th>Media</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="no-results" class="no-results hidden">
                    <p>üîç No matching questions found.</p>
                    <p>Try adjusting your search terms or filters.</p>
                </div>
                
                <div class="load-more hidden" id="load-more">
                    <button id="load-more-btn">Load More Results (showing first 100)</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="image-modal">
        <span class="close" id="modal-close">&times;</span>
        <img id="modal-image" src="" alt="Full size image">
    </div>
    
    <!-- Round Details Modal -->
    <div class="round-modal" id="round-modal">
        <div class="round-modal-content">
            <div class="round-modal-header">
                <button class="round-modal-close" id="round-modal-close">&times;</button>
                <h2 id="round-modal-title">Round Details</h2>
                <a id="round-drive-link" href="#" target="_blank" class="drive-link hidden">üìÅ Open Google Drive Folder</a>
            </div>
            <div class="round-modal-body">
                <div id="round-questions" class="round-questions">
                    <!-- Round questions will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
        // Fast and Robust Search Engine
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebasestorage.app",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // Fast Search Engine - Optimized for Speed
        class FastSearchEngine {
            constructor() {
                this.questions = []; // Simple array for fast searching
                this.isReady = false;
                this.cache = new Map(); // Simple in-memory cache
                this.roundTypes = new Set(); // Track available round types
                this.formats = new Set(); // Track available formats
                this.driveLookup = new Map(); // Google Drive folder lookup
                this.fullRoundData = new Map(); // Store complete round data for popups
            }
            
            // Safe string extraction with error handling
            safeString(value) {
                if (value === null || value === undefined) return '';
                if (typeof value === 'string') return value;
                if (typeof value === 'number') return String(value);
                if (typeof value === 'object') return JSON.stringify(value);
                return String(value);
            }
            
            // Build search index asynchronously with progress updates
            async buildIndex() {
                const startTime = performance.now();
                console.log('Building search index...');
                
                try {
                    // Get both archive and drive lookup data
                    const [archiveSnapshot, driveSnapshot] = await Promise.all([
                        db.ref('trivia-archive/archive').once('value'),
                        db.ref('trivia-archive/driveLookup').once('value')
                    ]);
                    
                    const archiveData = archiveSnapshot.val();
                    const driveData = driveSnapshot.val();
                    
                    if (!archiveData) {
                        console.warn('No trivia data found');
                        this.updateProgress(100, 'No data found');
                        return;
                    }
                    
                    // Store drive lookup data with debugging
                    if (driveData) {
                        console.log('Drive lookup data sample:', Object.keys(driveData).slice(0, 3));
                        Object.entries(driveData).forEach(([triviaNumber, data]) => {
                            if (data) {
                                // Debug the first few entries
                                if (Object.keys(this.driveLookup).length < 3) {
                                    console.log(`Drive data for ${triviaNumber}:`, data);
                                }
                                
                                // Try different possible field names for the link
                                const link = data.Link || data.link || data.url || data.driveLink || data['Google Drive Link'];
                                if (link) {
                                    this.driveLookup.set(triviaNumber, link);
                                }
                            }
                        });
                        console.log(`Loaded ${this.driveLookup.size} drive links`);
                    } else {
                        console.warn('No drive lookup data found');
                    }
                    
                    const triviaEntries = Object.entries(archiveData);
                    const totalItems = triviaEntries.length;
                    let processedItems = 0;
                    
                    // Process data in chunks to avoid blocking
                    for (const [triviaNumber, triviaSet] of triviaEntries) {
                        await this.processTriviaSetAsync(triviaNumber, triviaSet);
                        
                        processedItems++;
                        const progress = Math.round((processedItems / totalItems) * 100);
                        this.updateProgress(progress, `Processed ${processedItems}/${totalItems} trivia sets`);
                        
                        // Yield control to prevent blocking
                        if (processedItems % 10 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 1));
                        }
                    }
                    
                    this.isReady = true;
                    const endTime = performance.now();
                    const buildTime = Math.round(endTime - startTime);
                    
                    console.log(`Search index built in ${buildTime}ms with ${this.questions.length} questions`);
                    this.updateProgress(100, `Ready! ${this.questions.length} questions indexed in ${buildTime}ms`);
                    
                    // Update UI
                    document.getElementById('total-questions').textContent = this.questions.length.toLocaleString();
                    document.getElementById('index-status').classList.add('hidden');
                    
                    // Populate filter dropdowns
                    this.populateFilters();
                    
                } catch (error) {
                    console.error('Error building search index:', error);
                    this.updateProgress(100, 'Error building index. Please refresh.');
                    throw error; // Re-throw to handle in calling code
                }
            }
            
            updateProgress(percent, text) {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                
                if (progressFill) progressFill.style.width = `${percent}%`;
                if (progressText) progressText.textContent = text;
            }
            
            async processTriviaSetAsync(triviaNumber, triviaSet) {
                if (!triviaSet || !triviaSet.trivia) return;
                
                const triviaDate = this.safeString(triviaSet.date);
                
                for (const [roundKey, roundData] of Object.entries(triviaSet.trivia)) {
                    if (!roundData || typeof roundData !== 'object') continue;
                    
                    // Store complete round data for popup display
                    const roundId = `${triviaNumber}-${roundKey}`;
                    if (!this.fullRoundData.has(roundId)) {
                        this.fullRoundData.set(roundId, {
                            triviaNumber,
                            triviaDate,
                            roundKey,
                            roundData,
                            questions: []
                        });
                    }
                    
                    // Extract round-level instruction (check at round level first)
                    let roundInstruction = this.safeString(
                        roundData['Round Instruction'] || 
                        roundData['roundInstruction'] || 
                        roundData['instruction'] || 
                        ''
                    );
                    
                    for (const [formatKey, formatData] of Object.entries(roundData)) {
                        if (!formatData || typeof formatData !== 'object') continue;
                        
                        // Extract round metadata from format data (fallback if not at round level)
                        const roundName = this.safeString(
                            formatData['Round Name'] || 
                            formatData['name'] || 
                            formatData['round_name'] || 
                            ''
                        );
                        
                        const roundType = this.safeString(
                            formatData['Round Type'] || 
                            formatData['roundType'] || 
                            formatData['type'] || 
                            ''
                        );
                        
                        // Use format-level instruction if round-level is empty
                        if (!roundInstruction) {
                            roundInstruction = this.safeString(
                                formatData['Round Instruction'] || 
                                formatData['roundInstruction'] || 
                                formatData['instruction'] || 
                                ''
                            );
                        }
                        
                        // Track round types and formats for filtering
                        if (roundType) this.roundTypes.add(roundType);
                        if (formatKey) this.formats.add(formatKey);
                        
                        for (const [questionKey, questionData] of Object.entries(formatData)) {
                            // Skip metadata fields
                            if (this.isMetadataField(questionKey) || !questionData || typeof questionData !== 'object') {
                                continue;
                            }
                            
                            try {
                                const question = this.safeString(questionData.Question || questionData.question || '');
                                const answer = this.safeString(questionData.Answer || questionData.answer || '');
                                
                                // Only add if we have meaningful content
                                if (question.length > 0 || answer.length > 0) {
                                    const searchableText = `${question} ${answer} ${roundName} ${roundType} ${roundInstruction}`.toLowerCase();
                                    
                                    const questionItem = {
                                        id: `${triviaNumber}-${roundKey}-${formatKey}-${questionKey}`,
                                        triviaNumber,
                                        triviaDate,
                                        round: roundKey,
                                        roundName: roundName || `Round ${roundKey}`,
                                        roundType: roundType || '',
                                        roundInstruction: roundInstruction || '',
                                        format: formatKey,
                                        questionNumber: questionKey,
                                        question,
                                        answer,
                                        searchableText,
                                        data: questionData
                                    };
                                    
                                    this.questions.push(questionItem);
                                    
                                    // Add to full round data
                                    this.fullRoundData.get(roundId).questions.push(questionItem);
                                }
                            } catch (error) {
                                console.warn(`Error processing question ${triviaNumber}-${roundKey}-${formatKey}-${questionKey}:`, error);
                            }
                        }
                    }
                }
            }
            
            isMetadataField(key) {
                return ['Round Name', 'Round Type', 'Round Format', 'Round Instruction', 'name', 'round_name', 'type', 'roundType', 'instruction', 'roundInstruction'].includes(key);
            }
            
            populateFilters() {
                const roundTypeSelect = document.getElementById('round-type-filter');
                const formatSelect = document.getElementById('format-filter');
                
                // Populate round types
                const sortedRoundTypes = Array.from(this.roundTypes).sort();
                roundTypeSelect.innerHTML = '<option value="">All Round Types</option>';
                sortedRoundTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    roundTypeSelect.appendChild(option);
                });
                
                // Populate formats
                const sortedFormats = Array.from(this.formats).sort();
                formatSelect.innerHTML = '<option value="">All Formats</option>';
                sortedFormats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format;
                    formatSelect.appendChild(option);
                });
            }
            
            // Fast search function with filtering
            search(query, filters = {}) {
                if (!this.isReady) return { results: [], searchTime: 0, fromCache: false };
                
                const startTime = performance.now();
                const cacheKey = `${query}-${JSON.stringify(filters)}`;
                
                try {
                    // Check cache first
                    if (this.cache.has(cacheKey)) {
                        const cached = this.cache.get(cacheKey);
                        return {
                            results: cached,
                            searchTime: performance.now() - startTime,
                            fromCache: true
                        };
                    }
                    
                    let results = [];
                    const queryLower = query.toLowerCase().trim();
                    
                    // Fast linear search - optimized for speed
                    for (const question of this.questions) {
                        try {
                            // Apply filters first
                            if (filters.roundType && question.roundType !== filters.roundType) continue;
                            if (filters.format && question.format !== filters.format) continue;
                            
                            // Then check query match
                            if (!queryLower || this.matchesQuery(question, queryLower)) {
                                results.push(question);
                                
                                // Limit results for performance
                                if (results.length >= 100) break;
                            }
                        } catch (error) {
                            console.warn('Search error for question:', question.id, error);
                        }
                    }
                    
                    // Cache results
                    this.cache.set(cacheKey, results);
                    
                    // Clean cache if it gets too large
                    if (this.cache.size > 100) {
                        const firstKey = this.cache.keys().next().value;
                        this.cache.delete(firstKey);
                    }
                    
                    return {
                        results,
                        searchTime: performance.now() - startTime,
                        fromCache: false
                    };
                } catch (error) {
                    console.error('Search function error:', error);
                    return { results: [], searchTime: performance.now() - startTime, fromCache: false };
                }
            }
            
            matchesQuery(question, queryLower) {
                // Handle wildcards
                if (queryLower.includes('*')) {
                    const pattern = this.wildcardToRegex(queryLower);
                    return pattern.test(question.searchableText);
                }
                
                // Handle exact phrases
                if (queryLower.includes('"')) {
                    const phrases = queryLower.match(/"([^"]+)"/g) || [];
                    for (const phrase of phrases) {
                        const cleanPhrase = phrase.replace(/"/g, '');
                        if (question.searchableText.includes(cleanPhrase)) {
                            return true;
                        }
                    }
                }
                
                // Simple substring search - fastest option
                return question.searchableText.includes(queryLower);
            }
            
            wildcardToRegex(pattern) {
                const escaped = pattern.replace(/[.+^${}()|[\]\\]/g, '\\$&');
                const regex = escaped.replace(/\*/g, '.*');
                return new RegExp(regex, 'i');
            }
            
            // Get all questions for a specific round
            getRoundQuestions(triviaNumber, roundKey) {
                const roundId = `${triviaNumber}-${roundKey}`;
                return this.fullRoundData.get(roundId) || null;
            }
            
            // Get Google Drive folder link for a trivia number
            getDriveLink(triviaNumber) {
                const link = this.driveLookup.get(triviaNumber) || this.driveLookup.get(String(triviaNumber)) || null;
                console.log(`Drive link for trivia ${triviaNumber}:`, link);
                return link;
            }
        }
        
        // Initialize search engine
        const searchEngine = new FastSearchEngine();
        
        // Current results for sorting
        let currentResults = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const searchScreen = document.getElementById('search-screen');
        const searchQuery = document.getElementById('search-query');
        const searchBtn = document.getElementById('search-btn');
        const searchSpinner = document.getElementById('search-spinner');
        const searchClear = document.getElementById('search-clear');
        const roundTypeFilter = document.getElementById('round-type-filter');
        const formatFilter = document.getElementById('format-filter');
        const searchStats = document.getElementById('search-stats');
        const resultsBody = document.getElementById('results-body');
        const resultsCount = document.getElementById('results-count');
        const searchTime = document.getElementById('search-time');
        const noResults = document.getElementById('no-results');
        const loadMoreSection = document.getElementById('load-more');
        const clearBtn = document.getElementById('clear-btn');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalClose = document.getElementById('modal-close');
        const roundModal = document.getElementById('round-modal');
        const roundModalClose = document.getElementById('round-modal-close');
        const roundModalTitle = document.getElementById('round-modal-title');
        const roundDriveLink = document.getElementById('round-drive-link');
        const roundQuestions = document.getElementById('round-questions');
        
        // Search timeout for debouncing
        let searchTimeout = null;
        
        // Event Listeners
        searchQuery.addEventListener('input', (e) => {
            const value = e.target.value;
            searchClear.classList.toggle('visible', value.length > 0);
            
            // Debounced search
            clearTimeout(searchTimeout);
            if (value.length > 2) {
                searchTimeout = setTimeout(() => {
                    try {
                        performSearch();
                    } catch (error) {
                        console.error('Search input error:', error);
                        setLoadingState(false);
                    }
                }, 300);
            } else if (value.length === 0) {
                clearResults();
            }
        });
        
        searchQuery.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                try {
                    performSearch();
                } catch (error) {
                    console.error('Search keypress error:', error);
                    setLoadingState(false);
                }
            }
        });
        
        searchClear.addEventListener('click', () => {
            searchQuery.value = '';
            searchClear.classList.remove('visible');
            clearResults();
        });
        
        searchBtn.addEventListener('click', () => {
            try {
                performSearch();
            } catch (error) {
                console.error('Search button error:', error);
                setLoadingState(false);
            }
        });
        
        clearBtn.addEventListener('click', clearResults);
        
        // Filter change events
        roundTypeFilter.addEventListener('change', () => {
            try {
                performSearch();
            } catch (error) {
                console.error('Filter change error:', error);
                setLoadingState(false);
            }
        });
        formatFilter.addEventListener('change', () => {
            try {
                performSearch();
            } catch (error) {
                console.error('Filter change error:', error);
                setLoadingState(false);
            }
        });
        
        // Image modal events
        modalClose.addEventListener('click', () => {
            imageModal.classList.remove('show');
        });
        
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                imageModal.classList.remove('show');
            }
        });
        
        // Round modal events
        roundModalClose.addEventListener('click', () => {
            roundModal.classList.remove('show');
        });
        
        roundModal.addEventListener('click', (e) => {
            if (e.target === roundModal) {
                roundModal.classList.remove('show');
            }
        });
        
        // Column sorting
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                try {
                    const sortColumn = header.dataset.sort;
                    
                    if (currentSortColumn === sortColumn) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = sortColumn;
                        currentSortDirection = 'asc';
                    }
                    
                    // Update header indicators
                    document.querySelectorAll('.sortable').forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    header.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    
                    // Sort and redisplay results
                    if (currentResults.length > 0) {
                        sortResults();
                        displayResults({ results: currentResults, searchTime: 0, fromCache: true });
                    }
                } catch (error) {
                    console.error('Sort error:', error);
                }
            });
        });
        
        function performSearch() {
            const query = searchQuery.value.trim();
            
            try {
                if (!searchEngine.isReady) {
                    if (query) {
                        alert('Search index is still building. Please wait a moment.');
                    }
                    return;
                }
                
                setLoadingState(true);
                
                // Get filter values
                const filters = {
                    roundType: roundTypeFilter.value,
                    format: formatFilter.value
                };
                
                const result = searchEngine.search(query, filters);
                currentResults = result.results;
                currentSortColumn = null; // Reset sorting when new search
                
                // Reset sort indicators
                document.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                displayResults(result);
                updateSearchStats(result);
                
            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed. Please try again.');
            } finally {
                // Ensure loading state is always reset
                setLoadingState(false);
            }
        }
        
        function sortResults() {
            if (!currentSortColumn) return;
            
            currentResults.sort((a, b) => {
                let aVal = a[currentSortColumn];
                let bVal = b[currentSortColumn];
                
                // Handle different data types
                if (currentSortColumn === 'triviaNumber') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else if (currentSortColumn === 'triviaDate') {
                    aVal = new Date(aVal) || new Date(0);
                    bVal = new Date(bVal) || new Date(0);
                } else if (currentSortColumn === 'round') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else {
                    // String comparison
                    aVal = String(aVal || '').toLowerCase();
                    bVal = String(bVal || '').toLowerCase();
                }
                
                if (currentSortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
        }
        
        function displayResults(searchResult) {
            try {
                resultsBody.innerHTML = '';
                
                if (searchResult.results.length === 0) {
                    noResults.classList.remove('hidden');
                    searchStats.classList.add('hidden');
                    loadMoreSection.classList.add('hidden');
                    return;
                }
                
                noResults.classList.add('hidden');
                searchStats.classList.remove('hidden');
                
                searchResult.results.forEach((result, index) => {
                    const row = createResultRow(result);
                    resultsBody.appendChild(row);
                });
                
                // Show load more if we hit the limit
                if (searchResult.results.length >= 100) {
                    loadMoreSection.classList.remove('hidden');
                } else {
                    loadMoreSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Display results error:', error);
            }
        }
        
        function createResultRow(result) {
            const row = document.createElement('tr');
            
            try {
                const question = result.question || '';
                const answer = result.answer || '';
                const dateStr = formatDate(result.triviaDate);
                
                // Simple highlighting
                const highlightedQuestion = highlightSearchTerms(question, searchQuery.value);
                const highlightedAnswer = highlightSearchTerms(answer, searchQuery.value);
                const highlightedInstruction = highlightSearchTerms(result.roundInstruction, searchQuery.value);
                
                row.innerHTML = `
                    <td><strong>#${escapeHTML(result.triviaNumber)}</strong></td>
                    <td>${escapeHTML(dateStr)}</td>
                    <td>R${escapeHTML(result.round)}</td>
                    <td>
                        ${escapeHTML(result.roundName)}
                        ${result.roundName !== `Round ${result.round}` ? '<div class="round-name">(' + escapeHTML(`Round ${result.round}`) + ')</div>' : ''}
                    </td>
                    <td>${escapeHTML(result.roundType)}</td>
                    <td>${escapeHTML(result.format)}</td>
                    <td class="instruction-text">${highlightedInstruction}</td>
                    <td class="question-text">${highlightedQuestion}</td>
                    <td class="question-text">${highlightedAnswer}</td>
                    <td class="media-cell">${createMediaPreview(result.data)}</td>
                `;
                
                // Add click handler to show round popup
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => {
                    try {
                        showRoundPopup(result.triviaNumber, result.round, result.roundName, result.roundType);
                    } catch (error) {
                        console.error('Round popup error:', error);
                    }
                });
            } catch (error) {
                console.error('Create result row error:', error);
                row.innerHTML = '<td colspan="10">Error displaying this result</td>';
            }
            
            return row;
        }
        
        function showRoundPopup(triviaNumber, roundKey, roundName, roundType) {
            try {
                const roundData = searchEngine.getRoundQuestions(triviaNumber, roundKey);
                if (!roundData) {
                    alert('Unable to load round data.');
                    return;
                }
                
                // Set title
                const title = `Trivia #${triviaNumber} - Round ${roundKey}${roundName ? `: ${roundName}` : ''}`;
                roundModalTitle.textContent = title;
                
                // Set Google Drive link with debugging
                const driveLink = searchEngine.getDriveLink(triviaNumber);
                console.log(`Setting drive link for trivia ${triviaNumber}:`, driveLink);
                
                if (driveLink && driveLink !== '' && driveLink !== '#') {
                    roundDriveLink.href = driveLink;
                    roundDriveLink.classList.remove('hidden');
                    console.log('Drive link set successfully');
                } else {
                    roundDriveLink.href = '#';
                    roundDriveLink.classList.add('hidden');
                    console.log('No drive link available');
                }
                
                // Populate questions
                roundQuestions.innerHTML = '';
                
                if (roundData.questions.length === 0) {
                    roundQuestions.innerHTML = '<p>No questions found for this round.</p>';
                } else {
                    roundData.questions.forEach((question, index) => {
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'question-item';
                        
                        questionDiv.innerHTML = `
                            <div class="question-number">Question ${question.questionNumber} (${question.format})</div>
                            <div class="question">${escapeHTML(question.question)}</div>
                            <div class="answer"><strong>Answer:</strong> ${escapeHTML(question.answer)}</div>
                            ${createMediaPreview(question.data) ? `<div class="media-preview">${createMediaPreview(question.data)}</div>` : ''}
                        `;
                        
                        roundQuestions.appendChild(questionDiv);
                    });
                }
                
                // Show modal
                roundModal.classList.add('show');
            } catch (error) {
                console.error('Show round popup error:', error);
                alert('Error loading round details.');
            }
        }
        
        function highlightSearchTerms(text, query) {
            if (!text || !query) return escapeHTML(text);
            
            try {
                const escapedText = escapeHTML(text);
                const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 2 && !w.includes('*') && !w.includes('"'));
                
                let highlighted = escapedText;
                for (const word of words) {
                    const regex = new RegExp(`\\b(${escapeRegex(word)})\\b`, 'gi');
                    highlighted = highlighted.replace(regex, '<span class="highlighted">$1</span>');
                }
                
                return highlighted;
            } catch (error) {
                console.error('Highlight search terms error:', error);
                return escapeHTML(text);
            }
        }
        
        function createMediaPreview(data) {
            try {
                const items = [];
                
                const imageLink = data['Image Link'] || data['image_link'];
                const answerImageLink = data['Answer Image Link'] || data['answer_image_link'];
                const musicClipLink = data['Music Clip Link'] || data['music_clip_link'];
                
                if (imageLink) {
                    items.push(createImagePreview(imageLink, 'Question Image'));
                }
                
                if (answerImageLink) {
                    items.push(createImagePreview(answerImageLink, 'Answer Image'));
                }
                
                if (musicClipLink) {
                    items.push(createAudioPreview(musicClipLink));
                }
                
                return items.length > 0 ? `<div class="media-container">${items.join('')}</div>` : '';
            } catch (error) {
                console.error('Create media preview error:', error);
                return '';
            }
        }
        
        function createImagePreview(url, title) {
            if (!url) return '';
            
            try {
                // Extract Google Drive file ID and create proper viewing URL
                let driveImageUrl = url;
                if (url.includes('drive.google.com')) {
                    let fileId = '';
                    
                    // Handle different Google Drive URL formats
                    if (url.includes('/file/d/')) {
                        fileId = url.split('/file/d/')[1].split('/')[0];
                    } else if (url.includes('/d/')) {
                        fileId = url.split('/d/')[1].split('/')[0];
                    } else if (url.includes('id=')) {
                        const urlObj = new URL(url);
                        fileId = urlObj.searchParams.get('id');
                    } else if (url.includes('open?id=')) {
                        fileId = url.split('open?id=')[1].split('&')[0];
                    }
                    
                    if (fileId) {
                        // Use thumbnail for preview and direct link for modal
                        driveImageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
                        console.log(`Created image URL: ${driveImageUrl} from ${url}`);
                    }
                }
                
                return `
                    <div>
                        <img src="${escapeHTML(driveImageUrl)}" 
                             alt="${escapeHTML(title)}" 
                             class="image-preview" 
                             onclick="openImageModal('${escapeHTML(driveImageUrl)}', '${escapeHTML(title)}')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <a href="${escapeHTML(url)}" target="_blank" class="media-link" style="display:none;">üì∑ ${escapeHTML(title)}</a>
                    </div>
                `;
            } catch (error) {
                console.error('Create image preview error:', error);
                return `<a href="${escapeHTML(url)}" target="_blank" class="media-link">üì∑ ${escapeHTML(title)}</a>`;
            }
        }
        
        function createAudioPreview(url) {
            if (!url) return '';
            
            try {
                // Try to create an embedded audio player for Google Drive
                if (url.includes('drive.google.com')) {
                    let fileId = '';
                    
                    // Handle different Google Drive URL formats
                    if (url.includes('/file/d/')) {
                        fileId = url.split('/file/d/')[1].split('/')[0];
                    } else if (url.includes('/d/')) {
                        fileId = url.split('/d/')[1].split('/')[0];
                    } else if (url.includes('id=')) {
                        const urlObj = new URL(url);
                        fileId = urlObj.searchParams.get('id');
                    } else if (url.includes('open?id=')) {
                        fileId = url.split('open?id=')[1].split('&')[0];
                    }
                    
                    if (fileId) {
                        // Use iframe preview for Google Drive audio
                        return `
                            <div>
                                <iframe class="audio-player" 
                                        src="https://drive.google.com/file/d/${fileId}/preview" 
                                        frameborder="0"
                                        allow="autoplay">
                                </iframe>
                                <a href="${escapeHTML(url)}" target="_blank" class="media-link">üéµ Open Audio</a>
                            </div>
                        `;
                    }
                } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    // YouTube audio
                    let videoId = '';
                    if (url.includes('youtube.com/watch?v=')) {
                        const urlObj = new URL(url);
                        videoId = urlObj.searchParams.get('v');
                    } else if (url.includes('youtu.be/')) {
                        videoId = url.split('youtu.be/')[1].split('?')[0];
                    }
                    
                    if (videoId) {
                        return `
                            <div>
                                <iframe class="audio-player" 
                                        src="https://www.youtube.com/embed/${videoId}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                </iframe>
                                <a href="${escapeHTML(url)}" target="_blank" class="media-link">üéµ YouTube</a>
                            </div>
                        `;
                    }
                } else if (url.match(/\.(mp3|wav|ogg|m4a)$/i)) {
                    // Direct audio file
                    return `
                        <div>
                            <audio class="audio-player" controls>
                                <source src="${escapeHTML(url)}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            <a href="${escapeHTML(url)}" target="_blank" class="media-link">üéµ Download</a>
                        </div>
                    `;
                }
                
                // Fallback to link
                return `<a href="${escapeHTML(url)}" target="_blank" class="media-link">üéµ Audio Clip</a>`;
            } catch (error) {
                console.error('Create audio preview error:', error);
                return `<a href="${escapeHTML(url)}" target="_blank" class="media-link">üéµ Audio Clip</a>`;
            }
        }
        
        function openImageModal(url, title) {
            try {
                modalImage.src = url;
                modalImage.alt = title;
                imageModal.classList.add('show');
            } catch (error) {
                console.error('Open image modal error:', error);
            }
        }
        
        function updateSearchStats(result) {
            try {
                resultsCount.textContent = result.results.length.toLocaleString();
                searchTime.textContent = `Search completed in ${Math.round(result.searchTime)}ms`;
            } catch (error) {
                console.error('Update search stats error:', error);
            }
        }
        
        function setLoadingState(loading) {
            try {
                const btnText = document.querySelector('.search-btn-text');
                
                if (loading) {
                    btnText.textContent = 'Searching...';
                    searchSpinner.classList.remove('hidden');
                    searchBtn.disabled = true;
                } else {
                    btnText.textContent = 'Search';
                    searchSpinner.classList.add('hidden');
                    searchBtn.disabled = false;
                }
            } catch (error) {
                console.error('Set loading state error:', error);
            }
        }
        
        function clearResults() {
            try {
                resultsBody.innerHTML = '';
                searchStats.classList.add('hidden');
                noResults.classList.add('hidden');
                loadMoreSection.classList.add('hidden');
                currentResults = [];
                currentSortColumn = null;
                
                // Reset sort indicators
                document.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                // Reset filters
                roundTypeFilter.value = '';
                formatFilter.value = '';
            } catch (error) {
                console.error('Clear results error:', error);
            }
        }
        
        function showError(message) {
            try {
                alert(message);
            } catch (error) {
                console.error('Show error failed:', error);
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            try {
                let date;
                if (/^\d{8}$/.test(dateStr)) {
                    const year = dateStr.substring(0, 4);
                    const month = dateStr.substring(4, 6);
                    const day = dateStr.substring(6, 8);
                    date = new Date(`${year}-${month}-${day}`);
                } else {
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) return dateStr;
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateStr;
            }
        }
        
        function escapeHTML(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Authentication check and initialization
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const snapshot = await db.ref(`users/${user.uid}`).once('value');
                    const userData = snapshot.val() || {};
                    
                    const isAdmin = 
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin')) ||
                        (userData.role === 'admin');
                    
                    const hasToolsAccess =
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('tools')) ||
                        (userData.role === 'tools');
                    
                    if (isAdmin || hasToolsAccess) {
                        authScreen.classList.add('hidden');
                        searchScreen.classList.remove('hidden');
                        
                        try {
                            // Start building the search index
                            await searchEngine.buildIndex();
                            
                            // Check for URL parameters
                            const urlParams = new URLSearchParams(window.location.search);
                            const searchParam = urlParams.get('q');
                            const autoSubmit = urlParams.get('autosubmit') === 'true';
                            
                            if (searchParam) {
                                searchQuery.value = searchParam;
                                searchClear.classList.add('visible');
                                
                                if (autoSubmit && searchEngine.isReady) {
                                    performSearch();
                                }
                            }
                        } catch (error) {
                            console.error('Index building failed:', error);
                            alert('Failed to build search index. Please refresh the page.');
                        }
                        
                    } else {
                        authScreen.classList.remove('hidden');
                        searchScreen.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    authScreen.classList.remove('hidden');
                    searchScreen.classList.add('hidden');
                }
            } else {
                authScreen.classList.remove('hidden');
                searchScreen.classList.add('hidden');
            }
        });
        
        console.log('üöÄ Enhanced Trivia Search Engine loaded!');
        
    </script>
</body>
</html> 