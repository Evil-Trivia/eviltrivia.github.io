<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Trivia - Search Archive</title>
    <script src="/js/components/autoload-banner.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FFCC00;
            --secondary-color: #000;
            --background-white: #fff;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-color);
            margin-top: 60px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .search-container {
            background-color: var(--background-white);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            width: 100%;
            box-sizing: border-box;
        }
        
        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            width: 100%;
            align-items: flex-end;
        }
        
        .search-input-wrapper {
            flex-grow: 1;
            min-width: 250px;
            position: relative;
        }
        
        .search-input-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: var(--transition);
            font-family: inherit;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }
        
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            display: none;
            padding: 4px;
            border-radius: 4px;
        }
        
        .search-clear:hover {
            background-color: #f0f0f0;
        }
        
        .search-clear.visible {
            display: block;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            font-family: inherit;
        }
        
        button:hover:not(:disabled) {
            background-color: #333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-container {
            background-color: var(--background-white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .results-count {
            font-weight: 600;
            color: var(--text-color);
            font-size: 18px;
        }
        
        .search-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 16px;
            font-size: 14px;
            color: #666;
        }
        
        .search-time {
            font-style: italic;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .results-table th, .results-table td {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .results-table th {
            background-color: #f8f9fa;
            color: var(--text-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .results-table tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .question-text {
            max-width: 400px;
            min-height: 40px;
            max-height: 120px;
            white-space: normal;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .highlighted {
            background-color: #fff3cd;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .auth-container {
            background-color: var(--background-white);
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            margin: 40px auto;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .auth-container h2 {
            margin-top: 0;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .auth-container p {
            margin-bottom: 24px;
            color: #666;
            line-height: 1.6;
        }
        
        .auth-btn {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .hidden {
            display: none;
        }

        .search-help {
            margin-top: 12px;
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .search-help code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results, .end-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }
        
        .load-more {
            text-align: center;
            margin-top: 24px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .index-status {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 12px;
            }
            
            .search-container, .results-container {
                padding: 16px;
                border-radius: 8px;
            }
            
            .search-row {
                flex-direction: column;
                gap: 12px;
            }
            
            .results-table {
                font-size: 13px;
            }
            
            .results-table th, .results-table td {
                padding: 12px 8px;
            }
            
            .question-text {
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Enhanced Trivia Archive Search</h1>
        
        <!-- Authentication Required Screen -->
        <div id="auth-screen" class="auth-container hidden">
            <h2>üîê Access Required</h2>
            <p>You need admin or tools privileges to access this search interface.</p>
            <a href="/account" class="auth-btn">Go to Account Page</a>
        </div>
        
        <!-- Search Interface -->
        <div id="search-screen" class="hidden">
            <div class="search-container">
                <div class="search-row">
                    <div class="search-input-wrapper">
                        <label class="search-input-label">Search questions, answers, and more...</label>
                        <input type="text" id="search-query" placeholder="Try: 'music', 'visual round', 'washington', etc.">
                        <button class="search-clear" id="search-clear" title="Clear search">√ó</button>
                    </div>
                    <button id="search-btn">
                        <span class="search-btn-text">Search</span>
                        <span class="loading-spinner hidden" id="search-spinner"></span>
                    </button>
                </div>
                
                <div class="search-help">
                    <strong>Pro tips:</strong> Use <code>*</code> for wildcards, <code>"exact phrase"</code> for exact matches
                </div>
            </div>
            
            <!-- Index Building Status -->
            <div id="index-status" class="index-status">
                <div>Building search index...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div id="progress-text">Preparing search engine...</div>
            </div>
            
            <div class="results-container">
                <div class="results-header">
                    <div class="results-count">Ready to search <span id="total-questions">0</span> questions</div>
                    <button id="clear-btn">Clear Results</button>
                </div>
                
                <div class="search-stats hidden" id="search-stats">
                    <div>
                        <span id="results-count">0</span> results found
                    </div>
                    <div class="search-time" id="search-time"></div>
                </div>
                
                <div class="table-responsive">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Trivia #</th>
                                <th>Date</th>
                                <th>Round</th>
                                <th>Format</th>
                                <th>Question</th>
                                <th>Answer</th>
                                <th>Media</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="no-results" class="no-results hidden">
                    <p>üîç No matching questions found.</p>
                    <p>Try adjusting your search terms.</p>
                </div>
                
                <div class="load-more hidden" id="load-more">
                    <button id="load-more-btn">Load More Results (showing first 100)</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
        // Fast and Robust Search Engine
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebasestorage.app",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // Fast Search Engine - Optimized for Speed
        class FastSearchEngine {
            constructor() {
                this.questions = []; // Simple array for fast searching
                this.isReady = false;
                this.cache = new Map(); // Simple in-memory cache
            }
            
            // Safe string extraction with error handling
            safeString(value) {
                if (value === null || value === undefined) return '';
                if (typeof value === 'string') return value;
                if (typeof value === 'number') return String(value);
                if (typeof value === 'object') return JSON.stringify(value);
                return String(value);
            }
            
            // Build search index asynchronously with progress updates
            async buildIndex() {
                const startTime = performance.now();
                console.log('Building search index...');
                
                try {
                    // Get data from Firebase
                    const archiveRef = db.ref('trivia-archive/archive');
                    const snapshot = await archiveRef.once('value');
                    const data = snapshot.val();
                    
                    if (!data) {
                        console.warn('No trivia data found');
                        this.updateProgress(100, 'No data found');
                        return;
                    }
                    
                    const triviaEntries = Object.entries(data);
                    const totalItems = triviaEntries.length;
                    let processedItems = 0;
                    
                    // Process data in chunks to avoid blocking
                    for (const [triviaNumber, triviaSet] of triviaEntries) {
                        await this.processTriviaSetAsync(triviaNumber, triviaSet);
                        
                        processedItems++;
                        const progress = Math.round((processedItems / totalItems) * 100);
                        this.updateProgress(progress, `Processed ${processedItems}/${totalItems} trivia sets`);
                        
                        // Yield control to prevent blocking
                        if (processedItems % 10 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 1));
                        }
                    }
                    
                    this.isReady = true;
                    const endTime = performance.now();
                    const buildTime = Math.round(endTime - startTime);
                    
                    console.log(`Search index built in ${buildTime}ms with ${this.questions.length} questions`);
                    this.updateProgress(100, `Ready! ${this.questions.length} questions indexed in ${buildTime}ms`);
                    
                    // Update UI
                    document.getElementById('total-questions').textContent = this.questions.length.toLocaleString();
                    document.getElementById('index-status').classList.add('hidden');
                    
                } catch (error) {
                    console.error('Error building search index:', error);
                    this.updateProgress(100, 'Error building index. Please refresh.');
                }
            }
            
            updateProgress(percent, text) {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                
                if (progressFill) progressFill.style.width = `${percent}%`;
                if (progressText) progressText.textContent = text;
            }
            
            async processTriviaSetAsync(triviaNumber, triviaSet) {
                if (!triviaSet || !triviaSet.trivia) return;
                
                const triviaDate = this.safeString(triviaSet.date);
                
                for (const [roundKey, roundData] of Object.entries(triviaSet.trivia)) {
                    if (!roundData || typeof roundData !== 'object') continue;
                    
                    for (const [formatKey, formatData] of Object.entries(roundData)) {
                        if (!formatData || typeof formatData !== 'object') continue;
                        
                        for (const [questionKey, questionData] of Object.entries(formatData)) {
                            // Skip metadata fields
                            if (this.isMetadataField(questionKey) || !questionData || typeof questionData !== 'object') {
                                continue;
                            }
                            
                            try {
                                const question = this.safeString(questionData.Question || questionData.question || '');
                                const answer = this.safeString(questionData.Answer || questionData.answer || '');
                                
                                // Only add if we have meaningful content
                                if (question.length > 0 || answer.length > 0) {
                                    const searchableText = `${question} ${answer}`.toLowerCase();
                                    
                                    this.questions.push({
                                        id: `${triviaNumber}-${roundKey}-${formatKey}-${questionKey}`,
                                        triviaNumber,
                                        triviaDate,
                                        round: roundKey,
                                        format: formatKey,
                                        questionNumber: questionKey,
                                        question,
                                        answer,
                                        searchableText,
                                        data: questionData
                                    });
                                }
                            } catch (error) {
                                console.warn(`Error processing question ${triviaNumber}-${roundKey}-${formatKey}-${questionKey}:`, error);
                            }
                        }
                    }
                }
            }
            
            isMetadataField(key) {
                return ['Round Name', 'Round Type', 'Round Format', 'Round Instruction'].includes(key);
            }
            
            // Fast search function
            search(query) {
                if (!this.isReady || !query.trim()) return [];
                
                const startTime = performance.now();
                const queryKey = query.toLowerCase();
                
                // Check cache first
                if (this.cache.has(queryKey)) {
                    const cached = this.cache.get(queryKey);
                    return {
                        results: cached,
                        searchTime: performance.now() - startTime,
                        fromCache: true
                    };
                }
                
                const results = [];
                const queryLower = queryKey;
                
                // Fast linear search - optimized for speed
                for (const question of this.questions) {
                    try {
                        if (this.matchesQuery(question, queryLower)) {
                            results.push(question);
                            
                            // Limit results for performance
                            if (results.length >= 100) break;
                        }
                    } catch (error) {
                        console.warn('Search error for question:', question.id, error);
                    }
                }
                
                // Cache results
                this.cache.set(queryKey, results);
                
                // Clean cache if it gets too large
                if (this.cache.size > 100) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                return {
                    results,
                    searchTime: performance.now() - startTime,
                    fromCache: false
                };
            }
            
            matchesQuery(question, queryLower) {
                // Handle wildcards
                if (queryLower.includes('*')) {
                    const pattern = this.wildcardToRegex(queryLower);
                    return pattern.test(question.searchableText);
                }
                
                // Handle exact phrases
                if (queryLower.includes('"')) {
                    const phrases = queryLower.match(/"([^"]+)"/g) || [];
                    for (const phrase of phrases) {
                        const cleanPhrase = phrase.replace(/"/g, '');
                        if (question.searchableText.includes(cleanPhrase)) {
                            return true;
                        }
                    }
                }
                
                // Simple substring search - fastest option
                return question.searchableText.includes(queryLower);
            }
            
            wildcardToRegex(pattern) {
                const escaped = pattern.replace(/[.+^${}()|[\]\\]/g, '\\$&');
                const regex = escaped.replace(/\*/g, '.*');
                return new RegExp(regex, 'i');
            }
        }
        
        // Initialize search engine
        const searchEngine = new FastSearchEngine();
        
        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const searchScreen = document.getElementById('search-screen');
        const searchQuery = document.getElementById('search-query');
        const searchBtn = document.getElementById('search-btn');
        const searchSpinner = document.getElementById('search-spinner');
        const searchClear = document.getElementById('search-clear');
        const searchStats = document.getElementById('search-stats');
        const resultsBody = document.getElementById('results-body');
        const resultsCount = document.getElementById('results-count');
        const searchTime = document.getElementById('search-time');
        const noResults = document.getElementById('no-results');
        const loadMoreSection = document.getElementById('load-more');
        const clearBtn = document.getElementById('clear-btn');
        
        // Search timeout for debouncing
        let searchTimeout = null;
        
        // Event Listeners
        searchQuery.addEventListener('input', (e) => {
            const value = e.target.value;
            searchClear.classList.toggle('visible', value.length > 0);
            
            // Debounced search
            clearTimeout(searchTimeout);
            if (value.length > 2) {
                searchTimeout = setTimeout(performSearch, 300);
            } else if (value.length === 0) {
                clearResults();
            }
        });
        
        searchQuery.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        searchClear.addEventListener('click', () => {
            searchQuery.value = '';
            searchClear.classList.remove('visible');
            clearResults();
        });
        
        searchBtn.addEventListener('click', performSearch);
        clearBtn.addEventListener('click', clearResults);
        
        function performSearch() {
            const query = searchQuery.value.trim();
            if (!query || !searchEngine.isReady) {
                if (!searchEngine.isReady) {
                    alert('Search index is still building. Please wait a moment.');
                }
                return;
            }
            
            setLoadingState(true);
            
            try {
                const result = searchEngine.search(query);
                displayResults(result);
                updateSearchStats(result);
            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed. Please try again.');
            } finally {
                setLoadingState(false);
            }
        }
        
        function displayResults(searchResult) {
            resultsBody.innerHTML = '';
            
            if (searchResult.results.length === 0) {
                noResults.classList.remove('hidden');
                searchStats.classList.add('hidden');
                loadMoreSection.classList.add('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            searchStats.classList.remove('hidden');
            
            searchResult.results.forEach((result, index) => {
                const row = createResultRow(result);
                resultsBody.appendChild(row);
            });
            
            // Show load more if we hit the limit
            if (searchResult.results.length >= 100) {
                loadMoreSection.classList.remove('hidden');
            } else {
                loadMoreSection.classList.add('hidden');
            }
        }
        
        function createResultRow(result) {
            const row = document.createElement('tr');
            
            const question = result.question || '';
            const answer = result.answer || '';
            const dateStr = formatDate(result.triviaDate);
            
            // Simple highlighting
            const highlightedQuestion = highlightSearchTerms(question, searchQuery.value);
            const highlightedAnswer = highlightSearchTerms(answer, searchQuery.value);
            
            row.innerHTML = `
                <td><strong>#${escapeHTML(result.triviaNumber)}</strong></td>
                <td>${escapeHTML(dateStr)}</td>
                <td>R${escapeHTML(result.round)}</td>
                <td>${escapeHTML(result.format)}</td>
                <td class="question-text">${highlightedQuestion}</td>
                <td class="question-text">${highlightedAnswer}</td>
                <td>${createMediaPreview(result.data)}</td>
            `;
            
            return row;
        }
        
        function highlightSearchTerms(text, query) {
            if (!text || !query) return escapeHTML(text);
            
            const escapedText = escapeHTML(text);
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 2 && !w.includes('*') && !w.includes('"'));
            
            let highlighted = escapedText;
            for (const word of words) {
                const regex = new RegExp(`\\b(${escapeRegex(word)})\\b`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="highlighted">$1</span>');
            }
            
            return highlighted;
        }
        
        function createMediaPreview(data) {
            const items = [];
            
            const imageLink = data['Image Link'] || data['image_link'];
            const answerImageLink = data['Answer Image Link'] || data['answer_image_link'];
            const musicClipLink = data['Music Clip Link'] || data['music_clip_link'];
            
            if (imageLink) {
                items.push(`<a href="${escapeHTML(imageLink)}" target="_blank">üñºÔ∏è Image</a>`);
            }
            
            if (answerImageLink) {
                items.push(`<a href="${escapeHTML(answerImageLink)}" target="_blank">üñºÔ∏è Answer</a>`);
            }
            
            if (musicClipLink) {
                items.push(`<a href="${escapeHTML(musicClipLink)}" target="_blank">üéµ Audio</a>`);
            }
            
            return items.join('<br>');
        }
        
        function updateSearchStats(result) {
            resultsCount.textContent = result.results.length.toLocaleString();
            searchTime.textContent = `Search completed in ${Math.round(result.searchTime)}ms`;
        }
        
        function setLoadingState(loading) {
            const btnText = document.querySelector('.search-btn-text');
            
            if (loading) {
                btnText.textContent = 'Searching...';
                searchSpinner.classList.remove('hidden');
                searchBtn.disabled = true;
            } else {
                btnText.textContent = 'Search';
                searchSpinner.classList.add('hidden');
                searchBtn.disabled = false;
            }
        }
        
        function clearResults() {
            resultsBody.innerHTML = '';
            searchStats.classList.add('hidden');
            noResults.classList.add('hidden');
            loadMoreSection.classList.add('hidden');
        }
        
        function showError(message) {
            alert(message);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            try {
                let date;
                if (/^\d{8}$/.test(dateStr)) {
                    const year = dateStr.substring(0, 4);
                    const month = dateStr.substring(4, 6);
                    const day = dateStr.substring(6, 8);
                    date = new Date(`${year}-${month}-${day}`);
                } else {
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) return dateStr;
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateStr;
            }
        }
        
        function escapeHTML(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Authentication check and initialization
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const snapshot = await db.ref(`users/${user.uid}`).once('value');
                    const userData = snapshot.val() || {};
                    
                    const isAdmin = 
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin')) ||
                        (userData.role === 'admin');
                    
                    const hasToolsAccess =
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('tools')) ||
                        (userData.role === 'tools');
                    
                    if (isAdmin || hasToolsAccess) {
                        authScreen.classList.add('hidden');
                        searchScreen.classList.remove('hidden');
                        
                        // Start building the search index
                        await searchEngine.buildIndex();
                        
                        // Check for URL parameters
                        const urlParams = new URLSearchParams(window.location.search);
                        const searchParam = urlParams.get('q');
                        const autoSubmit = urlParams.get('autosubmit') === 'true';
                        
                        if (searchParam) {
                            searchQuery.value = searchParam;
                            searchClear.classList.add('visible');
                            
                            if (autoSubmit && searchEngine.isReady) {
                                performSearch();
                            }
                        }
                        
                    } else {
                        authScreen.classList.remove('hidden');
                        searchScreen.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    authScreen.classList.remove('hidden');
                    searchScreen.classList.add('hidden');
                }
            } else {
                authScreen.classList.remove('hidden');
                searchScreen.classList.add('hidden');
            }
        });
        
        console.log('üöÄ Fast Trivia Search Engine loaded!');
        
    </script>
</body>
</html> 