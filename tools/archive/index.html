<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Trivia - Archive Viewer</title>
    <script src="/js/components/autoload-banner.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #FFCC00;
            margin-top: 60px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 90%;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .subtitle {
            text-align: center;
            color: #555;
            margin-top: -20px;
            margin-bottom: 40px;
        }
        
        .auth-container {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            margin: 40px auto;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .auth-container h2 {
            margin-top: 0;
            color: #333;
        }
        
        .auth-container p {
            margin-bottom: 20px;
            color: #666;
        }
        
        .auth-btn {
            display: inline-block;
            background-color: #000;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .archive-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .load-more {
            text-align: center;
            margin-top: 20px;
        }
        
        .expandable {
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .expandable-header {
            background-color: #f5f5f5;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .expandable-header:hover {
            background-color: #eaeaea;
        }
        
        .expandable-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.3s;
        }
        
        .expandable.expanded .expandable-content {
            padding: 15px;
            max-height: 5000px;
        }
        
        .caret {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 8px solid #000;
            transition: transform 0.3s;
        }
        
        .expandable.expanded .caret {
            transform: rotate(180deg);
        }
        
        .trivia-card {
            background-color: white;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .trivia-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #000;
            color: white;
        }
        
        .trivia-number {
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .trivia-date {
            color: #ccc;
        }
        
        .rounds-container {
            padding: 0 15px 15px;
        }
        
        /* Trivia Information Section */
        .trivia-info {
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .trivia-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: #e8f4f8;
            cursor: pointer;
            font-weight: bold;
            color: #0066cc;
        }
        
        .trivia-info-header:hover {
            background-color: #d0e8f0;
        }
        
        .trivia-info-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.3s;
        }
        
        .trivia-info.expanded .trivia-info-content {
            padding: 15px;
            max-height: 3000px;
        }
        
        .team-name-prompt {
            font-size: 1.1em;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff;
            border-left: 4px solid #0066cc;
            border-radius: 4px;
        }
        
        .poster-section {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .poster-image {
            max-width: 300px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .poster-ref {
            font-style: italic;
            color: #666;
            margin-top: 5px;
        }
        
        .teams-section {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }
        
        .teams-section-header {
            padding: 10px;
            background-color: #f5f5f5;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .teams-section-header:hover {
            background-color: #eaeaea;
        }
        
        .teams-section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.3s;
        }
        
        .teams-section.expanded .teams-section-content {
            padding: 10px;
            max-height: 2000px;
        }
        
        .team-entry {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .team-entry:last-child {
            border-bottom: none;
        }
        
        .team-name-bonus {
            font-weight: bold;
            color: #0066cc;
        }
        
        .team-score {
            font-weight: 600;
            color: #333;
        }

        /* Round styling */
        .round {
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        .round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: #f5f5f5;
            cursor: pointer;
        }
        
        .round-name {
            font-weight: bold;
        }
        
        .round-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.3s;
        }
        
        .round.expanded .round-content {
            padding: 15px;
            max-height: 2000px;
        }
        
        /* Format styling */
        .format {
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        .format-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #f9f9f9;
            cursor: pointer;
        }
        
        .format-name {
            font-weight: bold;
        }
        
        .format-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s, padding 0.3s;
        }
        
        .format.expanded .format-content {
            padding: 15px;
            max-height: 2000px;
        }
        
        /* Question styling */
        .question {
            margin-bottom: 15px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }
        
        .question:last-child {
            margin-bottom: 0;
        }
        
        .question-header {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .question-content {
            margin-bottom: 8px;
        }
        
        .answer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        .question-meta {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }
        
        /* Metadata styling */
        .metadata {
            margin-bottom: 15px;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .metadata-item {
            margin-bottom: 5px;
        }
        
        .metadata-label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        /* Image and media styling */
        .media-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-container {
            max-width: 250px;
            margin-bottom: 10px;
        }
        
        .preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        
        .music-player {
            width: 100%;
            max-width: 450px;
            margin-top: 10px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
            font-size: 16px;
            color: #666;
        }
        
        .loading::after {
            content: "";
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border-radius: 50%;
            border: 3px solid #ddd;
            border-top-color: #000;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Page loading overlay */
        .page-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 204, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }
        
        .page-loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 6px solid #fff;
            border-top-color: #000;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 20px;
            font-weight: bold;
            color: #000;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            font-size: 14px;
            color: #333;
        }
        
        /* Search results info */
        .search-results-info {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 4px;
            font-size: 14px;
            color: #2e7d32;
            display: none;
        }
        
        .search-results-info.visible {
            display: block;
        }
        
        .round-instruction {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-style: italic;
        }
        
        .tag {
            display: inline-block;
            padding: 3px 8px;
            margin-right: 5px;
            background-color: #eee;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #555;
        }
        
        .expand-all-btn {
            background-color: #000;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .expand-all-btn:hover {
            background-color: #333;
        }

        /* Toolbar styles */
        .toolbar-btn {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 90px;
        }
        
        .toolbar-btn:hover:not(:disabled) {
            background-color: #e0e0e0;
            border-color: #bbb;
        }
        
        .toolbar-btn.active {
            background-color: #000;
            color: white;
            border-color: #000;
        }
        
        .toolbar-btn:disabled {
            background-color: #f9f9f9;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Full Archive specific styles */
        .full-archive-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .trivia-item {
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .trivia-summary {
            background-color: #f8f8f8;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .trivia-summary:hover {
            background-color: #f0f0f0;
        }
        
        .trivia-summary .expand-indicator {
            font-size: 18px;
            transition: transform 0.2s;
        }
        
        .trivia-item[open] .expand-indicator {
            transform: rotate(180deg);
        }
        
        .trivia-content {
            display: none;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .trivia-item[open] .trivia-content {
            display: block;
        }
        
        .trivia-columns {
            display: grid;
            grid-template-columns: 1fr 750px;
            gap: 20px;
            min-height: 700px;
            transition: grid-template-columns 0.3s ease;
        }
        
        .trivia-columns.preview-collapsed {
            grid-template-columns: 1fr auto;
        }
        
        .rounds-panel {
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
        }
        
        .pdf-panel {
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .pdf-panel.collapsed {
            width: auto;
            min-width: 0;
            padding: 15px 10px;
        }
        
        .pdf-panel h4 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            white-space: nowrap;
        }
        
        .pdf-panel.collapsed h4 {
            flex-direction: column;
            gap: 10px;
            margin-bottom: 0;
        }
        
        .pdf-panel.collapsed h4 span {
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        .toggle-preview-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
            white-space: nowrap;
            display: none; /* Hidden by default on desktop */
        }
        
        .toggle-preview-btn:hover {
            background: #3367d6;
        }
        
        .pdf-panel-content {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .pdf-panel-content.hidden {
            display: none;
        }
        
        .round-item {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .round-header {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f5f5f5;
        }
        
        .round-header:hover {
            background-color: #eee;
        }
        
        .round-content {
            display: none;
            padding: 15px;
            border-top: 1px solid #ddd;
            max-height: none;
            overflow: visible;
        }
        
        .round-item[open] .round-content {
            display: block;
        }
        
        .question-item {
            background-color: #f8f8f8;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .question-header {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        
        .question-text {
            margin-bottom: 5px;
        }
        
        .answer-text {
            color: #666;
            font-style: italic;
            border-top: 1px dashed #ddd;
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .pdf-viewer {
            flex: 1;
            min-height: 650px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .pdf-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .pdf-selector {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .drive-link {
            background-color: #4285f4;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
        }
        
        .drive-link:hover {
            background-color: #3367d6;
        }
        
        .missing-data {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }
        
        /* Search highlighting */
        .search-highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        .trivia-item.has-matches {
            border: 2px solid #4caf50;
            background-color: #f1f8e9;
        }
        
        .round-item.has-matches {
            background-color: #e8f5e8;
            border-color: #4caf50;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                margin-top: 50px; /* Reduced for mobile */
            }
            
            .container {
                max-width: 100%;
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            
            /* Toolbar buttons */
            .toolbar {
                flex-direction: column;
                gap: 8px;
            }
            
            .toolbar-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .toolbar-btn {
                font-size: 0.85rem;
                padding: 6px 10px;
                margin: 2px;
            }
            
            /* Search bar */
            #archive-search {
                width: 100% !important;
                max-width: 100%;
                font-size: 16px !important; /* Prevents iOS zoom */
            }
            
            .controls > div {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .controls button {
                width: 100%;
            }
            
            .controls label {
                font-size: 0.85rem !important;
            }
            
            /* Trivia cards */
            .trivia-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                padding: 10px;
            }
            
            .trivia-number {
                font-size: 1.1rem;
            }
            
            .image-container {
                max-width: 100%;
            }
            
            /* Trivia columns layout */
            .trivia-columns {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            .rounds-panel,
            .pdf-panel {
                width: 100%;
            }
            
            .pdf-panel {
                order: -1; /* PDF at top on mobile */
            }
            
            /* Show toggle button on mobile */
            .toggle-preview-btn {
                display: inline-block !important;
            }
            
            /* Default to collapsed on mobile */
            .pdf-panel-content {
                display: none !important;
            }
            
            /* When expanded on mobile, show as flex */
            .pdf-panel-content:not(.hidden) {
                display: flex !important;
            }
            
            .pdf-panel.collapsed {
                padding: 10px;
                min-height: auto;
            }
            
            .pdf-panel.collapsed h4 {
                flex-direction: row;
                margin-bottom: 0;
            }
            
            .pdf-panel.collapsed h4 span {
                writing-mode: horizontal-tb;
            }
            
            .pdf-viewer {
                min-height: 400px;
            }
            
            /* Trivia Information section */
            .trivia-info-content {
                padding: 10px !important;
            }
            
            .team-name-prompt {
                font-size: 0.95em;
                padding: 8px;
            }
            
            /* Poster section */
            .poster-section {
                flex-direction: column;
            }
            
            .poster-image {
                max-width: 100% !important;
            }
            
            .poster-section > div > div {
                width: 100% !important;
            }
            
            .poster-section iframe {
                width: 100% !important;
                height: auto !important;
                min-height: 300px;
            }
            
            /* Teams section */
            .teams-section-content {
                padding: 5px !important;
            }
            
            /* Teams header with tooltip and total */
            [id^="teams-header-"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px;
            }
            
            [id^="teams-header-"] > div {
                margin-left: 0 !important;
            }
            
            .team-entry {
                flex-direction: column;
                align-items: flex-start !important;
                padding: 10px 8px;
                gap: 8px;
            }
            
            .team-entry > div:first-child {
                width: 100%;
            }
            
            .team-score {
                width: 100%;
                text-align: left !important;
                font-size: 1.1em;
            }
            
            /* Location filter */
            select {
                max-width: 100%;
                font-size: 16px !important; /* Prevents iOS zoom */
            }
            
            /* Question content */
            .question {
                padding: 10px;
            }
            
            .question-header {
                font-size: 0.9rem;
            }
            
            .question-content {
                font-size: 0.9rem;
            }
            
            /* Format sections */
            .format-header,
            .round-header {
                padding: 10px;
                font-size: 0.95rem;
            }
            
            /* Metadata */
            .metadata-item {
                font-size: 0.85rem;
            }
            
            /* Search results */
            .search-results-info {
                font-size: 0.85rem;
                padding: 8px;
            }
            
            /* Tags */
            .tag {
                font-size: 0.75rem;
                padding: 3px 6px;
            }
            
            /* Ensure proper text wrapping */
            .trivia-summary,
            .round-name,
            .format-name {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.3rem;
            }
            
            .toolbar-btn {
                font-size: 0.8rem;
                padding: 5px 8px;
            }
            
            .trivia-number {
                font-size: 1rem;
            }
            
            .trivia-date {
                font-size: 0.85rem;
            }
            
            .round-header,
            .format-header {
                font-size: 0.9rem;
            }
            
            .team-entry {
                padding: 8px 6px;
            }
            
            .poster-section > div > div {
                max-width: 100%;
            }
            
            /* Make tables scrollable on very small screens */
            .question-content table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <!-- Page Loading Overlay -->
    <div id="page-loading-overlay" class="page-loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Archive...</div>
        <div class="loading-subtext">Please wait while we fetch all trivia data</div>
    </div>

    <div class="container">
        <h1>Trivia Archive</h1>
        <p class="subtitle">Browse all trivia rounds and questions</p>
        
        <!-- View Mode Toolbar -->
        <div id="view-toolbar" class="hidden" style="background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px;">
                <button id="btn-full-archive" class="toolbar-btn active">Full Archive</button>
                <button id="btn-puzzles" class="toolbar-btn" disabled>Puzzles</button>
                <button id="btn-visuals" class="toolbar-btn" disabled>Visuals</button>
                <button id="btn-fill-ins" class="toolbar-btn" disabled>Fill-Ins</button>
                <button id="btn-music" class="toolbar-btn" disabled>Music</button>
                <button id="btn-challenges" class="toolbar-btn" disabled>Challenges</button>
                <button id="btn-written-only" class="toolbar-btn" disabled>Written Only</button>
            </div>
            <!-- Search Bar -->
            <div style="display: flex; gap: 10px; align-items: center; justify-content: center; flex-direction: column;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="archive-search" placeholder="Search all trivia content..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 300px; font-size: 14px;">
                    <button id="search-btn" onclick="performArchiveSearch()" style="padding: 8px 16px; background-color: #000; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
                    <button id="clear-search-btn" onclick="clearArchiveSearch()" style="padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 14px; user-select: none;">
                        <input type="checkbox" id="simple-search-toggle" checked style="cursor: pointer;">
                        <span>Simple Mode</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 14px; user-select: none;">
                        <input type="checkbox" id="search-rounds-only" checked style="cursor: pointer;">
                        <span>Search trivia rounds only</span>
                    </label>
                </div>
                <div id="search-results-info" class="search-results-info"></div>
            </div>
        </div>
        
        <!-- Authentication Required Screen -->
        <div id="auth-screen" class="auth-container hidden">
            <h2>Access Required</h2>
            <p>You need admin or tools privileges to access this page.</p>
            <a href="/account" class="auth-btn">Go to Account Page</a>
        </div>
        
        <!-- Archive Container -->
        <div id="archive-screen" class="hidden">
            <!-- Legacy Archive View (hidden when Full Archive is active) -->
            <div id="legacy-archive" class="archive-container">
                <div class="controls">
                    <div>
                        <label for="items-per-page">Trivia Sets per Page:</label>
                        <select id="items-per-page">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div>
                        <button id="expand-all" class="expand-all-btn">Expand All Trivia Sets</button>
                        <button id="collapse-all" class="expand-all-btn">Collapse All</button>
                    </div>
                </div>
                
                <div id="archive-loading" class="loading">Loading archive data...</div>
                
                <div id="archive-list">
                    <!-- Trivia sets will be loaded here -->
                </div>
                
                <div class="load-more">
                    <button id="load-more-btn" class="expand-all-btn">Load More</button>
                </div>
            </div>
            
            <!-- Full Archive View -->
            <div id="full-archive" class="full-archive-container">
                <div id="full-archive-loading" class="loading">Loading full archive data...</div>
                <div id="full-archive-list">
                    <!-- Full archive items will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebasestorage.app",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // Global state
        let allTriviaData = new Map();
        let currentViewMode = 'full-archive';
        
        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const archiveScreen = document.getElementById('archive-screen');
        const viewToolbar = document.getElementById('view-toolbar');
        const legacyArchive = document.getElementById('legacy-archive');
        const fullArchive = document.getElementById('full-archive');
        const fullArchiveLoading = document.getElementById('full-archive-loading');
        const fullArchiveList = document.getElementById('full-archive-list');
        
        // Legacy elements
        const archiveList = document.getElementById('archive-list');
        const archiveLoading = document.getElementById('archive-loading');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const itemsPerPageSelect = document.getElementById('items-per-page');
        const expandAllBtn = document.getElementById('expand-all');
        const collapseAllBtn = document.getElementById('collapse-all');
        
        // Archive state
        let lastTrivia = null;
        let isLoading = false;
        let hasMoreData = true;
        let itemsPerPage = 10;
        
        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'Unknown Date';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Global cache for question correctness
        const correctnessCache = new Map();
        
        // Fetch all trivia data for Full Archive mode
        async function fetchAllTriviaData() {
            try {
                fullArchiveLoading.style.display = 'flex';
                
                // Update loading text
                const loadingText = document.querySelector('.loading-text');
                const loadingSubtext = document.querySelector('.loading-subtext');
                
                if (loadingText) loadingText.textContent = 'Loading Archive Data...';
                if (loadingSubtext) loadingSubtext.textContent = 'Fetching trivia questions and answers';
                
                // Fetch all three data sources in parallel
                const [overviewSnap, archiveSnap, driveLookupSnap] = await Promise.all([
                    db.ref('trivia-archive/overview').once('value'),
                    db.ref('trivia-archive/archive').once('value'), 
                    db.ref('trivia-archive/driveLookup').once('value')
                ]);
                
                const overview = overviewSnap.val() || [];
                const archive = archiveSnap.val() || {};
                const driveLookup = driveLookupSnap.val() || {};
                
                // Merge data by triviaNumber
                allTriviaData.clear();
                
                // Get all unique trivia numbers, primarily from archive
                const allTriviaNumbers = new Set([
                    ...Object.keys(archive),
                    ...Object.keys(driveLookup)
                ]);
                
                for (const triviaNumber of allTriviaNumbers) {
                    const numericTriviaNumber = parseInt(triviaNumber);
                    if (isNaN(numericTriviaNumber)) continue;
                    
                    // Get overview data by matching trivia number
                    const overviewData = Array.isArray(overview) ? 
                        overview.find(item => item && item['Trivia number'] === numericTriviaNumber) || 
                        overview.find(item => item && item.Number === numericTriviaNumber) :
                        null;
                    
                    allTriviaData.set(numericTriviaNumber, {
                        triviaNumber: numericTriviaNumber,
                        overview: overviewData,
                        archive: archive[triviaNumber] || null,
                        drive: driveLookup[triviaNumber] || null
                    });
                }
                
                console.log(`Loaded ${allTriviaData.size} trivia entries`);
                
                // Now load all grading data for correctness calculations
                if (loadingText) loadingText.textContent = 'Loading Correctness Data...';
                if (loadingSubtext) loadingSubtext.textContent = 'Calculating question statistics from all sessions';
                
                await preloadAllCorrectness();
                
                console.log('Correctness data preloaded');
                
            } catch (error) {
                console.error('Error fetching trivia data:', error);
                throw error;
            } finally {
                fullArchiveLoading.style.display = 'none';
                
                // Hide page loading overlay with fade effect
                const overlay = document.getElementById('page-loading-overlay');
                if (overlay) {
                    overlay.classList.add('fade-out');
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 300);
                }
            }
        }
        
        // Preload all correctness data at startup
        async function preloadAllCorrectness() {
            try {
                // Fetch all grading sessions once
                const allSessionsSnap = await db.ref('grading').once('value');
                if (!allSessionsSnap.exists()) return;
                
                const allSessions = allSessionsSnap.val();
                
                // Process each trivia in allTriviaData
                for (const [triviaNumber, trivia] of allTriviaData.entries()) {
                    if (!trivia.archive?.trivia) continue;
                    
                    // Get all sessions for this trivia number
                    const relevantSessions = Object.keys(allSessions).filter(sessionId => 
                        allSessions[sessionId].triviaNumber === triviaNumber
                    );
                    
                    if (relevantSessions.length === 0) continue;
                    
                    // Process each round
                    for (const [roundNumber, roundData] of Object.entries(trivia.archive.trivia)) {
                        if (isNaN(parseInt(roundNumber)) || typeof roundData !== 'object') continue;
                        
                        const allFormats = ['Written', 'Visual', 'Music', 'Fill-In', 'FDQ', 'Puzzle', 'Challenge'];
                        
                        // Process each format
                        for (const format of allFormats) {
                            if (!roundData[format]) continue;
                            
                            let questions = [];
                            
                            if (Array.isArray(roundData[format])) {
                                roundData[format].forEach((qData, index) => {
                                    if (qData && typeof qData === 'object') {
                                        questions.push({
                                            questionNumber: qData['Question Number'] || index
                                        });
                                    }
                                });
                            } else {
                                Object.entries(roundData[format]).forEach(([key, qData]) => {
                                    if (!isNaN(parseInt(key)) && qData && typeof qData === 'object') {
                                        questions.push({
                                            questionNumber: qData['Question Number'] || parseInt(key)
                                        });
                                    }
                                });
                            }
                            
                            // Calculate correctness for each question
                            for (const question of questions) {
                                const cacheKey = `${triviaNumber}-${roundNumber}-${format}-${question.questionNumber}`;
                                
                                let totalResponses = 0;
                                let correctResponses = 0;
                                
                                // Check each session for this question
                                for (const sessionId of relevantSessions) {
                                    const session = allSessions[sessionId];
                                    if (!session.teams) continue;
                                    
                                    // Check each team's response to this question
                                    for (const [teamId, team] of Object.entries(session.teams)) {
                                        const roundKey = `round${roundNumber}`;
                                        if (!team[roundKey] || !team[roundKey][format]) continue;
                                        
                                        const questionData = team[roundKey][format][question.questionNumber];
                                        if (questionData && questionData.percentage !== undefined) {
                                            totalResponses++;
                                            correctResponses += (questionData.percentage / 100);
                                        }
                                    }
                                }
                                
                                // Store in cache
                                if (totalResponses > 0) {
                                    correctnessCache.set(cacheKey, (correctResponses / totalResponses) * 100);
                                }
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error preloading correctness data:', error);
                // Don't throw - we can still show the archive without correctness data
            }
        }
        
        // Render Full Archive view
        function renderFullArchive() {
            if (allTriviaData.size === 0) {
                fullArchiveList.innerHTML = '<p class="no-results">No trivia data found.</p>';
                return;
            }
            
            // Sort by triviaNumber descending
            const sortedTrivias = Array.from(allTriviaData.values())
                .sort((a, b) => b.triviaNumber - a.triviaNumber);
            
            const archiveHTML = sortedTrivias.map(trivia => createTriviaItem(trivia)).join('');
            fullArchiveList.innerHTML = archiveHTML;
            
            // Add event listeners for collapsible items
            setupCollapsibleHandlers();
        }
        
        // Create a single trivia item
        function createTriviaItem(trivia) {
            // Get trivia name from archive data first, then overview
            const triviaName = trivia.archive?.triviaName || 
                              trivia.overview?.['Trivia Name'] || 
                              trivia.overview?.triviaName || 
                              'Unnamed Trivia';
            
            // Get date from archive data first, then overview
            const dateHosted = trivia.archive?.date || 
                              trivia.overview?.Date || 
                              trivia.overview?.date || 
                              '';
            
            const formattedDate = formatDate(dateHosted);
            
                        return `
                <div class="trivia-item" data-trivia-number="${trivia.triviaNumber}">
                    <div class="trivia-summary" onclick="toggleTriviaItem(${trivia.triviaNumber})">
                        <span>Trivia #${trivia.triviaNumber} — ${escapeHTML(triviaName)} — ${formattedDate}</span>
                        <span class="expand-indicator">▼</span>
                    </div>
                    <div class="trivia-content">
                        ${createTriviaContent(trivia)}
                    </div>
                            </div>
                        `;
                }
                
        // Create trivia content (left/right panels)
        function createTriviaContent(trivia) {
                    return `
                <div class="trivia-columns">
                    <div class="rounds-panel">
                        <h4>Rounds & Questions</h4>
                        ${createRoundsPanel(trivia)}
                    </div>
                    <div class="pdf-panel">
                        <h4>
                            <span>Preview</span>
                            <button class="toggle-preview-btn" onclick="togglePreview(${trivia.triviaNumber})">Show</button>
                        </h4>
                        <div id="pdf-panel-content-${trivia.triviaNumber}" class="pdf-panel-content">
                            <div id="pdf-placeholder-${trivia.triviaNumber}" class="pdf-viewer" style="display: flex; align-items: center; justify-content: center; background-color: #f5f5f5;">
                                <p style="color: #666;">PDF preview will load when trivia is expanded</p>
                            </div>
                        </div>
                    </div>
                        </div>
                    `;
                }
        
        // Create Trivia Information section HTML
        function createTriviaInfoHTML(triviaNumber, driveData) {
            if (!driveData) return '';
            
            let contentHTML = '';
            
            // Add Instagram Poster
            if (driveData['Instagram Poster Link']) {
                const fileId = extractDriveFileID(driveData['Instagram Poster Link']);
                const posterRef = driveData['IG Poster Ref'] || '';
                const igChallenge = driveData['IG Challenge'] || '';
                
                if (fileId) {
                    const posterEmbed = createDriveImageEmbed(fileId, 'Instagram Poster');
                    contentHTML += `
                        <div class="poster-section">
                            <div>
                                ${posterEmbed}
                                ${posterRef ? `<div class="poster-ref">(${escapeHTML(posterRef)})</div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    // Add IG Challenge with title if present
                    if (igChallenge) {
                        contentHTML += `
                            <div style="margin-top: 15px; margin-bottom: 15px;">
                                <div style="font-weight: bold; font-size: 0.95em; color: #333; margin-bottom: 8px;">Instagram Caption and Challenge</div>
                                <div style="padding: 10px; background: #f9f9f9; border-left: 3px solid #0066cc; border-radius: 4px; font-size: 0.95em; line-height: 1.5; color: #333;">${escapeHTML(igChallenge)}</div>
                            </div>
                        `;
                    }
                }
            }
            
            // Add Team Name Prompt
            if (driveData['Team Name Prompt']) {
                contentHTML += `
                    <div class="team-name-prompt">
                        <strong>Team Name Prompt:</strong> ${escapeHTML(driveData['Team Name Prompt'])}
                    </div>
                `;
            }
            
            // Add Teams Section with scores
            contentHTML += `
                <div id="teams-section-${triviaNumber}" class="teams-section">
                    <div class="teams-section-header" onclick="toggleTeamsSection(${triviaNumber})">
                        <div>Teams That Played</div>
                        <span class="expand-indicator">▼</span>
                    </div>
                    <div class="teams-section-content">
                        <div class="teams-loading">Loading team data...</div>
                    </div>
                </div>
            `;
            
            // If no content was added, return empty string
            if (!contentHTML.trim()) return '';
            
            // Wrap in Trivia Information container
            return `
                <div class="round-item trivia-info-item" data-trivia-info="true">
                    <div class="round-header" onclick="toggleTriviaInfo(${triviaNumber})">
                        <span>Trivia Information</span>
                        <span class="expand-indicator">▼</span>
                    </div>
                    <div class="round-content">
                        ${contentHTML}
                    </div>
                </div>
            `;
        }
                
        // Create rounds panel content
        function createRoundsPanel(trivia) {
            if (!trivia.archive?.trivia) {
                return '<div class="missing-data">Missing archive data</div>';
            }
            
            const rounds = Object.entries(trivia.archive.trivia)
                .filter(([key, value]) => !isNaN(parseInt(key)) && typeof value === 'object')
                .sort((a, b) => {
                    // Sort by Round Number (which is the key), not Round Ordering
                    return parseInt(a[0]) - parseInt(b[0]);
                });
            
            if (rounds.length === 0) {
                return '<div class="missing-data">No rounds found</div>';
            }
            
            // Create Trivia Information section HTML if drive data exists
            let triviaInfoHTML = '';
            if (trivia.drive) {
                triviaInfoHTML = createTriviaInfoHTML(trivia.triviaNumber, trivia.drive);
            }
            
            const roundsHTML = rounds.map(([roundNumber, roundData]) => {
                // Always show "Round X" as the header, not the specific round name
                    return `
                    <div class="round-item" data-round="${roundNumber}">
                        <div class="round-header" onclick="toggleRound(${trivia.triviaNumber}, ${roundNumber})">
                            <span>Round ${roundNumber}</span>
                            <span class="expand-indicator">▼</span>
                        </div>
                        <div class="round-content">
                            ${createRoundContentFast(roundData, trivia.triviaNumber, roundNumber)}
                        </div>
                        </div>
                    `;
            }).join('');
            
            return triviaInfoHTML + roundsHTML;
        }
        
        // Helper to get round ordering from any question in the round
        function getRoundOrdering(roundData) {
            for (const format of Object.keys(roundData)) {
                if (typeof roundData[format] === 'object') {
                    for (const question of Object.values(roundData[format])) {
                        if (question && question['Round Ordering']) {
                            return parseInt(question['Round Ordering']);
                        }
                    }
                }
            }
            return null;
        }
        
        // Helper to get round name from any question in the round
        function getRoundName(roundData) {
            for (const format of Object.keys(roundData)) {
                if (typeof roundData[format] === 'object') {
                    for (const question of Object.values(roundData[format])) {
                        if (question && question['Round Name']) {
                            return question['Round Name'];
                        }
                    }
                }
            }
            return null;
        }
        
        // Create round content fast (immediate Q&A, background % correct)
        function createRoundContentFast(roundData, triviaNumber, roundNumber) {
            // All possible format names based on actual data structure
            const allFormats = ['Written', 'Visual', 'Music', 'Fill-In', 'FDQ', 'Puzzle', 'Challenge'];
            const formatDisplayNames = {
                'Written': 'Written',
                'Visual': 'Visual', 
                'Music': 'Music',
                'Fill-In': 'Fill-In',
                'FDQ': 'Free Drink Questions',
                'Puzzle': 'Puzzle',
                'Challenge': 'Final Challenge'
            };
            
            // Collect all formats that exist in this round with their Round Ordering
            const formatsWithOrdering = [];
            
            for (const format of allFormats) {
                if (roundData[format]) {
                    let roundOrdering = 999; // default
                    
                    // Get Round Ordering from first question in format
                    if (Array.isArray(roundData[format])) {
                        const firstQuestion = roundData[format].find(q => q && typeof q === 'object');
                        if (firstQuestion && firstQuestion['Round Ordering']) {
                            roundOrdering = parseInt(firstQuestion['Round Ordering']);
                        }
                    } else {
                        const firstQuestion = Object.values(roundData[format]).find(q => q && typeof q === 'object');
                        if (firstQuestion && firstQuestion['Round Ordering']) {
                            roundOrdering = parseInt(firstQuestion['Round Ordering']);
                        }
                    }
                    
                    formatsWithOrdering.push({
                        format: format,
                        roundOrdering: roundOrdering
                    });
                }
            }
            
            // Sort formats by Round Ordering
            formatsWithOrdering.sort((a, b) => a.roundOrdering - b.roundOrdering);
            
            let questionsHTML = '';
            
            // Process each format in Round Ordering order
            for (const formatInfo of formatsWithOrdering) {
                const format = formatInfo.format;
                if (roundData[format]) {
                    let questions = [];
                    let formatInstruction = '';
                    let roundName = '';
                    
                    if (Array.isArray(roundData[format])) {
                        // Array format - iterate through with indices
                        roundData[format].forEach((qData, index) => {
                            if (qData && typeof qData === 'object') {
                                questions.push({
                                    question: qData.Question || '',
                                    answer: qData.Answer || '',
                                    questionNumber: qData['Question Number'] || index,
                                    roundOrdering: parseInt(qData['Round Ordering']) || 1
                                });
                                // Get format instruction and round name from first question
                                if (!formatInstruction) {
                                    formatInstruction = qData['Round Instruction'] || '';
                                }
                                if (!roundName) {
                                    roundName = qData['Round Name'] || '';
                                }
                            }
                        });
                    } else {
                        // Object format - use Object.entries
                        Object.entries(roundData[format]).forEach(([key, qData]) => {
                            if (!isNaN(parseInt(key)) && qData && typeof qData === 'object') {
                                questions.push({
                                    question: qData.Question || '',
                                    answer: qData.Answer || '',
                                    questionNumber: qData['Question Number'] || parseInt(key),
                                    roundOrdering: parseInt(qData['Round Ordering']) || 1
                                });
                                // Get format instruction and round name from first question
                                if (!formatInstruction) {
                                    formatInstruction = qData['Round Instruction'] || '';
                                }
                                if (!roundName) {
                                    roundName = qData['Round Name'] || '';
                                }
                            }
                        });
                    }
                    
                    if (questions.length > 0) {
                        // Sort by Round Ordering > Question Number
                        questions.sort((a, b) => {
                            if (a.roundOrdering !== b.roundOrdering) return a.roundOrdering - b.roundOrdering;
                            return a.questionNumber - b.questionNumber;
                        });
                        
                        // Add format header with round name if available
                        const formatTitle = roundName 
                            ? `${formatDisplayNames[format] || format} - ${escapeHTML(roundName)}`
                            : formatDisplayNames[format] || format;
                        questionsHTML += `<h5 style="margin-top: 20px; margin-bottom: 10px; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px;">${formatTitle}</h5>`;
                        
                        // Add format instruction if available
                        if (formatInstruction) {
                            questionsHTML += `
                                <div style="background-color: #e3f2fd; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-style: italic; border-left: 4px solid #2196f3;">
                                    <strong>Instructions:</strong> ${escapeHTML(formatInstruction)}
                                </div>
                            `;
                        }
                        
                        // Create table grid for this format with preloaded % correct data
                        questionsHTML += `
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                <thead>
                                    <tr style="background-color: #f5f5f5;">
                                        <th style="padding: 6px; border: 1px solid #ddd; text-align: left; width: 60px; font-size: 12px;">Q#</th>
                                        <th style="padding: 6px; border: 1px solid #ddd; text-align: left; font-size: 12px;">Question</th>
                                        <th style="padding: 6px; border: 1px solid #ddd; text-align: left; width: 180px; font-size: 12px;">Answer</th>
                                        <th style="padding: 6px; border: 1px solid #ddd; text-align: center; width: 80px; font-size: 12px;">% Correct</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${questions.map(q => {
                                        const cacheKey = `${triviaNumber}-${roundNumber}-${format}-${q.questionNumber}`;
                                        const correctness = correctnessCache.get(cacheKey);
                                        let correctnessHTML;
                                        
                                        if (correctness !== undefined) {
                                            const percentage = correctness.toFixed(1);
                                            const color = correctness >= 50 ? '#4caf50' : '#f44336';
                                            correctnessHTML = `<span style="color: ${color};">${percentage}%</span>`;
                                        } else {
                                            correctnessHTML = '<span style="color: #ccc;">—</span>';
                                        }
                                        
                                        return `
                                            <tr>
                                                <td style="padding: 6px; border: 1px solid #ddd; font-weight: bold; font-size: 12px;">${q.questionNumber}</td>
                                                <td style="padding: 6px; border: 1px solid #ddd; font-size: 12px;">${escapeHTML(q.question)}</td>
                                                <td style="padding: 6px; border: 1px solid #ddd; font-style: italic; font-size: 12px;">${escapeHTML(q.answer)}</td>
                                                <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 12px;">
                                                    ${correctnessHTML}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                }
            }
            
            return questionsHTML || '<div class="missing-data">No questions found</div>';
        }
        
        // Note: loadQuestionCorrectness is no longer needed as correctness is preloaded
        // Keeping calculateQuestionCorrectness for potential future use
        
        // Create PDF panel content
        function createPDFPanel(trivia) {
            if (!trivia.drive) {
                return '<div class="missing-data">No PDF data available</div>';
            }
            
            const pdfFiles = [];
            const folderUrl = trivia.drive.Link || trivia.drive.folderUrl || trivia.drive.folder;
            const musicFolder = trivia.drive['Music Folder'];
            
            // Extract PDF file IDs from drive data, prioritizing Teams Sheet PDF
            const pdfFields = ['Teams Sheet PDF', 'Questions PDF', 'Answers PDF']; // Teams Sheet first
            
            for (const field of pdfFields) {
                const value = trivia.drive[field];
                if (typeof value === 'string' && value.trim()) {
                    const fileId = extractGoogleDriveFileId(value);
                    if (fileId) {
                        pdfFiles.push({
                            name: field,
                            fileId: fileId,
                            originalUrl: value
                        });
                    }
                }
            }
            
            // Add any other PDF fields that might exist
            for (const [key, value] of Object.entries(trivia.drive)) {
                if (typeof value === 'string' && value.trim() && !pdfFields.includes(key)) {
                    if (key.toLowerCase().includes('pdf')) {
                        const fileId = extractGoogleDriveFileId(value);
                        if (fileId) {
                            pdfFiles.push({
                                name: key,
                                fileId: fileId,
                                originalUrl: value
                            });
                        }
                    }
                }
            }
            
            // Add music folder as an option if available
            if (musicFolder && musicFolder.trim()) {
                pdfFiles.push({
                    name: 'Music Folder',
                    fileId: null,
                    originalUrl: musicFolder,
                    isFolder: true
                });
            }
            
            if (pdfFiles.length === 0) {
            return `
                    <div class="missing-data">No preview available</div>
                    ${folderUrl ? `<a href="${folderUrl}" target="_blank" class="drive-link">Open Google Drive Folder</a>` : ''}
                `;
            }
            
            const firstItem = pdfFiles[0];
            let previewContent = '';
            
            if (firstItem.isFolder) {
                // For music folder, create a custom audio player with common file names
                previewContent = `
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div style="background-color: #f5f5f5; padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">
                            <h4 style="margin: 0; color: #333;">🎵 Music Round Player</h4>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Select and play music files below</p>
                        </div>
                        <div style="flex: 1; padding: 15px; background-color: white; overflow-y: auto;">
                            <div id="music-player-${trivia.triviaNumber}">
                                <div id="music-files-${trivia.triviaNumber}">
                                    <div style="text-align: center; padding: 20px;">
                                        <button onclick="loadMusicFilesFromAPI(${trivia.triviaNumber}, '${extractGoogleDriveFolderId(firstItem.originalUrl)}')" 
                                                style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                            🎵 Load Music Files
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background-color: #f5f5f5; padding: 8px; text-align: center; border-top: 1px solid #ddd;">
                            <a href="${firstItem.originalUrl}" target="_blank" class="drive-link" style="font-size: 12px; padding: 6px 12px;">🎵 Open Full Music Folder</a>
                        </div>
                </div>
            `;
            } else {
                const previewUrl = `https://drive.google.com/file/d/${firstItem.fileId}/preview`;
                previewContent = `<iframe class="pdf-viewer" src="${previewUrl}" frameborder="0"></iframe>`;
            }
            
            return `
                <div class="pdf-controls">
                    ${pdfFiles.length > 1 ? `
                        <select class="pdf-selector" onchange="changePDFOrFolder(this, ${trivia.triviaNumber})">
                            ${pdfFiles.map((item, index) => 
                                `<option value="${index}" ${index === 0 ? 'selected' : ''}>${escapeHTML(item.name)}</option>`
                            ).join('')}
                        </select>
                    ` : `<span style="font-weight: 500;">${escapeHTML(firstItem.name)}</span>`}
                </div>
                <div id="preview-content-${trivia.triviaNumber}">
                    ${previewContent}
                </div>
                ${folderUrl ? `<a href="${folderUrl}" target="_blank" class="drive-link">Open Google Drive Folder</a>` : ''}
            `;
        }
        
        // Extract Google Drive file ID from various URL formats
        function extractGoogleDriveFileId(url) {
            if (!url) return null;
            
            // If it's already a file ID (no slashes or special chars)
            if (/^[a-zA-Z0-9_-]{25,}$/.test(url.trim())) {
                return url.trim();
            }
            
            // Extract from various Google Drive URL formats
            const patterns = [
                /\/file\/d\/([a-zA-Z0-9_-]+)/,
                /id=([a-zA-Z0-9_-]+)/,
                /\/([a-zA-Z0-9_-]{25,})\//
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }
        
        // Extract Google Drive folder ID from various URL formats
        function extractGoogleDriveFolderId(url) {
            if (!url) return null;
            
            // Extract from various Google Drive folder URL formats
            const patterns = [
                /\/folders\/([a-zA-Z0-9_-]+)/,
                /\/drive\/folders\/([a-zA-Z0-9_-]+)/,
                /\/drive\/u\/\d+\/folders\/([a-zA-Z0-9_-]+)/,
                /id=([a-zA-Z0-9_-]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }
        
        // Toggle trivia item open/closed
        function toggleTriviaItem(triviaNumber) {
            const item = document.querySelector(`[data-trivia-number="${triviaNumber}"]`);
            if (item) {
                const isOpen = item.hasAttribute('open');
                if (isOpen) {
                    item.removeAttribute('open');
                } else {
                    item.setAttribute('open', '');
                    
                    // Lazy load PDF content when trivia is opened
                    loadPDFContent(triviaNumber);
                }
            }
        }
        
        // Lazy load PDF content for a specific trivia
        function loadPDFContent(triviaNumber) {
            const trivia = Array.from(allTriviaData.values()).find(t => t.triviaNumber === triviaNumber);
            if (!trivia) return;
            
            const placeholder = document.getElementById(`pdf-placeholder-${triviaNumber}`);
            if (!placeholder) return;
            
            // Replace placeholder with actual PDF content
            const pdfContent = createPDFPanel(trivia);
            placeholder.outerHTML = pdfContent;
            
        }
        
        // Toggle round open/closed
        function toggleRound(triviaNumber, roundNumber) {
            const round = document.querySelector(`[data-trivia-number="${triviaNumber}"] [data-round="${roundNumber}"]`);
            if (round) {
                const isOpen = round.hasAttribute('open');
                if (isOpen) {
                    round.removeAttribute('open');
                } else {
                    round.setAttribute('open', '');
                }
            }
        }
        
        // Toggle trivia info section open/closed
        function toggleTriviaInfo(triviaNumber) {
            const infoSection = document.querySelector(`[data-trivia-number="${triviaNumber}"] .trivia-info-item`);
            if (infoSection) {
                const isOpen = infoSection.hasAttribute('open');
                if (isOpen) {
                    infoSection.removeAttribute('open');
                } else {
                    infoSection.setAttribute('open', '');
                    // Load team data when opened for the first time
                    loadTeamData(triviaNumber);
                }
            }
        }
        
        // Toggle teams section open/closed
        function toggleTeamsSection(triviaNumber) {
            const teamsSection = document.getElementById(`teams-section-${triviaNumber}`);
            if (teamsSection) {
                const isOpen = teamsSection.hasAttribute('open');
                if (isOpen) {
                    teamsSection.removeAttribute('open');
                } else {
                    teamsSection.setAttribute('open', '');
                }
            }
        }
        
        // Toggle PDF/Music preview panel visibility
        function togglePreview(triviaNumber) {
            const content = document.getElementById(`pdf-panel-content-${triviaNumber}`);
            const button = event.target;
            const pdfPanel = button.closest('.pdf-panel');
            const triviaColumns = button.closest('.trivia-columns');
            
            if (content && button && pdfPanel && triviaColumns) {
                // Check if content is visible (either by having hidden class or by display style)
                const isHidden = content.classList.contains('hidden') || 
                                window.getComputedStyle(content).display === 'none';
                
                if (isHidden) {
                    // Show the panel
                    content.classList.remove('hidden');
                    content.style.display = 'flex';
                    pdfPanel.classList.remove('collapsed');
                    triviaColumns.classList.remove('preview-collapsed');
                    button.textContent = 'Hide';
                } else {
                    // Hide the panel but keep button visible
                    content.classList.add('hidden');
                    pdfPanel.classList.add('collapsed');
                    triviaColumns.classList.add('preview-collapsed');
                    button.textContent = 'Show';
                }
            }
        }
        
        // Change PDF in viewer (legacy function, keeping for compatibility)
        function changePDF(selectElement, triviaNumber) {
            const fileId = selectElement.value;
            const previewUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            const iframe = selectElement.closest('.pdf-panel').querySelector('.pdf-viewer');
            if (iframe) {
                iframe.src = previewUrl;
            }
        }
        
        // Change PDF or folder in viewer (new function)
        function changePDFOrFolder(selectElement, triviaNumber) {
            const selectedIndex = parseInt(selectElement.value);
            const trivia = Array.from(allTriviaData.values()).find(t => t.triviaNumber === triviaNumber);
            if (!trivia || !trivia.drive) return;
            
            // Rebuild the files array (same logic as in createPDFPanel)
            const pdfFiles = [];
            const pdfFields = ['Teams Sheet PDF', 'Questions PDF', 'Answers PDF']; // Teams Sheet first
            const musicFolder = trivia.drive['Music Folder'];
            
            // Add PDFs in priority order
            for (const field of pdfFields) {
                const value = trivia.drive[field];
                if (typeof value === 'string' && value.trim()) {
                    const fileId = extractGoogleDriveFileId(value);
                    if (fileId) {
                        pdfFiles.push({
                            name: field,
                            fileId: fileId,
                            originalUrl: value
                        });
                    }
                }
            }
            
            // Add any other PDF fields
            for (const [key, value] of Object.entries(trivia.drive)) {
                if (typeof value === 'string' && value.trim() && !pdfFields.includes(key)) {
                    if (key.toLowerCase().includes('pdf')) {
                        const fileId = extractGoogleDriveFileId(value);
                        if (fileId) {
                            pdfFiles.push({
                                name: key,
                                fileId: fileId,
                                originalUrl: value
                            });
                        }
                    }
                }
            }
            
            if (musicFolder && musicFolder.trim()) {
                pdfFiles.push({
                    name: 'Music Folder',
                    fileId: null,
                    originalUrl: musicFolder,
                    isFolder: true
                });
            }
            
            const selectedItem = pdfFiles[selectedIndex];
            if (!selectedItem) return;
            
            const previewContainer = document.getElementById(`preview-content-${triviaNumber}`);
            if (!previewContainer) return;
            
            let previewContent = '';
            if (selectedItem.isFolder) {
                // For music folder, create the same interface as in createPDFPanel
                const folderId = extractGoogleDriveFolderId(selectedItem.originalUrl);
                if (folderId) {
                    previewContent = `
                        <div style="display: flex; flex-direction: column; height: 100%;">
                            <div style="background-color: #f5f5f5; padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">
                                <h4 style="margin: 0; color: #333;">🎵 Music Round Player</h4>
                                <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Select and play music files below</p>
                            </div>
                            <div style="flex: 1; padding: 15px; background-color: white; overflow-y: auto;">
                                <div id="music-player-${triviaNumber}">
                                    <div id="music-files-${triviaNumber}">
                                        <div style="text-align: center; padding: 20px;">
                                            <button onclick="loadMusicFilesFromAPI(${triviaNumber}, '${folderId}')" 
                                                    style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                🎵 Load Music Files
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="background-color: #f5f5f5; padding: 8px; text-align: center; border-top: 1px solid #ddd;">
                                <a href="${selectedItem.originalUrl}" target="_blank" class="drive-link" style="font-size: 12px; padding: 6px 12px;">🎵 Open Full Music Folder</a>
                            </div>
                        </div>
                    `;
                } else {
                    previewContent = `<div class="pdf-viewer" style="display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f5f5f5; padding: 20px;">
                        <div style="text-align: center;">
                            <h3 style="margin-bottom: 15px; color: #333;">🎵 Music Folder</h3>
                            <p style="margin-bottom: 20px; color: #666;">Click below to open the music folder where you can play the audio files.</p>
                            <a href="${selectedItem.originalUrl}" target="_blank" class="drive-link" style="font-size: 16px; padding: 12px 24px;">🎵 Open Music Folder</a>
                        </div>
                    </div>`;
                }
            } else {
                const previewUrl = `https://drive.google.com/file/d/${selectedItem.fileId}/preview`;
                previewContent = `<iframe class="pdf-viewer" src="${previewUrl}" frameborder="0"></iframe>`;
            }
            
            previewContainer.innerHTML = previewContent;
        }
        
        // Open PDF in full screen
        function openPDFFullScreen(pdfUrl) {
            window.open(pdfUrl, '_blank');
        }
        
        // Setup collapsible handlers
        function setupCollapsibleHandlers() {
            // Handlers are inline in the HTML for simplicity
        }
        
        // Switch view modes
        function switchViewMode(mode) {
            currentViewMode = mode;
            
            // Update toolbar buttons
            document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
            
            if (mode === 'full-archive') {
                legacyArchive.style.display = 'none';
                fullArchive.style.display = 'block';
                
                // Load full archive if not already loaded
                if (allTriviaData.size === 0) {
                    loadFullArchive();
                }
            } else {
                // TODO: Implement other view modes
                // For now, show placeholder
                legacyArchive.style.display = 'block';
                fullArchive.style.display = 'none';
            }
        }
        
        // Load Full Archive data and render
        async function loadFullArchive() {
            try {
                await fetchAllTriviaData();
                renderFullArchive();
            } catch (error) {
                console.error('Error loading full archive:', error);
                fullArchiveList.innerHTML = `<p class="error">Error loading archive: ${error.message}</p>`;
            }
        }
        
        // Helper function to escape HTML
        function escapeHTML(str) {
            if (!str) return '';
            
            // Convert to string first to ensure we're working with a string
            const strValue = String(str);
            
            return strValue
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // Initialize toolbar event handlers
        function initializeToolbar() {
            document.getElementById('btn-full-archive').addEventListener('click', () => switchViewMode('full-archive'));
            
            // Add search functionality
            document.getElementById('archive-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performArchiveSearch();
                }
            });
            
            // TODO: Add handlers for other view modes when implemented
            // document.getElementById('btn-puzzles').addEventListener('click', () => switchViewMode('puzzles'));
            // document.getElementById('btn-visuals').addEventListener('click', () => switchViewMode('visuals'));
            // document.getElementById('btn-fill-ins').addEventListener('click', () => switchViewMode('fill-ins'));
            // document.getElementById('btn-music').addEventListener('click', () => switchViewMode('music'));
            // document.getElementById('btn-challenges').addEventListener('click', () => switchViewMode('challenges'));
            // document.getElementById('btn-written-only').addEventListener('click', () => switchViewMode('written-only'));
        }
        
        // Search functionality
        function performArchiveSearch() {
            const searchTerm = document.getElementById('archive-search').value.trim().toLowerCase();
            if (!searchTerm) {
                clearArchiveSearch();
                return;
            }
            
            // Check if Simple mode is enabled
            const simpleMode = document.getElementById('simple-search-toggle').checked;
            
            // Check if "search trivia rounds only" is enabled
            const searchRoundsOnly = document.getElementById('search-rounds-only').checked;
            
            // First, collapse all trivias and clear previous search results
            document.querySelectorAll('.trivia-item, .round-item').forEach(item => {
                item.removeAttribute('open');
            });
            
            // Collapse all trivia cards (legacy view)
            document.querySelectorAll('.trivia-card').forEach(card => {
                card.classList.remove('expanded');
                card.querySelectorAll('.round, .trivia-info').forEach(element => {
                    element.classList.remove('expanded');
                });
            });
            
            // Remove previous highlighting and match styling
            document.querySelectorAll('.search-highlight').forEach(el => {
                el.outerHTML = el.innerHTML;
            });
            document.querySelectorAll('.has-matches').forEach(el => {
                el.classList.remove('has-matches');
            });
            
            let matchingTrivias = [];
            
            // Search through Full Archive view (.trivia-item)
            document.querySelectorAll('.trivia-item').forEach(triviaItem => {
                const triviaNumber = parseInt(triviaItem.dataset.triviaNumber);
                let triviaHasMatches = false;
                
                // Search through all round-items in this trivia
                triviaItem.querySelectorAll('.round-item').forEach(roundElement => {
                    // Skip trivia info items if "search rounds only" is checked
                    if (searchRoundsOnly && roundElement.dataset.triviaInfo === 'true') {
                        return;
                    }
                    
                    let roundHasMatches = false;
                    
                    // Search all text content in this round
                    const roundText = roundElement.textContent.toLowerCase();
                    
                    // Check for match based on mode
                    let hasMatch = false;
                    if (simpleMode) {
                        // Simple mode: search term must be surrounded by spaces, special characters, or string boundaries
                        const pattern = new RegExp(`(^|[^a-z])${escapeRegex(searchTerm)}($|[^a-z])`, 'i');
                        hasMatch = pattern.test(roundText);
                    } else {
                        // Standard mode: just check if search term is contained anywhere
                        hasMatch = roundText.includes(searchTerm);
                    }
                    
                    if (hasMatch) {
                        roundHasMatches = true;
                        triviaHasMatches = true;
                        
                        // Highlight the search term in this round's HTML
                        highlightSearchTerm(roundElement, searchTerm, simpleMode);
                        
                        // Auto-expand this round
                        roundElement.setAttribute('open', '');
                        roundElement.classList.add('has-matches');
                    }
                });
                
                // Add/remove trivia match styling and auto-expand if has matches
                if (triviaHasMatches) {
                    triviaItem.setAttribute('open', '');
                    triviaItem.classList.add('has-matches');
                    
                    // Get trivia data for date
                    const trivia = Array.from(allTriviaData.values()).find(t => t.triviaNumber === triviaNumber);
                    if (trivia) {
                        const dateHosted = trivia.archive?.date || 
                                          trivia.archive?.metadata?.date ||
                                          trivia.overview?.Date || 
                                          trivia.overview?.date || 
                                          '';
                        matchingTrivias.push({
                            number: triviaNumber,
                            date: dateHosted
                        });
                    }
                }
            });
            
            // Display search results info
            const resultsInfo = document.getElementById('search-results-info');
            if (matchingTrivias.length > 0) {
                // Sort by trivia number descending to get most recent
                matchingTrivias.sort((a, b) => b.number - a.number);
                const mostRecent = matchingTrivias[0];
                const mostRecentDate = formatDate(mostRecent.date);
                
                resultsInfo.innerHTML = `Found ${matchingTrivias.length} result${matchingTrivias.length === 1 ? '' : 's'}, most recent: Trivia #${mostRecent.number} (${mostRecentDate})`;
                resultsInfo.classList.add('visible');
            } else {
                resultsInfo.innerHTML = `No matches found for "${document.getElementById('archive-search').value}"`;
                resultsInfo.style.backgroundColor = '#ffebee';
                resultsInfo.style.borderColor = '#f44336';
                resultsInfo.style.color = '#c62828';
                resultsInfo.classList.add('visible');
            }
        }
        
        // Clear search highlighting
        function clearArchiveSearch() {
            document.getElementById('archive-search').value = '';
            
            // Remove all highlighting
            document.querySelectorAll('.search-highlight').forEach(el => {
                el.outerHTML = el.innerHTML;
            });
            
            // Remove match styling
            document.querySelectorAll('.has-matches').forEach(el => {
                el.classList.remove('has-matches');
            });
            
            // Collapse all items (legacy view)
            document.querySelectorAll('.trivia-item, .round-item').forEach(item => {
                item.removeAttribute('open');
            });
            
            // Collapse all trivia cards and their rounds/info sections
            document.querySelectorAll('.trivia-card').forEach(card => {
                card.classList.remove('expanded');
                card.querySelectorAll('.round, .trivia-info').forEach(element => {
                    element.classList.remove('expanded');
                });
            });
            
            // Hide search results info
            const resultsInfo = document.getElementById('search-results-info');
            if (resultsInfo) {
                resultsInfo.classList.remove('visible');
                resultsInfo.style.backgroundColor = '#e8f5e9';
                resultsInfo.style.borderColor = '#4caf50';
                resultsInfo.style.color = '#2e7d32';
            }
        }
        
        // Highlight search term in element
        function highlightSearchTerm(element, searchTerm, simpleMode = false) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                
                // Build regex based on mode
                let regex;
                if (simpleMode) {
                    // Simple mode: match only when surrounded by non-letter characters or string boundaries
                    regex = new RegExp(`(^|[^a-zA-Z])(${escapeRegex(searchTerm)})($|[^a-zA-Z])`, 'gi');
                } else {
                    // Standard mode: match anywhere
                    regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
                }
                
                if (regex.test(text)) {
                    let highlightedText;
                    if (simpleMode) {
                        // In simple mode, we need to preserve the boundary characters (group 1 and 3)
                        // and only highlight the search term (group 2)
                        highlightedText = text.replace(
                            new RegExp(`(^|[^a-zA-Z])(${escapeRegex(searchTerm)})($|[^a-zA-Z])`, 'gi'),
                            '$1<span class="search-highlight">$2</span>$3'
                        );
                    } else {
                        highlightedText = text.replace(
                            new RegExp(`(${escapeRegex(searchTerm)})`, 'gi'),
                            '<span class="search-highlight">$1</span>'
                        );
                    }
                    const wrapper = document.createElement('span');
                    wrapper.innerHTML = highlightedText;
                    textNode.parentNode.replaceChild(wrapper, textNode);
                }
            });
        }
        
        // Escape regex special characters
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Calculate question correctness percentage across all grading sessions
        async function calculateQuestionCorrectness(question, triviaNumber, roundNumber, format) {
            try {
                // Get all grading sessions for this trivia number
                const allSessionsSnap = await db.ref('grading').once('value');
                if (!allSessionsSnap.exists()) return null;
                
                const allSessions = allSessionsSnap.val();
                const relevantSessions = Object.keys(allSessions).filter(sessionId => 
                    allSessions[sessionId].triviaNumber === triviaNumber
                );
                
                if (relevantSessions.length === 0) return null;
                
                let totalResponses = 0;
                let correctResponses = 0;
                
                // Check each session for this question
                for (const sessionId of relevantSessions) {
                    const teamsSnap = await db.ref(`grading/${sessionId}/teams`).once('value');
                    if (!teamsSnap.exists()) continue;
                    
                    const teams = teamsSnap.val();
                    
                    // Check each team's response to this question
                    for (const [teamId, team] of Object.entries(teams)) {
                        const roundKey = `round${roundNumber}`;
                        if (!team[roundKey] || !team[roundKey][format]) continue;
                        
                        const questionData = team[roundKey][format][question.questionNumber];
                        if (questionData && questionData.percentage !== undefined) {
                            totalResponses++;
                            correctResponses += (questionData.percentage / 100);
                        }
                    }
                }
                
                return totalResponses > 0 ? (correctResponses / totalResponses) * 100 : null;
                
            } catch (error) {
                console.error('Error calculating question correctness:', error);
                return null;
            }
        }
        
        // Load music files from Google Drive API and create audio players
        async function loadMusicFile(triviaNumber, fileNumber) {
            const trivia = Array.from(allTriviaData.values()).find(t => t.triviaNumber === triviaNumber);
            if (!trivia || !trivia.drive || !trivia.drive['Music Folder']) return;
            
            const musicFolderUrl = trivia.drive['Music Folder'];
            const folderId = extractGoogleDriveFolderId(musicFolderUrl);
            
            if (!folderId) {
                window.open(musicFolderUrl, '_blank');
                return;
            }
            
            // Check if we already have the music files loaded for this trivia
            const musicPlayer = document.getElementById(`music-player-${triviaNumber}`);
            if (!musicPlayer) return;
            
            // If files aren't loaded yet, load them
            if (!musicPlayer.dataset.filesLoaded) {
                await loadMusicFilesFromAPI(triviaNumber, folderId);
            }
            
            // Play the specific file
            playMusicFile(triviaNumber, fileNumber);
        }
        
        // Load music files using Google Drive API with proper error handling
        async function loadMusicFilesFromAPI(triviaNumber, folderId) {
            const trivia = Array.from(allTriviaData.values()).find(t => t.triviaNumber === triviaNumber);
            const musicFilesContainer = document.getElementById(`music-files-${triviaNumber}`);
            
            if (!musicFilesContainer || !trivia) return;
            
            try {
                // Get API key from Firebase
                const apiKeySnap = await db.ref('adminSettings/googleDriveApiKey').once('value');
                if (!apiKeySnap.exists()) {
                    throw new Error('Google Drive API key not configured in Firebase');
                }
                const apiKey = apiKeySnap.val();
                
                // Try multiple API approaches for better compatibility
                const apiUrls = [
                    // Standard API call
                    `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${apiKey}&fields=files(id,name,mimeType)`,
                    // With supportsAllDrives for shared drives
                    `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&supportsAllDrives=true&includeItemsFromAllDrives=true&key=${apiKey}&fields=files(id,name,mimeType)`
                ];
                
                let response;
                let lastError;
                
                for (const url of apiUrls) {
                    try {
                        response = await fetch(url);
                        if (response.ok) break;
                        lastError = `${response.status}: ${response.statusText}`;
            } catch (e) {
                        lastError = e.message;
                        continue;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`All API attempts failed. Last error: ${lastError}. The API key may need to be enabled for Google Drive API in Google Cloud Console.`);
                }
                
                const data = await response.json();
                
                if (!data.files || data.files.length === 0) {
                    throw new Error('No files found in folder. The folder may not be publicly accessible or may be empty.');
                }
                
                const audioFiles = data.files.filter(file => 
                    file.mimeType.startsWith('audio/') || file.name.toLowerCase().endsWith('.mp3')
                );
                
                if (audioFiles.length === 0) {
                    throw new Error('No audio files found in this folder.');
                }
                
                // Sort files alphabetically by name
                audioFiles.sort((a, b) => a.name.localeCompare(b.name));
                
                // Create individual Google Drive native audio players (auto-loaded)
                musicFilesContainer.innerHTML = audioFiles.map((file, index) => `
                    <div style="border: 1px solid #ddd; border-radius: 6px; background: white; overflow: hidden; margin-bottom: 8px;">
                        <div style="padding: 6px 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 12px; font-weight: 500;">
                            🎵 ${escapeHTML(file.name)}
                </div>
                        <div id="player-container-${triviaNumber}-${index}" style="padding: 5px;">
                            <iframe src="https://drive.google.com/file/d/${file.id}/preview" 
                                    style="width: 100%; height: 50px; border: none;"
                                    frameborder="0"
                                    allow="autoplay"
                                    onerror="handlePlayerError('${triviaNumber}', '${index}', '${file.id}', '${escapeHTML(file.name)}')">
                            </iframe>
                        </div>
                    </div>
                `).join('');
                
                // Mark as loaded
                document.getElementById(`music-player-${triviaNumber}`).dataset.filesLoaded = 'true';
                
            } catch (error) {
                console.error('Error loading music files via API:', error);
                
                // Fallback to embedded folder view
                musicFilesContainer.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h5>⚠️ API Access Issue</h5>
                        <p style="color: #d32f2f; font-size: 12px; margin-bottom: 10px;">${error.message}</p>
                        <details style="margin-bottom: 10px;">
                            <summary style="cursor: pointer; color: #666; font-size: 12px;">How to fix this (for admin)</summary>
                            <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-top: 5px; font-size: 11px;">
                                <p>1. Go to <a href="https://console.cloud.google.com/apis/dashboard" target="_blank">Google Cloud Console</a></p>
                                <p>2. Enable "Google Drive API" for your project</p>
                                <p>3. Ensure music folders are set to "Anyone with the link can view"</p>
                                <p>4. API Key: ${apiKey ? 'Configured ✓' : 'Missing ✗'}</p>
                            </div>
                        </details>
                    </div>
                    <h5>📁 Folder Browser (Fallback):</h5>
                    <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Click music files below to open them in new tab</p>
                    <iframe src="https://drive.google.com/embeddedfolderview?id=${folderId}" 
                            style="width: 100%; height: 250px; border: 1px solid #ddd; border-radius: 4px;"
                            frameborder="0">
                    </iframe>
                `;
            }
        }
        
        // Handle player loading errors (CSP issues)
        function handlePlayerError(triviaNumber, fileIndex, fileId, fileName) {
            const playerContainer = document.getElementById(`player-container-${triviaNumber}-${fileIndex}`);
            if (!playerContainer) return;
            
            // Replace failed iframe with fallback link
            playerContainer.innerHTML = `
                <div style="padding: 8px; background: #fff3cd; border-radius: 4px; text-align: center;">
                    <p style="font-size: 11px; color: #856404; margin: 0 0 5px 0;">Player blocked by security policy</p>
                    <a href="https://drive.google.com/file/d/${fileId}/view" target="_blank" 
                       style="font-size: 12px; color: #4285f4; text-decoration: none;">
                        ▶️ Open in Google Drive
                    </a>
                </div>
            `;
        }
        
        // Load Google Drive native audio player for specific file (legacy)
        function loadGoogleDriveAudioPlayer(triviaNumber, fileIndex, fileId, fileName) {
            // This function is now handled automatically in loadMusicFilesFromAPI
            // Kept for compatibility
        }
        
        // Legacy function - Play specific music file by ID (kept for compatibility)
        function playMusicFileById(triviaNumber, fileId, fileName) {
            // This function is now replaced by loadGoogleDriveAudioPlayer
            loadGoogleDriveAudioPlayer(triviaNumber, 0, fileId, fileName);
        }
        
        // Legacy function for backward compatibility
        function playMusicFile(triviaNumber, fileNumber) {
            // This is called by the old numbered buttons - just open folder for now
            const trivia = Array.from(allTriviaData.values()).find(t => t.triviaNumber === triviaNumber);
            if (trivia && trivia.drive && trivia.drive['Music Folder']) {
                window.open(trivia.drive['Music Folder'], '_blank');
            }
        }
        
        // Function to convert Google Drive link ID to file ID
        function extractDriveFileID(driveLink) {
            if (!driveLink) return null;
            
            // Extract ID from various Google Drive URL formats
            let fileId = null;
            
            if (driveLink.includes('id=')) {
                const match = driveLink.match(/[?&]id=([^&]+)/);
                fileId = match ? match[1] : null;
            } else if (driveLink.includes('/d/')) {
                const match = driveLink.match(/\/d\/([^/]+)/);
                fileId = match ? match[1] : null;
            } else {
                // Assume it's just the ID
                fileId = driveLink;
            }
            
            return fileId;
        }
        
        // Function to create Google Drive image embed - tries multiple methods for best performance
        function createDriveImageEmbed(fileId, altText = 'Image') {
            if (!fileId) return '';
            
            // Try multiple Google Drive image URL formats for best compatibility and speed
            // Method 1: lh3.googleusercontent.com (fastest, direct image)
            // Method 2: drive.google.com/uc (fallback)
            // Method 3: iframe preview (slowest but most reliable)
            
            return `
                <div style="width: 300px; min-height: 300px; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.15); background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                    <img src="https://lh3.googleusercontent.com/d/${fileId}" 
                         alt="${altText}"
                         style="max-width: 300px; max-height: 300px; width: auto; height: auto; display: block;"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='https://drive.google.com/uc?export=view&id=${fileId}'; this.onerror=function(){handlePosterImageError(this, '${fileId}', '${altText}');};" />
                </div>
            `;
        }
        
        // Fallback handler for poster images that fail to load via img tag
        function handlePosterImageError(img, fileId, altText) {
            // Replace failed img with lazy-loaded iframe as last resort
            const container = img.parentElement;
            if (!container) return;
            
            container.innerHTML = `
                <div style="position: relative; width: 300px; height: 300px;">
                    <iframe src="https://drive.google.com/file/d/${fileId}/preview" 
                            style="width: 300px; height: 300px; border: none;" 
                            frameborder="0"
                            loading="lazy"
                            title="${altText}">
                    </iframe>
                    <div style="position: absolute; top: 0; right: 0; width: 40px; height: 40px; background: transparent; z-index: 10;"></div>
                </div>
            `;
        }
        
        // Function to create Trivia Information section
        function createTriviaInfoSection(triviaNumber, driveData) {
            const infoSection = document.createElement('div');
            infoSection.className = 'trivia-info';
            infoSection.setAttribute('data-trivia-info', 'true'); // Mark for search filtering
            
            const infoHeader = document.createElement('div');
            infoHeader.className = 'trivia-info-header';
            infoHeader.innerHTML = `
                <div>Trivia Information</div>
                <div class="caret"></div>
            `;
            
            const infoContent = document.createElement('div');
            infoContent.className = 'trivia-info-content';
            
            let contentHTML = '';
            
            // Add Team Name Prompt
            if (driveData && driveData['Team Name Prompt']) {
                contentHTML += `
                    <div class="team-name-prompt">
                        <strong>Team Name Prompt:</strong> ${escapeHTML(driveData['Team Name Prompt'])}
                    </div>
                `;
            }
            
            // Add Instagram Poster
            if (driveData && driveData['Instagram Poster Link']) {
                const fileId = extractDriveFileID(driveData['Instagram Poster Link']);
                const posterRef = driveData['IG Poster Ref'] || '';
                const igChallenge = driveData['IG Challenge'] || '';
                
                if (fileId) {
                    const posterEmbed = createDriveImageEmbed(fileId, 'Instagram Poster');
                    contentHTML += `
                        <div class="poster-section">
                            <div>
                                ${posterEmbed}
                                ${posterRef ? `<div class="poster-ref">(${escapeHTML(posterRef)})</div>` : ''}
                                ${igChallenge ? `<div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-left: 3px solid #0066cc; border-radius: 4px; font-size: 0.95em; line-height: 1.5; color: #333;">${escapeHTML(igChallenge)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Add Teams Section with scores
            contentHTML += '<div id="teams-section-' + triviaNumber + '" class="teams-section">';
            contentHTML += '<div class="teams-section-header">';
            contentHTML += '<div>Teams That Played</div>';
            contentHTML += '<div class="caret"></div>';
            contentHTML += '</div>';
            contentHTML += '<div class="teams-section-content">';
            contentHTML += '<div class="teams-loading">Loading team data...</div>';
            contentHTML += '</div>';
            contentHTML += '</div>';
            
            infoContent.innerHTML = contentHTML;
            
            // Make the header clickable
            infoHeader.addEventListener('click', () => {
                infoSection.classList.toggle('expanded');
            });
            
            infoSection.appendChild(infoHeader);
            infoSection.appendChild(infoContent);
            
            // Load team data asynchronously
            loadTeamData(triviaNumber);
            
            return infoSection;
        }
        
        // Function to load and display team data for a trivia
        async function loadTeamData(triviaNumber) {
            try {
                // Get all grading sessions for this trivia number
                const allSessionsSnap = await db.ref('grading').once('value');
                if (!allSessionsSnap.exists()) {
                    updateTeamsSection(triviaNumber, []);
                    return;
                }
                
                const allSessions = allSessionsSnap.val();
                const relevantSessions = Object.entries(allSessions).filter(([sessionId, session]) => 
                    session.triviaNumber === triviaNumber
                );
                
                if (relevantSessions.length === 0) {
                    updateTeamsSection(triviaNumber, []);
                    return;
                }
                
                // Collect all teams from all sessions
                const allTeams = [];
                
                for (const [sessionId, session] of relevantSessions) {
                    if (!session.teams) continue;
                    
                    const sessionDate = session.date || '';
                    const sessionLocation = session.location || '';
                    
                    for (const [teamId, team] of Object.entries(session.teams)) {
                        // Calculate total score
                        let totalScore = 0;
                        
                        // Add round scores
                        for (let i = 1; i <= 10; i++) {
                            const roundKey = `round${i}`;
                            if (team[roundKey] && team[roundKey].total) {
                                totalScore += parseFloat(team[roundKey].total) || 0;
                            }
                        }
                        
                        // Add bonuses
                        totalScore += parseInt(team.igChallenge || 0);
                        totalScore += parseInt(team.teamNameBonus || 0);
                        totalScore += parseInt(team.finalChallenge || 0);
                        
                        // Add size penalty
                        const teamSize = team.size || 0;
                        if (teamSize > 6) {
                            totalScore += -2 * (teamSize - 5);
                        }
                        
                        allTeams.push({
                            name: team.name || 'Unknown Team',
                            score: totalScore.toFixed(2),
                            size: teamSize,
                            hasTeamNameBonus: team.teamNameBonus > 0,
                            sessionDate: sessionDate,
                            sessionLocation: sessionLocation
                        });
                    }
                }
                
                // Sort teams by score (descending)
                allTeams.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));
                
                updateTeamsSection(triviaNumber, allTeams);
                
            } catch (error) {
                console.error('Error loading team data:', error);
                updateTeamsSection(triviaNumber, [], true);
            }
        }
        
        // Function to update teams section with data
        function updateTeamsSection(triviaNumber, teams, hasError = false) {
            const teamsSection = document.getElementById(`teams-section-${triviaNumber}`);
            if (!teamsSection) return;
            
            const teamsContent = teamsSection.querySelector('.teams-section-content');
            if (!teamsContent) return;
            
            if (hasError) {
                teamsContent.innerHTML = '<div style="padding: 10px; color: #999;">Error loading team data</div>';
                return;
            }
            
            if (teams.length === 0) {
                teamsContent.innerHTML = '<div style="padding: 10px; color: #999;">No teams have played this trivia yet</div>';
                return;
            }
            
            // Store all teams for filtering
            window[`teamsData_${triviaNumber}`] = teams;
            
            // Get unique locations
            const locations = [...new Set(teams.map(t => t.sessionLocation).filter(Boolean))].sort();
            
            // Calculate totals first
            let totalPeople = 0;
            teams.forEach(team => {
                totalPeople += parseInt(team.size) || 0;
            });
            
            // Clear existing content
            teamsContent.innerHTML = '';
            
            // Create location filter dropdown if needed
            if (locations.length > 1) {
                const filterDiv = document.createElement('div');
                filterDiv.id = `location-filter-container-${triviaNumber}`;
                filterDiv.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; background: #f9f9f9;';
                filterDiv.innerHTML = `
                    <label style="font-size: 0.9em; color: #666; margin-right: 8px;">Filter by location:</label>
                    <select id="location-filter-${triviaNumber}" 
                            onchange="filterTeamsByLocation(${triviaNumber})" 
                            style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                        <option value="all">All Locations (${teams.length} teams)</option>
                        ${locations.map(loc => {
                            const count = teams.filter(t => t.sessionLocation === loc).length;
                            return `<option value="${escapeHTML(loc)}">${escapeHTML(loc)} (${count} teams)</option>`;
                        }).join('')}
                    </select>
                `;
                teamsContent.appendChild(filterDiv);
            }
            
            // Create header with tooltip and total
            const headerDiv = document.createElement('div');
            headerDiv.id = `teams-header-${triviaNumber}`;
            headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #e3f2fd; border-left: 3px solid #2196f3; font-size: 0.85em; color: #555; margin-bottom: 8px;';
            headerDiv.innerHTML = `
                <div>💡 <span style="color: #0066cc; font-weight: bold;">Blue team names</span> = earned Team Name Bonus Point</div>
                <div style="font-weight: bold; color: #333; margin-left: 15px; white-space: nowrap;">Total: ${teams.length} team${teams.length === 1 ? '' : 's'}, ${totalPeople} ${totalPeople === 1 ? 'person' : 'people'}</div>
            `;
            teamsContent.appendChild(headerDiv);
            
            // Create teams list container
            const teamsListDiv = document.createElement('div');
            teamsListDiv.id = `teams-list-${triviaNumber}`;
            
            teams.forEach((team, index) => {
                const teamNameClass = team.hasTeamNameBonus ? 'team-name-bonus' : '';
                const teamEntry = document.createElement('div');
                teamEntry.className = 'team-entry';
                teamEntry.setAttribute('data-location', team.sessionLocation || '');
                teamEntry.innerHTML = `
                    <div>
                        <span style="color: #999; margin-right: 8px;">#${index + 1}</span>
                        <span class="${teamNameClass}">${escapeHTML(team.name)}</span>
                        ${team.size ? `<span style="font-size: 0.85em; color: #999; margin-left: 6px;">(${team.size} ${team.size === 1 ? 'person' : 'people'})</span>` : ''}
                        ${team.sessionLocation ? `<span style="font-size: 0.9em; color: #666; margin-left: 8px;">@ ${escapeHTML(team.sessionLocation)}</span>` : ''}
                    </div>
                    <div class="team-score">${team.score}</div>
                `;
                teamsListDiv.appendChild(teamEntry);
            });
            
            teamsContent.appendChild(teamsListDiv);
            
            // Make the teams section header clickable
            const teamsHeader = teamsSection.querySelector('.teams-section-header');
            if (teamsHeader) {
                teamsHeader.addEventListener('click', () => {
                    teamsSection.classList.toggle('expanded');
                });
            }
        }
        
        // Function to filter teams by location
        function filterTeamsByLocation(triviaNumber) {
            const filterSelect = document.getElementById(`location-filter-${triviaNumber}`);
            if (!filterSelect) return;
            
            const selectedLocation = filterSelect.value;
            const allTeams = window[`teamsData_${triviaNumber}`] || [];
            
            // Filter teams based on selection
            const filteredTeams = selectedLocation === 'all' 
                ? allTeams 
                : allTeams.filter(team => team.sessionLocation === selectedLocation);
            
            // Calculate totals for filtered teams
            let totalPeople = 0;
            filteredTeams.forEach(team => {
                totalPeople += parseInt(team.size) || 0;
            });
            
            // Update the header with new totals
            const headerDiv = document.getElementById(`teams-header-${triviaNumber}`);
            if (headerDiv) {
                headerDiv.innerHTML = `
                    <div>💡 <span style="color: #0066cc; font-weight: bold;">Blue team names</span> = earned Team Name Bonus Point</div>
                    <div style="font-weight: bold; color: #333; margin-left: 15px; white-space: nowrap;">Total: ${filteredTeams.length} team${filteredTeams.length === 1 ? '' : 's'}, ${totalPeople} ${totalPeople === 1 ? 'person' : 'people'}</div>
                `;
            }
            
            // Re-render the teams list
            const teamsList = document.getElementById(`teams-list-${triviaNumber}`);
            if (!teamsList) return;
            
            // Clear the teams list
            teamsList.innerHTML = '';
            
            if (filteredTeams.length === 0) {
                const noTeamsDiv = document.createElement('div');
                noTeamsDiv.style.cssText = 'padding: 10px; color: #999;';
                noTeamsDiv.textContent = 'No teams found for this location';
                teamsList.appendChild(noTeamsDiv);
            } else {
                filteredTeams.forEach((team, index) => {
                    const teamNameClass = team.hasTeamNameBonus ? 'team-name-bonus' : '';
                    const teamEntry = document.createElement('div');
                    teamEntry.className = 'team-entry';
                    teamEntry.setAttribute('data-location', team.sessionLocation || '');
                    teamEntry.innerHTML = `
                        <div>
                            <span style="color: #999; margin-right: 8px;">#${index + 1}</span>
                            <span class="${teamNameClass}">${escapeHTML(team.name)}</span>
                            ${team.size ? `<span style="font-size: 0.85em; color: #999; margin-left: 6px;">(${team.size} ${team.size === 1 ? 'person' : 'people'})</span>` : ''}
                            ${team.sessionLocation ? `<span style="font-size: 0.9em; color: #666; margin-left: 8px;">@ ${escapeHTML(team.sessionLocation)}</span>` : ''}
                        </div>
                        <div class="team-score">${team.score}</div>
                    `;
                    teamsList.appendChild(teamEntry);
                });
            }
        }
        
        // Legacy functions for old archive view (kept for compatibility)
        function createTriviaCard(triviaNumber, triviaData) {
            // Get date from metadata, ensuring it's a string or default to empty string
            const triviaDate = triviaData.metadata && triviaData.metadata.date ? 
                (typeof triviaData.metadata.date === 'string' ? 
                    triviaData.metadata.date : 
                    String(triviaData.metadata.date)) 
                : '';
            
            // Create the card container
            const card = document.createElement('div');
            card.className = 'trivia-card';
            card.id = `trivia-${triviaNumber}`;
            
            // Create the card header
            const header = document.createElement('div');
            header.className = 'trivia-header';
            header.innerHTML = `
                <div class="trivia-number">Trivia #${triviaNumber}</div>
                <div class="trivia-date">${formatDate(triviaDate)}</div>
            `;
            
            // Create the rounds container
            const roundsContainer = document.createElement('div');
            roundsContainer.className = 'rounds-container';
            
            // Get drive data from allTriviaData if available
            const triviaFullData = allTriviaData.get(triviaNumber);
            const driveData = triviaFullData ? triviaFullData.drive : null;
            
            // Add Trivia Information section before rounds
            if (driveData) {
                const infoSection = createTriviaInfoSection(triviaNumber, driveData);
                roundsContainer.appendChild(infoSection);
            }
            
            // Check if trivia data exists
            if (!triviaData.trivia) {
                roundsContainer.innerHTML += '<p>No rounds data available for this trivia.</p>';
            } else {
                // Sort rounds by round number
                const rounds = Object.entries(triviaData.trivia)
                    .filter(([key, value]) => !isNaN(parseInt(key)) && typeof value === 'object')
                    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
                
                // Add rounds to the container
                rounds.forEach(([roundNumber, roundData]) => {
                    const roundElement = createRoundElement(triviaNumber, roundNumber, roundData);
                    roundsContainer.appendChild(roundElement);
                });
            }
            
            // Assemble the card
            card.appendChild(header);
            card.appendChild(roundsContainer);
            
            // Make header clickable to expand/collapse the whole trivia
            header.addEventListener('click', () => {
                const allRounds = card.querySelectorAll('.round');
                const allInfo = card.querySelectorAll('.trivia-info');
                const isExpanded = card.classList.contains('expanded');
                
                card.classList.toggle('expanded');
                
                // Expand or collapse all rounds and info sections within this trivia
                allRounds.forEach(round => {
                    if (isExpanded) {
                        round.classList.remove('expanded');
                    } else {
                        round.classList.add('expanded');
                    }
                });
                
                allInfo.forEach(info => {
                    if (isExpanded) {
                        info.classList.remove('expanded');
                    } else {
                        info.classList.add('expanded');
                    }
                });
            });
            
            return card;
        }
        
        // Create a round element
        function createRoundElement(triviaNumber, roundNumber, roundData) {
            // Get round name if available
            let roundName = `Round ${roundNumber}`;
            
            // Create the round element
            const roundElement = document.createElement('div');
            roundElement.className = 'round';
            roundElement.id = `trivia-${triviaNumber}-round-${roundNumber}`;
            
            // Create the round header
            const roundHeader = document.createElement('div');
            roundHeader.className = 'round-header';
            
            // Create the round content
            const roundContent = document.createElement('div');
            roundContent.className = 'round-content';
            
            // Get all formats in this round
            const formats = Object.keys(roundData).filter(key => 
                typeof roundData[key] === 'object' && key !== 'metadata'
            );
            
            // Check if there's metadata for this round
            if (roundData.metadata) {
                const metadata = roundData.metadata;
                if (metadata['Round Name']) {
                    roundName = metadata['Round Name'];
                }
                
                // Add round metadata section
                const metadataSection = document.createElement('div');
                metadataSection.className = 'metadata';
                
                let metadataHTML = '';
                
                // Add known metadata fields
                if (metadata['Round Name']) {
                    metadataHTML += `<div class="metadata-item"><span class="metadata-label">Round Name:</span> ${escapeHTML(metadata['Round Name'])}</div>`;
                }
                if (metadata['Round Type']) {
                    metadataHTML += `<div class="metadata-item"><span class="metadata-label">Round Type:</span> ${escapeHTML(metadata['Round Type'])}</div>`;
                }
                if (metadata['Round Instruction']) {
                    metadataHTML += `<div class="metadata-item"><span class="metadata-label">Round Instruction:</span> ${escapeHTML(metadata['Round Instruction'])}</div>`;
                }
                
                // Add any other metadata fields that might exist
                for (const [key, value] of Object.entries(metadata)) {
                    if (key !== 'Round Name' && key !== 'Round Type' && key !== 'Round Instruction') {
                        // Convert value to string representation even if it's not a string
                        const stringValue = typeof value === 'object' && value !== null 
                            ? JSON.stringify(value) 
                            : String(value);
                        metadataHTML += `<div class="metadata-item"><span class="metadata-label">${escapeHTML(key)}:</span> ${escapeHTML(stringValue)}</div>`;
                    }
                }
                
                if (metadataHTML) {
                    metadataSection.innerHTML = metadataHTML;
                    roundContent.appendChild(metadataSection);
                }
            }
            
            // Add formats to the round content
            formats.forEach(format => {
                const formatElement = createFormatElement(triviaNumber, roundNumber, format, roundData[format], roundName);
                roundContent.appendChild(formatElement);
            });
            
            // Set the round header content
            roundHeader.innerHTML = `
                <div class="round-name">${escapeHTML(roundName)}</div>
                <div class="caret"></div>
            `;
            
            // Make the header clickable
            roundHeader.addEventListener('click', () => {
                toggleExpandable(roundElement);
            });
            
            // Assemble the round element
            roundElement.appendChild(roundHeader);
            roundElement.appendChild(roundContent);
            
            return roundElement;
        }
        
        // Create a format element
        function createFormatElement(triviaNumber, roundNumber, format, formatData, roundName) {
            // Create the format element
            const formatElement = document.createElement('div');
            formatElement.className = 'format';
            formatElement.id = `trivia-${triviaNumber}-round-${roundNumber}-format-${format}`;
            
            // Format display name
            let formatDisplayName = format;
            
            // Check if format has a "Round Type" field that should be used instead
            if (formatData['Round Type']) {
                const roundType = formatData['Round Type'];
                formatDisplayName = typeof roundType === 'string' ? roundType : String(roundType);
            }
            
            // Create the format header with round name if available
            const formatHeader = document.createElement('div');
            formatHeader.className = 'format-header';
            const displayText = roundName 
                ? `${escapeHTML(formatDisplayName)} - ${escapeHTML(roundName)}`
                : escapeHTML(formatDisplayName);
            formatHeader.innerHTML = `
                <div class="format-name">${displayText}</div>
                <div class="caret"></div>
            `;
            
            // Create the format content
            const formatContent = document.createElement('div');
            formatContent.className = 'format-content';
            
            // Check for format-level instructions
            if (formatData['Round Instruction']) {
                const instruction = document.createElement('div');
                instruction.className = 'round-instruction';
                // Convert to string if not already a string
                const instructionText = typeof formatData['Round Instruction'] === 'string' 
                    ? formatData['Round Instruction'] 
                    : String(formatData['Round Instruction']);
                instruction.textContent = instructionText;
                formatContent.appendChild(instruction);
            }
            
            // Get all questions in this format
            const questions = Object.entries(formatData)
                .filter(([key, value]) => 
                    typeof value === 'object' && 
                    value !== null && 
                    !isNaN(parseInt(key)) && 
                    key !== 'metadata'
                )
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            // Add questions to the format content
            questions.forEach(([questionNumber, questionData]) => {
                const questionElement = createQuestionElement(questionNumber, questionData, format);
                formatContent.appendChild(questionElement);
            });
            
            // Make the header clickable
            formatHeader.addEventListener('click', () => {
                toggleExpandable(formatElement);
            });
            
            // Assemble the format element
            formatElement.appendChild(formatHeader);
            formatElement.appendChild(formatContent);
            
            return formatElement;
        }
        
        // Create a question element
        function createQuestionElement(questionNumber, questionData, format) {
            // Create the question container
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            
            // Create question header
            const questionHeader = document.createElement('div');
            questionHeader.className = 'question-header';
            questionHeader.textContent = `Question ${questionNumber}`;
            
            // Extract common fields
            const question = questionData.Question || questionData.question || '';
            const answer = questionData.Answer || questionData.answer || '';
            const imageLink = questionData['Image Link'] || questionData.image_link || '';
            const answerImageLink = questionData['Answer Image Link'] || questionData.answer_image_link || '';
            const musicClipLink = questionData['Music Clip Link'] || questionData.music_clip_link || '';
            
            // Ensure all values are strings
            const questionStr = typeof question === 'string' ? question : String(question);
            const answerStr = typeof answer === 'string' ? answer : String(answer);
            const imageLinkStr = typeof imageLink === 'string' ? imageLink : String(imageLink);
            const answerImageLinkStr = typeof answerImageLink === 'string' ? answerImageLink : String(answerImageLink);
            const musicClipLinkStr = typeof musicClipLink === 'string' ? musicClipLink : String(musicClipLink);
            
            // Create question content
            let questionHTML = `
                <div class="question-content">${escapeHTML(questionStr)}</div>
            `;
            
            // Add music player if there's a music clip
            if (musicClipLinkStr) {
                questionHTML += createMusicPlayer(musicClipLinkStr);
            }
            
            // Add question image if available
            if (imageLinkStr) {
                questionHTML += `
                    <div class="media-container">
                        ${createImagePreview(imageLinkStr, 'Question Image')}
                    </div>
                `;
            }
            
            // Add answer section
            questionHTML += `
                <div class="answer">
                    <div class="question-header">Answer</div>
                    <div class="question-content">${escapeHTML(answerStr)}</div>
                    ${answerImageLinkStr ? `
                        <div class="media-container">
                            ${createImagePreview(answerImageLinkStr, 'Answer Image')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Add metadata/tags
            const metadataFields = Object.entries(questionData).filter(([key, value]) => 
                key !== 'Question' && 
                key !== 'question' && 
                key !== 'Answer' && 
                key !== 'answer' && 
                key !== 'Image Link' && 
                key !== 'image_link' && 
                key !== 'Answer Image Link' && 
                key !== 'answer_image_link' && 
                key !== 'Music Clip Link' && 
                key !== 'music_clip_link' &&
                key !== 'id' &&
                key !== 'uid'
            );
            
            if (metadataFields.length > 0) {
                questionHTML += `<div class="question-meta">`;
                
                metadataFields.forEach(([key, value]) => {
                    // Check if value exists and convert non-string values to appropriate string representation
                    if (value !== null && value !== undefined) {
                        // Convert value to string representation based on its type
                        const stringValue = typeof value === 'object' && value !== null 
                            ? JSON.stringify(value) 
                            : String(value);
                        questionHTML += `<span class="tag">${escapeHTML(key)}: ${escapeHTML(stringValue)}</span>`;
                    }
                });
                
                questionHTML += `</div>`;
            }
            
            // Assemble the question element
            questionElement.appendChild(questionHeader);
            questionElement.innerHTML += questionHTML;
            
            return questionElement;
        }
        
        // Load trivia data
        async function loadTriviaData(limit = 10) {
            if (isLoading || !hasMoreData) return;
            
            isLoading = true;
            archiveLoading.style.display = 'flex';
            loadMoreBtn.disabled = true;
            
            try {
                let query = db.ref('trivia-archive/archive')
                    .orderByKey()
                    .limitToLast(limit);
                
                if (lastTrivia) {
                    query = query.endBefore(lastTrivia);
                }
                
                const snapshot = await query.once('value');
                const data = snapshot.val();
                
                // Handle no data
                if (!data) {
                    archiveLoading.style.display = 'none';
                    loadMoreBtn.disabled = false;
                    isLoading = false;
                    
                    if (!lastTrivia) {
                        archiveList.innerHTML = '<p class="no-results">No trivia data found in the archive.</p>';
                    }
                    
                    hasMoreData = false;
                    loadMoreBtn.style.display = 'none';
                    return;
                }
                
                // Sort by trivia number (descending)
                const sortedTrivia = Object.entries(data)
                    .sort((a, b) => parseInt(b[0]) - parseInt(a[0]));
                
                // Track the last trivia number for pagination
                if (sortedTrivia.length > 0) {
                    lastTrivia = sortedTrivia[sortedTrivia.length - 1][0];
                }
                
                // Create trivia cards
                sortedTrivia.forEach(([triviaNumber, triviaData]) => {
                    const triviaCard = createTriviaCard(triviaNumber, triviaData);
                    archiveList.appendChild(triviaCard);
                });
                
                // Check if we've reached the end
                if (sortedTrivia.length < limit) {
                    hasMoreData = false;
                    loadMoreBtn.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading trivia data:', error);
                archiveList.innerHTML += `<p class="error">Error loading trivia data: ${error.message}</p>`;
            } finally {
                archiveLoading.style.display = 'none';
                loadMoreBtn.disabled = false;
                isLoading = false;
            }
        }
        
        // Event listeners
        loadMoreBtn.addEventListener('click', () => {
            loadTriviaData(itemsPerPage);
        });
        
        itemsPerPageSelect.addEventListener('change', () => {
            itemsPerPage = parseInt(itemsPerPageSelect.value);
        });
        
        expandAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.trivia-card').forEach(card => {
                card.classList.add('expanded');
                
                // Expand all rounds and formats within this trivia
                card.querySelectorAll('.round, .format').forEach(element => {
                    element.classList.add('expanded');
                });
            });
        });
        
        collapseAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.trivia-card, .round, .format').forEach(element => {
                element.classList.remove('expanded');
            });
        });
        
        // Check if user is admin or has tools access
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    // Get user data
                    const snapshot = await db.ref(`users/${user.uid}`).once('value');
                    const userData = snapshot.val() || {};
                    
                    // Check for admin or tools role
                    const isAdmin = 
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin')) ||
                        (userData.role === 'admin');
                    
                    const hasToolsAccess =
                        (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('tools')) ||
                        (userData.role === 'tools');
                    
                    if (isAdmin || hasToolsAccess) {
                        // User has appropriate access, show archive interface
                        authScreen.classList.add('hidden');
                        archiveScreen.classList.remove('hidden');
                        viewToolbar.classList.remove('hidden');
                        
                        // Initialize toolbar
                        initializeToolbar();
                        
                        // Start with Full Archive mode
                        switchViewMode('full-archive');
                    } else {
                        // User does not have access
                        authScreen.classList.remove('hidden');
                        archiveScreen.classList.add('hidden');
                        viewToolbar.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    authScreen.classList.remove('hidden');
                    archiveScreen.classList.add('hidden');
                    viewToolbar.classList.add('hidden');
                }
            } else {
                // User is not signed in
                authScreen.classList.remove('hidden');
                archiveScreen.classList.add('hidden');
                viewToolbar.classList.add('hidden');
            }
        });
    </script>
</body>
</html> 
</html> 
</html> 