<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Trivia Scores</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Trivia Questions and Scores</h1>
  <label for="dateInput">Select Date:</label>
  <input type="date" id="dateInput" />
  <button onclick="fetchAndDisplayData()">Load Data</button>
  
  <table border="1" id="resultsTable" style="margin-top: 20px; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Round Number</th>
        <th>Round Type</th>
        <th>Question Number</th>
        <th>Question</th>
        <th>Answer</th>
        <th>Score Correct</th>
        <th>Total Possible</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBy8ExrgvBDto-BcNhlvrcC6ZB9G7HNaWE",
      authDomain: "eviltriviagrading.firebaseapp.com",
      databaseURL: "https://eviltriviagrading-default-rtdb.firebaseio.com",
      projectId: "eviltriviagrading",
      storageBucket: "eviltriviagrading.firebasestorage.app",
      messagingSenderId: "738486013114",
      appId: "1:738486013114:web:fe0f480cc3f66f42d6c683"
    };

    firebase.initializeApp(firebaseConfig);

    async function fetchAndDisplayData() {
      const selectedDate = document.getElementById("dateInput").value;
      if (!selectedDate) {
        alert("Please select a date first!");
        return;
      }

      const db = firebase.database();
      const triviaRef = db.ref("trivia/" + selectedDate);
      const scoresRef = db.ref("scores/" + selectedDate);

      const triviaData = (await triviaRef.get()).val();
      const scoresData = (await scoresRef.get()).val();

      if (!triviaData || !scoresData) {
        alert("No data found for this date.");
        return;
      }

      const allQuestions = parseTriviaData(triviaData);
      const aggregatedScores = aggregateScores(allQuestions, scoresData);
      displayResults(aggregatedScores);
    }

    function parseTriviaData(triviaData) {
      let results = [];
      Object.keys(triviaData).forEach(roundIndex => {
        const roundObj = triviaData[roundIndex];
        Object.keys(roundObj).forEach(roundType => {
          const questionSet = roundObj[roundType];
          Object.keys(questionSet).forEach(qKey => {
            const qData = questionSet[qKey];
            results.push({
              roundIndex,
              roundType,
              questionKey: qKey,
              questionText: qData.question,
              answerText: qData.answer,
              totalPossiblePoints: qData.total_possible_points || 0
            });
          });
        });
      });
      return results;
    }

    function aggregateScores(allQuestions, scoresData) {
      let scoreSums = {};
      let teamCounts = {};
      Object.keys(scoresData).forEach(teamId => {
        const teamScores = scoresData[teamId].scores;
        teamScores.forEach((roundScores, rIndex) => {
          if (!roundScores) return;
          Object.keys(roundScores).forEach(qKey => {
            const compositeKey = rIndex + "~" + qKey;
            scoreSums[compositeKey] = (scoreSums[compositeKey] || 0) + roundScores[qKey];
            teamCounts[compositeKey] = (teamCounts[compositeKey] || 0) + 1;
          });
        });
      });
      return allQuestions.map(q => {
        const compositeKey = q.roundIndex + "~" + q.questionKey;
        return {
          ...q,
          totalScore: scoreSums[compositeKey] || 0,
          totalPossible: q.totalPossiblePoints * (teamCounts[compositeKey] || 1)
        };
      });
    }

    function displayResults(aggregated) {
      const tbody = document.getElementById("resultsTable").querySelector("tbody");
      tbody.innerHTML = "";
      aggregated.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.roundIndex}</td>
          <td>${row.roundType}</td>
          <td>${row.questionKey}</td>
          <td>${row.questionText}</td>
          <td>${row.answerText}</td>
          <td>${row.totalScore}</td>
          <td>${row.totalPossible}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
