<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Free Drinkle</title>
  <script src="/js/components/autoload-banner.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      margin-top: 60px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .game-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    
    .question {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .answer-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 30px;
    }
    
    .answer-input-container {
      display: flex;
      width: 100%;
      max-width: 300px;
      align-items: center;
      gap: 10px;
    }
    
    .answer-input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }
    
    .unit-label {
      font-weight: bold;
      color: #666;
    }
    
    .submit-btn {
      padding: 12px 30px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .submit-btn:hover {
      background-color: #333;
    }
    
    .result {
      margin-top: 30px;
      text-align: center;
      font-size: 18px;
      display: none;
    }
    
    .percentile {
      font-weight: bold;
      font-size: 24px;
      color: #000;
    }
    
    .copyable-result {
      margin: 20px auto;
      max-width: 400px;
      padding: 15px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      position: relative;
    }
    
    .copy-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 3px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .copy-button:hover {
      background-color: #ddd;
    }
    
    .question-title {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 30px;
      font-size: 18px;
    }
    
    .no-question {
      text-align: center;
      padding: 30px;
      font-size: 18px;
      color: #666;
    }
    
    .emoji {
      font-size: 32px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Free Drinkle</h1>
    
    <div class="game-card" id="gameContainer">
      <div id="loadingMessage" class="loading">
        Loading question...
      </div>
      
      <div id="noQuestionMessage" class="no-question" style="display: none;">
        <div class="emoji">üçπ</div>
        <p>There's no active Free Drinkle question at the moment. Please check back later!</p>
      </div>
      
      <div id="questionContainer" style="display: none;">
        <div id="questionTitle" class="question-title"></div>
        <div id="questionText" class="question"></div>
        
        <form id="answerForm" class="answer-form">
          <div class="answer-input-container">
            <input type="number" id="answerInput" class="answer-input" required step="any" min="0">
            <span id="unitLabel" class="unit-label"></span>
          </div>
          <button type="submit" class="submit-btn">Submit Answer</button>
        </form>
        
        <div id="resultContainer" class="result">
          <div class="emoji" id="resultEmoji">üéâ</div>
          <p>Your answer places you in the <span id="percentileValue" class="percentile">0th</span> percentile of all guesses!</p>
          <p id="resultMessage"></p>
          
          <div class="copyable-result" id="copyableResult">
            <button class="copy-button" id="copyButton">Copy</button>
            <div id="copyText">
              Your answer was <span id="percentOffValue">0%</span> off from the actual answer.<br><br>
              That places you in the <span id="percentileValueCopy">0th</span> percentile of guessers today!
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
        authDomain: "eviltrivia-47664.firebaseapp.com",
        databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
        projectId: "eviltrivia-47664",
        storageBucket: "eviltrivia-47664.appspot.com",
        messagingSenderId: "401826818140",
        appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
        measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    // DOM elements
    const loadingMessage = document.getElementById('loadingMessage');
    const noQuestionMessage = document.getElementById('noQuestionMessage');
    const questionContainer = document.getElementById('questionContainer');
    const questionTitle = document.getElementById('questionTitle');
    const questionText = document.getElementById('questionText');
    const answerForm = document.getElementById('answerForm');
    const answerInput = document.getElementById('answerInput');
    const unitLabel = document.getElementById('unitLabel');
    const resultContainer = document.getElementById('resultContainer');
    const percentileValue = document.getElementById('percentileValue');
    const percentileValueCopy = document.getElementById('percentileValueCopy');
    const percentOffValue = document.getElementById('percentOffValue');
    const resultMessage = document.getElementById('resultMessage');
    const resultEmoji = document.getElementById('resultEmoji');
    const copyButton = document.getElementById('copyButton');
    const copyText = document.getElementById('copyText');
    
    // Game state
    let currentQuestion = null;
    let currentUserId = null;
    let hasAnswered = false;
    
    // Copy functionality
    copyButton.addEventListener('click', () => {
      const textToCopy = copyText.innerText;
      navigator.clipboard.writeText(textToCopy)
        .then(() => {
          copyButton.textContent = 'Copied!';
          setTimeout(() => {
            copyButton.textContent = 'Copy';
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy text: ', err);
        });
    });
    
    // Check if user is logged in
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
      } else {
        currentUserId = null;
      }
      
      // Load the active question
      loadActiveQuestion();
    });
    
    // Load the active question from Firebase
    async function loadActiveQuestion() {
      try {
        const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
        
        onValue(activeQuestionRef, async (snapshot) => {
          const activeQuestionId = snapshot.val();
          
          if (!activeQuestionId) {
            // No active question
            loadingMessage.style.display = 'none';
            noQuestionMessage.style.display = 'block';
            questionContainer.style.display = 'none';
            return;
          }
          
          // Get the question details
          const questionRef = ref(db, `games/drinkle/questions/${activeQuestionId}`);
          const questionSnapshot = await get(questionRef);
          currentQuestion = questionSnapshot.val();
          
          if (!currentQuestion) {
            // Question not found
            loadingMessage.style.display = 'none';
            noQuestionMessage.style.display = 'block';
            questionContainer.style.display = 'none';
            return;
          }
          
          // Display the question
          questionText.textContent = currentQuestion.question;
          unitLabel.textContent = currentQuestion.unit;
          
          // Display the title if available
          if (currentQuestion.title) {
            questionTitle.textContent = currentQuestion.title;
            questionTitle.style.display = 'block';
          } else {
            questionTitle.style.display = 'none';
          }
          
          // Check if user has already answered
          if (currentUserId) {
            const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
            const answersSnapshot = await get(answersRef);
            const answers = answersSnapshot.val() || {};
            
            // Check if this user has already answered
            if (Object.values(answers).some(answer => answer.userId === currentUserId)) {
              hasAnswered = true;
              
              // Get their answer and show result
              for (const key in answers) {
                if (answers[key].userId === currentUserId) {
                  showPercentileResult(parseFloat(answers[key].answer), answers);
                  break;
                }
              }
            } else {
              hasAnswered = false;
              resultContainer.style.display = 'none';
            }
          }
          
          // Show question and hide loading
          loadingMessage.style.display = 'none';
          noQuestionMessage.style.display = 'none';
          questionContainer.style.display = 'block';
        });
      } catch (error) {
        console.error("Error loading question:", error);
        loadingMessage.style.display = 'none';
        noQuestionMessage.style.display = 'block';
        noQuestionMessage.innerHTML = `
          <div class="emoji">üòû</div>
          <p>Error loading question: ${error.message}</p>
          <p>Please try refreshing the page or contact support if the issue persists.</p>
        `;
      }
    }
    
    // Handle form submission
    answerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (hasAnswered) {
        alert("You've already submitted an answer for this question!");
        return;
      }
      
      const answer = parseFloat(answerInput.value);
      
      if (isNaN(answer) || answer < 0) {
        alert("Please enter a valid number");
        return;
      }
      
      try {
        // Get current answers
        const activeQuestionId = currentQuestion.id;
        const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
        const answersSnapshot = await get(answersRef);
        const answers = answersSnapshot.val() || {};
        
        // Generate a unique ID if user is not logged in
        const userId = currentUserId || ('anonymous_' + Date.now() + '_' + Math.floor(Math.random() * 10000));
        
        // Add new answer
        const newAnswerRef = push(answersRef);
        await set(newAnswerRef, {
          userId: userId,
          answer: answer,
          timestamp: Date.now()
        });
        
        // Update answers with the new one
        answers[newAnswerRef.key] = {
          userId: userId,
          answer: answer
        };
        
        // Show the percentile
        showPercentileResult(answer, answers);
        
        // Mark as answered
        hasAnswered = true;
        
        // Store in localStorage to prevent multiple submissions
        localStorage.setItem(`drinkle_answered_${activeQuestionId}`, 'true');
      } catch (error) {
        console.error("Error submitting answer:", error);
        
        // Try submitting to a public path if we get a permission error
        if (error.message && error.message.includes("permission_denied")) {
          try {
            // Try using a different path that allows anonymous writes
            const activeQuestionId = currentQuestion.id;
            const publicAnswersRef = ref(db, `publicAnswers/drinkle/${activeQuestionId}`);
            
            // Generate a unique anonymous ID
            const anonymousId = 'anon_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            // Add new answer to public path
            const newAnswerRef = push(publicAnswersRef);
            await set(newAnswerRef, {
              userId: anonymousId,
              answer: answer,
              timestamp: Date.now()
            });
            
            // Get all answers to calculate percentile
            const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
            const answersSnapshot = await get(answersRef);
            let answers = answersSnapshot.val() || {};
            
            // Add our new answer to the local calculation
            answers[newAnswerRef.key] = {
              userId: anonymousId,
              answer: answer
            };
            
            // Show the percentile
            showPercentileResult(answer, answers);
            
            // Mark as answered
            hasAnswered = true;
            
            // Store in localStorage to prevent multiple submissions
            localStorage.setItem(`drinkle_answered_${activeQuestionId}`, 'true');
          } catch (secondError) {
            console.error("Second error submitting answer:", secondError);
            alert("Error submitting your answer. Please try again or contact support.");
          }
        } else {
          alert("Error submitting your answer. Please try again.");
        }
      }
    });
    
    // Show percentile result
    function showPercentileResult(userAnswer, allAnswers) {
      const answers = Object.values(allAnswers);
      const sortedAnswers = answers.map(a => parseFloat(a.answer)).sort((a, b) => a - b);
      
      // Find position of user's answer
      const correctAnswer = parseFloat(currentQuestion.answer);
      const userIndex = sortedAnswers.findIndex(a => a === userAnswer);
      
      // Calculate percentile (0-100)
      const percentile = Math.round((userIndex / (sortedAnswers.length - 1)) * 100);
      
      // Calculate how close to the correct answer
      const percentDifference = Math.abs((userAnswer - correctAnswer) / correctAnswer * 100);
      const percentOff = percentDifference.toFixed(1);
      
      // Show result
      percentileValue.textContent = `${percentile}th`;
      percentileValueCopy.textContent = `${percentile}th`;
      percentOffValue.textContent = `${percentOff}%`;
      
      // Get custom message based on percentile if available, or use default messages
      let customMessage = "";
      
      if (currentQuestion.customMessages && Array.isArray(currentQuestion.customMessages)) {
        // Sort messages by threshold (highest first)
        const sortedMessages = [...currentQuestion.customMessages].sort((a, b) => b.threshold - a.threshold);
        
        // Find the first message with a threshold below the user's percentile
        for (const message of sortedMessages) {
          if (percentile >= message.threshold) {
            customMessage = message.text;
            break;
          }
        }
      }
      
      // Use custom message if available, otherwise use default messages
      if (customMessage) {
        resultMessage.textContent = customMessage;
      } else {
        // Determine emoji and message based on accuracy
        if (percentDifference <= 5) {
          resultEmoji.textContent = 'üéØ';
          resultMessage.textContent = "Amazing! Your answer is extremely close to the correct answer!";
        } else if (percentDifference <= 15) {
          resultEmoji.textContent = 'üî•';
          resultMessage.textContent = "Great job! Your answer is very close to the correct value!";
        } else if (percentDifference <= 30) {
          resultEmoji.textContent = 'üëç';
          resultMessage.textContent = "Not bad! You're in the ballpark of the correct answer.";
        } else if (percentDifference <= 50) {
          resultEmoji.textContent = 'ü§î';
          resultMessage.textContent = "Your guess is somewhat off from the correct answer.";
        } else {
          resultEmoji.textContent = 'üòÖ';
          resultMessage.textContent = "Your guess is quite far from the correct answer. Better luck next time!";
        }
      }
      
      // Show result
      resultContainer.style.display = 'block';
      
      // Disable form
      answerInput.disabled = true;
      answerForm.querySelector('button').disabled = true;
    }
  </script>
</body>
</html> 