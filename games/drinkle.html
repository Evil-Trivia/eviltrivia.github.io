<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Free Drinkle</title>
  <script src="/js/components/autoload-banner.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      margin-top: 60px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      color: #555;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .subtitle a {
      color: #000;
      text-decoration: underline;
      font-weight: bold;
    }
    
    .subtitle a:hover {
      color: #333;
    }

    .game-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
      position: relative;
    }
    
    .question {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .answer-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 30px;
    }
    
    .answer-input-container {
      display: flex;
      width: 100%;
      max-width: 300px;
      align-items: center;
      gap: 10px;
    }
    
    .answer-input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }
    
    .unit-label {
      font-weight: bold;
      color: #666;
    }
    
    .submit-btn {
      padding: 12px 30px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .submit-btn:hover {
      background-color: #333;
    }
    
    .result {
      margin-top: 30px;
      text-align: center;
      font-size: 18px;
      display: none;
    }
    
    .percentile {
      font-weight: bold;
      font-size: 24px;
      color: #000;
    }
    
    .copyable-result {
      margin: 20px auto;
      max-width: 400px;
      padding: 20px;
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 8px;
      text-align: left;
      position: relative;
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .copy-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .copy-button:hover {
      background-color: #ddd;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .question-title {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 30px;
      font-size: 18px;
    }
    
    .no-question {
      text-align: center;
      padding: 30px;
      font-size: 18px;
      color: #666;
    }
    
    .emoji {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    /* Info icon styling */
    .info-icon {
      display: inline-block;
      width: 22px;
      height: 22px;
      background-color: #28a745;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 22px;
      font-size: 14px;
      font-weight: bold;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    /* Help popup styling */
    .help-button {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 30px;
      height: 30px;
      background-color: #007bff;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
      z-index: 10; /* Ensure button is on top */
    }
    
    .help-button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
      box-shadow: 0 3px 6px rgba(0,0,0,0.25);
    }
    
    .help-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    
    .help-popup {
      background-color: white;
      max-width: 500px;
      width: 90%;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .help-popup h3 {
      margin-top: 0;
      color: #333;
    }
    
    .help-popup p {
      color: #555;
      line-height: 1.5;
    }
    
    .close-button {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 24px;
      height: 24px;
      background-color: #f0f0f0;
      color: #333;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-button:hover {
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Free Drinkle</h1>
    <div class="subtitle">
      In the style of Evil Trivia's Free Drink Question<br>
      Want to play in-person? <a href="https://eviltrivia.com/live/">Click here</a>
    </div>
    
    <div class="game-card" id="gameContainer">
      <!-- Help button and popup -->
      <div class="help-button" id="helpButton">?</div>
      
      <div class="help-overlay" id="helpOverlay">
        <div class="help-popup">
          <div class="close-button" id="closeHelpButton">‚úï</div>
          <h3>About Free Drink Questions</h3>
          <p>At Evil Trivia, we ask "Free Drink Questions", questions that always have a number as an answer and always are impossible to truly <em>know</em>. But! Everyone gets a guess. And whoever is closest to the right number gets a free drink token.</p>
          <p>We can't give you a free drink virtually, but if you get close, feel free to celebrate with a cold one. Or a hot one. We don't know what you like. Freak.</p>
        </div>
      </div>
      
      <div id="loadingMessage" class="loading">
        Loading question...
      </div>
      
      <div id="noQuestionMessage" class="no-question" style="display: none;">
        <div class="emoji">üçπ</div>
        <p>There's no active Free Drinkle question at the moment. Please check back later!</p>
      </div>
      
      <div id="questionContainer" style="display: none;">
        <div id="questionTitle" class="question-title"></div>
        <div id="questionText" class="question"></div>
        
        <form id="answerForm" class="answer-form">
          <div class="answer-input-container">
            <input type="number" id="answerInput" class="answer-input" required step="any" min="0">
            <span id="unitLabel" class="unit-label"></span>
          </div>
          <button type="submit" class="submit-btn">Submit Answer</button>
        </form>
        
        <div id="resultContainer" class="result">
          <div class="emoji" id="resultEmoji">üéâ</div>
          <p>Your answer places you in the <span id="percentileValue" class="percentile">0th</span> percentile of all guesses!</p>
          <p id="resultMessage"></p>
          
          <div class="emoji-boxes" style="margin: 15px 0; text-align: center; font-size: 20px;">
            <div style="margin-bottom: 5px;">Accuracy: <span id="accuracyBoxesDisplay">‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú</span></div>
            <div>Percentile: <span id="percentileBoxesDisplay">‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú</span></div>
          </div>
          
          <div style="margin: 20px 0; padding: 15px; background-color: #f0f0f0; border-radius: 8px; font-size: 16px;">
            <p><strong>Your answer:</strong> <span id="userAnswerDisplay"></span> <span id="unitDisplay"></span></p>
            <p><strong>Correct answer:</strong> <span id="correctAnswerDisplay"></span> <span id="unitDisplay2"></span></p>
          </div>
          
          <p style="margin: 15px 0; font-style: italic; color: #666;">Keep checking back to see how your score compares as more people answer!</p>
          
          <!-- Notes section - only shown if provided -->
          <div id="notesSection" style="margin: 20px 0; display: none; padding: 15px; background-color: #f8f8f8; border-radius: 8px; border-left: 4px solid #28a745;">
            <div style="display: flex; align-items: flex-start;">
              <span class="info-icon">i</span>
              <div id="notesContent" style="line-height: 1.5;"></div>
            </div>
          </div>
          
          <div class="copyable-result" id="copyableResult">
            <button class="copy-button" id="copyButton">Copy</button>
            <div id="copyText"></div>
          </div>
          <p id="comeBackMessage" style="margin-top: 20px; font-style: italic; color: #666;"></p>
        </div>
      </div>
    </div>
  </div>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    
    // Initialize help button as soon as DOM is ready
    document.addEventListener('DOMContentLoaded', initializeHelpButton);
    
    function initializeHelpButton() {
      const helpButton = document.getElementById('helpButton');
      const helpOverlay = document.getElementById('helpOverlay');
      const closeHelpButton = document.getElementById('closeHelpButton');
      
      if (helpButton && helpOverlay && closeHelpButton) {
        console.log("Help elements found and initialized");
        
        helpButton.addEventListener('click', () => {
          console.log("Help button clicked!");
          helpOverlay.style.display = 'flex';
        });
        
        closeHelpButton.addEventListener('click', () => {
          console.log("Close button clicked!");
          helpOverlay.style.display = 'none';
        });
        
        // Close help when clicking outside the popup
        helpOverlay.addEventListener('click', (e) => {
          if (e.target === helpOverlay) {
            console.log("Clicked outside popup, closing");
            helpOverlay.style.display = 'none';
          }
        });
      } else {
        console.error("Help elements not found:", { 
          helpButton: !!helpButton, 
          helpOverlay: !!helpOverlay, 
          closeHelpButton: !!closeHelpButton 
        });
      }
    }
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
        authDomain: "eviltrivia-47664.firebaseapp.com",
        databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
        projectId: "eviltrivia-47664",
        storageBucket: "eviltrivia-47664.appspot.com",
        messagingSenderId: "401826818140",
        appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
        measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
      loadingMessage.innerHTML = `
        <div class="emoji">üòû</div>
        <p>Error initializing Firebase: ${error.message}</p>
        <p>Please try refreshing the page.</p>
      `;
    }
    
    // DOM elements
    const loadingMessage = document.getElementById('loadingMessage');
    const noQuestionMessage = document.getElementById('noQuestionMessage');
    const questionContainer = document.getElementById('questionContainer');
    const questionTitle = document.getElementById('questionTitle');
    const questionText = document.getElementById('questionText');
    const answerForm = document.getElementById('answerForm');
    const answerInput = document.getElementById('answerInput');
    const unitLabel = document.getElementById('unitLabel');
    const resultContainer = document.getElementById('resultContainer');
    const percentileValue = document.getElementById('percentileValue');
    const percentOffValue = document.getElementById('percentOffValue') || document.createElement('span'); // May not exist in DOM anymore
    const resultMessage = document.getElementById('resultMessage');
    const resultEmoji = document.getElementById('resultEmoji');
    const copyButton = document.getElementById('copyButton');
    const copyText = document.getElementById('copyText');
    const comeBackMessage = document.getElementById('comeBackMessage');
    const accuracyBoxesDisplay = document.getElementById('accuracyBoxesDisplay');
    const percentileBoxesDisplay = document.getElementById('percentileBoxesDisplay');
    const notesSection = document.getElementById('notesSection');
    const notesContent = document.getElementById('notesContent');
    
    // Game state
    let currentQuestion = null;
    let currentUserId = null;
    let hasAnswered = false;
    
    // Copy functionality
    copyButton.addEventListener('click', () => {
      const textToCopy = copyText.innerText;
      navigator.clipboard.writeText(textToCopy)
        .then(() => {
          copyButton.textContent = 'Copied!';
          setTimeout(() => {
            copyButton.textContent = 'Copy';
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy text: ', err);
        });
    });
    
    // Check if user is logged in
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
      } else {
        currentUserId = null;
      }
      
      // Load the active question
      loadActiveQuestion();
    });
    
    // Check if user has already answered
    async function checkPreviousAnswer(activeQuestionId) {
      // First check for logged-in users
      if (currentUserId) {
        const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
        const answersSnapshot = await get(answersRef);
        const answers = answersSnapshot.val() || {};
        
        // Check if this user has already answered
        if (Object.values(answers).some(answer => answer.userId === currentUserId)) {
          hasAnswered = true;
          
          // Get their answer and show result with all current answers (for updated percentile)
          for (const key in answers) {
            if (answers[key].userId === currentUserId) {
              showPercentileResult(parseFloat(answers[key].answer), answers, true);
              break;
            }
          }
          return true;
        }
      }
      
      // Then check localStorage for anonymous users
      const hasAnsweredLocally = localStorage.getItem(`drinkle_answered_${activeQuestionId}`) === 'true';
      if (hasAnsweredLocally) {
        const storedAnswer = localStorage.getItem(`drinkle_answer_${activeQuestionId}`);
        if (storedAnswer) {
          hasAnswered = true;
          
          // Get all current answers to calculate updated percentile
          const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
          const answersSnapshot = await get(answersRef);
          const answers = answersSnapshot.val() || {};
          
          // Show result with the stored answer and all current answers
          showPercentileResult(parseFloat(storedAnswer), answers, true);
          return true;
        }
      }
      
      hasAnswered = false;
      resultContainer.style.display = 'none';
      return false;
    }
    
    // Load the active question from Firebase
    async function loadActiveQuestion() {
      try {
        if (!db) {
          throw new Error("Database connection not established");
        }
        
        console.log("Starting to load active question");
        const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
        
        onValue(activeQuestionRef, async (snapshot) => {
          try {
            console.log("Active question data received");
            const activeQuestionId = snapshot.val();
            
            if (!activeQuestionId) {
              // No active question
              console.log("No active question found");
              loadingMessage.style.display = 'none';
              noQuestionMessage.style.display = 'block';
              questionContainer.style.display = 'none';
              return;
            }
            
            console.log("Active question ID:", activeQuestionId);
            
            // Get the question details
            const questionRef = ref(db, `games/drinkle/questions/${activeQuestionId}`);
            const questionSnapshot = await get(questionRef);
            currentQuestion = questionSnapshot.val();
            
            if (!currentQuestion) {
              // Question not found
              console.error("Question not found with ID:", activeQuestionId);
              loadingMessage.style.display = 'none';
              noQuestionMessage.style.display = 'block';
              noQuestionMessage.innerHTML = `
                <div class="emoji">üòû</div>
                <p>Question not found. The active question may have been deleted.</p>
              `;
              questionContainer.style.display = 'none';
              return;
            }
            
            console.log("Question details loaded:", currentQuestion.title || currentQuestion.question.substring(0, 30));
            
            // Ensure ID is set on the question object
            currentQuestion.id = activeQuestionId;
            
            // Display the question
            questionText.textContent = currentQuestion.question;
            unitLabel.textContent = currentQuestion.unit;
            
            // Display the title if available
            if (currentQuestion.title) {
              questionTitle.textContent = currentQuestion.title;
              questionTitle.style.display = 'block';
            } else {
              questionTitle.style.display = 'none';
            }
            
            // Check if user has already answered
            await checkPreviousAnswer(activeQuestionId);
            
            // Show question and hide loading
            loadingMessage.style.display = 'none';
            noQuestionMessage.style.display = 'none';
            questionContainer.style.display = 'block';
          } catch (innerError) {
            console.error("Error in onValue callback:", innerError);
            loadingMessage.style.display = 'none';
            noQuestionMessage.style.display = 'block';
            noQuestionMessage.innerHTML = `
              <div class="emoji">üòû</div>
              <p>Error loading question: ${innerError.message}</p>
              <p>Please try refreshing the page.</p>
            `;
          }
        }, (error) => {
          console.error("onValue error:", error);
          loadingMessage.style.display = 'none';
          noQuestionMessage.style.display = 'block';
          noQuestionMessage.innerHTML = `
            <div class="emoji">üòû</div>
            <p>Error listening for question updates: ${error.message}</p>
            <p>Please try refreshing the page.</p>
          `;
        });
      } catch (error) {
        console.error("Error in loadActiveQuestion:", error);
        loadingMessage.style.display = 'none';
        noQuestionMessage.style.display = 'block';
        noQuestionMessage.innerHTML = `
          <div class="emoji">üòû</div>
          <p>Error loading question: ${error.message}</p>
          <p>Please try refreshing the page or contact support if the issue persists.</p>
        `;
      }
    }
    
    // Handle form submission
    answerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (hasAnswered) {
        alert("You've already submitted an answer for this question!");
        return;
      }
      
      const answer = parseFloat(answerInput.value);
      
      if (isNaN(answer) || answer < 0) {
        alert("Please enter a valid number");
        return;
      }
      
      try {
        // Get current answers
        const activeQuestionId = currentQuestion.id;
        const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
        const answersSnapshot = await get(answersRef);
        const answers = answersSnapshot.val() || {};
        
        // Generate a unique ID if user is not logged in
        const userId = currentUserId || ('anonymous_' + Date.now() + '_' + Math.floor(Math.random() * 10000));
        
        // Add new answer
        const newAnswerRef = push(answersRef);
        await set(newAnswerRef, {
          userId: userId,
          answer: answer,
          timestamp: Date.now()
        });
        
        // Update answers with the new one
        answers[newAnswerRef.key] = {
          userId: userId,
          answer: answer
        };
        
        // Show the percentile
        showPercentileResult(answer, answers);
        
        // Mark as answered
        hasAnswered = true;
        
        // Store in localStorage to prevent multiple submissions and store the user's answer
        localStorage.setItem(`drinkle_answered_${activeQuestionId}`, 'true');
        localStorage.setItem(`drinkle_answer_${activeQuestionId}`, answer.toString());
      } catch (error) {
        console.error("Error submitting answer:", error);
        
        // Try submitting to a public path if we get a permission error
        if (error.message && error.message.includes("permission_denied")) {
          try {
            // Try using a different path that allows anonymous writes
            const activeQuestionId = currentQuestion.id;
            const publicAnswersRef = ref(db, `publicAnswers/drinkle/${activeQuestionId}`);
            
            // Generate a unique anonymous ID
            const anonymousId = 'anon_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            // Add new answer to public path
            const newAnswerRef = push(publicAnswersRef);
            await set(newAnswerRef, {
              userId: anonymousId,
              answer: answer,
              timestamp: Date.now()
            });
            
            // Get all answers to calculate percentile
            const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
            const answersSnapshot = await get(answersRef);
            let answers = answersSnapshot.val() || {};
            
            // Add our new answer to the local calculation
            answers[newAnswerRef.key] = {
              userId: anonymousId,
              answer: answer
            };
            
            // Show the percentile
            showPercentileResult(answer, answers);
            
            // Mark as answered
            hasAnswered = true;
            
            // Store in localStorage to prevent multiple submissions and store the user's answer
            localStorage.setItem(`drinkle_answered_${activeQuestionId}`, 'true');
            localStorage.setItem(`drinkle_answer_${activeQuestionId}`, answer.toString());
          } catch (secondError) {
            console.error("Second error submitting answer:", secondError);
            alert("Error submitting your answer. Please try again or contact support.");
          }
        } else {
          alert("Error submitting your answer. Please try again.");
        }
      }
    });
    
    // Show percentile result
    function showPercentileResult(userAnswer, allAnswers, isReturnVisit = false) {
      const answers = Object.values(allAnswers);
      
      // Find position of user's answer
      const correctAnswer = parseFloat(currentQuestion.answer);
      
      // Calculate percentage off from the correct answer for the user
      const userPercentDifference = Math.abs((userAnswer - correctAnswer) / correctAnswer * 100);
      const percentOff = userPercentDifference.toFixed(1);
      percentOffValue.textContent = `${percentOff}%`;
      
      // Format numbers according to the question's format setting
      function formatNumber(number, formatType = 'decimal') {
        const num = parseFloat(number);
        
        switch(formatType) {
          case 'integer':
            return new Intl.NumberFormat('en-US', { 
              style: 'decimal',
              maximumFractionDigits: 0
            }).format(num);
            
          case 'year':
            return Math.round(num).toString();
            
          case 'percentage':
            return new Intl.NumberFormat('en-US', { 
              style: 'percent', 
              maximumFractionDigits: 2 
            }).format(num/100);
            
          case 'plain':
            return num.toString();
            
          case 'decimal':
          default:
            return new Intl.NumberFormat('en-US', { 
              style: 'decimal',
              maximumFractionDigits: 2
            }).format(num);
        }
      }
      
      // Use the question's format if available, or default to decimal
      const numberFormat = currentQuestion.format || 'decimal';
      
      // Calculate accuracy for all answers and sort from most accurate to least accurate
      const accuracyRankedAnswers = answers.map(a => {
        const value = parseFloat(a.answer);
        const diff = Math.abs((value - correctAnswer) / correctAnswer * 100);
        return { value, diff, userId: a.userId };
      }).sort((a, b) => a.diff - b.diff); // Sort by accuracy (smallest difference first)
      
      // Find position of user's answer in the accuracy-ranked list
      const userRankIndex = accuracyRankedAnswers.findIndex(a => 
        a.value === userAnswer && 
        (a.userId === currentUserId || (!currentUserId && a.userId.startsWith('anonymous_')))
      );
      
      // Handle first guess scenario
      const isFirstGuess = accuracyRankedAnswers.length <= 1;
      let percentile, percentileText;
      
      if (isFirstGuess) {
        percentile = null;
        percentileText = "first";
        percentileValue.textContent = "first";
      } else {
        // Calculate percentile (0-100) based on accuracy ranking
        // If you're first (most accurate), you get 100th percentile
        // If you're last (least accurate), you get 0th percentile
        percentile = Math.round(100 - (userRankIndex / (accuracyRankedAnswers.length - 1) * 100));
        percentileText = `${percentile}th`;
        percentileValue.textContent = percentileText;
      }
      
      // Get custom message based on percentile if available, or use default messages
      let customMessage = "";
      
      if (!isFirstGuess && currentQuestion.customMessages && Array.isArray(currentQuestion.customMessages)) {
        // Sort messages by threshold (highest first)
        const sortedMessages = [...currentQuestion.customMessages].sort((a, b) => b.threshold - a.threshold);
        
        // Find the first message with a threshold below the user's percentile
        for (const message of sortedMessages) {
          if (percentile >= message.threshold) {
            customMessage = message.text;
            break;
          }
        }
      }
      
      // Add "come back tomorrow" message if this is a return visit
      if (isReturnVisit) {
        comeBackMessage.textContent = "Check back tomorrow for a new Free Drinkle question!";
        comeBackMessage.style.display = "block";
      } else {
        comeBackMessage.style.display = "none";
      }
      
      // Use custom message if available, otherwise use default messages
      if (customMessage) {
        resultMessage.textContent = customMessage;
      } else if (isFirstGuess) {
        resultEmoji.textContent = 'üèÜ';
        resultMessage.textContent = "Congratulations! You're the first person to answer this question!";
      } else {
        // Determine emoji and message based on accuracy
        if (userPercentDifference <= 5) {
          resultEmoji.textContent = 'üéØ';
          resultMessage.textContent = "Amazing! Your answer is extremely close to the correct answer!";
        } else if (userPercentDifference <= 15) {
          resultEmoji.textContent = 'üî•';
          resultMessage.textContent = "Great job! Your answer is very close to the correct value!";
        } else if (userPercentDifference <= 30) {
          resultEmoji.textContent = 'üëç';
          resultMessage.textContent = "Not bad! You're in the ballpark of the correct answer.";
        } else if (userPercentDifference <= 50) {
          resultEmoji.textContent = 'ü§î';
          resultMessage.textContent = "Your guess is somewhat off from the correct answer.";
        } else {
          resultEmoji.textContent = 'üòÖ';
          resultMessage.textContent = "Your guess is quite far from the correct answer. Better luck next time!";
        }
      }
      
      // Generate emoji boxes for accuracy (like Wordle)
      function generateEmojiBoxes(value, max, count = 5, greenEmoji = 'üü©', whiteEmoji = '‚¨ú') {
        // Calculate how many green boxes to show (0 to count)
        const greenCount = Math.round((1 - Math.min(value / max, 1)) * count);
        const whiteCount = count - greenCount;
        
        return greenEmoji.repeat(greenCount) + whiteEmoji.repeat(whiteCount);
      }
      
      // Generate accuracy boxes (green for accuracy, max 100% off)
      const accuracyBoxes = generateEmojiBoxes(userPercentDifference, 100);
      
      // Generate percentile boxes (green for higher percentile)
      let percentileBoxes;
      if (isFirstGuess) {
        percentileBoxes = 'üèÜ'; // Trophy for first guess
      } else {
        percentileBoxes = generateEmojiBoxes(100 - percentile, 100);
      }
      
      // Display notes if available
      if (currentQuestion.notes) {
        notesContent.innerHTML = currentQuestion.notes;
        notesSection.style.display = "block";
      } else {
        notesSection.style.display = "none";
      }
      
      // Create copy text with title, message, and emoji boxes
      let copyTextContent = '';
      
      // Add Evil Trivia header line
      copyTextContent += 'üçã Evil Trivia üçã\n\n';
      
      // Add title if available
      if (currentQuestion.title) {
        copyTextContent += `Free Drinkle: ${currentQuestion.title}\n\n`;
      } else {
        copyTextContent += `Free Drinkle\n\n`;
      }
      
      // Add result message
      copyTextContent += `${resultMessage.textContent}\n\n`;
      
      // Add accuracy and percentile information with emoji boxes
      if (isFirstGuess) {
        copyTextContent += `My answer was ${percentOff}% off from the correct answer.\n`;
        copyTextContent += `Accuracy: ${accuracyBoxes}\n\n`;
        copyTextContent += `I'm the first person to answer this question! ${percentileBoxes}\n`;
      } else {
        copyTextContent += `My answer was ${percentOff}% off from the correct answer.\n`;
        copyTextContent += `Accuracy: ${accuracyBoxes}\n\n`;
        copyTextContent += `That places me in the ${percentileText} percentile of guessers.\n`;
        copyTextContent += `${percentileBoxes}\n`;
      }
      
      // Add link
      copyTextContent += `\nTry Free Drinkle at eviltrivia.com/games/drinkle`;
      
      // Set the copyable text
      copyText.innerText = copyTextContent;
      
      // Show result
      resultContainer.style.display = 'block';
      
      // Hide form entirely (not just disable)
      answerForm.style.display = 'none';
      
      // Update emoji-boxes display
      accuracyBoxesDisplay.textContent = accuracyBoxes;
      percentileBoxesDisplay.textContent = percentileBoxes;
      
      // Update user answer display
      const userAnswerDisplay = document.getElementById('userAnswerDisplay');
      const unitDisplay = document.getElementById('unitDisplay');
      const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
      const unitDisplay2 = document.getElementById('unitDisplay2');
      
      userAnswerDisplay.textContent = formatNumber(userAnswer, numberFormat);
      unitDisplay.textContent = currentQuestion.unit;
      correctAnswerDisplay.textContent = formatNumber(correctAnswer, numberFormat);
      unitDisplay2.textContent = currentQuestion.unit;
    }
  </script>
</body>
</html> 