<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Free Drinkle</title>
  <script src="/js/components/autoload-banner.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      margin-top: 60px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      color: #555;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .subtitle a {
      color: #000;
      text-decoration: underline;
      font-weight: bold;
    }
    
    .subtitle a:hover {
      color: #333;
    }

    .game-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
      position: relative;
    }
    
    .question {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .answer-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 30px;
    }
    
    .answer-input-container {
      display: flex;
      width: 100%;
      max-width: 300px;
      align-items: center;
      gap: 10px;
    }
    
    .answer-input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }
    
    .unit-label {
      font-weight: bold;
      color: #666;
    }
    
    .submit-btn {
      padding: 12px 30px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .submit-btn:hover {
      background-color: #333;
    }
    
    .result {
      margin-top: 30px;
      text-align: center;
      font-size: 18px;
      display: none;
    }
    
    .percentile {
      font-weight: bold;
      font-size: 24px;
      color: #000;
    }
    
    .copyable-result {
      margin: 20px auto;
      max-width: 400px;
      padding: 20px;
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 8px;
      text-align: left;
      position: relative;
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .copy-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .share-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.8;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-size: 12px;
      line-height: 1;
    }
    
    .share-button:hover {
      background-color: #555;
    }
    
    .share-button svg {
      width: 12px;
      height: 12px;
      fill: white;
    }
    
    .question-title {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 30px;
      font-size: 18px;
    }
    
    .no-question {
      text-align: center;
      padding: 30px;
      font-size: 18px;
      color: #666;
    }
    
    .emoji {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    /* Info icon styling */
    .info-icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      min-width: 24px;
      min-height: 24px;
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      background-color: #28a745;
      color: white;
      border-radius: 50%;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      margin-right: 10px;
    }
    
    /* Notes content container */
    .notes-content-wrapper {
      display: flex;
      align-items: flex-start;
      flex-wrap: nowrap;
    }
    
    #notesContent {
      flex: 1;
      line-height: 1.5;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    
    /* Help popup styling */
    .help-button {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 30px;
      height: 30px;
      background-color: #007bff;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
      z-index: 10;
    }
    
    .help-button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
      box-shadow: 0 3px 6px rgba(0,0,0,0.25);
    }
    
    .help-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    
    .help-popup {
      background-color: white;
      max-width: 500px;
      width: 90%;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .help-popup h3 {
      margin-top: 0;
      color: #333;
    }
    
    .help-popup p {
      color: #555;
      line-height: 1.5;
    }
    
    .close-button {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 24px;
      height: 24px;
      background-color: #f0f0f0;
      color: #333;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-button:hover {
      background-color: #e0e0e0;
    }

    /* Add navigation buttons styles */
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      margin-top: 45px;
    }

    .nav-button {
      padding: 8px 15px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .nav-button:hover {
      background-color: #333;
    }

    .nav-button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .question-date {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    /* Hide the question date display */
    #questionDate {
      display: none !important;
    }

    /* Media query for mobile devices */
    @media (max-width: 480px) {
      .emoji-boxes {
        font-size: 16px !important;
      }
      
      .emoji-boxes > div > span:first-child {
        min-width: 70px !important;
      }
      
      .emoji-boxes > div {
        gap: 5px !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Free Drinkle</h1>
    <div class="subtitle">
      In the style of Evil Trivia's Free Drink Question<br>
      Want to play in-person? <a href="https://eviltrivia.com/live/">Click here</a>
    </div>
    
    <div class="game-card" id="gameContainer">
      <!-- Help button and popup -->
      <div class="help-button" id="helpButton">?</div>
      
      <div class="help-overlay" id="helpOverlay">
        <div class="help-popup">
          <div class="close-button" id="closeHelpButton">‚úï</div>
          <h3>About Free Drink Questions</h3>
          <p>At Evil Trivia, we ask "Free Drink Questions", questions that always have a number as an answer and always are impossible to truly <em>know</em>. But! Everyone gets a guess. And whoever is closest to the right number gets a free drink token.</p>
          <p>We can't give you a free drink virtually, but if you get close, feel free to celebrate with a cold one. Or a hot one. We don't know what you like. Freak.</p>
        </div>
      </div>
      
      <div id="loadingMessage" class="loading">
        Loading question...
      </div>
      
      <div id="noQuestionMessage" class="no-question" style="display: none;">
        <div class="emoji">üçπ</div>
        <p>There's no active Free Drinkle question at the moment. Please check back later!</p>
      </div>
      
      <div id="questionContainer" style="display: none;">
        <div class="navigation-buttons">
          <button id="prevButton" class="nav-button" disabled>Older</button>
          <button id="nextButton" class="nav-button" disabled>Newer</button>
        </div>
        <div id="questionDate" class="question-date"></div>
        <div id="questionTitle" class="question-title"></div>
        <div id="questionText" class="question"></div>
        
        <form id="answerForm" class="answer-form">
          <div class="answer-input-container">
            <input type="number" id="answerInput" class="answer-input" required step="any" min="0">
            <span id="unitLabel" class="unit-label"></span>
          </div>
          <button type="submit" class="submit-btn">Submit Answer</button>
        </form>
        
        <div id="resultContainer" class="result">
          <p id="resultMessage" style="font-size: 20px; font-weight: bold; margin: 15px 0;"></p>
          
          <div class="emoji-boxes" style="margin: 15px 0; text-align: center; font-size: 20px;">
            <div style="margin-bottom: 5px; display: flex; align-items: center; justify-content: flex-start; width: fit-content; margin-left: auto; margin-right: auto; gap: 10px;">
              <span style="min-width: 85px; text-align: left;">Accuracy:</span> 
              <span id="accuracyBoxesDisplay">‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú</span>
              <span id="percentOffDisplay" style="font-weight: bold; color: #555;"></span>
            </div>
            <div style="display: flex; align-items: center; justify-content: flex-start; width: fit-content; margin-left: auto; margin-right: auto; gap: 10px;">
              <span style="min-width: 85px; text-align: left;">Percentile:</span> 
              <span id="percentileBoxesDisplay">‚¨ú‚¨ú‚¨ú‚¨ú‚¨ú</span>
              <span id="percentileValueDisplay" style="font-weight: bold; color: #555;"></span>
            </div>
          </div>
          
          <div style="margin: 25px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 180px; max-width: 300px; padding: 20px; background-color: #f0f0f0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
              <div style="font-weight: bold; margin-bottom: 10px; font-size: 18px; color: #333;">Your answer</div>
              <div style="font-size: 24px; color: #000; word-break: break-word;">
                <span id="userAnswerDisplay" style="font-weight: 500;"></span>
                <span id="unitDisplay" style="font-size: 20px; color: #555; margin-left: 2px;"></span>
              </div>
            </div>
            <div style="flex: 1; min-width: 180px; max-width: 300px; padding: 20px; background-color: #f0f0f0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
              <div style="font-weight: bold; margin-bottom: 10px; font-size: 18px; color: #333;">Correct answer</div>
              <div style="font-size: 24px; color: #000; word-break: break-word;">
                <span id="correctAnswerDisplay" style="font-weight: 500;"></span>
                <span id="unitDisplay2" style="font-size: 20px; color: #555; margin-left: 2px;"></span>
              </div>
            </div>
          </div>
          
          <!-- Notes section - only shown if provided -->
          <div id="notesSection" style="margin: 20px 0; display: none; padding: 15px; background-color: #f8f8f8; border-radius: 8px; border-left: 4px solid #28a745;">
            <div class="notes-content-wrapper">
              <span class="info-icon">i</span>
              <div id="notesContent" style="line-height: 1.5;"></div>
            </div>
          </div>
          
          <p style="margin: 15px 0; font-style: italic; color: #666;">Keep checking back to see how your score compares as more people answer!</p>
          
          <div class="copyable-result" id="copyableResult">
            <button class="share-button" id="shareButton">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                <polyline points="16 6 12 2 8 6"></polyline>
                <line x1="12" y1="2" x2="12" y2="15"></line>
              </svg>
              <span>Share</span>
            </button>
            <div id="copyText"></div>
          </div>
          <p id="comeBackMessage" style="margin-top: 20px; font-style: italic; color: #666;"></p>
        </div>
      </div>
    </div>
  </div>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    
    // Initialize help button as soon as DOM is ready
    document.addEventListener('DOMContentLoaded', initializeHelpButton);
    
    function initializeHelpButton() {
      const helpButton = document.getElementById('helpButton');
      const helpOverlay = document.getElementById('helpOverlay');
      const closeHelpButton = document.getElementById('closeHelpButton');
      
      if (helpButton && helpOverlay && closeHelpButton) {
        console.log("Help elements found and initialized");
        
        helpButton.addEventListener('click', () => {
          console.log("Help button clicked!");
          helpOverlay.style.display = 'flex';
        });
        
        closeHelpButton.addEventListener('click', () => {
          console.log("Close button clicked!");
          helpOverlay.style.display = 'none';
        });
        
        // Close help when clicking outside the popup
        helpOverlay.addEventListener('click', (e) => {
          if (e.target === helpOverlay) {
            console.log("Clicked outside popup, closing");
            helpOverlay.style.display = 'none';
          }
        });
      } else {
        console.error("Help elements not found:", { 
          helpButton: !!helpButton, 
          helpOverlay: !!helpOverlay, 
          closeHelpButton: !!closeHelpButton 
        });
      }
    }
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
        authDomain: "eviltrivia-47664.firebaseapp.com",
        databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
        projectId: "eviltrivia-47664",
        storageBucket: "eviltrivia-47664.appspot.com",
        messagingSenderId: "401826818140",
        appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
        measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
      loadingMessage.innerHTML = `
        <div class="emoji">üòû</div>
        <p>Error initializing Firebase: ${error.message}</p>
        <p>Please try refreshing the page.</p>
      `;
    }
    
    // DOM elements
    const loadingMessage = document.getElementById('loadingMessage');
    const noQuestionMessage = document.getElementById('noQuestionMessage');
    const questionContainer = document.getElementById('questionContainer');
    const questionTitle = document.getElementById('questionTitle');
    const questionText = document.getElementById('questionText');
    const answerForm = document.getElementById('answerForm');
    const answerInput = document.getElementById('answerInput');
    const unitLabel = document.getElementById('unitLabel');
    const resultContainer = document.getElementById('resultContainer');
    const percentileValue = document.getElementById('percentileValue') || document.createElement('span'); // May not exist in DOM anymore
    const percentOffValue = document.getElementById('percentOffValue') || document.createElement('span'); // May not exist in DOM anymore
    const resultMessage = document.getElementById('resultMessage');
    const resultEmoji = document.getElementById('resultEmoji');
    const shareButton = document.getElementById('shareButton');
    const copyText = document.getElementById('copyText');
    const comeBackMessage = document.getElementById('comeBackMessage');
    const accuracyBoxesDisplay = document.getElementById('accuracyBoxesDisplay');
    const percentileBoxesDisplay = document.getElementById('percentileBoxesDisplay');
    const notesSection = document.getElementById('notesSection');
    const notesContent = document.getElementById('notesContent');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const questionDate = document.getElementById('questionDate');
    
    // Game state
    let currentQuestion = null;
    let currentUserId = null;
    let hasAnswered = false;
    let questionHistory = [];
    let currentQuestionIndex = -1;
    
    // Share functionality
    shareButton.addEventListener('click', () => {
      const textToShare = copyText.innerText;
      
      // On mobile, use the native share functionality if available
      if (navigator.share && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        navigator.share({
          text: textToShare,
        })
        .then(() => {
          console.log('Successfully shared');
        })
        .catch((error) => {
          console.error('Error sharing:', error);
          // Fallback to copy
          copyToClipboard(textToShare);
        });
      } else {
        // On desktop, just copy to clipboard
        copyToClipboard(textToShare);
      }
    });
    
    // Helper function to copy text and show feedback
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => {
          shareButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 6L9 17l-5-5"/>
          </svg><span>Copied!</span>`;
          setTimeout(() => {
            shareButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg><span>Share</span>`;
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy text: ', err);
          shareButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg><span>Error</span>`;
          setTimeout(() => {
            shareButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg><span>Share</span>`;
          }, 2000);
        });
    }
    
    // Check if user is logged in
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
      } else {
        currentUserId = null;
      }
      
      // Load the active question
      loadActiveQuestion();
    });
    
    // Check if user has already answered
    async function checkPreviousAnswer(activeQuestionId) {
      // First check for logged-in users
      if (currentUserId) {
        const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
        const answersSnapshot = await get(answersRef);
        const answers = answersSnapshot.val() || {};
        
        // Check if this user has already answered
        if (Object.values(answers).some(answer => answer.userId === currentUserId)) {
          hasAnswered = true;
          
          // Get their answer and show result with all current answers (for updated percentile)
          for (const key in answers) {
            if (answers[key].userId === currentUserId) {
              showPercentileResult(parseFloat(answers[key].answer), answers, true);
              break;
            }
          }
          return true;
        }
      }
      
      // Then check localStorage for anonymous users
      const hasAnsweredLocally = localStorage.getItem(`drinkle_answered_${activeQuestionId}`) === 'true';
      if (hasAnsweredLocally) {
        const storedAnswer = localStorage.getItem(`drinkle_answer_${activeQuestionId}`);
        if (storedAnswer) {
          hasAnswered = true;
          
          // Get all current answers to calculate updated percentile
          const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
          const answersSnapshot = await get(answersRef);
          const answers = answersSnapshot.val() || {};
          
          // Show result with the stored answer and all current answers
          showPercentileResult(parseFloat(storedAnswer), answers, true);
          return true;
        }
      }
      
      hasAnswered = false;
      resultContainer.style.display = 'none';
      return false;
    }
    
    // Load the active question from Firebase
    async function loadActiveQuestion() {
      try {
        if (!db) {
          throw new Error("Database connection not established");
        }
        
        console.log("Starting to load active question");
        const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
        
        onValue(activeQuestionRef, async (snapshot) => {
          try {
            console.log("Active question data received");
            const activeQuestionId = snapshot.val();
            
            if (!activeQuestionId) {
              // No active question
              console.log("No active question found");
              loadingMessage.style.display = 'none';
              noQuestionMessage.style.display = 'block';
              questionContainer.style.display = 'none';
              return;
            }
            
            console.log("Active question ID:", activeQuestionId);
            
            // Get the question details
            const questionRef = ref(db, `games/drinkle/questions/${activeQuestionId}`);
            const questionSnapshot = await get(questionRef);
            currentQuestion = questionSnapshot.val();
            
            if (!currentQuestion) {
              // Question not found
              console.error("Question not found with ID:", activeQuestionId);
              loadingMessage.style.display = 'none';
              noQuestionMessage.style.display = 'block';
              noQuestionMessage.innerHTML = `
                <div class="emoji">üòû</div>
                <p>Question not found. The active question may have been deleted.</p>
              `;
              questionContainer.style.display = 'none';
              return;
            }
            
            // Check if question is marked as unavailable
            if (currentQuestion.available === false) {
              console.log("Active question is marked as unavailable:", activeQuestionId);
              loadingMessage.style.display = 'none';
              noQuestionMessage.style.display = 'block';
              noQuestionMessage.innerHTML = `
                <div class="emoji">üçã</div>
                <p>The current question is temporarily unavailable. Please check back later!</p>
              `;
              questionContainer.style.display = 'none';
              return;
            }
            
            console.log("Question details loaded:", currentQuestion.title || currentQuestion.question.substring(0, 30));
            
            // Ensure ID is set on the question object
            currentQuestion.id = activeQuestionId;
            
            // Load question history
            await loadQuestionHistory();
            
            // Display the question
            displayQuestion(currentQuestion);
            
            // Check if user has already answered
            await checkPreviousAnswer(activeQuestionId);
            
            // Show question and hide loading
            loadingMessage.style.display = 'none';
            noQuestionMessage.style.display = 'none';
            questionContainer.style.display = 'block';
          } catch (innerError) {
            console.error("Error in onValue callback:", innerError);
            loadingMessage.style.display = 'none';
            noQuestionMessage.style.display = 'block';
            noQuestionMessage.innerHTML = `
              <div class="emoji">üòû</div>
              <p>Error loading question: ${innerError.message}</p>
              <p>Please try refreshing the page.</p>
            `;
          }
        }, (error) => {
          console.error("onValue error:", error);
          loadingMessage.style.display = 'none';
          noQuestionMessage.style.display = 'block';
          noQuestionMessage.innerHTML = `
            <div class="emoji">üòû</div>
            <p>Error listening for question updates: ${error.message}</p>
            <p>Please try refreshing the page.</p>
          `;
        });
      } catch (error) {
        console.error("Error in loadActiveQuestion:", error);
        loadingMessage.style.display = 'none';
        noQuestionMessage.style.display = 'block';
        noQuestionMessage.innerHTML = `
          <div class="emoji">üòû</div>
          <p>Error loading question: ${error.message}</p>
          <p>Please try refreshing the page or contact support if the issue persists.</p>
        `;
      }
    }
    
    // Load question history
    async function loadQuestionHistory() {
      try {
        const questionsRef = ref(db, 'games/drinkle/questions');
        const questionsSnapshot = await get(questionsRef);
        const questions = questionsSnapshot.val() || {};
        
        // Convert to array and add IDs
        questionHistory = Object.entries(questions).map(([id, question]) => {
          return { ...question, id };
        });
        
        // Filter to only include available questions or questions without an availability flag
        questionHistory = questionHistory.filter(q => q.available === undefined || q.available === true);
        
        // Sort by date (oldest first so previous means older)
        questionHistory.sort((a, b) => {
          const dateA = a.date ? new Date(a.date) : new Date(0);
          const dateB = b.date ? new Date(b.date) : new Date(0);
          return dateA - dateB; // Oldest first, so previous = older question
        });
        
        // Find current question index
        currentQuestionIndex = questionHistory.findIndex(q => q.id === currentQuestion.id);
        
        // Update navigation buttons
        updateNavigationButtons();
      } catch (error) {
        console.error("Error loading question history:", error);
      }
    }
    
    // Update navigation buttons
    function updateNavigationButtons() {
      // Previous means older question (going back in time)
      prevButton.disabled = currentQuestionIndex <= 0;
      // Next means newer question (going forward in time)
      nextButton.disabled = currentQuestionIndex >= questionHistory.length - 1;
      
      // Add event listeners
      prevButton.onclick = () => {
        if (currentQuestionIndex > 0) {
          navigateToQuestion(currentQuestionIndex - 1);
        }
      };
      
      nextButton.onclick = () => {
        if (currentQuestionIndex < questionHistory.length - 1) {
          navigateToQuestion(currentQuestionIndex + 1);
        }
      };
    }
    
    // Navigate to a question by index
    async function navigateToQuestion(index) {
      if (index < 0 || index >= questionHistory.length) {
        return;
      }
      
      currentQuestionIndex = index;
      currentQuestion = questionHistory[index];
      
      console.log(`Navigating to ${currentQuestion.date ? new Date(currentQuestion.date).toLocaleDateString() : 'undated'} question: ${currentQuestion.title || currentQuestion.question.substring(0, 30)}`);
      
      // Reset answer state
      hasAnswered = false;
      resultContainer.style.display = 'none';
      answerForm.style.display = 'flex';
      
      // Display the question
      displayQuestion(currentQuestion);
      
      // Check if user has already answered
      await checkPreviousAnswer(currentQuestion.id);
      
      // Update navigation buttons
      updateNavigationButtons();
    }
    
    // Display a question
    function displayQuestion(question) {
      questionText.textContent = question.question;
      unitLabel.textContent = question.unit;
      
      // Display the title if available
      if (question.title) {
        questionTitle.textContent = question.title;
        questionTitle.style.display = 'block';
      } else {
        questionTitle.style.display = 'none';
      }
      
      // Display the date if available
      if (question.date) {
        const date = new Date(question.date);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString(undefined, options);
        
        // Add position in question history
        if (questionHistory.length > 0) {
          const position = currentQuestionIndex + 1;
          const total = questionHistory.length;
          questionDate.textContent = `${formattedDate} (Question ${position} of ${total})`;
        } else {
          questionDate.textContent = formattedDate;
        }
        questionDate.style.display = 'block';
      } else {
        questionDate.style.display = 'none';
      }
    }
    
    // Handle form submission
    answerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (hasAnswered) {
        alert("You've already submitted an answer for this question!");
        return;
      }
      
      const answer = parseFloat(answerInput.value);
      
      if (isNaN(answer) || answer < 0) {
        alert("Please enter a valid number");
        return;
      }
      
      try {
        // Get current answers
        const activeQuestionId = currentQuestion.id;
        const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
        const answersSnapshot = await get(answersRef);
        const answers = answersSnapshot.val() || {};
        
        // Generate a unique ID if user is not logged in
        const userId = currentUserId || ('anonymous_' + Date.now() + '_' + Math.floor(Math.random() * 10000));
        
        // Add new answer
        const newAnswerRef = push(answersRef);
        await set(newAnswerRef, {
          userId: userId,
          answer: answer,
          timestamp: Date.now()
        });
        
        // Update answers with the new one
        answers[newAnswerRef.key] = {
          userId: userId,
          answer: answer
        };
        
        // Show the percentile
        showPercentileResult(answer, answers);
        
        // Mark as answered
        hasAnswered = true;
        
        // Store in localStorage to prevent multiple submissions and store the user's answer
        localStorage.setItem(`drinkle_answered_${activeQuestionId}`, 'true');
        localStorage.setItem(`drinkle_answer_${activeQuestionId}`, answer.toString());
      } catch (error) {
        console.error("Error submitting answer:", error);
        
        // Try submitting to a public path if we get a permission error
        if (error.message && error.message.includes("permission_denied")) {
          try {
            // Try using a different path that allows anonymous writes
            const activeQuestionId = currentQuestion.id;
            const publicAnswersRef = ref(db, `publicAnswers/drinkle/${activeQuestionId}`);
            
            // Generate a unique anonymous ID
            const anonymousId = 'anon_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
            
            // Add new answer to public path
            const newAnswerRef = push(publicAnswersRef);
            await set(newAnswerRef, {
              userId: anonymousId,
              answer: answer,
              timestamp: Date.now()
            });
            
            // Get all answers to calculate percentile
            const answersRef = ref(db, `games/drinkle/answers/${activeQuestionId}`);
            const answersSnapshot = await get(answersRef);
            let answers = answersSnapshot.val() || {};
            
            // Add our new answer to the local calculation
            answers[newAnswerRef.key] = {
              userId: anonymousId,
              answer: answer
            };
            
            // Show the percentile
            showPercentileResult(answer, answers);
            
            // Mark as answered
            hasAnswered = true;
            
            // Store in localStorage to prevent multiple submissions and store the user's answer
            localStorage.setItem(`drinkle_answered_${activeQuestionId}`, 'true');
            localStorage.setItem(`drinkle_answer_${activeQuestionId}`, answer.toString());
          } catch (secondError) {
            console.error("Second error submitting answer:", secondError);
            alert("Error submitting your answer. Please try again or contact support.");
          }
        } else {
          alert("Error submitting your answer. Please try again.");
        }
      }
    });
    
    // Show percentile result
    function showPercentileResult(userAnswer, allAnswers, isReturnVisit = false) {
      const answers = Object.values(allAnswers);
      
      // Find position of user's answer
      const correctAnswer = parseFloat(currentQuestion.answer);
      
      // Calculate percentage off from the correct answer for the user
      const userPercentDifference = Math.abs((userAnswer - correctAnswer) / correctAnswer * 100);
      const percentOff = userPercentDifference.toFixed(1);
      
      // Update the percent off display next to the accuracy boxes
      const percentOffDisplay = document.getElementById('percentOffDisplay');
      if (percentOffDisplay) {
        percentOffDisplay.textContent = `${percentOff}% off`;
      }
      
      // Format numbers according to the question's format setting
      function formatNumber(number, formatType = 'decimal') {
        const num = parseFloat(number);
        
        switch(formatType) {
          case 'integer':
            return new Intl.NumberFormat('en-US', { 
              style: 'decimal',
              maximumFractionDigits: 0
            }).format(num);
            
          case 'year':
            return Math.round(num).toString();
            
          case 'percentage':
            return new Intl.NumberFormat('en-US', { 
              style: 'percent', 
              maximumFractionDigits: 2 
            }).format(num/100);
            
          case 'plain':
            return num.toString();
            
          case 'decimal':
          default:
            return new Intl.NumberFormat('en-US', { 
              style: 'decimal',
              maximumFractionDigits: 2
            }).format(num);
        }
      }
      
      // Use the question's format if available, or default to decimal
      const numberFormat = currentQuestion.format || 'decimal';
      
      // Calculate accuracy for all answers and sort from most accurate to least accurate
      const accuracyRankedAnswers = answers.map(a => {
        const value = parseFloat(a.answer);
        const diff = Math.abs((value - correctAnswer) / correctAnswer * 100);
        return { value, diff, userId: a.userId };
      }).sort((a, b) => a.diff - b.diff); // Sort by accuracy (smallest difference first)
      
      // Find position of user's answer in the accuracy-ranked list
      const userRankIndex = accuracyRankedAnswers.findIndex(a => 
        a.value === userAnswer && 
        (a.userId === currentUserId || (!currentUserId && a.userId.startsWith('anonymous_')))
      );
      
      // Handle first guess scenario
      const isFirstGuess = accuracyRankedAnswers.length <= 1;
      let percentile, percentileText;
      
      if (isFirstGuess) {
        percentile = null;
        percentileText = "first";
        
        // Update the percentile value display
        const percentileValueDisplay = document.getElementById('percentileValueDisplay');
        if (percentileValueDisplay) {
          percentileValueDisplay.textContent = "First!";
        }
      } else {
        // Calculate percentile (0-100) based on accuracy ranking
        // If you're first (most accurate), you get 100th percentile
        // If you're last (least accurate), you get 0th percentile
        percentile = Math.round(100 - (userRankIndex / (accuracyRankedAnswers.length - 1) * 100));
        
        // Get the correct ordinal suffix (st, nd, rd, th)
        function getOrdinalSuffix(num) {
          const j = num % 10;
          const k = num % 100;
          if (j === 1 && k !== 11) {
            return "st";
          }
          if (j === 2 && k !== 12) {
            return "nd";
          }
          if (j === 3 && k !== 13) {
            return "rd";
          }
          return "th";
        }
        
        const suffix = getOrdinalSuffix(percentile);
        percentileText = `${percentile}${suffix}`;
        
        // Update the percentile value display with response count
        const percentileValueDisplay = document.getElementById('percentileValueDisplay');
        if (percentileValueDisplay) {
          if (isFirstGuess) {
            percentileValueDisplay.textContent = "First!";
          } else {
            percentileValueDisplay.textContent = `${percentileText}`;
          }
        }
      }
      
      // Get custom message based on percentile if available, or use default messages
      let customMessage = "";
      
      if (!isFirstGuess && currentQuestion.customMessages && Array.isArray(currentQuestion.customMessages)) {
        // Sort messages by threshold (highest first)
        const sortedMessages = [...currentQuestion.customMessages].sort((a, b) => b.threshold - a.threshold);
        
        // Find the first message with a threshold below the user's percentile
        for (const message of sortedMessages) {
          if (percentile >= message.threshold) {
            customMessage = message.text;
            break;
          }
        }
      }
      
      // Add "come back tomorrow" message if this is a return visit
      if (isReturnVisit) {
        comeBackMessage.textContent = "Check back tomorrow for a new Free Drinkle question!";
        comeBackMessage.innerHTML += "<br><small>* or however often Graham is able to update this</small>";
        comeBackMessage.style.display = "block";
      } else {
        comeBackMessage.style.display = "none";
      }
      
      // Use custom message if available, otherwise use default messages
      if (customMessage) {
        resultMessage.textContent = customMessage;
      } else if (isFirstGuess) {
        resultMessage.textContent = "Congratulations! You're the first person to answer this question!";
      } else {
        // Determine message based on accuracy
        if (userPercentDifference <= 5) {
          resultMessage.textContent = "Amazing! Your answer is extremely close to the correct answer!";
        } else if (userPercentDifference <= 15) {
          resultMessage.textContent = "Great job! Your answer is very close to the correct value!";
        } else if (userPercentDifference <= 30) {
          resultMessage.textContent = "Not bad! You're in the ballpark of the correct answer.";
        } else if (userPercentDifference <= 50) {
          resultMessage.textContent = "Your guess is somewhat off from the correct answer.";
        } else {
          resultMessage.textContent = "Your guess is quite far from the correct answer. Better luck next time!";
        }
      }
      
      // Generate emoji boxes for accuracy (like Wordle)
      function generateEmojiBoxes(value, max, count = 10, greenEmoji = 'üü®', whiteEmoji = '‚¨ú') {
        // Calculate how many green boxes to show (0 to count)
        const greenCount = Math.round((1 - Math.min(value / max, 1)) * count);
        const whiteCount = count - greenCount;
        
        return greenEmoji.repeat(greenCount) + whiteEmoji.repeat(whiteCount);
      }
      
      // Generate accuracy boxes (green for accuracy, max 100% off)
      const accuracyBoxes = generateEmojiBoxes(userPercentDifference, 100);
      
      // Generate percentile boxes (green for higher percentile)
      let percentileBoxes;
      if (isFirstGuess) {
        percentileBoxes = 'üèÜ'; // Trophy for first guess
      } else {
        percentileBoxes = generateEmojiBoxes(100 - percentile, 100);
      }
      
      // Check if user got the exact right answer (allowing for tiny floating point differences)
      const isExactMatch = userPercentDifference < 0.001;
      
      // Display notes if available
      if (currentQuestion.notes) {
        notesContent.innerHTML = currentQuestion.notes;
        notesSection.style.display = "block";
      } else {
        notesSection.style.display = "none";
      }
      
      // Create copy text with title, message, and emoji boxes
      let copyTextContent = '';
      
      // Add Evil Trivia header line
      copyTextContent += 'üçã Evil Trivia üçã\n\n';
      
      // Add title if available
      if (currentQuestion.title) {
        copyTextContent += `Free Drinkle\n${currentQuestion.title}\n\n`;
      } else {
        copyTextContent += `Free Drinkle\n\n`;
      }
      
      // Add result message
      copyTextContent += `${resultMessage.textContent}\n\n`;
      
      // Add accuracy and percentile information with emoji boxes (or "Nailed It" for exact match)
      if (isExactMatch) {
        // Create a circle of lemons around "Nailed It."
        copyTextContent += `   üçã üçã üçã üçã üçã\n`;
        copyTextContent += ` üçã             üçã\n`;
        copyTextContent += `üçã   Nailed It.  üçã\n`;
        copyTextContent += ` üçã             üçã\n`;
        copyTextContent += `   üçã üçã üçã üçã üçã\n\n`;
      } else if (isFirstGuess) {
        copyTextContent += `My answer was ${percentOff}% off from the correct answer.\n`;
        copyTextContent += `${accuracyBoxes}\n\n`;
        copyTextContent += `I'm the first person to answer this question! ${percentileBoxes}\n`;
      } else {
        copyTextContent += `My answer was ${percentOff}% off from the correct answer.\n`;
        copyTextContent += `${accuracyBoxes}\n\n`;
        copyTextContent += `That places me in the ${percentileText} percentile of the ${answers.length} guessers so far.\n`;
        copyTextContent += `${percentileBoxes}\n`;
      }
      
      // Add link
      copyTextContent += `\n\neviltrivia.com/games/drinkle`;
      
      // Set the copyable text
      copyText.innerText = copyTextContent;
      
      // Show result
      resultContainer.style.display = 'block';
      
      // Hide form entirely (not just disable)
      answerForm.style.display = 'none';
      
      // Update emoji-boxes display - also handle "Nailed It" case
      if (isExactMatch) {
        accuracyBoxesDisplay.innerHTML = `<div style="text-align: center; margin: 10px 0;">
          <div>üçã   Nailed It.  üçã</div>
        </div>`;
        
        // Hide percentile boxes display for this special case
        percentileBoxesDisplay.parentElement.style.display = 'none';
        
        // Also hide the percent off display
        const percentOffDisplay = document.getElementById('percentOffDisplay');
        if (percentOffDisplay) {
          percentOffDisplay.style.display = 'none';
        }
        
        // Show a special message for the exact match
        resultMessage.textContent = "That's...right.";
      } else {
        accuracyBoxesDisplay.textContent = accuracyBoxes;
        percentileBoxesDisplay.textContent = percentileBoxes;
        percentileBoxesDisplay.parentElement.style.display = 'block';
        
        // Make sure the percent off display is visible
        const percentOffDisplay = document.getElementById('percentOffDisplay');
        if (percentOffDisplay) {
          percentOffDisplay.style.display = 'inline';
          percentOffDisplay.textContent = `${percentOff}% off`;
        }
      }
      
      // Update user answer display
      const userAnswerDisplay = document.getElementById('userAnswerDisplay');
      const unitDisplay = document.getElementById('unitDisplay');
      const correctAnswerDisplay = document.getElementById('correctAnswerDisplay');
      const unitDisplay2 = document.getElementById('unitDisplay2');
      
      userAnswerDisplay.textContent = formatNumber(userAnswer, numberFormat);
      unitDisplay.textContent = currentQuestion.unit;
      correctAnswerDisplay.textContent = formatNumber(correctAnswer, numberFormat);
      unitDisplay2.textContent = currentQuestion.unit;
    }
  </script>
</body>
</html> 