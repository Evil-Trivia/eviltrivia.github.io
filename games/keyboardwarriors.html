<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Evil Trivia - Keyboard Warriors</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    body {
      font-family: 'Press Start 2P', cursive;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      touch-action: manipulation;
      user-select: none;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      padding: 15px;
      position: relative;
      overflow-y: auto;
    }
    
    h1 {
      text-align: center;
      color: #0ff;
      margin-bottom: 10px;
      font-size: 24px;
      line-height: 1.5;
      text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
    }
    
    .subtitle {
      text-align: center;
      color: #f0f;
      margin-bottom: 15px;
      font-size: 10px;
      line-height: 1.8;
      text-shadow: 0 0 10px #f0f;
    }

    .game-card {
      background: #0f3460;
      border: 4px solid #0ff;
      padding: 20px;
      padding-bottom: 30px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      margin-top: 15px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .setup-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .form-group {
      width: 100%;
      max-width: 400px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 10px;
      color: #0ff;
      text-shadow: 0 0 10px #0ff;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      font-size: 12px;
      font-family: 'Press Start 2P', cursive;
      border: 3px solid #0ff;
      background: #1a1a2e;
      color: #fff;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: 3px solid #f0f;
      box-shadow: 0 0 15px #f0f;
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn {
      padding: 15px 25px;
      background-color: #e94560;
      color: white;
      border: 3px solid #0ff;
      cursor: pointer;
      font-size: 12px;
      font-family: 'Press Start 2P', cursive;
      box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
      transition: all 0.1s;
    }
    
    .btn:hover {
      background-color: #ff0066;
      box-shadow: 0 0 25px rgba(255, 0, 102, 0.8);
      transform: scale(1.05);
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .btn-secondary {
      background-color: #533483;
    }
    
    .btn-secondary:hover {
      background-color: #7b2cbf;
      box-shadow: 0 0 25px rgba(123, 44, 191, 0.8);
    }
    
    .game-area {
      display: none;
    }

    .game-hud {
      text-align: center;
      margin-bottom: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.7);
      border: 3px solid #0ff;
    }

    .timer-display {
      font-size: 20px;
      color: #f0f;
      text-shadow: 0 0 10px #f0f;
      margin-bottom: 10px;
    }

    .stats-display {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
      font-size: 10px;
    }

    .stat-item {
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
    }

    .stat-value {
      color: #fff;
      font-size: 14px;
      margin-top: 5px;
    }

    #wordDisplay {
      font-size: 24px;
      text-align: left;
      padding: 30px;
      margin: 20px 0;
      background: rgba(0, 0, 0, 0.5);
      border: 3px solid #0ff;
      min-height: 150px;
      color: #666;
      line-height: 1.8;
      font-family: 'Press Start 2P', cursive;
      word-wrap: break-word;
      letter-spacing: 1px;
    }

    #wordDisplay .correct {
      color: #0f0;
      text-shadow: 0 0 5px #0f0;
    }

    #wordDisplay .incorrect {
      color: #f00;
      text-shadow: 0 0 5px #f00;
      background: rgba(255, 0, 0, 0.2);
    }

    #wordDisplay .current {
      background: rgba(0, 255, 255, 0.3);
      border-bottom: 2px solid #0ff;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.5; }
    }

    #typeInput {
      width: 100%;
      padding: 20px;
      font-size: 20px;
      font-family: 'Press Start 2P', cursive;
      background: #1a1a2e;
      border: 3px solid #0ff;
      color: #fff;
      text-align: center;
      margin-bottom: 20px;
    }

    #typeInput:focus {
      outline: none;
      border-color: #f0f;
      box-shadow: 0 0 20px #f0f;
    }

    .instructions {
      font-size: 8px;
      color: #0ff;
      line-height: 1.8;
      text-align: center;
      text-shadow: 0 0 5px #0ff;
    }
    
    .results {
      display: none;
      text-align: center;
      background: rgba(0, 0, 0, 0.8);
      padding: 30px;
      border: 4px solid #f0f;
      margin-top: 20px;
    }
    
    .game-over-title {
      font-size: 24px;
      color: #0ff;
      text-shadow: 0 0 15px #0ff;
      margin-bottom: 20px;
    }

    .final-score {
      font-size: 16px;
      color: #f0f;
      text-shadow: 0 0 10px #f0f;
      margin: 15px 0;
      line-height: 1.8;
    }
    
    .hidden {
      display: none;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 16px;
      }
      
      .subtitle {
        font-size: 8px;
      }

      .game-card {
        padding: 10px;
      }

      .btn {
        font-size: 10px;
        padding: 12px 20px;
      }

      #wordDisplay {
        font-size: 18px;
        padding: 20px;
        line-height: 1.6;
      }

      #typeInput {
        font-size: 16px;
        padding: 15px;
      }
    }

    @media (max-width: 400px) {
      h1 {
        font-size: 14px;
      }

      #wordDisplay {
        font-size: 16px;
        padding: 15px;
        line-height: 1.5;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>⌨️ KEYBOARD WARRIORS ⌨️</h1>
    <div class="subtitle">
      Test your typing speed and accuracy!
    </div>

    <div class="game-card">
      <!-- Setup Form -->
      <div id="setupForm" class="setup-form">
        <div class="form-group">
          <label for="barLocation">BAR LOCATION:</label>
          <select id="barLocation" onchange="onLocationChange()">
            <option value="">Select location...</option>
            <option value="St. Dymphna's">St. Dymphna's</option>
            <option value="Radegast Hall">Radegast Hall</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="teamSelect">SELECT TEAM:</label>
          <select id="teamSelect">
            <option value="">Loading teams...</option>
          </select>
        </div>
        
        <div class="button-group">
          <button class="btn" onclick="startGame()">START TYPING TEST</button>
        </div>
      </div>

      <!-- Game Area -->
      <div id="gameArea" class="game-area">
        <div class="game-hud">
          <div class="timer-display">TIME: <span id="timerValue">60</span>s</div>
          <div class="stats-display">
            <div class="stat-item">
              WPM<br><span class="stat-value" id="wpmValue">0</span>
            </div>
            <div class="stat-item">
              ACCURACY<br><span class="stat-value" id="accuracyValue">100%</span>
            </div>
            <div class="stat-item">
              WORDS<br><span class="stat-value" id="wordsValue">0</span>
            </div>
          </div>
        </div>
        
        <div id="wordDisplay"></div>
        
        <input 
          type="text" 
          id="typeInput" 
          placeholder="Start typing..."
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
        >
        
        <div class="instructions">Type the text above as quickly and accurately as possible!</div>
      </div>

      <!-- Results -->
      <div id="results" class="results">
        <div class="game-over-title">TIME'S UP!</div>
        <div class="final-score">
          WORDS PER MINUTE: <span id="finalWPM">0</span><br>
          ACCURACY: <span id="finalAccuracy">0</span>%<br>
          WORDS TYPED: <span id="finalWords">0</span>
        </div>
        <div id="submissionMessage" style="margin: 15px 0; font-size: 12px; color: #0f0; text-shadow: 0 0 10px #0f0; display: none;">
          ✓ Score saved successfully!
        </div>
        <div id="scoreStats" style="margin: 20px 0; font-size: 10px; line-height: 2; color: #0ff;">
          <div>YOUR TEAM'S BEST: <span id="bestScoreDisplay">Loading...</span> WPM</div>
        </div>
        <div class="button-group">
          <button class="btn" onclick="resetGame()">PLAY AGAIN</button>
          <button class="btn btn-secondary" onclick="backToMenu()">MAIN MENU</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
        authDomain: "eviltrivia-47664.firebaseapp.com",
        databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
        projectId: "eviltrivia-47664",
        storageBucket: "eviltrivia-47664.firebaseapp.com",
        messagingSenderId: "401826818140",
        appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
        measurementId: "G-2W6RK96Y34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.dbRef = ref;
    window.dbPush = push;
    window.dbSet = set;
    window.dbGet = get;
  </script>

  <script>
    // Word pool for typing test (fallback if no paragraph is set)
    const WORD_POOL = [
      'trivia', 'answer', 'question', 'team', 'score', 'music', 'movie', 'history',
      'science', 'sports', 'geography', 'pop', 'culture', 'general', 'knowledge',
      'brain', 'challenge', 'compete', 'winner', 'champion', 'puzzle', 'mystery',
      'fact', 'truth', 'false', 'correct', 'wrong', 'point', 'round', 'final',
      'bonus', 'lightning', 'category', 'theme', 'decade', 'artist', 'album',
      'song', 'actor', 'director', 'author', 'book', 'novel', 'character', 'plot',
      'sequel', 'prequel', 'franchise', 'series', 'episode', 'season', 'finale',
      'president', 'capital', 'country', 'continent', 'ocean', 'mountain', 'river',
      'battle', 'war', 'peace', 'treaty', 'empire', 'dynasty', 'century', 'era',
      'element', 'compound', 'molecule', 'atom', 'physics', 'chemistry', 'biology',
      'equation', 'theory', 'hypothesis', 'experiment', 'discovery', 'invention',
      'player', 'athlete', 'championship', 'league', 'tournament', 'medal', 'record',
      'stadium', 'coach', 'referee', 'penalty', 'goal', 'touchdown', 'homerun'
    ];

    // Game variables
    let gameActive = false;
    let fullText = '';
    let currentCharIndex = 0;
    let wordsTyped = 0;
    let correctChars = 0;
    let totalChars = 0;
    let gameTimer = null;
    let timeRemaining = 60;
    let gameStartTime = 0;
    let errors = 0;

    // DOM elements
    const setupForm = document.getElementById('setupForm');
    const gameArea = document.getElementById('gameArea');
    const results = document.getElementById('results');
    const wordDisplay = document.getElementById('wordDisplay');
    const typeInput = document.getElementById('typeInput');
    const timerValue = document.getElementById('timerValue');
    const wpmValue = document.getElementById('wpmValue');
    const accuracyValue = document.getElementById('accuracyValue');
    const wordsValue = document.getElementById('wordsValue');

    async function onLocationChange() {
      const location = document.getElementById('barLocation').value;
      const teamSelect = document.getElementById('teamSelect');
      
      if (!location) {
        teamSelect.innerHTML = '<option value="">Select location first</option>';
        return;
      }
      
      await loadTeamsForLocation(location);
    }

    async function loadTeamsForLocation(location) {
      try {
        const teamSelect = document.getElementById('teamSelect');
        teamSelect.innerHTML = '<option value="">Loading...</option>';
        
        // Load teams for this specific location from active sessions
        const activeSessionsSnap = await window.dbGet(window.dbRef(window.db, 'games/keyboardwarriors/activeSessions'));
        
        if (!activeSessionsSnap.exists()) {
          teamSelect.innerHTML = '<option value="">No active sessions - contact admin</option>';
          return;
        }
        
        const activeSessions = activeSessionsSnap.val();
        
        // Find session by matching the location field
        let sessionData = null;
        for (const key in activeSessions) {
          if (activeSessions[key].location === location) {
            sessionData = activeSessions[key];
            break;
          }
        }
        
        if (!sessionData || !sessionData.teams || sessionData.teams.length === 0) {
          teamSelect.innerHTML = '<option value="">No active session for this location</option>';
          return;
        }
        
        // Populate with teams from this location only
        teamSelect.innerHTML = '<option value="">Select your team...</option>';
        sessionData.teams.sort().forEach(teamName => {
          const option = document.createElement('option');
          option.value = teamName;
          option.textContent = teamName;
          teamSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading teams:', error);
        document.getElementById('teamSelect').innerHTML = '<option value="">Error loading teams</option>';
      }
    }

    async function startGame() {
      const teamName = document.getElementById('teamSelect').value;
      const barLocation = document.getElementById('barLocation').value;
      
      if (!teamName || !barLocation) {
        alert('Please select team name and bar location.');
        return;
      }
      
      // Load paragraph settings
      await loadParagraphSettings();
      
      // Reset game state
      wordsTyped = 0;
      correctChars = 0;
      totalChars = 0;
      errors = 0;
      currentCharIndex = 0;
      timeRemaining = 60;
      gameActive = true;
      gameStartTime = Date.now();
      
      // Update UI
      setupForm.style.display = 'none';
      gameArea.style.display = 'block';
      results.style.display = 'none';
      
      typeInput.value = '';
      typeInput.disabled = false;
      typeInput.focus();
      
      // Display the full text
      displayText();
      startTimer();
      updateStats();
    }

    function displayText() {
      if (!fullText) return;
      
      let html = '';
      const typed = typeInput.value;
      
      for (let i = 0; i < fullText.length; i++) {
        const char = fullText[i];
        
        if (i < typed.length) {
          // Already typed
          if (typed[i] === char) {
            html += `<span class="correct">${char === ' ' ? '&nbsp;' : char}</span>`;
          } else {
            html += `<span class="incorrect">${char === ' ' ? '&nbsp;' : char}</span>`;
          }
        } else if (i === typed.length) {
          // Current character
          html += `<span class="current">${char === ' ' ? '&nbsp;' : char}</span>`;
        } else {
          // Not yet typed
          html += char === ' ' ? '&nbsp;' : char;
        }
      }
      
      wordDisplay.innerHTML = html;
    }

    async function loadParagraphSettings() {
      try {
        const paragraphRef = window.dbRef(window.db, 'games/keyboardwarriors/settings/paragraph');
        const snapshot = await window.dbGet(paragraphRef);
        
        if (snapshot.exists()) {
          const data = snapshot.val();
          const paragraphText = data.text || '';
          
          if (paragraphText.trim()) {
            fullText = paragraphText.trim();
            console.log('Using paragraph mode:', fullText.length, 'characters');
          } else {
            // Generate random words text
            generateRandomText();
          }
        } else {
          // Generate random words text
          generateRandomText();
        }
      } catch (error) {
        console.error('Error loading paragraph settings:', error);
        generateRandomText();
      }
    }

    function generateRandomText() {
      // Generate a paragraph from random words (about 50 words)
      const numWords = 50;
      const words = [];
      for (let i = 0; i < numWords; i++) {
        words.push(WORD_POOL[Math.floor(Math.random() * WORD_POOL.length)]);
      }
      fullText = words.join(' ');
      console.log('Using random words mode:', fullText.length, 'characters');
    }


    function startTimer() {
      timerValue.textContent = timeRemaining;
      
      gameTimer = setInterval(() => {
        timeRemaining--;
        timerValue.textContent = timeRemaining;
        
        if (timeRemaining <= 0) {
          endGame();
        }
      }, 1000);
    }

    // Handle typing input
    typeInput.addEventListener('input', (e) => {
      if (!gameActive) return;
      
      const typed = e.target.value;
      
      // Prevent typing beyond the text length
      if (typed.length > fullText.length) {
        typeInput.value = typed.slice(0, fullText.length);
        return;
      }
      
      // Calculate stats
      correctChars = 0;
      errors = 0;
      
      for (let i = 0; i < typed.length; i++) {
        if (typed[i] === fullText[i]) {
          correctChars++;
        } else {
          errors++;
        }
      }
      
      totalChars = typed.length;
      
      // Count words (count spaces that were typed correctly)
      wordsTyped = 0;
      for (let i = 0; i < typed.length; i++) {
        if (fullText[i] === ' ' && typed[i] === ' ') {
          wordsTyped++;
        }
      }
      
      // Check if finished
      if (typed.length === fullText.length && correctChars === fullText.length) {
        endGame();
        return;
      }
      
      // Update display
      displayText();
      updateStats();
    });

    function updateStats() {
      // Calculate WPM
      const timeElapsed = (Date.now() - gameStartTime) / 1000 / 60; // in minutes
      const wpm = timeElapsed > 0 ? Math.round(wordsTyped / timeElapsed) : 0;
      
      // Calculate accuracy
      const accuracy = totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 100;
      
      wpmValue.textContent = wpm;
      accuracyValue.textContent = accuracy + '%';
      wordsValue.textContent = wordsTyped;
    }

    function endGame() {
      gameActive = false;
      clearInterval(gameTimer);
      typeInput.disabled = true;
      
      // Calculate final stats
      const timeElapsed = 60 / 60; // 1 minute
      const finalWPM = Math.round(wordsTyped / timeElapsed);
      const finalAccuracy = totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 100;
      
      // Update results display
      document.getElementById('finalWPM').textContent = finalWPM;
      document.getElementById('finalAccuracy').textContent = finalAccuracy;
      document.getElementById('finalWords').textContent = wordsTyped;
      
      // Show results
      gameArea.style.display = 'none';
      results.style.display = 'block';
      
      // Submit score
      submitScore(finalWPM, finalAccuracy).then(() => {
        setTimeout(() => {
          loadScoreStats();
        }, 500);
      });
    }

    async function submitScore(wpm, accuracy) {
      const teamName = document.getElementById('teamSelect').value;
      const barLocation = document.getElementById('barLocation').value;
      
      if (!teamName || !barLocation) return;
      
      const scoreData = {
        teamName: teamName,
        barLocation: barLocation,
        wpm: wpm,
        accuracy: accuracy,
        wordsTyped: wordsTyped,
        timestamp: Date.now(),
        date: new Date().toISOString().split('T')[0]
      };
      
      try {
        const answersRef = window.dbRef(window.db, 'games/keyboardwarriors/answers');
        const newAnswerRef = window.dbPush(answersRef);
        await window.dbSet(newAnswerRef, scoreData);
        console.log('Score submitted successfully');
        document.getElementById('submissionMessage').style.display = 'block';
      } catch (error) {
        console.error('Error submitting to main path:', error);
        
        try {
          const publicAnswersRef = window.dbRef(window.db, 'publicAnswers/keyboardwarriors');
          const newAnswerRef = window.dbPush(publicAnswersRef);
          await window.dbSet(newAnswerRef, scoreData);
          console.log('Score submitted to fallback path');
          document.getElementById('submissionMessage').style.display = 'block';
        } catch (fallbackError) {
          console.error('Error submitting to fallback path:', fallbackError);
        }
      }
    }

    async function loadScoreStats() {
      try {
        const currentTeam = document.getElementById('teamSelect').value;
        document.getElementById('bestScoreDisplay').textContent = 'Loading...';
        
        const scores = [];
        
        // Load from both paths
        const mainSnap = await window.dbGet(window.dbRef(window.db, 'games/keyboardwarriors/answers'));
        if (mainSnap.exists()) {
          Object.values(mainSnap.val()).forEach(s => scores.push(s));
        }
        
        const publicSnap = await window.dbGet(window.dbRef(window.db, 'publicAnswers/keyboardwarriors'));
        if (publicSnap.exists()) {
          Object.values(publicSnap.val()).forEach(s => scores.push(s));
        }
        
        if (scores.length === 0) {
          document.getElementById('bestScoreDisplay').textContent = 'No scores yet';
          return;
        }
        
        // Filter scores for current team
        const teamScores = scores.filter(s => s.teamName === currentTeam);
        
        if (teamScores.length === 0) {
          document.getElementById('bestScoreDisplay').textContent = 'First score for your team!';
        } else {
          const bestWPM = Math.max(...teamScores.map(s => s.wpm || 0));
          document.getElementById('bestScoreDisplay').textContent = bestWPM;
        }
        
      } catch (error) {
        console.error('Error loading score stats:', error);
        document.getElementById('bestScoreDisplay').textContent = 'Error';
      }
    }

    function resetGame() {
      results.style.display = 'none';
      startGame();
    }

    function backToMenu() {
      results.style.display = 'none';
      gameArea.style.display = 'none';
      setupForm.style.display = 'flex';
    }

    // Make functions global
    window.startGame = startGame;
    window.resetGame = resetGame;
    window.backToMenu = backToMenu;
    window.onLocationChange = onLocationChange;
  </script>
</body>
</html>

