<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - This Week's Trivia</title>
  <script src="/js/components/autoload-banner.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      margin-top: 60px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .content-section {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .auth-message {
      text-align: center;
      padding: 50px;
      font-size: 18px;
      color: #666;
    }
    
    .btn {
      display: inline-block;
      background-color: #000;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      transition: background-color 0.3s;
    }
    
    .btn:hover {
      background-color: #333;
    }
    
    .btn-patreon {
      background-color: #F96854;
    }
    
    .btn-patreon:hover {
      background-color: #e05c49;
    }
    
    .trivia-content {
      display: none;
    }
    
    .trivia-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
    }
    
    .active-btn {
      background-color: #555;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .login-section {
      text-align: center;
      padding: 20px;
    }
    
    .pdf-viewer, .interactive-trivia {
      margin-top: 20px;
    }
    
    .pdf-container {
      margin-top: 20px;
    }
    
    .iframe-container {
      position: relative;
      width: 100%;
      height: 600px;
      margin: 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      background-color: #f5f5f5;
    }
    
    .pdf-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .pdf-controls {
      margin: 20px 0;
      text-align: center;
    }
    
    .music-section {
      margin-top: 30px;
      text-align: center;
    }
    
    #reveal-answers-btn {
      background-color: #dc3545;
    }
    
    #reveal-answers-btn:hover {
      background-color: #c82333;
    }
    
    /* Side-by-side PDF layout */
    .pdf-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .pdf-column {
      flex: 1;
      min-width: 300px;
    }
    
    .pdf-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .print-btn {
      background-color: #28a745;
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .print-btn:hover {
      background-color: #218838;
    }
    
    @media (max-width: 768px) {
      .pdf-row {
        flex-direction: column;
      }
    }
    
    /* Styles for audio player */
    .audio-player {
      background-color: #f0f0f0;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      max-width: 100%;
    }
    
    .audio-player audio {
      width: 100%;
    }
    
    /* Custom audio player appearance */
    audio {
      border-radius: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Now Playing indicator */
    .now-playing {
      font-size: 14px;
      margin-bottom: 5px;
      color: #333;
      font-weight: bold;
    }
    
    /* Container for the embedded music player */
    #embedded-audio-container {
      margin: 15px 0;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>This Week's Trivia</h1>
    
    <!-- Admin Controls - Only visible to admins -->
    <div id="admin-controls" class="content-section hidden">
      <h3>Admin Controls</h3>
      <div class="admin-form">
        <div class="form-group">
          <label for="trivia-selector">Select Trivia Number:</label>
          <select id="trivia-selector" class="form-control"></select>
        </div>
        <button id="btn-change-trivia" class="btn">Change Active Trivia</button>
        <a href="/games/triviaadmin.html" class="btn" style="margin-left: 10px;">Trivia Management</a>
      </div>
    </div>
    
    <div class="content-section">
      <!-- Loading State -->
      <div id="loading-section" class="auth-message">
        <div class="loader"></div>
        <p>Loading trivia content...</p>
      </div>
      
      <!-- Not Logged In State -->
      <div id="not-logged-in" class="auth-message hidden">
        <h2>Access Required</h2>
        <p>You need to sign in to access this week's trivia.</p>
        <div class="login-section">
          <a href="/pages/account.html" class="btn">Sign In</a>
        </div>
      </div>
      
      <!-- Not Authorized State -->
      <div id="not-authorized" class="auth-message hidden">
        <h2>Patreon Membership Required</h2>
        <p>You must be a Patreon member pledging $5 or more to access this week's trivia.</p>
        <div class="login-section">
          <a href="https://patreon.com/eviltrivia" class="btn btn-patreon">Join on Patreon</a>
          <a href="/pages/account.html" class="btn">Connect Existing Patreon</a>
        </div>
      </div>
      
      <!-- Authorized Content -->
      <div id="trivia-authorized" class="trivia-content">
        <div class="trivia-options">
          <button id="btn-pdf" class="btn">PDF Trivia</button>
          <button id="btn-interactive" class="btn">Interactive Trivia</button>
        </div>
        
        <!-- PDF Trivia Section -->
        <div id="pdf-section" class="pdf-viewer hidden">
          <h2>PDF Trivia</h2>
          
          <div class="pdf-container">
            <!-- Questions and Teams Sheet side by side -->
            <div class="pdf-row">
              <!-- Questions PDF Column -->
              <div class="pdf-column">
                <div class="pdf-header">
                  <h3>Questions PDF</h3>
                  <a id="questions-print-btn" class="btn print-btn" target="_blank">Open to Print</a>
                </div>
                <div class="iframe-container" id="questions-pdf-container">
                  <div class="loader" id="questions-pdf-loader"></div>
                  <!-- iframe will be inserted here dynamically -->
                </div>
              </div>
              
              <!-- Teams Sheet Column -->
              <div class="pdf-column">
                <div class="pdf-header">
                  <h3>Teams Sheet</h3>
                  <a id="teams-print-btn" class="btn print-btn" target="_blank">Open to Print</a>
                </div>
                <div class="iframe-container" id="teams-pdf-container">
                  <div class="loader" id="teams-pdf-loader"></div>
                  <!-- iframe will be inserted here dynamically -->
                </div>
              </div>
            </div>
            
            <!-- Music Section - Moved above Reveal Answers button -->
            <div class="music-section">
              <div class="pdf-header">
                <h3>Music Folder</h3>
                <a id="music-folder-link" class="btn print-btn" target="_blank">Open in New Tab</a>
              </div>
              <!-- Dedicated audio player for playing music without leaving the page -->
              <div id="embedded-audio-container" class="audio-player">
                <div class="now-playing">Now Playing: <span id="track-name">No track selected</span></div>
                <audio id="embedded-audio-player" controls></audio>
              </div>
              <div class="iframe-container" id="music-folder-container">
                <div class="loader" id="music-folder-loader"></div>
                <!-- Music folder iframe will be inserted here dynamically -->
              </div>
            </div>
            
            <div class="pdf-controls">
              <button id="reveal-answers-btn" class="btn">Reveal Answers</button>
            </div>
            
            <div id="answers-section" class="hidden">
              <div class="pdf-header">
                <h3>Answers PDF</h3>
                <a id="answers-print-btn" class="btn print-btn" target="_blank">Open to Print</a>
              </div>
              <div class="iframe-container" id="answers-pdf-container">
                <div class="loader" id="answers-pdf-loader"></div>
                <!-- iframe will be inserted here dynamically -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Interactive Trivia Section -->
        <div id="interactive-section" class="interactive-trivia hidden">
          <h2>Interactive Trivia</h2>
          <p>Interactive trivia content will be loaded here.</p>
          <!-- Interactive content will be loaded here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.firebasestorage.app",
      messagingSenderId: "401826818140",
      appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
      measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    // DOM Elements
    const loadingSection = document.getElementById('loading-section');
    const notLoggedIn = document.getElementById('not-logged-in');
    const notAuthorized = document.getElementById('not-authorized');
    const triviaAuthorized = document.getElementById('trivia-authorized');
    const btnPDF = document.getElementById('btn-pdf');
    const btnInteractive = document.getElementById('btn-interactive');
    const pdfSection = document.getElementById('pdf-section');
    const interactiveSection = document.getElementById('interactive-section');
    
    // Admin Elements
    const adminControls = document.getElementById('admin-controls');
    const triviaSelector = document.getElementById('trivia-selector');
    const btnChangeTrivia = document.getElementById('btn-change-trivia');
    
    // Current active trivia
    let currentTriviaNumber = 1;
    let isAdmin = false;
    
    // Check if user is authorized
    async function checkUserAuthorization(user) {
      try {
        // Check if user exists in database
        const userSnapshot = await get(ref(db, `users/${user.uid}`));
        if (!userSnapshot.exists()) {
          console.log('User not found in database');
          return false;
        }
        
        const userData = userSnapshot.val();
        
        // If user is admin, they're authorized
        if (userData.role === 'admin') {
          console.log('User is admin, access granted');
          isAdmin = true;
          return true;
        }
        
        // Check if user has Patreon ID
        if (!userData.patreonId) {
          console.log('User has no Patreon ID');
          return false;
        }
        
        // Get Patreon settings - minimum pledge amount
        const settingsSnapshot = await get(ref(db, 'adminSettings/patreon'));
        if (!settingsSnapshot.exists()) {
          console.log('Patreon settings not found');
          return false;
        }
        
        const patreonSettings = settingsSnapshot.val();
        const requiredAmountCents = patreonSettings.requiredAmountCents || 500; // Default to $5 if not set
        
        // Get Patreon user data
        const patreonSnapshot = await get(ref(db, `patreonUsers/${userData.patreonId}`));
        if (!patreonSnapshot.exists()) {
          console.log('Patreon user data not found');
          return false;
        }
        
        const patreonData = patreonSnapshot.val();
        
        // Check if user is active member with sufficient pledge
        const membershipData = patreonData.membershipData || {};
        const attributes = membershipData.attributes || {};
        
        // Check pledge amount
        const pledgeAmountCents = patreonData.pledgeAmountCents || 
                                  attributes.currently_entitled_amount_cents || 0;
        
        // Check if pledge amount meets minimum requirements
        if (pledgeAmountCents >= requiredAmountCents && 
            (patreonData.isActiveMember || attributes.patron_status === 'active_patron')) {
          console.log('User is active Patreon member with sufficient pledge');
          return true;
        }
        
        console.log('User Patreon membership does not meet requirements');
        return false;
        
      } catch (error) {
        console.error('Error checking authorization:', error);
        return false;
      }
    }
    
    // Handle auth state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log('User is signed in:', user.uid);
        
        // Check if user is authorized
        const isAuthorized = await checkUserAuthorization(user);
        
        if (isAuthorized) {
          // Show authorized content
          loadingSection.classList.add('hidden');
          notLoggedIn.classList.add('hidden');
          notAuthorized.classList.add('hidden');
          triviaAuthorized.style.display = 'block';
          
          // Show admin controls if user is admin
          if (isAdmin) {
            adminControls.classList.remove('hidden');
            loadAdminData();
          }
          
          // Load trivia content
          loadTriviaContent();
        } else {
          // Show not authorized message
          loadingSection.classList.add('hidden');
          notLoggedIn.classList.add('hidden');
          notAuthorized.classList.remove('hidden');
          triviaAuthorized.style.display = 'none';
        }
      } else {
        // User is not signed in
        console.log('User is not signed in');
        loadingSection.classList.add('hidden');
        notLoggedIn.classList.remove('hidden');
        notAuthorized.classList.add('hidden');
        triviaAuthorized.style.display = 'none';
      }
    });
    
    // Load trivia content
    async function loadTriviaContent() {
      try {
        // Fetch active trivia information from Firebase
        const activeTrivia = await getActiveTrivia();
        currentTriviaNumber = activeTrivia.number || 1;
        
        console.log('Loading trivia content for trivia #', currentTriviaNumber);
        
        // Update the section titles with the trivia number
        pdfSection.querySelector('h2').textContent = `PDF Trivia #${currentTriviaNumber}`;
        interactiveSection.querySelector('h2').textContent = `Interactive Trivia #${currentTriviaNumber}`;
        
        // Load PDF content
        if (btnPDF.classList.contains('active-btn')) {
          loadPDFContent(currentTriviaNumber);
        }
      } catch (error) {
        console.error('Error loading trivia content:', error);
      }
    }
    
    // Get active trivia from Firebase
    async function getActiveTrivia() {
      try {
        const snapshot = await get(ref(db, 'trivia-archive/active'));
        if (snapshot.exists()) {
          return snapshot.val();
        }
        return { number: 1, name: 'Default Trivia' };
      } catch (error) {
        console.error('Error getting active trivia:', error);
        return { number: 1, name: 'Default Trivia' };
      }
    }
    
    // Load admin data including available trivias
    async function loadAdminData() {
      try {
        // Clear existing options
        triviaSelector.innerHTML = '';
        
        // Get list of available trivias
        const snapshot = await get(ref(db, 'trivia-archive/archive'));
        if (snapshot.exists()) {
          const trivias = snapshot.val();
          // Create options for each trivia
          Object.entries(trivias).forEach(([number, trivia]) => {
            const option = document.createElement('option');
            option.value = number;
            option.textContent = `Trivia #${number}: ${trivia.triviaName || 'Untitled'}`;
            triviaSelector.appendChild(option);
          });
        } else {
          // Add a default option if no trivias found
          const option = document.createElement('option');
          option.value = "1";
          option.textContent = "Trivia #1";
          triviaSelector.appendChild(option);
        }
        
        // Get active trivia and set selector to match
        const activeTrivia = await getActiveTrivia();
        triviaSelector.value = activeTrivia.number;
        
      } catch (error) {
        console.error('Error loading admin data:', error);
      }
    }
    
    // Handle change active trivia button
    btnChangeTrivia.addEventListener('click', async () => {
      try {
        const selectedTriviaNumber = triviaSelector.value;
        if (!selectedTriviaNumber) {
          console.error('No trivia selected');
          return;
        }
        
        // Get name of selected trivia
        const snapshot = await get(ref(db, `trivia-archive/archive/${selectedTriviaNumber}`));
        let triviaName = 'Unknown Trivia';
        if (snapshot.exists()) {
          triviaName = snapshot.val().triviaName || `Trivia #${selectedTriviaNumber}`;
        }
        
        // Update active trivia
        await set(ref(db, 'trivia-archive/active'), {
          number: selectedTriviaNumber,
          name: triviaName,
          updatedAt: new Date().toISOString(),
          updatedBy: auth.currentUser.uid
        });
        
        console.log('Active trivia updated to:', selectedTriviaNumber);
        
        // Reload trivia content
        loadTriviaContent();
        
      } catch (error) {
        console.error('Error changing active trivia:', error);
      }
    });
    
    // Load PDF content from Firebase
    async function loadPDFContent(triviaNumber) {
      try {
        // Show loaders
        const questionsLoader = document.getElementById('questions-pdf-loader');
        const teamsLoader = document.getElementById('teams-pdf-loader');
        const answersLoader = document.getElementById('answers-pdf-loader');
        
        if (questionsLoader) questionsLoader.style.display = 'block';
        if (teamsLoader) teamsLoader.style.display = 'block';
        if (answersLoader) answersLoader.style.display = 'block';
        
        // Get trivia drive links from Firebase
        const driveLinksSnapshot = await get(ref(db, `trivia-archive/driveLookup/${triviaNumber}`));
        
        if (driveLinksSnapshot.exists()) {
          const driveLinks = driveLinksSnapshot.val();
          console.log("Drive links data:", driveLinks);
          
          // Helper function to create a direct embed for Google Drive
          function createGoogleDriveEmbed(url) {
            if (!url) return null;
            
            // Extract the Google Drive file ID
            let fileId = null;
            
            // Format: https://drive.google.com/open?id=FILE_ID
            const openIdMatch = url.match(/id=([^&]+)/);
            if (openIdMatch) {
              fileId = openIdMatch[1];
            }
            
            // Format: https://drive.google.com/file/d/FILE_ID/view
            const fileViewMatch = url.match(/\/file\/d\/([^\/]+)/);
            if (fileViewMatch) {
              fileId = fileViewMatch[1];
            }
            
            if (!fileId) {
              console.error("Could not extract file ID from URL:", url);
              return null;
            }
            
            console.log("Extracted file ID:", fileId);
            return fileId;
          }
          
          // Helper function to get direct view URL for printing
          function getDirectViewUrl(fileId) {
            if (!fileId) return null;
            return `https://drive.google.com/file/d/${fileId}/view`;
          }
          
          // Set Questions PDF
          const questionsPdfContainer = document.getElementById('questions-pdf-container');
          const questionsPrintBtn = document.getElementById('questions-print-btn');
          if (questionsPdfContainer && questionsPrintBtn) {
            if (driveLinks["Questions PDF"]) {
              try {
                const fileId = createGoogleDriveEmbed(driveLinks["Questions PDF"]);
                if (fileId) {
                  // Create the embed HTML
                  const embedHtml = `
                    <iframe 
                      src="https://drive.google.com/file/d/${fileId}/preview" 
                      width="100%" 
                      height="100%" 
                      allow="autoplay"
                      allowfullscreen>
                    </iframe>
                  `;
                  questionsPdfContainer.innerHTML = embedHtml;
                  
                  // Set up print button
                  questionsPrintBtn.href = getDirectViewUrl(fileId);
                  questionsPrintBtn.style.display = 'inline-block';
                } else {
                  questionsPdfContainer.innerHTML = '<p>Error: Could not process Questions PDF link.</p>';
                  questionsPrintBtn.style.display = 'none';
                }
              } catch (error) {
                console.error("Error setting questions PDF:", error);
                questionsPdfContainer.innerHTML = '<p>Error loading Questions PDF: ' + error.message + '</p>';
                questionsPrintBtn.style.display = 'none';
              }
            } else {
              questionsPdfContainer.innerHTML = '<p>Questions PDF not available</p>';
              questionsPrintBtn.style.display = 'none';
            }
          }
          
          // Set Teams Sheet PDF
          const teamsPdfContainer = document.getElementById('teams-pdf-container');
          const teamsPrintBtn = document.getElementById('teams-print-btn');
          if (teamsPdfContainer && teamsPrintBtn) {
            if (driveLinks["Teams Sheet PDF"]) {
              try {
                const fileId = createGoogleDriveEmbed(driveLinks["Teams Sheet PDF"]);
                if (fileId) {
                  // Create the embed HTML
                  const embedHtml = `
                    <iframe 
                      src="https://drive.google.com/file/d/${fileId}/preview" 
                      width="100%" 
                      height="100%" 
                      allow="autoplay"
                      allowfullscreen>
                    </iframe>
                  `;
                  teamsPdfContainer.innerHTML = embedHtml;
                  
                  // Set up print button
                  teamsPrintBtn.href = getDirectViewUrl(fileId);
                  teamsPrintBtn.style.display = 'inline-block';
                } else {
                  teamsPdfContainer.innerHTML = '<p>Error: Could not process Teams Sheet PDF link.</p>';
                  teamsPrintBtn.style.display = 'none';
                }
              } catch (error) {
                console.error("Error setting teams PDF:", error);
                teamsPdfContainer.innerHTML = '<p>Error loading Teams Sheet: ' + error.message + '</p>';
                teamsPrintBtn.style.display = 'none';
              }
            } else {
              teamsPdfContainer.innerHTML = '<p>Teams Sheet not available</p>';
              teamsPrintBtn.style.display = 'none';
            }
          }
          
          // Set Answers PDF
          const answersPdfContainer = document.getElementById('answers-pdf-container');
          const answersPrintBtn = document.getElementById('answers-print-btn');
          if (answersPdfContainer && answersPrintBtn) {
            if (driveLinks["Answers PDF"]) {
              try {
                const fileId = createGoogleDriveEmbed(driveLinks["Answers PDF"]);
                if (fileId) {
                  // Create the embed HTML
                  const embedHtml = `
                    <iframe 
                      src="https://drive.google.com/file/d/${fileId}/preview" 
                      width="100%" 
                      height="100%" 
                      allow="autoplay"
                      allowfullscreen>
                    </iframe>
                  `;
                  answersPdfContainer.innerHTML = embedHtml;
                  
                  // Set up print button
                  answersPrintBtn.href = getDirectViewUrl(fileId);
                  answersPrintBtn.style.display = 'inline-block';
                } else {
                  answersPdfContainer.innerHTML = '<p>Error: Could not process Answers PDF link.</p>';
                  answersPrintBtn.style.display = 'none';
                }
              } catch (error) {
                console.error("Error setting answers PDF:", error);
                answersPdfContainer.innerHTML = '<p>Error loading Answers PDF: ' + error.message + '</p>';
                answersPrintBtn.style.display = 'none';
              }
            } else {
              answersPdfContainer.innerHTML = '<p>Answers PDF not available</p>';
              answersPrintBtn.style.display = 'none';
            }
          }
          
          // Set Music Folder link
          const musicFolderLink = document.getElementById('music-folder-link');
          const musicFolderContainer = document.getElementById('music-folder-container');
          const musicLoader = document.getElementById('music-folder-loader');
          
          if (musicFolderLink && musicFolderContainer) {
            console.log("Music Folder URL from database:", driveLinks["Music Folder"]);
            
            if (driveLinks["Music Folder"] && driveLinks["Music Folder"].trim() !== '') {
              try {
                // Extract folder ID from the Google Drive URL
                let folderId = null;
                const musicFolderUrl = driveLinks["Music Folder"];
                
                // Format: https://drive.google.com/drive/folders/FOLDER_ID
                const folderMatch = musicFolderUrl.match(/\/folders\/([^\/\?]+)/);
                if (folderMatch) {
                  folderId = folderMatch[1];
                  console.log("Extracted folder ID from folders URL:", folderId);
                }
                
                // Format: https://drive.google.com/open?id=FOLDER_ID
                if (!folderId) {
                  const openIdMatch = musicFolderUrl.match(/id=([^&]+)/);
                  if (openIdMatch) {
                    folderId = openIdMatch[1];
                    console.log("Extracted folder ID from open URL:", folderId);
                  }
                }
                
                // Set up folder viewer and direct link
                if (folderId) {
                  // Update direct link
                  musicFolderLink.href = musicFolderUrl;
                  musicFolderLink.textContent = "Open in New Tab";
                  musicFolderLink.style.display = 'inline-block';
                  
                  // Create folder embed in iframe with clear logging
                  console.log("Creating music folder embed with ID:", folderId);
                  // Using list view which might be better for playing audio files
                  const embedUrl = `https://drive.google.com/embeddedfolderview?id=${folderId}#list`;
                  console.log("Embed URL:", embedUrl);
                  
                  // Create the embed HTML with sandbox allowing media playback
                  const embedHtml = `
                    <iframe 
                      src="${embedUrl}" 
                      width="100%" 
                      height="100%" 
                      frameborder="0"
                      allow="autoplay; encrypted-media; fullscreen"
                      sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-popups-to-escape-sandbox allow-presentation"
                      onload="document.getElementById('music-folder-loader').style.display='none'; console.log('Music folder iframe loaded');"
                      onerror="console.error('Failed to load music folder iframe'); document.getElementById('music-folder-loader').style.display='none';">
                    </iframe>
                  `;
                  musicFolderContainer.innerHTML = embedHtml;
                  
                  console.log("Music folder iframe created");
                  
                  // Add event listener to try to intercept clicks in the iframe
                  try {
                    // Add a message listener to receive messages from the iframe
                    window.addEventListener('message', function(event) {
                      // Check if the message is from Google Drive
                      if (event.origin.includes('google.com') && event.data && event.data.type === 'audio') {
                        console.log("Received audio file from iframe:", event.data);
                        // Play the audio in our embedded player
                        playAudioInEmbeddedPlayer(event.data.url, event.data.name);
                      }
                    });
                    
                    // Inject script into iframe to intercept clicks (this might not work due to cross-origin restrictions)
                    setTimeout(() => {
                      const musicIframe = musicFolderContainer.querySelector('iframe');
                      if (musicIframe && musicIframe.contentWindow) {
                        console.log("Setting up message passing for music iframe");
                        
                        // Function to play audio in our custom player
                        window.playAudioInEmbeddedPlayer = function(url, name) {
                          const audioPlayer = document.getElementById('embedded-audio-player');
                          const trackName = document.getElementById('track-name');
                          const container = document.getElementById('embedded-audio-container');
                          
                          if (audioPlayer && trackName && container) {
                            audioPlayer.src = url;
                            trackName.textContent = name || 'Unknown Track';
                            container.style.display = 'block';
                            audioPlayer.play().catch(err => console.error("Could not autoplay:", err));
                            
                            // Scroll to the player
                            container.scrollIntoView({ behavior: 'smooth' });
                          }
                        };
                        
                        // This is a fallback approach that likely won't work due to cross-origin restrictions
                        try {
                          const iframeDoc = musicIframe.contentDocument || musicIframe.contentWindow.document;
                          
                          // Add click listener to the iframe document
                          iframeDoc.addEventListener('click', function(e) {
                            const link = e.target.closest('a');
                            console.log("Click in iframe detected:", link);
                            
                            if (link && link.href) {
                              // Check if this is an audio file
                              const isAudio = link.href.match(/\.(mp3|wav|ogg|m4a)$/i);
                              // Check if this looks like a Google Drive file
                              const isDriveFile = link.href.includes('/file/d/');
                              
                              if (isAudio || isDriveFile) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                const fileName = link.textContent || 'Track';
                                console.log("Intercepted audio file:", fileName, link.href);
                                
                                // Get direct playable URL (if Google Drive, convert to direct link)
                                let directUrl = link.href;
                                if (isDriveFile) {
                                  // Try to extract file ID
                                  const fileIdMatch = link.href.match(/\/file\/d\/([^\/]+)/);
                                  if (fileIdMatch && fileIdMatch[1]) {
                                    directUrl = `https://drive.google.com/uc?export=download&id=${fileIdMatch[1]}`;
                                  }
                                }
                                
                                // Play in our custom player
                                window.playAudioInEmbeddedPlayer(directUrl, fileName);
                                return false;
                              }
                            }
                          }, true);
                          
                          console.log("Successfully added click interceptor to iframe document");
                        } catch (err) {
                          console.warn("Could not access iframe document due to cross-origin policy:", err);
                        }
                      }
                    }, 2000);
                  } catch (e) {
                    console.warn("Could not set up click interception for music files:", e);
                  }
                } else {
                  console.warn("Could not extract folder ID from URL:", musicFolderUrl);
                  // If we can't extract a folder ID, just use direct link as before
                  musicFolderLink.href = musicFolderUrl;
                  musicFolderLink.textContent = "Open Music Folder";
                  musicFolderLink.style.display = 'inline-block';
                  
                  // Show message in container
                  musicFolderContainer.innerHTML = '<p>Music folder embed not available, please use the link above.</p>';
                  // Hide loader
                  if (musicLoader) {
                    musicLoader.style.display = 'none';
                  }
                }
              } catch (error) {
                console.error("Error setting music folder link:", error);
                const musicSection = document.querySelector('.music-section');
                musicFolderContainer.innerHTML = '<p>Error loading Music Folder: ' + error.message + '</p>';
                // Hide loader
                if (musicLoader) {
                  musicLoader.style.display = 'none';
                }
              }
            } else {
              console.warn("No music folder URL provided in database");
              musicFolderContainer.innerHTML = '<p>Music folder not available</p>';
              if (musicLoader) {
                musicLoader.style.display = 'none';
              }
            }
          } else {
            console.error("Missing music folder elements in the DOM");
          }
        } else {
          console.error('No drive links found for trivia #', triviaNumber);
          const pdfSection = document.getElementById('pdf-section');
          if (pdfSection) {
            pdfSection.innerHTML = `<h2>PDF Trivia #${triviaNumber}</h2><p>No PDF content available for this trivia.</p>`;
          }
        }
      } catch (error) {
        console.error('Error loading PDF content:', error);
        const pdfSection = document.getElementById('pdf-section');
        if (pdfSection) {
          pdfSection.innerHTML += `<p class="error">Error loading PDF content: ${error.message}</p>`;
        }
      } finally {
        // Hide all loaders in case they weren't hidden properly
        const loaders = document.querySelectorAll('.loader');
        loaders.forEach(loader => {
          if (loader) loader.style.display = 'none';
        });
      }
    }
    
    // Button click handlers
    btnPDF.addEventListener('click', () => {
      btnPDF.classList.add('active-btn');
      btnInteractive.classList.remove('active-btn');
      pdfSection.classList.remove('hidden');
      interactiveSection.classList.add('hidden');
      
      // Load PDF content if it hasn't been loaded yet
      loadPDFContent(currentTriviaNumber);
    });
    
    btnInteractive.addEventListener('click', () => {
      btnInteractive.classList.add('active-btn');
      btnPDF.classList.remove('active-btn');
      interactiveSection.classList.remove('hidden');
      pdfSection.classList.add('hidden');
    });
    
    // Reveal answers button handler
    document.getElementById('reveal-answers-btn').addEventListener('click', function() {
      const answersSection = document.getElementById('answers-section');
      if (answersSection.classList.contains('hidden')) {
        answersSection.classList.remove('hidden');
        this.textContent = 'Hide Answers';
      } else {
        answersSection.classList.add('hidden');
        this.textContent = 'Reveal Answers';
      }
    });
    
    // Initialize with PDF view active by default
    document.addEventListener('DOMContentLoaded', () => {
      btnPDF.click();
    });
  </script>
</body>
</html> 