<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Evil Trivia - Face the Nation Admin</title>
    <script src="/js/components/autoload-banner.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 30px;
            background-color: #FFCC00;
            margin-top: 60px;
        }
        .hidden {
            display: none;
        }
        .section {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 15px;
            background-color: white;
            border-radius: 8px;
            max-width: 1200px;
        }
        h1, h2 {
            margin-top: 0;
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-weight: bold;
            font-size: 14px;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #000000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #333333;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input[type="text"], 
        input[type="number"],
        textarea,
        select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            width: 100%;
            height: 100px;
            resize: vertical;
            font-family: monospace;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }
        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-group-small {
            flex: 0 0 100px;
        }
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        .preview-container {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .auth-message {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        .btn-login {
            display: inline-block;
            background-color: #000;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 20px;
        }
        .btn-login:hover {
            background-color: #333;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="authContainer" class="section">
        <div class="auth-message">
            <h1>Face the Nation Admin</h1>
            <p>You need to be signed in as an admin to access this page.</p>
            <a href="/pages/account.html" class="btn-login">Sign In</a>
        </div>
    </div>

    <!-- Admin Container -->
    <div id="adminContainer" class="hidden">
        <h1>Face the Nation Admin</h1>
        
        <!-- API Key Configuration Section -->
        <div class="section">
            <h2>API Key Setup (Required for Label Hiding)</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="apiKeyInput">Maps Embed API Key (Free):</label>
                    <input type="text" id="apiKeyInput" placeholder="Paste your Google Maps Embed API key here">
                    <small>Get a free API key: <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> → Enable "Maps Embed API" → Create API Key</small>
                </div>
            </div>
            <div class="controls">
                <button onclick="saveApiKey()">Save API Key</button>
                <button onclick="testApiKey()">Test API Key</button>
            </div>
            <div id="apiKeyMessage" style="margin-top: 15px;"></div>
        </div>

        <!-- Add New Location Section -->
        <div class="section">
            <h2>Add New Location</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="newLocationName">Location Name (for admin reference only):</label>
                    <input type="text" id="newLocationName" placeholder="e.g., Times Square, NYC">
                </div>
                <div class="form-group-small">
                    <label for="newLocationOrder">Order:</label>
                    <input type="number" id="newLocationOrder" min="1" value="1">
                </div>
            </div>
            
            <div class="form-group">
                <label for="newLocationUrl">Street View Embed URL:</label>
                <textarea id="newLocationUrl" placeholder="Paste the Google Maps Street View embed URL here..."></textarea>
                <small>To get the embed URL: Go to Google Maps → Find location → Street View → Share → Embed → Copy HTML → Extract the src URL<br>
                <strong>Note:</strong> The puzzle will automatically hide address labels and street names for players.</small>
            </div>
            
            <div class="form-group">
                <label>Preview:</label>
                <div class="preview-container">
                    <iframe id="previewIframe" class="preview-iframe" src=""></iframe>
                </div>
            </div>
            
            <div class="controls">
                <button onclick="previewLocation()">Preview URL</button>
                <button onclick="addLocation()">Add Location</button>
                <button onclick="clearForm()">Clear Form</button>
            </div>
            
            <div id="addLocationMessage" style="margin-top: 15px;"></div>
        </div>

        <!-- Current Locations Section -->
        <div class="section">
            <h2>Current Puzzle Locations</h2>
            
            <div class="controls">
                <button onclick="loadLocations()">Refresh Locations</button>
                <button onclick="clearAllLocations()" style="background-color: #dc3545;">Clear All Locations</button>
            </div>
            
            <div id="locationsLoading" class="loading hidden">
                Loading locations...
            </div>
            
            <div id="locationsError" class="error hidden"></div>
            
            <div id="noLocationsMessage" class="no-data hidden">
                No locations configured yet.
            </div>

            <div class="table-container">
                <table id="locationsTable" class="hidden">
                    <thead>
                        <tr>
                            <th>Order</th>
                            <th>Name</th>
                            <th>URL Preview</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="locationsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getDatabase, ref, get, set, remove, push } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebaseapp.com",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        window.db = db;
        window.dbRef = ref;
        window.dbGet = get;
        window.dbSet = set;
        window.dbRemove = remove;
        window.dbPush = push;

        // Authentication check
        onAuthStateChanged(auth, async (user) => {
            const authContainer = document.getElementById('authContainer');
            const adminContainer = document.getElementById('adminContainer');
            
            if (user) {
                console.log("User is signed in:", user.uid);
                try {
                    const userRoleRef = ref(db, `users/${user.uid}/role`);
                    const roleSnapshot = await get(userRoleRef);
                    
                    console.log("Role check - exists:", roleSnapshot.exists(), "value:", roleSnapshot.val());
                    
                    if (roleSnapshot.exists() && roleSnapshot.val() === 'admin') {
                        console.log("Admin access granted");
                        // User is admin, show admin interface
                        authContainer.style.display = 'none';
                        adminContainer.classList.remove('hidden');
                        // Load locations after showing admin container
                        loadLocations();
                    } else {
                        console.log("User is not admin");
                        // User is not admin
                        authContainer.style.display = 'block';
                        adminContainer.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error checking user role:", error);
                    authContainer.style.display = 'block';
                    adminContainer.classList.add('hidden');
                }
            } else {
                console.log("No user signed in");
                // No user signed in
                authContainer.style.display = 'block';
                adminContainer.classList.add('hidden');
            }
        });
    </script>

    <script>
        // Global variables
        let allLocations = [];
        let mapsApiKey = localStorage.getItem('mapsEmbedApiKey') || '';
        
        // Load saved API key on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (mapsApiKey) {
                document.getElementById('apiKeyInput').value = mapsApiKey;
            }
        });
        
        // Save API key to localStorage
        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showApiKeyMessage('Please enter an API key', 'error');
                return;
            }
            
            localStorage.setItem('mapsEmbedApiKey', apiKey);
            mapsApiKey = apiKey;
            showApiKeyMessage('API key saved successfully!', 'success');
        }
        
        // Test API key by making a simple request
        function testApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showApiKeyMessage('Please enter an API key to test', 'error');
                return;
            }
            
            // Create a test iframe to see if the API key works
            const testUrl = `https://www.google.com/maps/embed/v1/streetview?location=40.7580,-73.9855&key=${apiKey}`;
            const testIframe = document.createElement('iframe');
            testIframe.src = testUrl;
            testIframe.style.width = '300px';
            testIframe.style.height = '200px';
            testIframe.style.border = '1px solid #ddd';
            testIframe.style.borderRadius = '4px';
            
            // Clear previous test results
            const messageDiv = document.getElementById('apiKeyMessage');
            messageDiv.innerHTML = '<p>Testing API key...</p>';
            messageDiv.appendChild(testIframe);
            
            // Check if it loads successfully
            setTimeout(() => {
                showApiKeyMessage('API key appears to be working! Test Street View loaded above.', 'success');
            }, 2000);
        }
        
        function showApiKeyMessage(message, type) {
            const messageDiv = document.getElementById('apiKeyMessage');
            messageDiv.className = type;
            messageDiv.innerHTML = `<p>${message}</p>`;
        }

        // Load all locations from Firebase
        async function loadLocations() {
            try {
                showLoading();
                hideError();
                hideNoData();
                hideTable();

                console.log('Loading locations from Firebase...');
                
                const locationsRef = window.dbRef(window.db, 'games/streetview/locations');
                const snapshot = await window.dbGet(locationsRef);
                
                allLocations = [];
                
                if (snapshot.exists()) {
                    const locationsData = snapshot.val();
                    console.log("Locations data:", locationsData);
                    
                    // Convert to array
                    Object.entries(locationsData).forEach(([key, location]) => {
                        location.id = key;
                        allLocations.push(location);
                    });
                    
                    // Sort by order
                    allLocations.sort((a, b) => (a.order || 0) - (b.order || 0));
                }

                hideLoading();
                updateDisplay();

            } catch (error) {
                console.error('Error loading locations:', error);
                showError('Failed to load locations: ' + error.message);
                hideLoading();
            }
        }

        function updateDisplay() {
            if (allLocations.length === 0) {
                showNoData();
                hideTable();
                return;
            }

            hideNoData();
            showTable();
            
            const tbody = document.getElementById('locationsTableBody');
            tbody.innerHTML = '';

            allLocations.forEach(location => {
                const row = document.createElement('tr');
                
                // Order
                const orderCell = document.createElement('td');
                orderCell.textContent = location.order || 0;
                row.appendChild(orderCell);
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = location.name || 'Unnamed Location';
                row.appendChild(nameCell);
                
                // URL Preview (truncated)
                const urlCell = document.createElement('td');
                const truncatedUrl = location.url ? 
                    (location.url.length > 50 ? location.url.substring(0, 50) + '...' : location.url) : 
                    'No URL';
                urlCell.textContent = truncatedUrl;
                urlCell.title = location.url || '';
                row.appendChild(urlCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <button onclick="editLocation('${location.id}')" style="margin-right: 5px;">Edit</button>
                    <button onclick="deleteLocation('${location.id}')" class="delete-btn">Delete</button>
                `;
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        // Preview the location URL
        function previewLocation() {
            const url = document.getElementById('newLocationUrl').value.trim();
            const previewIframe = document.getElementById('previewIframe');
            
            if (!url) {
                alert('Please enter a Street View URL to preview');
                return;
            }
            
            // Validate that it looks like a Google Maps embed URL
            if (!url.includes('google.com/maps/embed') || !url.includes('6m8')) {
                alert('This doesn\'t appear to be a valid Google Maps Street View embed URL');
                return;
            }
            
            previewIframe.src = url;
        }

        // Add new location
        async function addLocation() {
            try {
                const name = document.getElementById('newLocationName').value.trim();
                const url = document.getElementById('newLocationUrl').value.trim();
                const order = parseInt(document.getElementById('newLocationOrder').value) || 1;
                
                if (!name || !url) {
                    alert('Please fill in both name and URL');
                    return;
                }
                
                // Validate URL
                if (!url.includes('google.com/maps/embed') || !url.includes('6m8')) {
                    alert('Please enter a valid Google Maps Street View embed URL');
                    return;
                }
                
                const locationData = {
                    name: name,
                    url: url,
                    order: order,
                    createdAt: new Date().toISOString()
                };
                
                console.log('Adding location:', locationData);
                
                const locationsRef = window.dbRef(window.db, 'games/streetview/locations');
                const newLocationRef = window.dbPush(locationsRef);
                await window.dbSet(newLocationRef, locationData);
                
                showMessage('Location added successfully!', 'success');
                clearForm();
                loadLocations(); // Refresh the list
                
            } catch (error) {
                console.error('Error adding location:', error);
                showMessage('Error adding location: ' + error.message, 'error');
            }
        }

        // Edit location (populate form with existing data)
        function editLocation(locationId) {
            const location = allLocations.find(loc => loc.id === locationId);
            if (!location) return;
            
            document.getElementById('newLocationName').value = location.name || '';
            document.getElementById('newLocationUrl').value = location.url || '';
            document.getElementById('newLocationOrder').value = location.order || 1;
            
            // Change the add button to update
            const addBtn = document.querySelector('button[onclick="addLocation()"]');
            addBtn.textContent = 'Update Location';
            addBtn.onclick = () => updateLocation(locationId);
            
            // Preview the location
            previewLocation();
            
            // Scroll to form
            document.querySelector('.section').scrollIntoView({ behavior: 'smooth' });
        }

        // Update existing location
        async function updateLocation(locationId) {
            try {
                const name = document.getElementById('newLocationName').value.trim();
                const url = document.getElementById('newLocationUrl').value.trim();
                const order = parseInt(document.getElementById('newLocationOrder').value) || 1;
                
                if (!name || !url) {
                    alert('Please fill in both name and URL');
                    return;
                }
                
                // Validate URL
                if (!url.includes('google.com/maps/embed') || !url.includes('6m8')) {
                    alert('Please enter a valid Google Maps Street View embed URL');
                    return;
                }
                
                const locationData = {
                    name: name,
                    url: url,
                    order: order,
                    updatedAt: new Date().toISOString()
                };
                
                console.log('Updating location:', locationId, locationData);
                
                const locationRef = window.dbRef(window.db, `games/streetview/locations/${locationId}`);
                await window.dbSet(locationRef, locationData);
                
                showMessage('Location updated successfully!', 'success');
                clearForm();
                loadLocations(); // Refresh the list
                
            } catch (error) {
                console.error('Error updating location:', error);
                showMessage('Error updating location: ' + error.message, 'error');
            }
        }

        // Delete location
        async function deleteLocation(locationId) {
            const location = allLocations.find(loc => loc.id === locationId);
            if (!location) return;
            
            if (!confirm(`Are you sure you want to delete "${location.name}"?`)) {
                return;
            }
            
            try {
                console.log('Deleting location:', locationId);
                
                const locationRef = window.dbRef(window.db, `games/streetview/locations/${locationId}`);
                await window.dbRemove(locationRef);
                
                showMessage('Location deleted successfully!', 'success');
                loadLocations(); // Refresh the list
                
            } catch (error) {
                console.error('Error deleting location:', error);
                showMessage('Error deleting location: ' + error.message, 'error');
            }
        }

        // Clear all locations
        async function clearAllLocations() {
            if (!confirm('Are you sure you want to delete ALL locations? This cannot be undone!')) {
                return;
            }
            
            try {
                console.log('Clearing all locations');
                
                const locationsRef = window.dbRef(window.db, 'games/streetview/locations');
                await window.dbRemove(locationsRef);
                
                showMessage('All locations cleared!', 'success');
                loadLocations(); // Refresh the list
                
            } catch (error) {
                console.error('Error clearing locations:', error);
                showMessage('Error clearing locations: ' + error.message, 'error');
            }
        }

        // Clear the form
        function clearForm() {
            document.getElementById('newLocationName').value = '';
            document.getElementById('newLocationUrl').value = '';
            document.getElementById('newLocationOrder').value = '1';
            document.getElementById('previewIframe').src = '';
            
            // Reset the add button
            const addBtn = document.querySelector('button[onclick^="addLocation"], button[onclick^="updateLocation"]');
            addBtn.textContent = 'Add Location';
            addBtn.onclick = addLocation;
        }

        // Show/hide UI elements
        function showLoading() {
            document.getElementById('locationsLoading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('locationsLoading').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('locationsError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('locationsError').classList.add('hidden');
        }

        function showNoData() {
            document.getElementById('noLocationsMessage').classList.remove('hidden');
        }

        function hideNoData() {
            document.getElementById('noLocationsMessage').classList.add('hidden');
        }

        function showTable() {
            document.getElementById('locationsTable').classList.remove('hidden');
        }

        function hideTable() {
            document.getElementById('locationsTable').classList.add('hidden');
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('addLocationMessage');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            // Clear message after 5 seconds
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Auto-update order field based on existing locations
        function updateOrderField() {
            const maxOrder = allLocations.length > 0 ? 
                Math.max(...allLocations.map(loc => loc.order || 0)) : 0;
            document.getElementById('newLocationOrder').value = maxOrder + 1;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-preview when URL is pasted
            document.getElementById('newLocationUrl').addEventListener('input', () => {
                const url = document.getElementById('newLocationUrl').value.trim();
                if (url && url.includes('google.com/maps/embed')) {
                    setTimeout(previewLocation, 500); // Small delay to avoid too many updates
                }
            });
        });
    </script>
</body>
</html> 