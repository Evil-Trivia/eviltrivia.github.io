<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Evil Trivia - Lemon Drop Admin</title>
    <script src="/js/components/autoload-banner.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            padding: 30px;
            background: linear-gradient(180deg, #87CEEB 0%, #4A90A4 100%);
            margin-top: 60px;
            min-height: 100vh;
        }
        .hidden {
            display: none;
        }
        .section {
            border: 4px solid #000;
            padding: 20px;
            margin-top: 15px;
            background-color: #8B4513;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.5);
            max-width: 1200px;
        }
        h1, h2 {
            margin-top: 0;
            color: #FFD700;
            text-shadow: 3px 3px 0px #000;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            line-height: 1.5;
        }
        h2 {
            font-size: 16px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 10px;
            color: #FFD700;
            text-shadow: 2px 2px 0px #000;
        }
        button {
            padding: 12px 20px;
            font-size: 10px;
            font-family: 'Press Start 2P', cursive;
            background-color: #228B22;
            color: white;
            border: 3px solid #000;
            cursor: pointer;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.1s;
        }
        button:hover {
            background-color: #32CD32;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }
        button:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px #000;
        }
        input[type="text"], 
        input[type="date"],
        select {
            padding: 10px;
            border: 3px solid #000;
            font-size: 10px;
            font-family: 'Press Start 2P', cursive;
            background: #F5DEB3;
        }
        input:focus, select:focus {
            outline: 3px solid #FFD700;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #654321;
            padding: 15px;
            border: 3px solid #000;
            text-align: center;
            box-shadow: 4px 4px 0px #000;
        }
        .stat-value {
            font-size: 20px;
            color: #FFD700;
            text-shadow: 2px 2px 0px #000;
        }
        .stat-label {
            font-size: 8px;
            color: #fff;
            margin-top: 8px;
            line-height: 1.5;
        }
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
            background: #F5DEB3;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #F5DEB3;
        }
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #000;
            font-size: 8px;
            line-height: 1.5;
        }
        th {
            background-color: #8B4513;
            color: #FFD700;
            text-shadow: 2px 2px 0px #000;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 3px solid #000;
        }
        tr:nth-child(even) {
            background-color: rgba(139, 69, 19, 0.1);
        }
        tr:hover {
            background-color: rgba(255, 215, 0, 0.2);
        }
        .score-cell {
            font-weight: bold;
            text-align: center;
            font-size: 10px;
        }
        .score-top {
            color: #FFD700;
            text-shadow: 1px 1px 0px #000;
        }
        .score-good {
            color: #32CD32;
        }
        .score-medium {
            color: #FF8C00;
        }
        .score-low {
            color: #DC143C;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 12px;
            color: #FFD700;
            text-shadow: 2px 2px 0px #000;
            line-height: 1.8;
        }
        .error {
            background: #DC143C;
            color: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
            font-size: 10px;
            line-height: 1.8;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #FFD700;
            font-size: 12px;
            text-shadow: 2px 2px 0px #000;
            line-height: 1.8;
        }
        .refresh-info {
            font-size: 8px;
            color: #FFD700;
            text-align: center;
            margin-top: 10px;
            text-shadow: 1px 1px 0px #000;
            line-height: 1.8;
        }
        .btn-delete {
            background-color: #DC143C;
            color: white;
            padding: 8px 12px;
            font-size: 8px;
            border: 2px solid #000;
            cursor: pointer;
            box-shadow: 2px 2px 0px #000;
        }
        .btn-delete:hover {
            background-color: #FF0000;
        }
        a {
            color: #FFD700;
            text-decoration: none;
        }
        a:hover {
            color: #FFF;
        }
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            h1 {
                font-size: 16px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            th, td {
                padding: 8px 4px;
                font-size: 7px;
            }
        }
    </style>
</head>
<body>
    <h1>üçã LEMON DROP ADMIN üçã</h1>

    <div id="authContainer" class="section">
        <h2>AUTHENTICATION REQUIRED</h2>
        <p style="color: #fff; font-size: 10px; line-height: 1.8;">Please log in with your admin account to access this page.</p>
        <p style="margin-top: 15px;"><a href="/pages/account.html">Go to Account Page</a></p>
    </div>

    <div id="adminContainer" class="hidden">
        <!-- Session Management -->
        <div class="section">
            <h2>SESSION MANAGEMENT</h2>
            <p style="color: #fff; font-size: 9px; line-height: 1.6; margin-bottom: 15px;">
                Load sessions from the grading page. You can activate one session per location.
            </p>
            <div class="controls">
                <div class="control-group">
                    <label for="sessionLocationFilter">LOCATION:</label>
                    <select id="sessionLocationFilter" onchange="filterSessionsByLocation()">
                        <option value="">All Locations</option>
                        <option value="St. Dymphna's">St. Dymphna's</option>
                        <option value="Radegast Hall">Radegast Hall</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="existingSessionSelect">SELECT SESSION:</label>
                    <select id="existingSessionSelect">
                        <option value="">Select a session...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="activateSession()">ACTIVATE SESSION</button>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="loadExistingSessions()">REFRESH SESSIONS</button>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="clearAllSessions()" style="background-color: #DC143C;">CLEAR ALL</button>
                </div>
            </div>
            <div id="activeSessionsInfo" style="margin-top: 15px; padding: 15px; background: rgba(255,215,0,0.2); border: 2px solid #FFD700;">
                <strong style="color: #FFD700;">ACTIVE SESSIONS:</strong>
                <div id="activeSessionsList" style="color: #fff; margin-top: 10px; font-size: 9px; line-height: 1.8;">
                    None
                </div>
            </div>
        </div>

        <div class="section">
        <div class="controls">
            <div class="control-group">
                <label for="gameFilter">GAME MODE:</label>
                <select id="gameFilter">
                    <option value="">All Games</option>
                    <option value="lemondrop">Lemon Drop (Dodge)</option>
                    <option value="lemondrop2">Lemon Drop 2 (Platform)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="barFilter">FILTER BY BAR:</label>
                <select id="barFilter">
                    <option value="">All Locations</option>
                    <option value="St. Dymphna's">St. Dymphna's</option>
                    <option value="Radegast Hall">Radegast Hall</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="dateFilter">FILTER BY DATE:</label>
                <input type="date" id="dateFilter">
            </div>
            
            <div class="control-group">
                <label for="teamFilter">SEARCH TEAM:</label>
                <input type="text" id="teamFilter" placeholder="Team name...">
            </div>
            
            <div class="control-group">
                <label for="sortBy">SORT BY:</label>
                <select id="sortBy">
                    <option value="score-desc">Highest Score First</option>
                    <option value="score-asc">Lowest Score First</option>
                    <option value="timestamp-desc">Newest First</option>
                    <option value="timestamp-asc">Oldest First</option>
                    <option value="teamName-asc">Team Name A-Z</option>
                    <option value="teamName-desc">Team Name Z-A</option>
                    <option value="location-asc">Location A-Z</option>
                    <option value="location-desc">Location Z-A</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="loadScores()">REFRESH DATA</button>
            </div>
        </div>

        <div id="statsSection" class="stats hidden">
            <div class="stat-card">
                <div class="stat-value" id="totalScores">0</div>
                <div class="stat-label">TOTAL GAMES</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="averageScore">0</div>
                <div class="stat-label">AVERAGE SCORE</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="highScore">0</div>
                <div class="stat-label">BEST SCORE</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="recentScore">-</div>
                <div class="stat-label">MOST RECENT</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayScores">0</div>
                <div class="stat-label">TODAY'S GAMES</div>
            </div>
        </div>

        <div id="errorMessage" class="error hidden"></div>
        
        <div id="loadingMessage" class="loading">
            Click "REFRESH DATA" to load scores...
        </div>

        <div id="noDataMessage" class="no-data hidden">
            No scores found matching the current filters.
        </div>

        <div class="table-container">
            <table id="scoresTable" class="hidden">
                <thead>
                    <tr>
                        <th>TEAM NAME</th>
                        <th>LOCATION</th>
                        <th>RECENT (DODGE)</th>
                        <th>HIGH (DODGE)</th>
                        <th>RECENT (PLATFORM)</th>
                        <th>HIGH (PLATFORM)</th>
                    </tr>
                </thead>
                <tbody id="scoresTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="refresh-info">
            LAST UPDATED: <span id="lastUpdate">Never</span>
        </div>
    </div>
    </div> <!-- End adminContainer -->

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getDatabase, ref, get, remove, set } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebaseapp.com",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        window.db = db;
        window.dbRef = ref;
        window.dbGet = get;
        window.dbRemove = remove;
        window.dbSet = set;

        // Authentication check
        onAuthStateChanged(auth, async (user) => {
            const authContainer = document.getElementById('authContainer');
            const adminContainer = document.getElementById('adminContainer');
            
            if (user) {
                console.log("User is signed in:", user.uid);
                try {
                    const userRoleRef = ref(db, `users/${user.uid}/role`);
                    const roleSnapshot = await get(userRoleRef);
                    
                    console.log("Role check - exists:", roleSnapshot.exists(), "value:", roleSnapshot.val());
                    
                    if (roleSnapshot.exists() && roleSnapshot.val() === 'admin') {
                        console.log("Admin access granted");
                        authContainer.style.display = 'none';
                        adminContainer.classList.remove('hidden');
                        window.loadScores();
                    } else {
                        console.log("User is not admin");
                        authContainer.style.display = 'block';
                        adminContainer.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error checking user role:", error);
                    authContainer.style.display = 'block';
                    adminContainer.classList.add('hidden');
                }
            } else {
                console.log("No user signed in");
                authContainer.style.display = 'block';
                adminContainer.classList.add('hidden');
            }
        });
    </script>

    <script>
        let allScores = [];
        let filteredScores = [];

        // DOM elements
        const barFilter = document.getElementById('barFilter');
        const dateFilter = document.getElementById('dateFilter');
        const teamFilter = document.getElementById('teamFilter');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const noDataMessage = document.getElementById('noDataMessage');
        const scoresTable = document.getElementById('scoresTable');
        const scoresTableBody = document.getElementById('scoresTableBody');
        const statsSection = document.getElementById('statsSection');
        const lastUpdate = document.getElementById('lastUpdate');

        // Stats elements
        const totalScoresEl = document.getElementById('totalScores');
        const averageScoreEl = document.getElementById('averageScore');
        const highScoreEl = document.getElementById('highScore');
        const todayScoresEl = document.getElementById('todayScores');

        // Event listeners
        document.getElementById('gameFilter').addEventListener('change', applyFilters);
        barFilter.addEventListener('change', applyFilters);
        dateFilter.addEventListener('change', applyFilters);
        teamFilter.addEventListener('input', applyFilters);
        document.getElementById('sortBy').addEventListener('change', applySorting);

        // Make loadScores available globally for the module script
        window.loadScores = loadScores;

        async function loadScores() {
            showLoading();
            hideError();

            try {
                allScores = [];

                // Load LemonDrop 1 (Dodge) scores
                const ld1MainRef = window.dbRef(window.db, 'games/lemondrop/answers');
                const ld1MainSnap = await window.dbGet(ld1MainRef);
                if (ld1MainSnap.exists()) {
                    const data = ld1MainSnap.val();
                    Object.keys(data).forEach(key => {
                        const score = data[key];
                        score.id = key;
                        score.source = 'main';
                        score.game = 'lemondrop';
                        score.gameName = 'Dodge';
                        allScores.push(score);
                    });
                }

                const ld1PublicRef = window.dbRef(window.db, 'publicAnswers/lemondrop');
                const ld1PublicSnap = await window.dbGet(ld1PublicRef);
                if (ld1PublicSnap.exists()) {
                    const data = ld1PublicSnap.val();
                    Object.keys(data).forEach(key => {
                        const score = data[key];
                        score.id = key;
                        score.source = 'public';
                        score.game = 'lemondrop';
                        score.gameName = 'Dodge';
                        allScores.push(score);
                    });
                }

                // Load LemonDrop 2 (Platform) scores
                const ld2MainRef = window.dbRef(window.db, 'games/lemondrop2/answers');
                const ld2MainSnap = await window.dbGet(ld2MainRef);
                if (ld2MainSnap.exists()) {
                    const data = ld2MainSnap.val();
                    Object.keys(data).forEach(key => {
                        const score = data[key];
                        score.id = key;
                        score.source = 'main';
                        score.game = 'lemondrop2';
                        score.gameName = 'Platform';
                        allScores.push(score);
                    });
                }

                const ld2PublicRef = window.dbRef(window.db, 'publicAnswers/lemondrop2');
                const ld2PublicSnap = await window.dbGet(ld2PublicRef);
                if (ld2PublicSnap.exists()) {
                    const data = ld2PublicSnap.val();
                    Object.keys(data).forEach(key => {
                        const score = data[key];
                        score.id = key;
                        score.source = 'public';
                        score.game = 'lemondrop2';
                        score.gameName = 'Platform';
                        allScores.push(score);
                    });
                }

                hideLoading();
                applyFilters();
                updateLastRefresh();

            } catch (error) {
                console.error('Error loading scores:', error);
                showError('Failed to load scores: ' + error.message);
                hideLoading();
            }
        }

        function applyFilters() {
            const barValue = barFilter.value;
            const dateValue = dateFilter.value;
            const teamValue = teamFilter.value.toLowerCase().trim();
            const gameValue = document.getElementById('gameFilter').value;

            filteredScores = allScores.filter(score => {
                // Game filter
                if (gameValue && score.game !== gameValue) {
                    return false;
                }

                // Bar filter
                if (barValue && score.barLocation !== barValue) {
                    return false;
                }

                // Date filter
                if (dateValue && score.date !== dateValue) {
                    return false;
                }

                // Team filter
                if (teamValue && !score.teamName.toLowerCase().includes(teamValue)) {
                    return false;
                }

                return true;
            });

            applySorting();
        }

        function applySorting() {
            // Sorting is now done in populateTable
            updateDisplay();
        }

        function updateDisplay() {
            if (filteredScores.length === 0) {
                showNoData();
                hideTable();
                hideStats();
            } else {
                hideNoData();
                showTable();
                showStats();
                populateTable();
                updateStats();
            }
        }

        function populateTable() {
            scoresTableBody.innerHTML = '';

            // Group scores by team name and location
            const grouped = {};
            
            filteredScores.forEach(score => {
                const key = `${score.teamName}|${score.barLocation}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        teamName: score.teamName || 'Unknown',
                        location: score.barLocation || 'Unknown',
                        dodgeScores: [],
                        platformScores: []
                    };
                }
                
                if (score.game === 'lemondrop') {
                    grouped[key].dodgeScores.push(score);
                } else if (score.game === 'lemondrop2') {
                    grouped[key].platformScores.push(score);
                }
            });
            
            // Apply sorting to grouped entries
            const sortBy = document.getElementById('sortBy').value;
            const [field, direction] = sortBy.split('-');
            
            const sortedEntries = Object.values(grouped).sort((a, b) => {
                let aVal, bVal;
                
                switch(field) {
                    case 'teamName':
                        aVal = a.teamName.toLowerCase();
                        bVal = b.teamName.toLowerCase();
                        break;
                    case 'location':
                        aVal = a.location.toLowerCase();
                        bVal = b.location.toLowerCase();
                        break;
                    case 'score':
                        // Sort by highest score across both games
                        const aDodgeHigh = a.dodgeScores.length > 0 ? Math.max(...a.dodgeScores.map(s => s.score || 0)) : 0;
                        const aPlatformHigh = a.platformScores.length > 0 ? Math.max(...a.platformScores.map(s => s.score || 0)) : 0;
                        const bDodgeHigh = b.dodgeScores.length > 0 ? Math.max(...b.dodgeScores.map(s => s.score || 0)) : 0;
                        const bPlatformHigh = b.platformScores.length > 0 ? Math.max(...b.platformScores.map(s => s.score || 0)) : 0;
                        aVal = Math.max(aDodgeHigh, aPlatformHigh);
                        bVal = Math.max(bDodgeHigh, bPlatformHigh);
                        break;
                    case 'timestamp':
                        // Sort by most recent timestamp across both games
                        const aDodgeRecent = a.dodgeScores.length > 0 ? Math.max(...a.dodgeScores.map(s => s.timestamp || 0)) : 0;
                        const aPlatformRecent = a.platformScores.length > 0 ? Math.max(...a.platformScores.map(s => s.timestamp || 0)) : 0;
                        const bDodgeRecent = b.dodgeScores.length > 0 ? Math.max(...b.dodgeScores.map(s => s.timestamp || 0)) : 0;
                        const bPlatformRecent = b.platformScores.length > 0 ? Math.max(...b.platformScores.map(s => s.timestamp || 0)) : 0;
                        aVal = Math.max(aDodgeRecent, aPlatformRecent);
                        bVal = Math.max(bDodgeRecent, bPlatformRecent);
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            sortedEntries.forEach(entry => {
                const row = document.createElement('tr');
                
                // Get stats for each game
                const dodgeRecent = entry.dodgeScores.length > 0 
                    ? entry.dodgeScores.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))[0].score 
                    : '-';
                const dodgeHigh = entry.dodgeScores.length > 0 
                    ? Math.max(...entry.dodgeScores.map(s => s.score || 0))
                    : '-';
                const platformRecent = entry.platformScores.length > 0 
                    ? entry.platformScores.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))[0].score 
                    : '-';
                const platformHigh = entry.platformScores.length > 0 
                    ? Math.max(...entry.platformScores.map(s => s.score || 0))
                    : '-';
                
                row.innerHTML = `
                    <td><strong>${escapeHtml(entry.teamName)}</strong></td>
                    <td>${escapeHtml(entry.location)}</td>
                    <td class="score-cell">${dodgeRecent}</td>
                    <td class="score-cell score-good">${dodgeHigh}</td>
                    <td class="score-cell">${platformRecent}</td>
                    <td class="score-cell score-good">${platformHigh}</td>
                `;
                
                scoresTableBody.appendChild(row);
            });
        }

        function updateStats() {
            const total = filteredScores.length;
            const scores = filteredScores.map(s => s.score || 0);
            const average = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            const high = scores.length > 0 ? Math.max(...scores) : 0;
            
            const today = new Date().toISOString().split('T')[0];
            const todayCount = filteredScores.filter(s => s.date === today).length;

            // Most recent score
            const sortedByTime = [...filteredScores].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const recentText = sortedByTime.length > 0 
                ? `${sortedByTime[0].score || 0} (${sortedByTime[0].teamName || 'Unknown'})`
                : '-';

            totalScoresEl.textContent = total;
            averageScoreEl.textContent = average;
            highScoreEl.textContent = high;
            document.getElementById('recentScore').textContent = recentText;
            todayScoresEl.textContent = todayCount;
        }

        function getScoreClass(score, rank) {
            if (rank < 3) return 'score-top';
            if (score >= 10) return 'score-good';
            if (score >= 5) return 'score-medium';
            return 'score-low';
        }

        async function deleteScore(scoreId, source, game) {
            if (!confirm('Are you sure you want to delete this score? This action cannot be undone.')) {
                return;
            }
            
            try {
                let path;
                const gamePath = game || 'lemondrop';
                if (source === 'main') {
                    path = `games/${gamePath}/answers/${scoreId}`;
                } else {
                    path = `publicAnswers/${gamePath}/${scoreId}`;
                }
                
                const scoreRef = window.dbRef(window.db, path);
                await window.dbRemove(scoreRef);
                
                // Remove from local arrays
                allScores = allScores.filter(s => s.id !== scoreId);
                filteredScores = filteredScores.filter(s => s.id !== scoreId);
                
                // Update display
                updateDisplay();
                
                alert('Score deleted successfully');
            } catch (error) {
                console.error('Error deleting score:', error);
                alert('Error deleting score: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading() {
            loadingMessage.classList.remove('hidden');
        }

        function hideLoading() {
            loadingMessage.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function showNoData() {
            noDataMessage.classList.remove('hidden');
        }

        function hideNoData() {
            noDataMessage.classList.add('hidden');
        }

        function showTable() {
            scoresTable.classList.remove('hidden');
        }

        function hideTable() {
            scoresTable.classList.add('hidden');
        }

        function showStats() {
            statsSection.classList.remove('hidden');
        }

        function hideStats() {
            statsSection.classList.add('hidden');
        }

        function updateLastRefresh() {
            lastUpdate.textContent = new Date().toLocaleString();
        }

        // Session management functions
        let allSessions = [];
        let filteredSessions = [];

        async function loadExistingSessions() {
            try {
                const sessionsSnap = await window.dbGet(window.dbRef(window.db, 'grading'));
                allSessions = [];
                
                if (sessionsSnap.exists()) {
                    const sessions = sessionsSnap.val();
                    allSessions = Object.entries(sessions)
                        .map(([id, data]) => ({
                            id: id,
                            location: data.location || 'Unknown',
                            date: data.date || '',
                            triviaNumber: data.triviaNumber || '',
                            triviaName: data.triviaName || ''
                        }))
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                }
                
                filterSessionsByLocation();
                await displayActiveSessions();
            } catch (error) {
                console.error("Error loading sessions:", error);
                alert("Error loading sessions: " + error.message);
            }
        }

        function filterSessionsByLocation() {
            const locationFilter = document.getElementById('sessionLocationFilter').value;
            const sessionSelect = document.getElementById('existingSessionSelect');
            sessionSelect.innerHTML = '<option value="">Select a session...</option>';
            
            filteredSessions = locationFilter 
                ? allSessions.filter(s => s.location === locationFilter)
                : allSessions;

            filteredSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.dataset.location = session.location;
                option.textContent = `${session.date} - ${session.location}${session.triviaName ? ' - ' + session.triviaName : ''}`;
                sessionSelect.appendChild(option);
            });
        }

        function encodeLocationKey(location) {
            // Encode location to be Firebase-safe (no special chars)
            return location.replace(/[.#$\[\]']/g, '_');
        }

        function decodeLocationKey(key) {
            // For display purposes - we'll store the original location in the data
            return key;
        }

        async function activateSession() {
            const sessionSelect = document.getElementById('existingSessionSelect');
            const sessionId = sessionSelect.value;
            
            if (!sessionId) {
                alert('Please select a session');
                return;
            }

            try {
                const sessionSnap = await window.dbGet(window.dbRef(window.db, `grading/${sessionId}`));
                if (!sessionSnap.exists()) {
                    alert('Session not found');
                    return;
                }

                const sessionData = sessionSnap.val();
                const location = sessionData.location;
                const locationKey = encodeLocationKey(location);
                
                // Get teams from this session
                const teamsSnap = await window.dbGet(window.dbRef(window.db, `grading/${sessionId}/teams`));
                const teamNames = [];
                if (teamsSnap.exists()) {
                    const teams = teamsSnap.val();
                    Object.values(teams).forEach(team => {
                        if (team.name) {
                            teamNames.push(team.name);
                        }
                    });
                }
                
                // Get current active sessions
                const activeSessionsSnap = await window.dbGet(window.dbRef(window.db, 'games/lemondrop/activeSessions'));
                const activeSessions = activeSessionsSnap.exists() ? activeSessionsSnap.val() : {};
                
                // Set this session for this location with team names
                activeSessions[locationKey] = {
                    sessionId: sessionId,
                    date: sessionData.date,
                    location: location,  // Store original location name
                    teams: teamNames
                };
                await window.dbSet(window.dbRef(window.db, 'games/lemondrop/activeSessions'), activeSessions);

                alert(`Session activated for ${location} with ${teamNames.length} teams!`);
                await displayActiveSessions();
            } catch (error) {
                console.error("Error activating session:", error);
                alert("Error activating session: " + error.message);
            }
        }

        async function displayActiveSessions() {
            try {
                const activeSessionsSnap = await window.dbGet(window.dbRef(window.db, 'games/lemondrop/activeSessions'));
                const activeSessionsList = document.getElementById('activeSessionsList');
                
                if (!activeSessionsSnap.exists() || Object.keys(activeSessionsSnap.val()).length === 0) {
                    activeSessionsList.innerHTML = 'None';
                    return;
                }

                const activeSessions = activeSessionsSnap.val();
                let html = '';
                
                for (const [locationKey, sessionData] of Object.entries(activeSessions)) {
                    const displayLocation = sessionData.location || locationKey;
                    const teamCount = sessionData.teams ? sessionData.teams.length : 0;
                    html += `<div style="margin-bottom: 8px;">
                        <strong>${displayLocation}:</strong> ${sessionData.date} (${teamCount} teams)
                        <button onclick="removeSessionForLocation('${locationKey}')" style="margin-left: 10px; padding: 4px 8px; font-size: 7px; background: #DC143C;">REMOVE</button>
                    </div>`;
                }
                
                activeSessionsList.innerHTML = html || 'None';
            } catch (error) {
                console.error("Error displaying active sessions:", error);
            }
        }

        async function removeSessionForLocation(locationKey) {
            try {
                const activeSessionsSnap = await window.dbGet(window.dbRef(window.db, 'games/lemondrop/activeSessions'));
                if (!activeSessionsSnap.exists()) return;
                
                const activeSessions = activeSessionsSnap.val();
                const displayLocation = activeSessions[locationKey]?.location || locationKey;
                delete activeSessions[locationKey];
                
                if (Object.keys(activeSessions).length === 0) {
                    await window.dbRemove(window.dbRef(window.db, 'games/lemondrop/activeSessions'));
                } else {
                    await window.dbSet(window.dbRef(window.db, 'games/lemondrop/activeSessions'), activeSessions);
                }
                
                alert(`Session removed for ${displayLocation}`);
                await displayActiveSessions();
            } catch (error) {
                console.error("Error removing session:", error);
                alert("Error removing session: " + error.message);
            }
        }

        async function clearAllSessions() {
            if (!confirm('Clear all active sessions?')) return;
            
            try {
                await window.dbRemove(window.dbRef(window.db, 'games/lemondrop/activeSessions'));
                alert('All sessions cleared');
                await displayActiveSessions();
            } catch (error) {
                console.error("Error clearing sessions:", error);
                alert("Error clearing sessions: " + error.message);
            }
        }

        // Make functions global
        window.deleteScore = deleteScore;
        window.loadExistingSessions = loadExistingSessions;
        window.activateSession = activateSession;
        window.filterSessionsByLocation = filterSessionsByLocation;
        window.removeSessionForLocation = removeSessionForLocation;
        window.clearAllSessions = clearAllSessions;

        // Load sessions on page load
        setTimeout(() => {
            if (!document.getElementById('adminContainer').classList.contains('hidden')) {
                loadExistingSessions();
            }
        }, 1000);
    </script>
</body>
</html>

