<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Rhythm Test</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      min-height: 100vh;
      touch-action: manipulation;
      user-select: none;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      color: #555;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
    }

    .game-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
      position: relative;
    }
    
    .setup-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .form-group {
      width: 100%;
      max-width: 300px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 30px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    
    .btn:hover {
      background-color: #333;
    }
    
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #666;
    }
    
    .btn-secondary:hover {
      background-color: #888;
    }
    
    .game-area {
      display: none;
      text-align: center;
    }
    
    .beat-display {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      margin: 30px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      transition: all 0.08s ease;
      cursor: pointer;
      background-color: #ddd;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .beat-display.active {
      background-color: #000;
      transform: scale(1.1);
    }
    
    .game-instructions {
      margin: 20px 0;
      font-size: 18px;
      line-height: 1.5;
    }
    
    .game-stats {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      font-size: 16px;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      display: block;
      font-size: 24px;
      font-weight: bold;
      color: #000;
    }
    
    .results {
      display: none;
      text-align: center;
      margin-top: 30px;
    }
    
    .final-score {
      font-size: 36px;
      font-weight: bold;
      color: #000;
      margin: 20px 0;
    }
    
    .score-breakdown {
      margin: 20px 0;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .hidden {
      display: none;
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      
      .game-card {
        padding: 20px;
      }
      
      .beat-display {
        width: 150px;
        height: 150px;
        font-size: 20px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽµ Rhythm Test ðŸŽµ</h1>
    <div class="subtitle">
      Test your rhythm consistency! Watch the visual beat, then tap to measure 20 intervals.
    </div>

    <div class="game-card">
      <!-- Setup Form -->
      <div id="setupForm" class="setup-form">
        <div class="form-group">
          <label for="teamName">Team Name:</label>
          <input type="text" id="teamName" placeholder="Enter your team name">
        </div>
        
        <div class="form-group">
          <label for="barLocation">Bar Location:</label>
          <select id="barLocation">
            <option value="">Select location...</option>
            <option value="St. Dymphna's">St. Dymphna's</option>
            <option value="Radegast Hall">Radegast Hall</option>
          </select>
        </div>
        
        <div class="button-group">
          <button class="btn" onclick="startGame(false)">Play Game</button>
          <button class="btn btn-secondary" onclick="startGame(true)">Practice Mode</button>
        </div>
      </div>

      <!-- Game Area -->
      <div id="gameArea" class="game-area">
        <div class="game-instructions" id="instructions">
          Get ready! Watch the beat pattern...
        </div>
        
        <div class="beat-display" id="beatDisplay" onclick="handleClick()" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
          TAP HERE
        </div>
        
        <div class="game-stats">
          <div class="stat">
            <span class="stat-value" id="avgError">-</span>
            <span>Avg Interval Error (ms)</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="currentError">-</span>
            <span>Last Interval Error (ms)</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="beatCount">0</span>
            <span>Taps</span>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div id="results" class="results">
        <h2>Game Complete!</h2>
        <div class="final-score" id="finalScore">0</div>
        <div class="score-breakdown" id="scoreBreakdown"></div>
        <button class="btn" onclick="resetGame()">Play Again</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
        authDomain: "eviltrivia-47664.firebaseapp.com",
        databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
        projectId: "eviltrivia-47664",
        storageBucket: "eviltrivia-47664.firebaseapp.com",
        messagingSenderId: "401826818140",
        appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
        measurementId: "G-2W6RK96Y34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.dbRef = ref;
    window.dbPush = push;
    window.dbSet = set;
    window.dbGet = get;
  </script>

  <script>
    // Game variables
    const BPM = 100; // Beats per minute
    const BEAT_INTERVAL = 60000 / BPM; // 600ms for 100 BPM
    const DEMO_BEATS = -1; // Demo beats continue indefinitely until user starts
    const GAME_BEATS = 21; // Player taps 21 times to get 20 measured intervals (first tap ignored for display)
    
    let gameState = 'setup'; // setup, demo, playing, finished
    let isPracticeMode = false;
    let beatCount = 0;
    let userTapTimes = [];
    let errors = [];
    let demoInterval;
    let gameTimeout;
    
    // DOM elements
    const setupForm = document.getElementById('setupForm');
    const gameArea = document.getElementById('gameArea');
    const results = document.getElementById('results');
    const beatDisplay = document.getElementById('beatDisplay');
    const instructions = document.getElementById('instructions');
    const beatCountEl = document.getElementById('beatCount');
    const avgErrorEl = document.getElementById('avgError');
    const currentErrorEl = document.getElementById('currentError');
    const finalScoreEl = document.getElementById('finalScore');
    const scoreBreakdownEl = document.getElementById('scoreBreakdown');
    
    function startGame(practiceMode) {
      const teamName = document.getElementById('teamName').value.trim();
      const barLocation = document.getElementById('barLocation').value;
      
      if (!practiceMode && (!teamName || !barLocation)) {
        alert('Please enter team name and select bar location, or use Practice Mode.');
        return;
      }
      
      isPracticeMode = practiceMode;
      gameState = 'demo';
      beatCount = 0;
      userTapTimes = [];
      errors = [];
      
      // Show game area
      setupForm.style.display = 'none';
      gameArea.style.display = 'block';
      results.style.display = 'none';
      
      // Start demo
      instructions.textContent = 'Watch the beat pattern... Tap the circle when you\'re ready to start!';
      startDemo();
    }
    
    function startDemo() {
      demoInterval = setInterval(() => {
        // Flash the beat
        beatDisplay.classList.add('active');
        
        setTimeout(() => {
          beatDisplay.classList.remove('active');
        }, 100);
        
        // Demo continues indefinitely until user starts tapping
      }, BEAT_INTERVAL);
    }
    
    function startUserGame() {
      gameState = 'playing';
      instructions.textContent = 'Tap to keep the rhythm! Try to keep consistent timing between taps.';
      
      // Clear previous data
      userTapTimes = [];
      errors = [];
      
      // Auto-end game after reasonable duration (give extra time for slower players)
      gameTimeout = setTimeout(() => {
        endGame();
      }, GAME_BEATS * BEAT_INTERVAL + 5000);
    }
    
    let lastTapTime = 0;
    const MIN_TAP_INTERVAL = 50; // Minimum 50ms between taps to prevent accidental double taps
    
    function userTap() {
      // Debounce rapid taps
      const now = Date.now();
      if (now - lastTapTime < MIN_TAP_INTERVAL) {
        return;
      }
      lastTapTime = now;
      
      if (gameState === 'demo') {
        // First tap starts the game
        clearInterval(demoInterval);
        startUserGame();
        return;
      }
      
      if (gameState !== 'playing') return;
      
      const tapTime = now;
      userTapTimes.push(tapTime);
      
      // Visual feedback with faster response
      beatDisplay.classList.add('active');
      setTimeout(() => {
        beatDisplay.classList.remove('active');
      }, 80);
      
      // Calculate error based on interval between taps
      beatCount = userTapTimes.length;
      let currentError = 0;
      
      if (userTapTimes.length > 1) {
        // Calculate interval since last tap (measure all intervals after first tap)
        const lastTapTime = userTapTimes[userTapTimes.length - 2];
        const actualInterval = tapTime - lastTapTime;
        
        // Compare to expected interval (start measuring from second tap onwards)
        currentError = Math.abs(actualInterval - BEAT_INTERVAL);
        errors.push(currentError);
        
        // Update current error display
        currentErrorEl.textContent = Math.round(currentError);
        
        // Update average error
        const avgError = errors.reduce((sum, err) => sum + err, 0) / errors.length;
        avgErrorEl.textContent = Math.round(avgError);
      } else {
        // First tap - no error to calculate
        currentErrorEl.textContent = '-';
      }
      
      // Update beat count and taps remaining
      const displayTaps = Math.max(0, beatCount - 1);
      const tapsRemaining = Math.max(0, 20 - displayTaps);
      beatCountEl.textContent = `${displayTaps} (${tapsRemaining} left)`;
      
      // End game if we have enough beats
      if (beatCount >= GAME_BEATS) {
        clearTimeout(gameTimeout);
        endGame();
      }
    }
    
    function endGame() {
      gameState = 'finished';
      
                    // Calculate final score (average error per interval)
      const totalError = errors.reduce((sum, err) => sum + err, 0);
      const finalScore = Math.round(totalError / Math.max(errors.length, 1));
      
      // Show results
      gameArea.style.display = 'none';
      results.style.display = 'block';
      
      finalScoreEl.textContent = finalScore;
      
      const measuredIntervals = errors.length;
      const breakdown = `
        Measured intervals: ${measuredIntervals}<br>
        Total timing error: ${Math.round(totalError)}ms<br>
        Average error per interval: ${finalScore}ms<br>
        ${errors.length > 0 ? `Most consistent interval: ${Math.round(Math.min(...errors))}ms off<br>` : ''}
        ${errors.length > 0 ? `Least consistent interval: ${Math.round(Math.max(...errors))}ms off` : ''}
        <br><small>Expected interval: ${BEAT_INTERVAL}ms between taps</small>
      `;
      scoreBreakdownEl.innerHTML = breakdown;
      
      // Submit to Firebase if not practice mode
      if (!isPracticeMode) {
        submitScore(finalScore);
      }
    }
    
    async function submitScore(score) {
      const teamName = document.getElementById('teamName').value.trim();
      const barLocation = document.getElementById('barLocation').value;
      
      if (!teamName || !barLocation) return;
      
      const scoreData = {
        teamName: teamName,
        barLocation: barLocation,
        score: score,
        totalTaps: Math.max(0, beatCount - 1), // Exclude first tap from display count
        measuredIntervals: errors.length,
        totalError: errors.reduce((sum, err) => sum + err, 0),
        errors: errors,
        timestamp: Date.now(),
        date: new Date().toISOString().split('T')[0]
      };
      
      try {
        // Try main path first
        const answersRef = window.dbRef(window.db, 'games/beats/answers');
        const newAnswerRef = window.dbPush(answersRef);
        await window.dbSet(newAnswerRef, scoreData);
        console.log('Score submitted successfully');
      } catch (error) {
        console.error('Error submitting to main path:', error);
        
        // Try fallback path
        try {
          const publicAnswersRef = window.dbRef(window.db, 'publicAnswers/beats');
          const newAnswerRef = window.dbPush(publicAnswersRef);
          await window.dbSet(newAnswerRef, scoreData);
          console.log('Score submitted to fallback path');
        } catch (fallbackError) {
          console.error('Error submitting to fallback path:', fallbackError);
        }
      }
    }
    
    function resetGame() {
      gameState = 'setup';
      setupForm.style.display = 'flex';
      gameArea.style.display = 'none';
      results.style.display = 'none';
      
      // Reset game data
      beatCount = 0;
      userTapTimes = [];
      errors = [];
      
      // Reset displays
      beatCountEl.textContent = '0';
      avgErrorEl.textContent = '-';
      currentErrorEl.textContent = '-';
      beatDisplay.classList.remove('active');
      
      // Clear any running intervals/timeouts
      if (demoInterval) clearInterval(demoInterval);
      if (gameTimeout) clearTimeout(gameTimeout);
    }
    
    // Improved mobile touch handling
    let touchStarted = false;
    let touchUsed = false;
    
    function handleTouchStart(event) {
      event.preventDefault(); // Prevent scrolling, zooming, etc.
      touchStarted = true;
      touchUsed = true;
      setTimeout(() => { touchUsed = false; }, 500); // Reset after 500ms
    }
    
    function handleTouchEnd(event) {
      event.preventDefault(); // Prevent mouse events from firing
      if (touchStarted) {
        touchStarted = false;
        userTap();
      }
    }
    
    function handleClick() {
      // Only trigger click if touch wasn't used recently
      if (!touchUsed) {
        userTap();
      }
    }
    
    // Make functions globally available
    window.handleTouchStart = handleTouchStart;
    window.handleTouchEnd = handleTouchEnd;
    window.handleClick = handleClick;
    
    // Prevent double-tap zoom on mobile - less aggressive version
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    
    document.addEventListener('touchend', function(event) {
      if (event.target.closest('.beat-display')) {
        event.preventDefault(); // Only prevent on beat display
      }
    }, { passive: false });
  </script>
</body>
</html> 