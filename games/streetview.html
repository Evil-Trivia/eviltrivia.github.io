<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Face the Nation</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .game-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .streetview-container {
      width: 100%;
      height: 500px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      position: relative;
    }
    
    .streetview-embed {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .location-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }
    
    .location-btn {
      padding: 10px 20px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .location-btn:hover {
      background-color: #333;
    }
    
    .location-btn.active {
      background-color: #28a745;
    }
    
    .location-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .current-location {
      text-align: center;
      margin-bottom: 15px;
      color: #666;
      font-style: italic;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .no-locations {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
    
    .api-setup-notice {
      background-color: #e7f3ff;
      color: #0066cc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #0066cc;
    }
    
    .api-setup-notice h3 {
      margin-top: 0;
      color: #004499;
    }
    
    .api-setup-notice code {
      background-color: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    
    @media (max-width: 768px) {
      .location-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .location-btn {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Face the Nation</h1>
    
    <div class="game-card">
      <div class="api-setup-notice">
        <h3>Setup Required</h3>
        <p>To hide address labels in Street View, you need to set up a <strong>free</strong> Google Maps Embed API key:</p>
        <ol>
          <li>Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
          <li>Create a new project (or select existing)</li>
          <li>Enable "Maps Embed API" (it's free with unlimited usage)</li>
          <li>Create an API key in Credentials</li>
          <li>Replace <code>YOUR_API_KEY</code> in the admin interface</li>
        </ol>
        <p><strong>Note:</strong> The Maps Embed API is completely free - no billing required!</p>
      </div>
      
      <div id="loading-section" class="loading">
        Loading puzzle locations...
      </div>
      
      <div id="error-section" class="error" style="display: none;">
        <p>Error loading puzzle locations. Please try again later.</p>
      </div>
      
      <div id="no-locations-section" class="no-locations" style="display: none;">
        <p>No puzzle locations have been set up yet. Check back later!</p>
      </div>
      
      <div id="puzzle-content" style="display: none;">
        <div class="current-location" id="current-location">
          Location 1 of ?
        </div>
        
        <div class="streetview-container">
          <iframe 
            id="streetview-iframe"
            class="streetview-embed"
            src=""
            allowfullscreen>
          </iframe>
        </div>
        
        <div class="location-controls" id="location-controls">
          <!-- Location buttons will be generated dynamically -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.firebaseapp.com",
      messagingSenderId: "401826818140",
      appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
      measurementId: "G-2W6RK96Y34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.dbRef = ref;
    window.dbGet = get;
  </script>

  <script>
    // Game state
    let puzzleLocations = [];
    let currentLocationIndex = 0;
    const MAPS_API_KEY = 'YOUR_API_KEY'; // Replace with your Maps Embed API key
    
    // DOM elements
    const loadingSection = document.getElementById('loading-section');
    const errorSection = document.getElementById('error-section');
    const noLocationsSection = document.getElementById('no-locations-section');
    const puzzleContent = document.getElementById('puzzle-content');
    const streetviewIframe = document.getElementById('streetview-iframe');
    const currentLocationDiv = document.getElementById('current-location');
    const locationControls = document.getElementById('location-controls');
    
    // Convert old embed URL to Maps Embed API v1 format (which allows hiding labels)
    function convertToMapsEmbedAPI(originalUrl) {
      try {
        // Extract coordinates and parameters from the original URL
        const latMatch = originalUrl.match(/!1d(-?\d+\.?\d*)/);
        const lngMatch = originalUrl.match(/!2d(-?\d+\.?\d*)/);
        const headingMatch = originalUrl.match(/!3f(-?\d+\.?\d*)/);
        const pitchMatch = originalUrl.match(/!4f(-?\d+\.?\d*)/);
        const panoMatch = originalUrl.match(/!1s([^!]+)/);
        
        if (latMatch && lngMatch) {
          const lat = parseFloat(latMatch[1]);
          const lng = parseFloat(lngMatch[1]);
          
          // Build Maps Embed API v1 URL
          let embedUrl = `https://www.google.com/maps/embed/v1/streetview?`;
          embedUrl += `location=${lat}%2C${lng}`;
          
          if (panoMatch) {
            embedUrl += `&pano=${panoMatch[1]}`;
          }
          
          if (headingMatch) {
            embedUrl += `&heading=${headingMatch[1]}`;
          }
          
          if (pitchMatch) {
            embedUrl += `&pitch=${pitchMatch[1]}`;
          }
          
          embedUrl += `&key=${MAPS_API_KEY}`;
          
          console.log('Converted to Maps Embed API:', embedUrl);
          return embedUrl;
        }
      } catch (error) {
        console.error('Error converting URL:', error);
      }
      
      // Fallback to original URL if conversion fails
      return originalUrl;
    }
    
    // Load puzzle locations from Firebase
    async function loadPuzzleLocations() {
      try {
        console.log('Loading puzzle locations from Firebase...');
        const locationsRef = window.dbRef(window.db, 'games/streetview/locations');
        const snapshot = await window.dbGet(locationsRef);
        
        if (snapshot.exists()) {
          const locationsData = snapshot.val();
          console.log('Locations data:', locationsData);
          
          // Convert to array and sort by order
          puzzleLocations = Object.entries(locationsData)
            .map(([key, location]) => ({
              id: key,
              ...location
            }))
            .sort((a, b) => (a.order || 0) - (b.order || 0));
          
          console.log('Processed locations:', puzzleLocations);
          
          if (puzzleLocations.length > 0) {
            initializePuzzle();
          } else {
            showNoLocations();
          }
        } else {
          console.log('No locations found in Firebase');
          showNoLocations();
        }
      } catch (error) {
        console.error('Error loading puzzle locations:', error);
        showError();
      }
    }
    
    // Initialize the puzzle interface
    function initializePuzzle() {
      loadingSection.style.display = 'none';
      errorSection.style.display = 'none';
      noLocationsSection.style.display = 'none';
      puzzleContent.style.display = 'block';
      
      // Create navigation buttons
      createLocationButtons();
      
      // Load first location
      currentLocationIndex = 0;
      loadCurrentLocation();
    }
    
    // Create navigation buttons for each location
    function createLocationButtons() {
      locationControls.innerHTML = '';
      
      puzzleLocations.forEach((location, index) => {
        const button = document.createElement('button');
        button.className = 'location-btn';
        button.textContent = `Location ${index + 1}`;
        button.addEventListener('click', () => {
          currentLocationIndex = index;
          loadCurrentLocation();
          updateActiveButton();
        });
        locationControls.appendChild(button);
      });
      
      updateActiveButton();
    }
    
    // Load the current location into the Street View iframe
    function loadCurrentLocation() {
      if (currentLocationIndex >= 0 && currentLocationIndex < puzzleLocations.length) {
        const location = puzzleLocations[currentLocationIndex];
        
        // Convert to Maps Embed API format if API key is available
        let urlToUse = location.url;
        if (MAPS_API_KEY !== 'YOUR_API_KEY') {
          urlToUse = convertToMapsEmbedAPI(location.url);
        }
        
        streetviewIframe.src = urlToUse;
        currentLocationDiv.textContent = `Location ${currentLocationIndex + 1} of ${puzzleLocations.length}`;
      }
    }
    
    // Update which button is active
    function updateActiveButton() {
      const buttons = locationControls.querySelectorAll('.location-btn');
      buttons.forEach((btn, index) => {
        if (index === currentLocationIndex) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    
    // Show error state
    function showError() {
      loadingSection.style.display = 'none';
      errorSection.style.display = 'block';
      noLocationsSection.style.display = 'none';
      puzzleContent.style.display = 'none';
    }
    
    // Show no locations state
    function showNoLocations() {
      loadingSection.style.display = 'none';
      errorSection.style.display = 'none';
      noLocationsSection.style.display = 'block';
      puzzleContent.style.display = 'none';
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadPuzzleLocations();
    });
  </script>
</body>
</html> 