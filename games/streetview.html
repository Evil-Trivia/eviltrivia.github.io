<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Face the Nation</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .game-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .streetview-container {
      width: 100%;
      height: 500px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      position: relative;
    }
    
    #streetview-panorama {
      width: 100%;
      height: 100%;
    }
    
    .location-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }
    
    .location-btn {
      padding: 10px 20px;
      background-color: #000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .location-btn:hover {
      background-color: #333;
    }
    
    .location-btn.active {
      background-color: #28a745;
    }
    
    .location-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .current-location {
      text-align: center;
      margin-bottom: 15px;
      color: #666;
      font-style: italic;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .no-locations {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
    
    @media (max-width: 768px) {
      .location-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .location-btn {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Face the Nation</h1>
    
    <div class="game-card">
      <div id="loading-section" class="loading">
        Loading puzzle locations...
      </div>
      
      <div id="error-section" class="error" style="display: none;">
        <p>Error loading puzzle locations. Please try again later.</p>
      </div>
      
      <div id="no-locations-section" class="no-locations" style="display: none;">
        <p>No puzzle locations have been set up yet. Check back later!</p>
      </div>
      
      <div id="puzzle-content" style="display: none;">
        <div class="current-location" id="current-location">
          Location 1 of ?
        </div>
        
        <div class="streetview-container">
          <div id="streetview-panorama"></div>
        </div>
        
        <div class="location-controls" id="location-controls">
          <!-- Location buttons will be generated dynamically -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.firebaseapp.com",
      messagingSenderId: "401826818140",
      appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
      measurementId: "G-2W6RK96Y34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.db = db;
    window.dbRef = ref;
    window.dbGet = get;
  </script>

  <script>
    // Game state
    let puzzleLocations = [];
    let currentLocationIndex = 0;
    let streetViewPanorama = null;
    
    // DOM elements
    const loadingSection = document.getElementById('loading-section');
    const errorSection = document.getElementById('error-section');
    const noLocationsSection = document.getElementById('no-locations-section');
    const puzzleContent = document.getElementById('puzzle-content');
    const currentLocationDiv = document.getElementById('current-location');
    const locationControls = document.getElementById('location-controls');
    
    // Ensure Firebase is initialized before reading
    function waitForFirebaseReady(timeoutMs = 7000) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function check() {
          if (window.db && window.dbRef && window.dbGet) return resolve();
          if (Date.now() - start > timeoutMs) return reject(new Error('Firebase not initialized'));
          setTimeout(check, 50);
        })();
      });
    }
    
    // Initialize Google Maps
    function initMap() {
      // Create Street View panorama with hidden labels/controls
      streetViewPanorama = new google.maps.StreetViewPanorama(
        document.getElementById('streetview-panorama'),
        {
          addressControl: false,
          showRoadLabels: false,
          disableDefaultUI: true,
          linksControl: true,
          panControl: false,
          zoomControl: false,
          fullscreenControl: false,
          enableCloseButton: false,
          clickToGo: true,
          scrollwheel: true,
          motionTracking: false,
          motionTrackingControl: false
        }
      );
      
      // Load puzzle locations after Maps API is ready and Firebase is ready
      waitForFirebaseReady().then(loadPuzzleLocations).catch((e) => {
        console.error(e);
        showError();
      });
    }
    
    // Expose init for the callback
    window.initMap = initMap;
    
    // Dynamically load Maps JS using saved key (from admin page)
    function loadMapsJs() {
      const key = localStorage.getItem('mapsEmbedApiKey') || '';
      const script = document.createElement('script');
      const params = new URLSearchParams({ key, libraries: 'streetview', callback: 'initMap' });
      script.src = `https://maps.googleapis.com/maps/api/js?${params.toString()}`;
      script.async = true;
      script.defer = true;
      script.onerror = () => {
        console.error('Failed to load Google Maps JavaScript API');
        showError();
      };
      document.head.appendChild(script);
    }
    
    // Parse coordinates from Street View URL
    function parseCoordinatesFromUrl(url) {
      try {
        const latMatch = url.match(/!1d(-?\d+\.?\d*)/);
        const lngMatch = url.match(/!2d(-?\d+\.?\d*)/);
        const headingMatch = url.match(/!3f(-?\d+\.?\d*)/);
        const pitchMatch = url.match(/!4f(-?\d+\.?\d*)/);
        const panoMatch = url.match(/!1s([^!]+)/);
        
        if (latMatch && lngMatch) {
          const result = {
            position: { lat: parseFloat(latMatch[1]), lng: parseFloat(lngMatch[1]) }
          };
          if (headingMatch && pitchMatch) {
            result.pov = { heading: parseFloat(headingMatch[1]), pitch: parseFloat(pitchMatch[1]) };
          }
          if (panoMatch) {
            result.pano = panoMatch[1];
          }
          return result;
        }
      } catch (e) {
        console.error('Error parsing URL', e);
      }
      return null;
    }
    
    // Load puzzle locations from Firebase
    async function loadPuzzleLocations() {
      try {
        const locationsRef = window.dbRef(window.db, 'games/streetview/locations');
        const snapshot = await window.dbGet(locationsRef);
        if (snapshot.exists()) {
          const locationsData = snapshot.val();
          puzzleLocations = Object.entries(locationsData)
            .map(([key, location]) => ({ id: key, ...location }))
            .sort((a, b) => (a.order || 0) - (b.order || 0));
          if (puzzleLocations.length > 0) {
            initializePuzzle();
          } else {
            showNoLocations();
          }
        } else {
          showNoLocations();
        }
      } catch (error) {
        console.error('Error loading puzzle locations:', error);
        showError();
      }
    }
    
    // Initialize the puzzle interface
    function initializePuzzle() {
      loadingSection.style.display = 'none';
      errorSection.style.display = 'none';
      noLocationsSection.style.display = 'none';
      puzzleContent.style.display = 'block';
      createLocationButtons();
      currentLocationIndex = 0;
      loadCurrentLocation();
    }
    
    function createLocationButtons() {
      locationControls.innerHTML = '';
      puzzleLocations.forEach((location, index) => {
        const button = document.createElement('button');
        button.className = 'location-btn';
        button.textContent = `Location ${index + 1}`;
        button.addEventListener('click', () => {
          currentLocationIndex = index;
          loadCurrentLocation();
          updateActiveButton();
        });
        locationControls.appendChild(button);
      });
      updateActiveButton();
    }
    
    function loadCurrentLocation() {
      if (!streetViewPanorama) return;
      const location = puzzleLocations[currentLocationIndex];
      currentLocationDiv.textContent = `Location ${currentLocationIndex + 1} of ${puzzleLocations.length}`;
      const parsed = parseCoordinatesFromUrl(location.url);
      if (parsed) {
        streetViewPanorama.setPosition(parsed.position);
        if (parsed.pov) streetViewPanorama.setPov(parsed.pov);
        if (parsed.pano) streetViewPanorama.setPano(parsed.pano);
      }
    }
    
    function updateActiveButton() {
      const buttons = locationControls.querySelectorAll('.location-btn');
      buttons.forEach((btn, index) => btn.classList.toggle('active', index === currentLocationIndex));
    }
    
    function showError() {
      loadingSection.style.display = 'none';
      errorSection.style.display = 'block';
      noLocationsSection.style.display = 'none';
      puzzleContent.style.display = 'none';
    }
    
    function showNoLocations() {
      loadingSection.style.display = 'none';
      errorSection.style.display = 'none';
      noLocationsSection.style.display = 'block';
      puzzleContent.style.display = 'none';
    }
    
    // Start by loading Maps JS
    loadMapsJs();
  </script>
</body>
</html> 