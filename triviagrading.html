<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Trivia Grading App</title>
  <!-- Minimal styling for clarity -->
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    .screen {
      display: none; /* All screens hidden by default */
      margin-bottom: 30px;
    }
    .screen.active {
      display: block; /* The currently active screen */
    }
    .section {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
    }
    h2, h3 {
      margin: 0.2em 0;
    }
    select, input[type="text"], input[type="number"] {
      margin-right: 8px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
    }
    .button-row {
      margin-top: 16px;
    }
    .button-row button {
      margin-right: 8px;
    }
  </style>
</head>
<body>

<h1>Trivia Grading App</h1>

<!-- SCREEN A: Date Selection -->
<div id="screenDateSelect" class="screen active">
  <h2>1. Select Date</h2>
  <p>Select a trivia date from the database:</p>
  <select id="dateSelect"></select>
  <div class="button-row">
    <button id="btnCheckGrading">Continue</button>
  </div>
</div>

<!-- SCREEN B: Team Setup -->
<div id="screenTeamSetup" class="screen">
  <h2>2. Enter Teams</h2>
  <p>It seems there's no existing grading data for this date. Please add your teams:</p>
  
  <div>
    <input type="text" id="teamNameInput" placeholder="Team Name" />
    <input type="number" id="teamSizeInput" placeholder="Team Size" min="1" />
    <button id="btnAddTeam">Add Team</button>
  </div>

  <div class="section">
    <h3>Teams Added</h3>
    <ul id="teamList"></ul>
  </div>

  <div class="button-row">
    <button id="btnProceedToRounds">Proceed to Round Selection</button>
  </div>
</div>

<!-- SCREEN C: Rubric (Team & Round Overview) -->
<div id="screenRubric" class="screen">
  <h2>Rubric / Summary</h2>
  <p>Below are all teams found in the database for this date, plus their total scores so far.</p>
  <button id="btnAddMoreTeams">Add / Edit Teams</button>
  <button id="btnSelectRoundFromRubric">Select a Round to Grade</button>
  <div id="rubricContent" class="section">
    <!-- Table of (Team, Size, Score), each with link to "Edit" or "Open Round" -->
  </div>
</div>

<!-- SCREEN D: Select Round -->
<div id="screenRoundSelect" class="screen">
  <h2>3. Select Round to Grade</h2>
  <p>Choose from the rounds found under <em>trivia/[date]</em> in the DB.</p>
  <select id="roundSelect"></select>
  <div class="button-row">
    <button id="btnOpenGrading">Grade This Round</button>
    <button id="btnBackToRubric">Back to Rubric</button>
  </div>
</div>

<!-- SCREEN E: Grading for One Round -->
<div id="screenGrading" class="screen">
  <h2>4. Grade Round</h2>
  <div class="section">
    <label for="teamSelect">Team:</label>
    <select id="teamSelect"></select>
  </div>

  <div class="section">
    <table id="questionTable">
      <thead>
        <tr>
          <th>Question</th>
          <th>Answer</th>
          <th>Points</th>
          <th>Your Score (%)</th>
          <th>Calc</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows appended by JS -->
      </tbody>
    </table>
  </div>
  
  <div class="button-row">
    <button id="btnSaveScores">Save Scores</button>
    <button id="btnSwitchTeam">Switch Team</button>
    <button id="btnDoneRound">Done / Back to Rubric</button>
  </div>
</div>


<!-- Firebase + JS Logic -->
<script type="module">
  /***************************************************
   * 1) Import Firebase + Initialize
   ***************************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
  import { 
    getDatabase, ref, child, get, set, update, remove 
  } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBy8ExrgvBDto-BcNhlvrcC6ZB9G7HNaWE",
    authDomain: "eviltriviagrading.firebaseapp.com",
    databaseURL: "https://eviltriviagrading-default-rtdb.firebaseio.com",
    projectId: "eviltriviagrading",
    storageBucket: "eviltriviagrading.firebasestorage.app",
    messagingSenderId: "738486013114",
    appId: "1:738486013114:web:fe0f480cc3f66f42d6c683",
    measurementId: "G-R84N89NTJZ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /***************************************************
   * 2) DOM Elements
   ***************************************************/
  const screenDateSelect    = document.getElementById('screenDateSelect');
  const screenTeamSetup     = document.getElementById('screenTeamSetup');
  const screenRubric        = document.getElementById('screenRubric');
  const screenRoundSelect   = document.getElementById('screenRoundSelect');
  const screenGrading       = document.getElementById('screenGrading');

  const dateSelect          = document.getElementById('dateSelect');
  const btnCheckGrading     = document.getElementById('btnCheckGrading');

  const teamNameInput       = document.getElementById('teamNameInput');
  const teamSizeInput       = document.getElementById('teamSizeInput');
  const btnAddTeam          = document.getElementById('btnAddTeam');
  const teamList            = document.getElementById('teamList');
  const btnProceedToRounds  = document.getElementById('btnProceedToRounds');

  const rubricContent       = document.getElementById('rubricContent');
  const btnAddMoreTeams     = document.getElementById('btnAddMoreTeams');
  const btnSelectRoundFromRubric = document.getElementById('btnSelectRoundFromRubric');

  const roundSelect         = document.getElementById('roundSelect');
  const btnOpenGrading      = document.getElementById('btnOpenGrading');
  const btnBackToRubric     = document.getElementById('btnBackToRubric');

  const teamSelect          = document.getElementById('teamSelect');
  const questionTable       = document.getElementById('questionTable').querySelector('tbody');
  const btnSaveScores       = document.getElementById('btnSaveScores');
  const btnSwitchTeam       = document.getElementById('btnSwitchTeam');
  const btnDoneRound        = document.getElementById('btnDoneRound');

  /***************************************************
   * 3) App State Variables
   ***************************************************/
  let currentDate = null;
  let allTeams = []; // Array of { teamName, teamSize }
  let currentRound = null;
  let currentRoundData = {}; // The question data loaded for the round
  let cachedTriviaData = {}; // { date: { roundNum: {...} } } from /trivia
  let existingScores = {};   // { [teamName]: { [roundNum]: { [qID]: number } } }

  // Percentage options for scoring
  const percentageOptions = [
    { label: "0%",  value: 0.0 },
    { label: "25%", value: 0.25 },
    { label: "33%", value: 0.33 },
    { label: "50%", value: 0.50 },
    { label: "66%", value: 0.66 },
    { label: "75%", value: 0.75 },
    { label: "100%",value: 1.0 },
  ];

  /***************************************************
   * 4) Screen Navigation Helpers
   ***************************************************/
  function showScreen(screenElem) {
    // Hide all .screen
    [screenDateSelect, screenTeamSetup, screenRubric, screenRoundSelect, screenGrading].forEach(s => {
      s.classList.remove('active');
    });
    // Show the target
    screenElem.classList.add('active');
  }

  /***************************************************
   * 5) On Page Load: Populate the date dropdown
   ***************************************************/
  window.addEventListener('DOMContentLoaded', async () => {
    await loadDates();
  });

  async function loadDates() {
    dateSelect.innerHTML = "";
    const snapshot = await get(child(ref(db), "trivia"));
    if (snapshot.exists()) {
      const data = snapshot.val();
      const dateKeys = Object.keys(data).sort().reverse();
      dateKeys.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        dateSelect.appendChild(opt);
      });
    } else {
      // No trivia data
      const opt = document.createElement("option");
      opt.textContent = "No Trivia Data Found";
      opt.disabled = true;
      dateSelect.appendChild(opt);
    }
  }

  /***************************************************
   * 6) Date Selected -> Check if there's existing grading
   ***************************************************/
  btnCheckGrading.addEventListener('click', async () => {
    currentDate = dateSelect.value;
    if (!currentDate) {
      alert("Please select a date.");
      return;
    }
    // Check if scores/date exist
    const snap = await get(child(ref(db), `scores/${currentDate}`));
    if (snap.exists()) {
      // We have existing grading => Go to Rubric
      showRubric();
    } else {
      // No existing grading => go to Team Setup
      allTeams = [];
      teamList.innerHTML = "";
      showScreen(screenTeamSetup);
    }
  });

  /***************************************************
   * 7) Team Setup Screen
   ***************************************************/
  btnAddTeam.addEventListener('click', () => {
    const name = teamNameInput.value.trim();
    const size = Number(teamSizeInput.value.trim() || 0);
    if (!name) {
      alert("Enter a team name.");
      return;
    }
    if (size < 1) {
      alert("Enter a valid team size.");
      return;
    }
    // Add to local array
    const existing = allTeams.find(t => t.teamName === name);
    if (existing) {
      existing.teamSize = size;
    } else {
      allTeams.push({ teamName: name, teamSize: size });
    }
    refreshTeamList();
    teamNameInput.value = "";
    teamSizeInput.value = "";
  });

  function refreshTeamList() {
    teamList.innerHTML = "";
    allTeams.forEach(t => {
      const li = document.createElement('li');
      li.textContent = `${t.teamName} (size: ${t.teamSize})`;
      teamList.appendChild(li);
    });
  }

  btnProceedToRounds.addEventListener('click', async () => {
    if (!allTeams.length) {
      alert("Please add at least one team first.");
      return;
    }
    // Save these teams into the DB under scores/[date]
    // so we can retrieve them from the rubric or next session
    for (let t of allTeams) {
      const path = `scores/${currentDate}/${t.teamName}`;
      await set(ref(db, path), {
        number_of_people: t.teamSize
      });
    }
    // Now go to the Round Select or Rubric
    // Let's just go to Round Select
    await loadRoundOptions();
    showScreen(screenRoundSelect);
  });

  /***************************************************
   * 8) Rubric Screen
   ***************************************************/
  btnAddMoreTeams.addEventListener('click', async () => {
    // Retrieve teams from DB, show in the "Team Setup" screen
    // We could let the user see them and add more.
    allTeams = await fetchTeamsForDate(currentDate);
    refreshTeamList();
    showScreen(screenTeamSetup);
  });

  btnSelectRoundFromRubric.addEventListener('click', async () => {
    await loadRoundOptions();
    showScreen(screenRoundSelect);
  });

  async function showRubric() {
    showScreen(screenRubric);
    // build table of teams with total score
    rubricContent.innerHTML = "Loading...";
    const dateSnap = await get(child(ref(db), `scores/${currentDate}`));
    if (!dateSnap.exists()) {
      // no data
      rubricContent.innerHTML = "<p>No scores found for this date.</p>";
      return;
    }
    const data = dateSnap.val();
    // data => { [teamName]: { number_of_people, scores: {...} } }
    let html = `<table><thead>
      <tr>
        <th>Team</th>
        <th>Size</th>
        <th>Total Score</th>
      </tr>
    </thead><tbody>`;

    const teamNames = Object.keys(data).sort();
    teamNames.forEach(tName => {
      const tObj = data[tName];
      const size = tObj.number_of_people || 0;
      let total = 0;
      if (tObj.scores) {
        // sum up the scores
        Object.keys(tObj.scores).forEach(rNum => {
          Object.keys(tObj.scores[rNum]).forEach(qId => {
            total += Number(tObj.scores[rNum][qId]) || 0;
          });
        });
      }
      html += `<tr>
        <td>${tName}</td>
        <td>${size}</td>
        <td>${total}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    rubricContent.innerHTML = html;
  }

  /***************************************************
   * 9) Round Selection Screen
   ***************************************************/
  btnOpenGrading.addEventListener('click', () => {
    currentRound = roundSelect.value; 
    if (!currentRound) {
      alert("No round selected.");
      return;
    }
    // Go to grading screen for that round
    showGradingScreen();
  });

  btnBackToRubric.addEventListener('click', () => {
    showRubric();
  });

  async function loadRoundOptions() {
    // We want to load the rounds from /trivia/[date]
    // Typically the structure is /trivia/[date]/ROUNDNUM/...
    // We'll just read all subkeys
    if (!cachedTriviaData[currentDate]) {
      const snap = await get(child(ref(db), `trivia/${currentDate}`));
      if (snap.exists()) {
        cachedTriviaData[currentDate] = snap.val();
      } else {
        cachedTriviaData[currentDate] = {};
      }
    }
    const data = cachedTriviaData[currentDate];
    // data might look like { "1": { Written: {...}, Visual: {...} }, "2": {...} }
    const roundKeys = Object.keys(data).sort((a,b) => Number(a) - Number(b));
    roundSelect.innerHTML = "";
    roundKeys.forEach(rNum => {
      const opt = document.createElement("option");
      opt.value = rNum;
      opt.textContent = `Round ${rNum}`;
      roundSelect.appendChild(opt);
    });
    if (!roundKeys.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No Rounds Found";
      roundSelect.appendChild(opt);
    }
  }

  /***************************************************
   * 10) Grading Screen
   ***************************************************/
  async function showGradingScreen() {
    showScreen(screenGrading);
    // 1) Load teams
    allTeams = await fetchTeamsForDate(currentDate);
    teamSelect.innerHTML = "";
    allTeams.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.teamName;
      opt.textContent = t.teamName;
      teamSelect.appendChild(opt);
    });
    // 2) Load question data for current round
    loadQuestionDataForRound(currentRound);
    // 3) By default, fill table for the first team
    loadTeamScoresIntoTable(teamSelect.value);
  }

  teamSelect.addEventListener('change', () => {
    loadTeamScoresIntoTable(teamSelect.value);
  });

  function loadQuestionDataForRound(rNum) {
    const dataForDate = cachedTriviaData[currentDate] || {};
    const roundObj = dataForDate[rNum] || {};

    // Merge all question objects from all round types
    // e.g. roundObj might be { Written: {...}, Visual: {...} }
    // We'll flatten them:
    currentRoundData = {}; // { qid => { question, answer, total_points } }
    Object.keys(roundObj).forEach(rType => {
      const questionsOfType = roundObj[rType]; // { QID: { question, answer, total_possible_points } }
      Object.keys(questionsOfType).forEach(qId => {
        const q = questionsOfType[qId];
        // Combine roundType + qId => unique key
        const uniqueQID = `${rType}-${qId}`;
        currentRoundData[uniqueQID] = {
          roundType: rType,
          question: q.question,
          answer: q.answer,
          totalPoints: Number(q.total_possible_points) || 0
        };
      });
    });
  }

  async function loadTeamScoresIntoTable(teamName) {
    // Load this team's existing scores from DB for the current round
    const path = `scores/${currentDate}/${teamName}/scores/${currentRound}`;
    const snap = await get(child(ref(db), path));
    let teamRoundScores = {};
    if (snap.exists()) {
      teamRoundScores = snap.val(); 
      // e.g. { "Written-qId": 4, "Visual-qId": 2, ... }
    }

    // Build table rows
    questionTable.innerHTML = "";
    Object.keys(currentRoundData).forEach(uniqueQID => {
      const q = currentRoundData[uniqueQID];
      const tr = document.createElement('tr');

      // question
      const tdQ = document.createElement('td');
      tdQ.textContent = q.question;
      tr.appendChild(tdQ);

      // answer
      const tdA = document.createElement('td');
      tdA.textContent = q.answer;
      tr.appendChild(tdA);

      // total points
      const tdPts = document.createElement('td');
      tdPts.textContent = q.totalPoints;
      tr.appendChild(tdPts);

      // your score (percentage selection)
      const tdSelect = document.createElement('td');
      const sel = document.createElement('select');
      percentageOptions.forEach(optObj => {
        const opt = document.createElement('option');
        opt.value = optObj.value;
        opt.textContent = optObj.label;
        sel.appendChild(opt);
      });

      // If we have an existing score, figure out which percentage it is
      // (or the closest match). This is tricky because we only stored the final
      // numeric score. So we might do: existingScore / totalPoints => ratio
      const existingScore = Number(teamRoundScores[uniqueQID] || 0);
      const ratio = q.totalPoints ? (existingScore / q.totalPoints) : 0;
      // find the best matching ratio in the list
      let bestMatch = 0;
      let bestDiff = 9999;
      percentageOptions.forEach(optObj => {
        const diff = Math.abs(optObj.value - ratio);
        if (diff < bestDiff) {
          bestDiff = diff;
          bestMatch = optObj.value;
        }
      });
      sel.value = bestMatch;

      // We'll store an attribute for uniqueQID
      sel.setAttribute('data-qid', uniqueQID);
      tdSelect.appendChild(sel);
      tr.appendChild(tdSelect);

      // A column to show the computed numeric score
      const tdCalc = document.createElement('td');
      tdCalc.textContent = existingScore; // initial
      tr.appendChild(tdCalc);

      // On change, recalc
      sel.addEventListener('change', () => {
        const pct = Number(sel.value);
        const newScore = Math.round(q.totalPoints * pct * 100)/100; 
        tdCalc.textContent = newScore.toString();
      });

      questionTable.appendChild(tr);
    });
  }

  btnSaveScores.addEventListener('click', async () => {
    // Gather scores from questionTable
    const teamName = teamSelect.value;
    if (!teamName) {
      alert("No team selected!");
      return;
    }
    const inputs = questionTable.querySelectorAll('select');
    let updates = {};
    inputs.forEach(sel => {
      const uniqueQID = sel.getAttribute('data-qid');
      const pct = Number(sel.value);
      const q = currentRoundData[uniqueQID];
      const score = Math.round(q.totalPoints * pct * 100)/100; // e.g. 3.3
      updates[uniqueQID] = score;
    });

    // Write to /scores/[date]/[teamName]/scores/[roundNum]
    const path = `scores/${currentDate}/${teamName}/scores/${currentRound}`;
    await set(ref(db, path), updates);

    alert("Scores saved!");
  });

  btnSwitchTeam.addEventListener('click', () => {
    if (teamSelect.options.length > 1) {
      // Just pick a different team from the dropdown
      const idx = teamSelect.selectedIndex;
      const newIdx = (idx + 1) % teamSelect.options.length;
      teamSelect.selectedIndex = newIdx;
      loadTeamScoresIntoTable(teamSelect.value);
    } else {
      alert("Only one team in the list.");
    }
  });

  btnDoneRound.addEventListener('click', () => {
    showRubric();
  });

  /***************************************************
   * 11) Utility: Fetch teams for a date
   ***************************************************/
  async function fetchTeamsForDate(date) {
    const snap = await get(child(ref(db), `scores/${date}`));
    let result = [];
    if (snap.exists()) {
      const data = snap.val();
      // data: { [teamName]: { number_of_people, scores: {...} } }
      Object.keys(data).forEach(tName => {
        const tObj = data[tName];
        result.push({
          teamName: tName,
          teamSize: tObj.number_of_people || 0
        });
      });
    }
    return result;
  }

</script>

</body>
</html>
