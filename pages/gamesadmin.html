<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Evil Trivia - Games Admin</title>
    <script src="/js/components/autoload-banner.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- TinyMCE for rich text editing -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 30px;
            background-color: #FFCC00;
            margin-top: 60px;
        }
        .hidden {
            display: none;
        }
        .section {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 15px;
            background-color: white;
            border-radius: 8px;
            max-width: 800px;
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        .input-row {
            margin: 15px 0;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #000000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #333333;
        }
        input[type="text"], 
        input[type="number"],
        textarea,
        select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-row > div {
            flex: 1;
        }
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .question-list-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .question-list-item:hover {
            background-color: #f9f9f9;
        }
        .question-list-item.active {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .success-message {
            background-color: #dff0d8;
            color: #3c763d;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        .error-message {
            background-color: #f2dede;
            color: #a94442;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        .debug-section {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .debug-result {
            margin-top: 10px;
            padding: 10px;
            background-color: #ddd;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Evil Trivia Games Admin</h1>

    <div id="loginPrompt" class="section">
        <h2>Admin Login</h2>
        <form id="loginForm" class="login-form" style="display: none; margin-bottom: 30px;">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="button" id="loginButton" class="btn btn-primary">Login</button>
            <p id="loginStatus" style="display: none; margin-top: 10px; color: #d50000;"></p>
            <button type="button" id="checkRolesButton" class="btn btn-secondary" style="margin-top: 10px;">Check My Roles</button>
        </form>
        
        <div class="debug-section">
            <h3>Troubleshooting</h3>
            <p>If you're having trouble accessing this page despite being logged in:</p>
            <button id="btnCheckRoles">Check My Roles</button>
            <div id="debugResult" class="debug-result" style="display: none;"></div>
        </div>
    </div>

    <div id="adminUI" class="hidden">
        <div class="section">
            <h2>Free Drinkle Administration</h2>
            
            <div class="form-row">
                <div>
                    <h3>Set Active Question</h3>
                    <div class="form-group">
                        <label for="activeQuestionSelect">Choose Active Question:</label>
                        <select id="activeQuestionSelect">
                            <option value="">None (Disable Free Drinkle)</option>
                            <!-- Questions will be populated here -->
                        </select>
                    </div>
                    <button id="saveActiveQuestion">Set Active Question</button>
                    <div id="activeSuccess" class="success-message">Active question updated successfully!</div>
                </div>
                
                <div>
                    <h3>Current Active Question</h3>
                    <div id="currentActiveQuestionInfo">
                        <p>No active question set</p>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button id="editActiveQuestionBtn" style="margin-right: 10px; background-color: #28a745; display: none;" title="Edit the current active question">‚úèÔ∏è Edit Active Question</button>
                        <button id="viewResponsesBtn" style="background-color: #17a2b8; display: none;" title="View all user submissions for this question">üë• View All Responses</button>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0;">
            
            <!-- Edit Active Question Form (Hidden by default) -->
            <div id="editActiveQuestionSection" style="display: none;">
                <h3>Edit Active Question</h3>
                <form id="editQuestionForm">
                    <div class="form-group">
                        <label for="editTitleInput">Title (optional):</label>
                        <input type="text" id="editTitleInput" placeholder="Enter a title for this question (displayed prominently)">
                    </div>
                    
                    <div class="form-group">
                        <label for="editQuestionInput">Question:</label>
                        <textarea id="editQuestionInput" placeholder="Enter the question" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAnswerInput">Correct Answer (number):</label>
                            <input type="number" id="editAnswerInput" placeholder="e.g. 42" step="any" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editUnitInput">Unit:</label>
                            <input type="text" id="editUnitInput" placeholder="e.g. miles, years, etc." required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editFormatSelect">Number Format:</label>
                        <select id="editFormatSelect" required>
                            <option value="decimal">Decimal (e.g., 1,234.56)</option>
                            <option value="integer">Integer (e.g., 1,234)</option>
                            <option value="year">Year (e.g., 1999)</option>
                            <option value="percentage">Percentage (e.g., 75%)</option>
                            <option value="plain">Plain Number (e.g., 1234.56)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editDateInput">Date:</label>
                        <input type="date" id="editDateInput" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editNotesInput">Notes (Optional - shown after user submits answer):</label>
                        <p class="helper-text" style="font-size: 12px; color: #666; margin-top: 5px;">
                            Add additional context, explanations, or links that will be shown after the user submits their answer.
                            HTML formatting is supported (e.g., <code>&lt;a href="..."&gt;link&lt;/a&gt;</code>).
                        </p>
                        <textarea id="editNotesInput" placeholder="Additional notes, context, or links to be shown after answer submission" style="min-height: 120px;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Result Messages (optional):</label>
                        <p class="helper-text" style="font-size: 12px; color: #666; margin-top: 5px;">
                            Add custom messages for different percentile ranges. Messages will be shown based on the highest threshold the user's percentile reaches.
                        </p>
                        
                        <div id="editCustomMessagesContainer">
                            <!-- Custom messages will be added here -->
                        </div>
                        
                        <button type="button" id="editAddMessageBtn" style="margin-top: 10px; background-color: #5cb85c;">+ Add Message</button>
                    </div>
                    
                    <button type="submit">Save Changes</button>
                    <button type="button" id="cancelEditBtn" style="background-color: #d9534f; margin-left: 10px;">Cancel</button>
                    <div id="editSuccess" class="success-message">Question updated successfully!</div>
                    <div id="editError" class="error-message">Error updating question. Please try again.</div>
                </form>
            </div>

            <!-- User Responses Section (Hidden by default) -->
            <div id="responsesSection" style="display: none;">
                <h3>User Responses</h3>
                <div class="table-container">
                    <table id="responsesTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Answer</th>
                                <th>% Off</th>
                                <th>Percentile</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Responses will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="responseStats" style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <h4>Response Statistics</h4>
                    <p><strong>Total Responses:</strong> <span id="totalResponses">0</span></p>
                    <p><strong>Average Answer:</strong> <span id="avgAnswer">0</span></p>
                    <p><strong>Average % Off:</strong> <span id="avgPercentOff">0%</span></p>
                </div>
                <button id="closeResponsesBtn" style="margin-top: 15px; background-color: #6c757d;">Close</button>
                <button id="exportResponsesBtn" style="margin-top: 15px; margin-left: 10px; background-color: #28a745;">Export CSV</button>
            </div>
            
            <h3>Create New Question</h3>
            <form id="newQuestionForm">
                <div class="form-group">
                    <label for="titleInput">Title (optional):</label>
                    <input type="text" id="titleInput" placeholder="Enter a title for this question (displayed prominently)">
                </div>
                
                <div class="form-group">
                    <label for="questionInput">Question:</label>
                    <textarea id="questionInput" placeholder="Enter the question" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="answerInput">Correct Answer (number):</label>
                        <input type="number" id="answerInput" placeholder="e.g. 42" step="any" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="unitInput">Unit:</label>
                        <input type="text" id="unitInput" placeholder="e.g. miles, years, etc." required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="formatSelect">Number Format:</label>
                    <select id="formatSelect" required>
                        <option value="decimal">Decimal (e.g., 1,234.56)</option>
                        <option value="integer">Integer (e.g., 1,234)</option>
                        <option value="year">Year (e.g., 1999)</option>
                        <option value="percentage">Percentage (e.g., 75%)</option>
                        <option value="plain">Plain Number (e.g., 1234.56)</option>
                    </select>
                    <p class="helper-text" style="font-size: 12px; color: #666; margin-top: 5px;">
                        Choose how numbers should be displayed on the question page
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="dateInput">Date:</label>
                    <input type="date" id="dateInput" required>
                </div>
                
                <div class="form-group">
                    <label for="notesInput">Notes (Optional - shown after user submits answer):</label>
                    <p class="helper-text" style="font-size: 12px; color: #666; margin-top: 5px;">
                        Add additional context, explanations, or links that will be shown after the user submits their answer.
                        HTML formatting is supported (e.g., <code>&lt;a href="..."&gt;link&lt;/a&gt;</code>).
                    </p>
                    <textarea id="notesInput" placeholder="Additional notes, context, or links to be shown after answer submission" style="min-height: 120px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Custom Result Messages (optional):</label>
                    <p class="helper-text" style="font-size: 12px; color: #666; margin-top: 5px;">
                        Add custom messages for different percentile ranges. Messages will be shown based on the highest threshold the user's percentile reaches.
                    </p>
                    
                    <div id="customMessagesContainer">
                        <div class="custom-message-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 0 0 100px;">
                                <input type="number" class="threshold-input" min="0" max="100" placeholder="Percentile" style="width: 100%;">
                            </div>
                            <div style="flex: 1;">
                                <input type="text" class="message-input" placeholder="Custom message for this percentile or higher" style="width: 100%;">
                            </div>
                            <div>
                                <button type="button" class="remove-message-btn" style="background-color: #d9534f;">‚úï</button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="addMessageBtn" style="margin-top: 10px; background-color: #5cb85c;">+ Add Message</button>
                </div>
                
                <button type="submit">Save Question</button>
                <div id="saveSuccess" class="success-message">Question saved successfully!</div>
                <div id="saveError" class="error-message">Error saving question. Please try again.</div>
            </form>
            
            <hr style="margin: 30px 0;">
            
            <h3>Question History</h3>
            <div class="table-container">
                <table id="questionsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Question</th>
                            <th>Answer</th>
                            <th>Unit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Questions will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getDatabase, ref, get, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebaseapp.com",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // DOM elements
        const loginPrompt = document.getElementById('loginPrompt');
        const adminUI = document.getElementById('adminUI');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('btnLogin');
        const loginStatus = document.getElementById('loginStatus');
        const checkRolesButton = document.getElementById('btnCheckRoles');
        const debugResult = document.getElementById('debugResult');
        
        const activeQuestionSelect = document.getElementById('activeQuestionSelect');
        const saveActiveButton = document.getElementById('saveActiveQuestion');
        const currentActiveQuestionInfo = document.getElementById('currentActiveQuestionInfo');
        const activeSuccess = document.getElementById('activeSuccess');
        
        const editActiveQuestionBtn = document.getElementById('editActiveQuestionBtn');
        const viewResponsesBtn = document.getElementById('viewResponsesBtn');
        const editActiveQuestionSection = document.getElementById('editActiveQuestionSection');
        const editQuestionForm = document.getElementById('editQuestionForm');
        const editTitleInput = document.getElementById('editTitleInput');
        const editQuestionInput = document.getElementById('editQuestionInput');
        const editAnswerInput = document.getElementById('editAnswerInput');
        const editUnitInput = document.getElementById('editUnitInput');
        const editFormatSelect = document.getElementById('editFormatSelect');
        const editDateInput = document.getElementById('editDateInput');
        const editNotesInput = document.getElementById('editNotesInput');
        const editCustomMessagesContainer = document.getElementById('editCustomMessagesContainer');
        const editAddMessageBtn = document.getElementById('editAddMessageBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const editSuccess = document.getElementById('editSuccess');
        const editError = document.getElementById('editError');
        
        const responsesSection = document.getElementById('responsesSection');
        const responsesTable = document.getElementById('responsesTable').getElementsByTagName('tbody')[0];
        const closeResponsesBtn = document.getElementById('closeResponsesBtn');
        const exportResponsesBtn = document.getElementById('exportResponsesBtn');
        const totalResponses = document.getElementById('totalResponses');
        const avgAnswer = document.getElementById('avgAnswer');
        const avgPercentOff = document.getElementById('avgPercentOff');
        
        const newQuestionForm = document.getElementById('newQuestionForm');
        const titleInput = document.getElementById('titleInput');
        const questionInput = document.getElementById('questionInput');
        const answerInput = document.getElementById('answerInput');
        const unitInput = document.getElementById('unitInput');
        const formatSelect = document.getElementById('formatSelect');
        const dateInput = document.getElementById('dateInput');
        const notesInput = document.getElementById('notesInput');
        const customMessagesContainer = document.getElementById('customMessagesContainer');
        const addMessageBtn = document.getElementById('addMessageBtn');
        const saveSuccess = document.getElementById('saveSuccess');
        const saveError = document.getElementById('saveError');
        
        const questionsTable = document.getElementById('questionsTable').getElementsByTagName('tbody')[0];
        
        // Set today's date as default
        dateInput.valueAsDate = new Date();
        
        // Variable to store current active question
        let currentActiveQuestion = null;
        
        // Add event listener for adding new custom message rows
        addMessageBtn.addEventListener('click', () => {
            addCustomMessageRow('', '', customMessagesContainer);
        });
        
        // Add event delegation for remove buttons
        customMessagesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-message-btn')) {
                e.target.closest('.custom-message-row').remove();
            }
        });
        
        // Add event delegation for edit form remove buttons
        editCustomMessagesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-message-btn')) {
                e.target.closest('.custom-message-row').remove();
            }
        });
        
        // Function to add a new custom message row
        function addCustomMessageRow(threshold = '', message = '', container = customMessagesContainer) {
            const row = document.createElement('div');
            row.className = 'custom-message-row';
            row.style = 'display: flex; gap: 10px; margin-bottom: 10px;';
            
            row.innerHTML = `
                <div style="flex: 0 0 100px;">
                    <input type="number" class="threshold-input" min="0" max="100" placeholder="Percentile" style="width: 100%;" value="${threshold}">
                </div>
                <div style="flex: 1;">
                    <input type="text" class="message-input" placeholder="Custom message for this percentile or higher" style="width: 100%;" value="${message}">
                </div>
                <div>
                    <button type="button" class="remove-message-btn" style="background-color: #d9534f;">‚úï</button>
                </div>
            `;
            
            container.appendChild(row);
        }
        
        // Check auth state (This is the main difference - simpler auth check like in admin.html)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                console.log("User is signed in");
                
                try {
                    // Check if user has admin role
                    const userRef = ref(db, `users/${user.uid}`);
                    const userSnapshot = await get(userRef);
                    const userData = userSnapshot.val();
                    
                    if (!userData) {
                        console.error("No user data found for this user");
                        loginStatus.textContent = "User account exists but no data found. Please contact an administrator.";
                        loginStatus.style.display = "block";
                        return;
                    }
                    
                    // Check roles - both legacy and new format
                    let isAdmin = false;
                    
                    // Check new roles format (array)
                    if (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin')) {
                        isAdmin = true;
                    }
                    // Check legacy role format (string)
                    else if (userData.role === 'admin') {
                        isAdmin = true;
                    }
                    
                    if (isAdmin) {
                        // User is admin, show admin UI
                        loginPrompt.classList.add('hidden');
                        adminUI.classList.remove('hidden');
                        
                        // Initialize the buttons
                        initializeAdminButtons();
                        
                        // Load questions and active question
                        loadQuestions();
                        loadActiveQuestion();
                    } else {
                        // Not admin, show error
                        loginStatus.textContent = "You need admin privileges to access this page";
                        loginStatus.style.display = "block";
                        loginPrompt.classList.remove('hidden');
                        adminUI.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error checking user role:", error);
                    loginStatus.textContent = "Error checking permissions: " + error.message;
                    loginStatus.style.display = "block";
                }
            } else {
                // User is signed out
                console.log("User is signed out");
                loginPrompt.classList.remove('hidden');
                adminUI.classList.add('hidden');
            }
            
            // Add one empty custom message row on page load
            addCustomMessageRow();
        });
        
        // Initialize admin buttons
        function initializeAdminButtons() {
            console.log("Initializing admin buttons");
            
            // Make sure the edit and view buttons have event listeners
            if (editActiveQuestionBtn && viewResponsesBtn) {
                console.log("Admin buttons found and initialized");
                
                // Ensure buttons are visible when appropriate
                if (currentActiveQuestion) {
                    editActiveQuestionBtn.style.display = 'inline-block';
                    viewResponsesBtn.style.display = 'inline-block';
                }
            } else {
                console.error("Admin buttons not found in the DOM");
            }
        }
        
        // Login handler
        loginButton.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!email || !password) {
                loginStatus.textContent = "Please enter email and password";
                loginStatus.style.display = "block";
                return;
            }
            
            try {
                loginStatus.style.display = 'none';
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change listener will handle UI updates
            } catch (error) {
                console.error("Login error:", error);
                loginStatus.textContent = "Login failed: " + error.message;
                loginStatus.style.display = "block";
            }
        });
        
        // Add enter key handler for password field
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginButton.click();
            }
        });
        
        // Load questions from Firebase
        function loadQuestions() {
            const questionsRef = ref(db, 'games/drinkle/questions');
            
            onValue(questionsRef, (snapshot) => {
                const questions = snapshot.val() || {};
                
                // Clear the table
                questionsTable.innerHTML = '';
                
                // Clear the select
                while (activeQuestionSelect.options.length > 1) {
                    activeQuestionSelect.remove(1);
                }
                
                // Sort questions by date (newest first)
                const sortedQuestions = Object.entries(questions)
                    .map(([id, question]) => ({...question, id}))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Populate the table and select
                sortedQuestions.forEach(question => {
                    // Add to table
                    const row = questionsTable.insertRow();
                    
                    const dateCell = row.insertCell(0);
                    dateCell.textContent = new Date(question.date).toLocaleDateString();
                    
                    const questionCell = row.insertCell(1);
                    
                    // Show title in the table if available
                    if (question.title) {
                        questionCell.innerHTML = `<strong>${question.title}</strong><br>`;
                    }
                    
                    questionCell.innerHTML += question.question.length > 50 
                        ? question.question.substring(0, 50) + '...' 
                        : question.question;
                    
                    const answerCell = row.insertCell(2);
                    answerCell.textContent = question.answer;
                    
                    const unitCell = row.insertCell(3);
                    unitCell.textContent = question.unit;
                    
                    const actionsCell = row.insertCell(4);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.style.backgroundColor = '#d9534f';
                    deleteBtn.onclick = () => deleteQuestion(question.id);
                    actionsCell.appendChild(deleteBtn);
                    
                    // Add to select
                    const option = document.createElement('option');
                    option.value = question.id;
                    
                    // Include title in option text if available
                    if (question.title) {
                        option.textContent = `${new Date(question.date).toLocaleDateString()} - ${question.title}`;
                    } else {
                        option.textContent = `${new Date(question.date).toLocaleDateString()} - ${
                            question.question.length > 30 
                                ? question.question.substring(0, 30) + '...' 
                                : question.question
                        }`;
                    }
                    
                    activeQuestionSelect.appendChild(option);
                });
            });
        }
        
        // Load active question
        function loadActiveQuestion() {
            const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
            
            onValue(activeQuestionRef, async (snapshot) => {
                const activeQuestionId = snapshot.val();
                
                if (!activeQuestionId) {
                    activeQuestionSelect.value = '';
                    currentActiveQuestionInfo.innerHTML = '<p>No active question set</p>';
                    editActiveQuestionBtn.style.display = 'none';
                    viewResponsesBtn.style.display = 'none';
                    return;
                }
                
                console.log("Active question ID:", activeQuestionId);
                
                // Set the select value
                activeQuestionSelect.value = activeQuestionId;
                
                // Get the question details
                const questionRef = ref(db, `games/drinkle/questions/${activeQuestionId}`);
                const questionSnapshot = await get(questionRef);
                currentActiveQuestion = questionSnapshot.val();
                
                if (currentActiveQuestion) {
                    // Store ID for reference
                    currentActiveQuestion.id = activeQuestionId;
                    
                    // Log complete object for debugging
                    console.log("Active question data:", JSON.stringify(currentActiveQuestion, null, 2));
                    
                    // Show active question details
                    let infoHTML = '';
                    
                    if (currentActiveQuestion.title) {
                        infoHTML += `<p><strong>Title:</strong> ${currentActiveQuestion.title}</p>`;
                    }
                    
                    infoHTML += `
                        <p><strong>Question:</strong> ${currentActiveQuestion.question}</p>
                        <p><strong>Answer:</strong> ${currentActiveQuestion.answer} ${currentActiveQuestion.unit}</p>
                        <p><strong>Date:</strong> ${new Date(currentActiveQuestion.date).toLocaleDateString()}</p>
                    `;
                    
                    // Add format info if available
                    if (currentActiveQuestion.format) {
                        const formatLabels = {
                            'decimal': 'Decimal (e.g., 1,234.56)',
                            'integer': 'Integer (e.g., 1,234)',
                            'year': 'Year (e.g., 1999)',
                            'percentage': 'Percentage (e.g., 75%)',
                            'plain': 'Plain Number (e.g., 1234.56)'
                        };
                        infoHTML += `<p><strong>Number Format:</strong> ${formatLabels[currentActiveQuestion.format] || currentActiveQuestion.format}</p>`;
                    }
                    
                    if (currentActiveQuestion.customMessages && currentActiveQuestion.customMessages.length > 0) {
                        infoHTML += `<p><strong>Custom Messages:</strong> ${currentActiveQuestion.customMessages.length} defined</p>`;
                    }
                    
                    // Show if notes are present
                    if (currentActiveQuestion.notes) {
                        const notesLength = currentActiveQuestion.notes.length;
                        infoHTML += `<p><strong>Notes:</strong> <span style="color: #28a745;">‚úì</span> Notes (${notesLength} characters) will be shown after submission</p>`;
                    } else {
                        infoHTML += `<p><strong>Notes:</strong> <span style="color: #dc3545;">‚úó</span> No notes defined</p>`;
                    }
                    
                    currentActiveQuestionInfo.innerHTML = infoHTML;
                    
                    // Show edit and view responses buttons
                    editActiveQuestionBtn.style.display = 'inline-block';
                    viewResponsesBtn.style.display = 'inline-block';
                    
                    console.log("Edit button display:", editActiveQuestionBtn.style.display);
                    console.log("View responses button display:", viewResponsesBtn.style.display);
                } else {
                    currentActiveQuestionInfo.innerHTML = '<p>Error: Selected question not found</p>';
                    editActiveQuestionBtn.style.display = 'none';
                    viewResponsesBtn.style.display = 'none';
                }
            });
        }
        
        // Save active question
        saveActiveButton.addEventListener('click', async () => {
            const questionId = activeQuestionSelect.value;
            
            try {
                const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
                await set(activeQuestionRef, questionId);
                
                // Show success message
                activeSuccess.style.display = 'block';
                setTimeout(() => {
                    activeSuccess.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error("Error setting active question:", error);
                alert("Error setting active question. Please try again.");
            }
        });
        
        // Save new question
        newQuestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = titleInput.value.trim();
            const question = questionInput.value;
            const answer = answerInput.value;
            const unit = unitInput.value;
            const format = formatSelect.value;
            const date = dateInput.value;
            
            // Safely get notes content
            let notes = '';
            const notesEditor = tinymce.get('notesInput');
            if (notesEditor && notesEditor.initialized) {
                notes = notesEditor.getContent();
                console.log("Saving new question notes content:", notes);
            } else {
                console.warn("TinyMCE editor not initialized for new question, attempting to get content directly");
                // Fallback to get content from textarea
                const notesTextarea = document.getElementById('notesInput');
                if (notesTextarea) {
                    notes = notesTextarea.value;
                }
            }
            
            if (!question || !answer || !unit || !date) {
                saveError.style.display = 'block';
                setTimeout(() => {
                    saveError.style.display = 'none';
                }, 3000);
                return;
            }
            
            // Collect custom messages
            const customMessages = [];
            const messageRows = customMessagesContainer.querySelectorAll('.custom-message-row');
            
            messageRows.forEach(row => {
                const threshold = parseInt(row.querySelector('.threshold-input').value);
                const message = row.querySelector('.message-input').value.trim();
                
                if (!isNaN(threshold) && threshold >= 0 && threshold <= 100 && message) {
                    customMessages.push({
                        threshold,
                        text: message
                    });
                }
            });
            
            try {
                const questionsRef = ref(db, 'games/drinkle/questions');
                const newQuestionRef = push(questionsRef);
                
                const questionData = {
                    question,
                    answer: parseFloat(answer),
                    unit,
                    date,
                    format,
                    id: newQuestionRef.key,
                    notes: notes // Always include notes field, even if empty
                };
                
                // Add optional fields if they exist
                if (title) {
                    questionData.title = title;
                }
                
                if (customMessages.length > 0) {
                    questionData.customMessages = customMessages;
                }
                
                console.log("Saving new question data:", questionData);
                await set(newQuestionRef, questionData);
                
                // Clear the form
                newQuestionForm.reset();
                dateInput.valueAsDate = new Date();
                customMessagesContainer.innerHTML = '';
                addCustomMessageRow(); // Add one empty row
                
                // Clear the TinyMCE editor
                if (notesEditor && notesEditor.initialized) {
                    notesEditor.setContent('');
                }
                
                // Show success message
                saveSuccess.style.display = 'block';
                setTimeout(() => {
                    saveSuccess.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error("Error saving question:", error);
                saveError.style.display = 'block';
                setTimeout(() => {
                    saveError.style.display = 'none';
                }, 3000);
            }
        });
        
        // Delete question
        async function deleteQuestion(questionId) {
            if (!confirm("Are you sure you want to delete this question?")) {
                return;
            }
            
            try {
                // Check if this is the active question
                const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
                const activeQuestionSnapshot = await get(activeQuestionRef);
                const activeQuestionId = activeQuestionSnapshot.val();
                
                if (activeQuestionId === questionId) {
                    if (!confirm("This is the currently active question! Deleting it will disable the Free Drinkle game. Continue?")) {
                        return;
                    }
                    
                    // Clear the active question
                    await set(activeQuestionRef, '');
                }
                
                // Delete the question
                const questionRef = ref(db, `games/drinkle/questions/${questionId}`);
                await remove(questionRef);
                
                // Delete any answers for this question
                const answersRef = ref(db, `games/drinkle/answers/${questionId}`);
                await remove(answersRef);
                
                alert("Question deleted successfully!");
            } catch (error) {
                console.error("Error deleting question:", error);
                alert("Error deleting question. Please try again.");
            }
        }
        
        // Add event listener for the check roles button
        checkRolesButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            debugResult.style.display = 'block';
            
            if (!user) {
                debugResult.textContent = 'You are not logged in. Please log in first.';
                return;
            }
            
            try {
                // Check user data
                const userRef = ref(db, `users/${user.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                
                if (!userData) {
                    debugResult.textContent = `You are logged in with email ${user.email}, but no user data found in database.`;
                    return;
                }
                
                // Format user data for display
                let output = `User: ${user.email}\nUID: ${user.uid}\n\n`;
                
                // Check roles
                if (userData.roles && Array.isArray(userData.roles)) {
                    output += `Roles (array): ${userData.roles.join(', ')}\n`;
                } else {
                    output += `Roles (array): Not found\n`;
                }
                
                if (userData.role && typeof userData.role === 'string') {
                    output += `Role (legacy): ${userData.role}\n`;
                } else {
                    output += `Role (legacy): Not found\n`;
                }
                
                // Add other useful data
                output += `\nFull user data:\n${JSON.stringify(userData, null, 2)}`;
                
                debugResult.textContent = output;
            } catch (error) {
                debugResult.textContent = `Error checking roles: ${error.message}\n${error.stack}`;
            }
        });
        
        // Edit active question button click
        editActiveQuestionBtn.addEventListener('click', () => {
            console.log("Edit active question button clicked");
            
            if (!currentActiveQuestion) {
                alert("No active question selected");
                return;
            }
            
            // Populate the edit form
            editTitleInput.value = currentActiveQuestion.title || '';
            editQuestionInput.value = currentActiveQuestion.question || '';
            editAnswerInput.value = currentActiveQuestion.answer || '';
            editUnitInput.value = currentActiveQuestion.unit || '';
            editFormatSelect.value = currentActiveQuestion.format || 'decimal';
            editDateInput.value = currentActiveQuestion.date || '';
            
            // Set the notes field using TinyMCE but ensure it's initialized first
            waitForTinyMCE('editNotesInput', (editor) => {
                console.log("Setting TinyMCE content:", currentActiveQuestion.notes || '');
                editor.setContent(currentActiveQuestion.notes || '');
            });
            
            // Clear existing custom messages
            editCustomMessagesContainer.innerHTML = '';
            
            // Add custom messages if they exist
            if (currentActiveQuestion.customMessages && Array.isArray(currentActiveQuestion.customMessages)) {
                currentActiveQuestion.customMessages.forEach(message => {
                    addCustomMessageRow(message.threshold, message.text, editCustomMessagesContainer);
                });
            }
            
            // Add at least one empty message row if none exist
            if (editCustomMessagesContainer.children.length === 0) {
                addCustomMessageRow('', '', editCustomMessagesContainer);
            }
            
            // Show the edit section
            editActiveQuestionSection.style.display = 'block';
        });
        
        // Cancel edit button click
        cancelEditBtn.addEventListener('click', () => {
            editActiveQuestionSection.style.display = 'none';
        });
        
        // Edit question form submission
        editQuestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentActiveQuestion) {
                alert("No active question to edit");
                return;
            }
            
            const title = editTitleInput.value.trim();
            const question = editQuestionInput.value;
            const answer = editAnswerInput.value;
            const unit = editUnitInput.value;
            const format = editFormatSelect.value;
            const date = editDateInput.value;
            
            // Ensure we get notes content safely
            let notes = '';
            const notesEditor = tinymce.get('editNotesInput');
            if (notesEditor && notesEditor.initialized) {
                notes = notesEditor.getContent();
                console.log("Saving notes content:", notes);
            } else {
                console.warn("TinyMCE editor not initialized, attempting to get content directly");
                // Fallback to get content from textarea
                const notesTextarea = document.getElementById('editNotesInput');
                if (notesTextarea) {
                    notes = notesTextarea.value;
                }
            }
            
            if (!question || !answer || !unit || !date) {
                editError.style.display = 'block';
                setTimeout(() => {
                    editError.style.display = 'none';
                }, 3000);
                return;
            }
            
            // Collect custom messages
            const customMessages = [];
            const messageRows = editCustomMessagesContainer.querySelectorAll('.custom-message-row');
            
            messageRows.forEach(row => {
                const threshold = parseInt(row.querySelector('.threshold-input').value);
                const message = row.querySelector('.message-input').value.trim();
                
                if (!isNaN(threshold) && threshold >= 0 && threshold <= 100 && message) {
                    customMessages.push({
                        threshold,
                        text: message
                    });
                }
            });
            
            try {
                const questionRef = ref(db, `games/drinkle/questions/${currentActiveQuestion.id}`);
                
                const questionData = {
                    question,
                    answer: parseFloat(answer),
                    unit,
                    date,
                    format,
                    id: currentActiveQuestion.id
                };
                
                // Add optional fields if they exist
                if (title) {
                    questionData.title = title;
                }
                
                // Always include notes field, even if empty
                questionData.notes = notes;
                
                if (customMessages.length > 0) {
                    questionData.customMessages = customMessages;
                }
                
                console.log("Saving question data:", questionData);
                await set(questionRef, questionData);
                
                // Hide the edit section
                editActiveQuestionSection.style.display = 'none';
                
                // Show success message
                editSuccess.style.display = 'block';
                setTimeout(() => {
                    editSuccess.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error("Error updating question:", error);
                editError.style.display = 'block';
                setTimeout(() => {
                    editError.style.display = 'none';
                }, 3000);
            }
        });
        
        // Edit Add Message button
        editAddMessageBtn.addEventListener('click', () => {
            addCustomMessageRow('', '', editCustomMessagesContainer);
        });
        
        // View responses button click
        viewResponsesBtn.addEventListener('click', async () => {
            console.log("View responses button clicked");
            
            if (!currentActiveQuestion) {
                alert("No active question selected");
                return;
            }
            
            // Clear previous data
            responsesTable.innerHTML = '';
            // Show loading indicator
            responsesTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">Loading responses...</td></tr>';
            
            try {
                let combinedAnswers = {};
                let loadingError = null;
                
                // Try to get answers from the main path
                try {
                    const answersRef = ref(db, `games/drinkle/answers/${currentActiveQuestion.id}`);
                    const answersSnapshot = await get(answersRef);
                    const answers = answersSnapshot.val() || {};
                    combinedAnswers = {...combinedAnswers, ...answers};
                    console.log("Successfully loaded answers from main path:", Object.keys(answers).length);
                } catch (error) {
                    console.error("Error loading answers from main path:", error);
                    loadingError = error;
                }
                
                // Also check publicAnswers path
                try {
                    const publicAnswersRef = ref(db, `publicAnswers/drinkle/${currentActiveQuestion.id}`);
                    const publicAnswersSnapshot = await get(publicAnswersRef);
                    const publicAnswers = publicAnswersSnapshot.val() || {};
                    combinedAnswers = {...combinedAnswers, ...publicAnswers};
                    console.log("Successfully loaded answers from public path:", Object.keys(publicAnswers).length);
                } catch (error) {
                    console.error("Error loading answers from public path:", error);
                    if (!loadingError) loadingError = error;
                }
                
                // If we couldn't get any answers and had errors, throw the main error
                if (Object.keys(combinedAnswers).length === 0 && loadingError) {
                    throw new Error(`Permission denied: Unable to access both answer paths. Please check your admin privileges. Error: ${loadingError.message}`);
                }
                
                // Clear the table
                responsesTable.innerHTML = '';
                
                if (Object.keys(combinedAnswers).length === 0) {
                    // No responses
                    responsesTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">No responses yet</td></tr>';
                    totalResponses.textContent = '0';
                    avgAnswer.textContent = 'N/A';
                    avgPercentOff.textContent = 'N/A';
                } else {
                    // Convert to array and sort by timestamp (newest first)
                    const answersList = Object.entries(combinedAnswers)
                        .map(([id, answer]) => ({
                            id,
                            userId: answer.userId,
                            answer: parseFloat(answer.answer),
                            timestamp: answer.timestamp || Date.now()
                        }))
                        .sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Calculate additional stats
                    const correctAnswer = parseFloat(currentActiveQuestion.answer);
                    
                    const answersWithStats = answersList.map(answer => {
                        const percentDiff = Math.abs((answer.answer - correctAnswer) / correctAnswer * 100);
                        return {
                            ...answer,
                            percentOff: percentDiff
                        };
                    });
                    
                    // Sort by accuracy for percentile calculation
                    const sortedByAccuracy = [...answersWithStats].sort((a, b) => a.percentOff - b.percentOff);
                    
                    // Calculate percentiles and add to answers
                    answersWithStats.forEach(answer => {
                        const index = sortedByAccuracy.findIndex(a => a.id === answer.id);
                        answer.percentile = Math.round(100 - (index / (sortedByAccuracy.length - 1) * 100));
                    });
                    
                    // Calculate average answer and percent off
                    const sum = answersWithStats.reduce((acc, curr) => acc + curr.answer, 0);
                    const sumPercentOff = answersWithStats.reduce((acc, curr) => acc + curr.percentOff, 0);
                    const avgAnswerValue = sum / answersWithStats.length;
                    const avgPercentOffValue = sumPercentOff / answersWithStats.length;
                    
                    // Format the average answer according to the question's format
                    const formattedAvgAnswer = formatNumber(avgAnswerValue, currentActiveQuestion.format);
                    
                    // Update stats display
                    totalResponses.textContent = answersWithStats.length;
                    avgAnswer.textContent = `${formattedAvgAnswer} ${currentActiveQuestion.unit}`;
                    avgPercentOff.textContent = `${avgPercentOffValue.toFixed(1)}%`;
                    
                    // Add to table
                    answersWithStats.forEach(answer => {
                        const row = responsesTable.insertRow();
                        
                        // User column
                        const userCell = row.insertCell(0);
                        
                        if (answer.userId.startsWith('anonymous_') || answer.userId.startsWith('anon_')) {
                            userCell.textContent = 'Anonymous';
                        } else {
                            userCell.textContent = answer.userId.substring(0, 8) + '...'; // Just show part of the ID
                        }
                        
                        // Answer column
                        const answerCell = row.insertCell(1);
                        answerCell.textContent = `${formatNumber(answer.answer, currentActiveQuestion.format)} ${currentActiveQuestion.unit}`;
                        
                        // Percent off column
                        const percentOffCell = row.insertCell(2);
                        percentOffCell.textContent = `${answer.percentOff.toFixed(1)}%`;
                        
                        // Percentile column
                        const percentileCell = row.insertCell(3);
                        percentileCell.textContent = `${answer.percentile}th`;
                        
                        // Time column
                        const timeCell = row.insertCell(4);
                        timeCell.textContent = new Date(answer.timestamp).toLocaleString();
                    });
                }
                
                // Show the responses section
                responsesSection.style.display = 'block';
            } catch (error) {
                console.error("Error loading responses:", error);
                
                // More descriptive error message
                let errorMessage = "Error loading responses. ";
                
                if (error.message.includes("Permission denied")) {
                    errorMessage += "You don't have permission to access response data. Please check your admin privileges and ensure the Firebase rules allow admin users to read from 'games/drinkle/answers' and 'publicAnswers/drinkle'.";
                } else if (error.code === "PERMISSION_DENIED") {
                    errorMessage += "Permission denied. Please check your admin privileges and ensure the Firebase rules allow admin users to read from 'games/drinkle/answers' and 'publicAnswers/drinkle'.";
                } else {
                    errorMessage += error.message;
                }
                
                // Clear the table and show the error
                responsesTable.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Error: ${errorMessage}</td></tr>`;
                
                // Also update stats display
                totalResponses.textContent = 'Error';
                avgAnswer.textContent = 'Error';
                avgPercentOff.textContent = 'Error';
                
                // Still show the section so the user can see the error
                responsesSection.style.display = 'block';
            }
        });
        
        // Close responses button click
        closeResponsesBtn.addEventListener('click', () => {
            responsesSection.style.display = 'none';
        });
        
        // Export responses as CSV
        exportResponsesBtn.addEventListener('click', () => {
            if (responsesTable.rows.length === 0) {
                alert("No data to export");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            csvContent += "User,Answer,% Off,Percentile,Time\n";
            
            // Add rows
            for (let i = 0; i < responsesTable.rows.length; i++) {
                const row = responsesTable.rows[i];
                const rowData = [];
                
                for (let j = 0; j < row.cells.length; j++) {
                    // Wrap cells in quotes to handle commas
                    rowData.push(`"${row.cells[j].textContent}"`);
                }
                
                csvContent += rowData.join(",") + "\n";
            }
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `drinkle_responses_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            
            // Download
            link.click();
            
            // Cleanup
            document.body.removeChild(link);
        });
        
        // Function to format numbers according to the specified format
        function formatNumber(number, formatType = 'decimal') {
            const num = parseFloat(number);
            
            if (isNaN(num)) return "N/A";
            
            switch(formatType) {
                case 'integer':
                    return new Intl.NumberFormat('en-US', { 
                        style: 'decimal',
                        maximumFractionDigits: 0
                    }).format(num);
                    
                case 'year':
                    return Math.round(num).toString();
                    
                case 'percentage':
                    return new Intl.NumberFormat('en-US', { 
                        style: 'percent', 
                        maximumFractionDigits: 2 
                    }).format(num/100);
                    
                case 'plain':
                    return num.toString();
                    
                case 'decimal':
                default:
                    return new Intl.NumberFormat('en-US', { 
                        style: 'decimal',
                        maximumFractionDigits: 2
                    }).format(num);
            }
        }
        
        // Initialize TinyMCE editor for rich text notes fields
        tinymce.init({
            selector: '#notesInput, #editNotesInput',
            height: 300,
            menubar: false,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | formatselect | ' +
                'bold italic backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | link | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; }',
            setup: function(editor) {
                // Make sure the editor is properly initialized
                editor.on('init', function() {
                    console.log('TinyMCE initialized for:', editor.id);
                });
            }
        });
        
        // Make sure TinyMCE is initialized before trying to use it
        function waitForTinyMCE(editorId, callback, maxAttempts = 10) {
            let attempts = 0;
            
            const checkEditor = () => {
                attempts++;
                const editor = tinymce.get(editorId);
                
                if (editor && editor.initialized) {
                    console.log(`TinyMCE editor ${editorId} is ready after ${attempts} attempts`);
                    callback(editor);
                } else if (attempts < maxAttempts) {
                    console.log(`Waiting for TinyMCE editor ${editorId}... Attempt ${attempts}`);
                    setTimeout(checkEditor, 200);
                } else {
                    console.error(`TinyMCE editor ${editorId} not initialized after ${maxAttempts} attempts`);
                }
            };
            
            checkEditor();
        }
    </script>
</body>
</html> 