<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Evil Trivia - Games Admin</title>
    <script src="/js/components/autoload-banner.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 30px;
            background-color: #FFCC00;
            margin-top: 60px;
        }
        .hidden {
            display: none;
        }
        .section {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 15px;
            background-color: white;
            border-radius: 8px;
            max-width: 800px;
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        .input-row {
            margin: 15px 0;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #000000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #333333;
        }
        input[type="text"], 
        input[type="number"],
        textarea,
        select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-row > div {
            flex: 1;
        }
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .question-list-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .question-list-item:hover {
            background-color: #f9f9f9;
        }
        .question-list-item.active {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .success-message {
            background-color: #dff0d8;
            color: #3c763d;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        .error-message {
            background-color: #f2dede;
            color: #a94442;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        .debug-section {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .debug-result {
            margin-top: 10px;
            padding: 10px;
            background-color: #ddd;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Evil Trivia Games Admin</h1>

    <div id="loginPrompt" class="section">
        <h2>Admin Login</h2>
        <div style="margin-bottom: 10px;">
            <input type="email" id="emailInput" placeholder="Email" />
        </div>
        <div style="margin-bottom: 10px;">
            <input type="password" id="passwordInput" placeholder="Password" />
        </div>
        <button id="btnLogin">Login</button>
        <p id="loginStatus" style="color: red; display: none;"></p>
        
        <div class="debug-section">
            <h3>Troubleshooting</h3>
            <p>If you're having trouble accessing this page despite being logged in:</p>
            <button id="btnCheckRoles">Check My Roles</button>
            <div id="debugResult" class="debug-result" style="display: none;"></div>
        </div>
    </div>

    <div id="adminUI" class="hidden">
        <div class="section">
            <h2>Free Drinkle Administration</h2>
            
            <div class="form-row">
                <div>
                    <h3>Set Active Question</h3>
                    <div class="form-group">
                        <label for="activeQuestionSelect">Choose Active Question:</label>
                        <select id="activeQuestionSelect">
                            <option value="">None (Disable Free Drinkle)</option>
                            <!-- Questions will be populated here -->
                        </select>
                    </div>
                    <button id="saveActiveQuestion">Set Active Question</button>
                    <div id="activeSuccess" class="success-message">Active question updated successfully!</div>
                </div>
                
                <div>
                    <h3>Current Active Question</h3>
                    <div id="currentActiveQuestionInfo">
                        <p>No active question set</p>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0;">
            
            <h3>Create New Question</h3>
            <form id="newQuestionForm">
                <div class="form-group">
                    <label for="titleInput">Title (optional):</label>
                    <input type="text" id="titleInput" placeholder="Enter a title for this question (displayed prominently)">
                </div>
                
                <div class="form-group">
                    <label for="questionInput">Question:</label>
                    <textarea id="questionInput" placeholder="Enter the question" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="answerInput">Correct Answer (number):</label>
                        <input type="number" id="answerInput" placeholder="e.g. 42" step="any" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="unitInput">Unit:</label>
                        <input type="text" id="unitInput" placeholder="e.g. miles, years, etc." required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="formatSelect">Number Format:</label>
                    <select id="formatSelect" required>
                        <option value="decimal">Decimal (e.g., 1,234.56)</option>
                        <option value="integer">Integer (e.g., 1,234)</option>
                        <option value="year">Year (e.g., 1999)</option>
                        <option value="percentage">Percentage (e.g., 75%)</option>
                        <option value="plain">Plain Number (e.g., 1234.56)</option>
                    </select>
                    <p class="helper-text" style="font-size: 12px; color: #666; margin-top: 5px;">
                        Choose how numbers should be displayed on the question page
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="dateInput">Date:</label>
                    <input type="date" id="dateInput" required>
                </div>
                
                <div class="form-group">
                    <label>Custom Result Messages (optional):</label>
                    <p class="helper-text" style="font-size: 12px; color: #666; margin-top: 5px;">
                        Add custom messages for different percentile ranges. Messages will be shown based on the highest threshold the user's percentile reaches.
                    </p>
                    
                    <div id="customMessagesContainer">
                        <div class="custom-message-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 0 0 100px;">
                                <input type="number" class="threshold-input" min="0" max="100" placeholder="Percentile" style="width: 100%;">
                            </div>
                            <div style="flex: 1;">
                                <input type="text" class="message-input" placeholder="Custom message for this percentile or higher" style="width: 100%;">
                            </div>
                            <div>
                                <button type="button" class="remove-message-btn" style="background-color: #d9534f;">âœ•</button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="addMessageBtn" style="margin-top: 10px; background-color: #5cb85c;">+ Add Message</button>
                </div>
                
                <button type="submit">Save Question</button>
                <div id="saveSuccess" class="success-message">Question saved successfully!</div>
                <div id="saveError" class="error-message">Error saving question. Please try again.</div>
            </form>
            
            <hr style="margin: 30px 0;">
            
            <h3>Question History</h3>
            <div class="table-container">
                <table id="questionsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Question</th>
                            <th>Answer</th>
                            <th>Unit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Questions will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
        import { getDatabase, ref, get, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
            authDomain: "eviltrivia-47664.firebaseapp.com",
            databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
            projectId: "eviltrivia-47664",
            storageBucket: "eviltrivia-47664.firebaseapp.com",
            messagingSenderId: "401826818140",
            appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
            measurementId: "G-2W6RK96Y34"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // DOM elements
        const loginPrompt = document.getElementById('loginPrompt');
        const adminUI = document.getElementById('adminUI');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('btnLogin');
        const loginStatus = document.getElementById('loginStatus');
        const checkRolesButton = document.getElementById('btnCheckRoles');
        const debugResult = document.getElementById('debugResult');
        
        const activeQuestionSelect = document.getElementById('activeQuestionSelect');
        const saveActiveButton = document.getElementById('saveActiveQuestion');
        const currentActiveQuestionInfo = document.getElementById('currentActiveQuestionInfo');
        const activeSuccess = document.getElementById('activeSuccess');
        
        const newQuestionForm = document.getElementById('newQuestionForm');
        const titleInput = document.getElementById('titleInput');
        const questionInput = document.getElementById('questionInput');
        const answerInput = document.getElementById('answerInput');
        const unitInput = document.getElementById('unitInput');
        const formatSelect = document.getElementById('formatSelect');
        const dateInput = document.getElementById('dateInput');
        const customMessagesContainer = document.getElementById('customMessagesContainer');
        const addMessageBtn = document.getElementById('addMessageBtn');
        const saveSuccess = document.getElementById('saveSuccess');
        const saveError = document.getElementById('saveError');
        
        const questionsTable = document.getElementById('questionsTable').getElementsByTagName('tbody')[0];
        
        // Set today's date as default
        dateInput.valueAsDate = new Date();
        
        // Add event listener for adding new custom message rows
        addMessageBtn.addEventListener('click', () => {
            addCustomMessageRow();
        });
        
        // Add event delegation for remove buttons
        customMessagesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-message-btn')) {
                e.target.closest('.custom-message-row').remove();
            }
        });
        
        // Function to add a new custom message row
        function addCustomMessageRow(threshold = '', message = '') {
            const row = document.createElement('div');
            row.className = 'custom-message-row';
            row.style = 'display: flex; gap: 10px; margin-bottom: 10px;';
            
            row.innerHTML = `
                <div style="flex: 0 0 100px;">
                    <input type="number" class="threshold-input" min="0" max="100" placeholder="Percentile" style="width: 100%;" value="${threshold}">
                </div>
                <div style="flex: 1;">
                    <input type="text" class="message-input" placeholder="Custom message for this percentile or higher" style="width: 100%;" value="${message}">
                </div>
                <div>
                    <button type="button" class="remove-message-btn" style="background-color: #d9534f;">âœ•</button>
                </div>
            `;
            
            customMessagesContainer.appendChild(row);
        }
        
        // Check auth state (This is the main difference - simpler auth check like in admin.html)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                console.log("User is signed in");
                
                try {
                    // Check if user has admin role
                    const userRef = ref(db, `users/${user.uid}`);
                    const userSnapshot = await get(userRef);
                    const userData = userSnapshot.val();
                    
                    if (!userData) {
                        console.error("No user data found for this user");
                        loginStatus.textContent = "User account exists but no data found. Please contact an administrator.";
                        loginStatus.style.display = "block";
                        return;
                    }
                    
                    // Check roles - both legacy and new format
                    let isAdmin = false;
                    
                    // Check new roles format (array)
                    if (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('admin')) {
                        isAdmin = true;
                    }
                    // Check legacy role format (string)
                    else if (userData.role === 'admin') {
                        isAdmin = true;
                    }
                    
                    if (isAdmin) {
                        // User is admin, show admin UI
                        loginPrompt.classList.add('hidden');
                        adminUI.classList.remove('hidden');
                        
                        // Load questions and active question
                        loadQuestions();
                        loadActiveQuestion();
                    } else {
                        // Not admin, show error
                        loginStatus.textContent = "You need admin privileges to access this page";
                        loginStatus.style.display = "block";
                        loginPrompt.classList.remove('hidden');
                        adminUI.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Error checking user role:", error);
                    loginStatus.textContent = "Error checking permissions: " + error.message;
                    loginStatus.style.display = "block";
                }
            } else {
                // User is signed out
                console.log("User is signed out");
                loginPrompt.classList.remove('hidden');
                adminUI.classList.add('hidden');
            }
            
            // Add one empty custom message row on page load
            addCustomMessageRow();
        });
        
        // Login handler
        loginButton.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!email || !password) {
                loginStatus.textContent = "Please enter email and password";
                loginStatus.style.display = "block";
                return;
            }
            
            try {
                loginStatus.style.display = 'none';
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change listener will handle UI updates
            } catch (error) {
                console.error("Login error:", error);
                loginStatus.textContent = "Login failed: " + error.message;
                loginStatus.style.display = "block";
            }
        });
        
        // Add enter key handler for password field
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                loginButton.click();
            }
        });
        
        // Load questions from Firebase
        function loadQuestions() {
            const questionsRef = ref(db, 'games/drinkle/questions');
            
            onValue(questionsRef, (snapshot) => {
                const questions = snapshot.val() || {};
                
                // Clear the table
                questionsTable.innerHTML = '';
                
                // Clear the select
                while (activeQuestionSelect.options.length > 1) {
                    activeQuestionSelect.remove(1);
                }
                
                // Sort questions by date (newest first)
                const sortedQuestions = Object.entries(questions)
                    .map(([id, question]) => ({...question, id}))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Populate the table and select
                sortedQuestions.forEach(question => {
                    // Add to table
                    const row = questionsTable.insertRow();
                    
                    const dateCell = row.insertCell(0);
                    dateCell.textContent = new Date(question.date).toLocaleDateString();
                    
                    const questionCell = row.insertCell(1);
                    
                    // Show title in the table if available
                    if (question.title) {
                        questionCell.innerHTML = `<strong>${question.title}</strong><br>`;
                    }
                    
                    questionCell.innerHTML += question.question.length > 50 
                        ? question.question.substring(0, 50) + '...' 
                        : question.question;
                    
                    const answerCell = row.insertCell(2);
                    answerCell.textContent = question.answer;
                    
                    const unitCell = row.insertCell(3);
                    unitCell.textContent = question.unit;
                    
                    const actionsCell = row.insertCell(4);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.style.backgroundColor = '#d9534f';
                    deleteBtn.onclick = () => deleteQuestion(question.id);
                    actionsCell.appendChild(deleteBtn);
                    
                    // Add to select
                    const option = document.createElement('option');
                    option.value = question.id;
                    
                    // Include title in option text if available
                    if (question.title) {
                        option.textContent = `${new Date(question.date).toLocaleDateString()} - ${question.title}`;
                    } else {
                        option.textContent = `${new Date(question.date).toLocaleDateString()} - ${
                            question.question.length > 30 
                                ? question.question.substring(0, 30) + '...' 
                                : question.question
                        }`;
                    }
                    
                    activeQuestionSelect.appendChild(option);
                });
            });
        }
        
        // Load active question
        function loadActiveQuestion() {
            const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
            
            onValue(activeQuestionRef, async (snapshot) => {
                const activeQuestionId = snapshot.val();
                
                if (!activeQuestionId) {
                    activeQuestionSelect.value = '';
                    currentActiveQuestionInfo.innerHTML = '<p>No active question set</p>';
                    return;
                }
                
                // Set the select value
                activeQuestionSelect.value = activeQuestionId;
                
                // Get the question details
                const questionRef = ref(db, `games/drinkle/questions/${activeQuestionId}`);
                const questionSnapshot = await get(questionRef);
                const question = questionSnapshot.val();
                
                if (question) {
                    // Show active question details
                    let infoHTML = '';
                    
                    if (question.title) {
                        infoHTML += `<p><strong>Title:</strong> ${question.title}</p>`;
                    }
                    
                    infoHTML += `
                        <p><strong>Question:</strong> ${question.question}</p>
                        <p><strong>Answer:</strong> ${question.answer} ${question.unit}</p>
                        <p><strong>Date:</strong> ${new Date(question.date).toLocaleDateString()}</p>
                    `;
                    
                    // Add format info if available
                    if (question.format) {
                        const formatLabels = {
                            'decimal': 'Decimal (e.g., 1,234.56)',
                            'integer': 'Integer (e.g., 1,234)',
                            'year': 'Year (e.g., 1999)',
                            'percentage': 'Percentage (e.g., 75%)',
                            'plain': 'Plain Number (e.g., 1234.56)'
                        };
                        infoHTML += `<p><strong>Number Format:</strong> ${formatLabels[question.format] || question.format}</p>`;
                    }
                    
                    if (question.customMessages && question.customMessages.length > 0) {
                        infoHTML += `<p><strong>Custom Messages:</strong> ${question.customMessages.length} defined</p>`;
                    }
                    
                    currentActiveQuestionInfo.innerHTML = infoHTML;
                } else {
                    currentActiveQuestionInfo.innerHTML = '<p>Error: Selected question not found</p>';
                }
            });
        }
        
        // Save active question
        saveActiveButton.addEventListener('click', async () => {
            const questionId = activeQuestionSelect.value;
            
            try {
                const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
                await set(activeQuestionRef, questionId);
                
                // Show success message
                activeSuccess.style.display = 'block';
                setTimeout(() => {
                    activeSuccess.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error("Error setting active question:", error);
                alert("Error setting active question. Please try again.");
            }
        });
        
        // Save new question
        newQuestionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = titleInput.value.trim();
            const question = questionInput.value;
            const answer = answerInput.value;
            const unit = unitInput.value;
            const format = formatSelect.value;
            const date = dateInput.value;
            
            if (!question || !answer || !unit || !date) {
                saveError.style.display = 'block';
                setTimeout(() => {
                    saveError.style.display = 'none';
                }, 3000);
                return;
            }
            
            // Collect custom messages
            const customMessages = [];
            const messageRows = customMessagesContainer.querySelectorAll('.custom-message-row');
            
            messageRows.forEach(row => {
                const threshold = parseInt(row.querySelector('.threshold-input').value);
                const message = row.querySelector('.message-input').value.trim();
                
                if (!isNaN(threshold) && threshold >= 0 && threshold <= 100 && message) {
                    customMessages.push({
                        threshold,
                        text: message
                    });
                }
            });
            
            try {
                const questionsRef = ref(db, 'games/drinkle/questions');
                const newQuestionRef = push(questionsRef);
                
                const questionData = {
                    question,
                    answer: parseFloat(answer),
                    unit,
                    date,
                    format,
                    id: newQuestionRef.key
                };
                
                // Add optional fields if they exist
                if (title) {
                    questionData.title = title;
                }
                
                if (customMessages.length > 0) {
                    questionData.customMessages = customMessages;
                }
                
                await set(newQuestionRef, questionData);
                
                // Clear the form
                newQuestionForm.reset();
                dateInput.valueAsDate = new Date();
                customMessagesContainer.innerHTML = '';
                addCustomMessageRow(); // Add one empty row
                
                // Show success message
                saveSuccess.style.display = 'block';
                setTimeout(() => {
                    saveSuccess.style.display = 'none';
                }, 3000);
            } catch (error) {
                console.error("Error saving question:", error);
                saveError.style.display = 'block';
                setTimeout(() => {
                    saveError.style.display = 'none';
                }, 3000);
            }
        });
        
        // Delete question
        async function deleteQuestion(questionId) {
            if (!confirm("Are you sure you want to delete this question?")) {
                return;
            }
            
            try {
                // Check if this is the active question
                const activeQuestionRef = ref(db, 'games/drinkle/activeQuestion');
                const activeQuestionSnapshot = await get(activeQuestionRef);
                const activeQuestionId = activeQuestionSnapshot.val();
                
                if (activeQuestionId === questionId) {
                    if (!confirm("This is the currently active question! Deleting it will disable the Free Drinkle game. Continue?")) {
                        return;
                    }
                    
                    // Clear the active question
                    await set(activeQuestionRef, '');
                }
                
                // Delete the question
                const questionRef = ref(db, `games/drinkle/questions/${questionId}`);
                await remove(questionRef);
                
                // Delete any answers for this question
                const answersRef = ref(db, `games/drinkle/answers/${questionId}`);
                await remove(answersRef);
                
                alert("Question deleted successfully!");
            } catch (error) {
                console.error("Error deleting question:", error);
                alert("Error deleting question. Please try again.");
            }
        }
        
        // Add event listener for the check roles button
        checkRolesButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            debugResult.style.display = 'block';
            
            if (!user) {
                debugResult.textContent = 'You are not logged in. Please log in first.';
                return;
            }
            
            try {
                // Check user data
                const userRef = ref(db, `users/${user.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();
                
                if (!userData) {
                    debugResult.textContent = `You are logged in with email ${user.email}, but no user data found in database.`;
                    return;
                }
                
                // Format user data for display
                let output = `User: ${user.email}\nUID: ${user.uid}\n\n`;
                
                // Check roles
                if (userData.roles && Array.isArray(userData.roles)) {
                    output += `Roles (array): ${userData.roles.join(', ')}\n`;
                } else {
                    output += `Roles (array): Not found\n`;
                }
                
                if (userData.role && typeof userData.role === 'string') {
                    output += `Role (legacy): ${userData.role}\n`;
                } else {
                    output += `Role (legacy): Not found\n`;
                }
                
                // Add other useful data
                output += `\nFull user data:\n${JSON.stringify(userData, null, 2)}`;
                
                debugResult.textContent = output;
            } catch (error) {
                debugResult.textContent = `Error checking roles: ${error.message}\n${error.stack}`;
            }
        });
    </script>
</body>
</html> 