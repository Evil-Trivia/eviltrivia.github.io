<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wedding Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Add rich text editor dependencies -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2rem;
      font-weight: bold;
    }
    
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #333;
    }
    
    #auth-message {
      text-align: center;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #f44336;
    }
    
    .tab-nav {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    
    .tab-nav button {
      background: none;
      border: none;
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-nav button.active {
      color: #000;
      border-bottom-color: #000;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: bold;
      color: #333;
      border-bottom: 2px solid #ddd;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    tr:hover {
      background-color: #f9f9f9;
    }
    
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    input:focus, textarea:focus {
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      outline: none;
    }
    
    textarea {
      min-height: 100px;
      font-family: inherit;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .btn-secondary {
      background-color: #666;
    }
    
    .btn-danger {
      background-color: #f44336;
    }
    
    .btn-success {
      background-color: #4CAF50;
    }
    
    .btn-icon {
      padding: 6px 10px;
      margin-left: 5px;
    }
    
    .status-pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: white;
      background-color: #999;
    }
    
    .status-pill.status-0 {
      background-color: #f44336; /* Not started */
    }
    
    .status-pill.status-solved {
      background-color: #4caf50; /* Solved */
    }
    
    .status-pill.status-inprogress {
      background-color: #2196f3; /* In progress */
    }
    
    .status-pill.status-completed {
      background-color: #9c27b0; /* All completed */
    }
    
    .player-details {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      margin-top: 20px;
      animation: fadeIn 0.5s ease;
    }
    
    .progress-bar {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #4caf50;
      transition: width 0.5s ease;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal.visible {
      opacity: 1;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal.visible .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-close {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .save-indicator {
      font-size: 12px;
      color: #4caf50;
      margin-left: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .save-indicator.show {
      opacity: 1;
    }
    
    .error-indicator {
      color: #f44336;
      font-size: 12px;
      margin-top: 5px;
    }
    
    .path-indicator {
      font-size: 12px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .answer-row {
      background-color: #f8f8f8;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 10px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .answer-row:hover {
      background-color: #f0f0f0;
    }
    
    .remove-answer-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remove-answer-btn:hover {
      background: #ff1744;
    }
    
    .add-answer-btn {
      margin-top: 10px;
      background-color: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-answer-btn:hover {
      background-color: #bdbdbd;
    }
    
    .global-settings {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
    }
    
    .image-gallery {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .image-item {
      position: relative;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      width: calc(50% - 10px);
      box-sizing: border-box;
    }
    
    .image-item input {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .image-item img {
      max-width: 100%;
      max-height: 100px;
      display: block;
      margin: 5px auto;
      border-radius: 4px;
    }
    
    .image-item .image-preview-error {
      color: #f44336;
      font-size: 12px;
      text-align: center;
      padding: 5px;
    }
    
    .add-image-btn {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-image-btn:hover {
      background-color: #bdbdbd;
    }
    
    .remove-image-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remove-image-btn:hover {
      background: #ff1744;
    }
    
    .editor-container {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .ql-editor {
      min-height: 150px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .ql-toolbar.ql-snow {
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
      background-color: #f9f9f9;
    }
    
    .clue-preview {
      margin-top: 10px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }
    
    .preview-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .image-modal.visible {
      opacity: 1;
      display: flex;
    }
    
    .image-modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .image-modal.visible .image-modal-content {
      transform: translateY(0);
    }
    
    @media (max-width: 768px) {
      .tab-nav {
        flex-direction: column;
      }
      
      .tab-nav button {
        width: 100%;
        text-align: left;
        margin-bottom: 5px;
      }
      
      .image-item {
        width: 100%;
      }
      
      .container {
        padding: 10px;
        margin: 10px auto;
      }
      
      .card {
        padding: 15px;
      }
      
      table th, table td {
        padding: 8px;
      }
    }
    
    .puzzle-tab-content {
      display: none;
      padding: 15px 0;
    }
    
    .puzzle-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .puzzle-preview {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .puzzle-preview-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .puzzle-preview-label {
      font-weight: bold;
      min-width: 80px;
    }
    
    .puzzle-preview-thumbnail {
      max-width: 60px;
      max-height: 60px;
      object-fit: contain;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-edit-all {
      background-color: #2196F3;
    }
    
    .btn-edit-all:hover {
      background-color: #0b7dda;
    }
    
    .inline-edit {
      background: transparent;
      border: 1px solid transparent;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }
    
    .inline-edit:hover {
      background-color: rgba(0,0,0,0.05);
      border-color: #ddd;
    }
    
    .inline-edit:focus {
      background-color: white;
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      outline: none;
    }
    
    .edit-section {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    
    .edit-section:hover {
      background: #f5f5f5;
      border-color: #ccc;
    }
    
    .edit-section.editing {
      background: white;
      border-color: #000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .edit-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: block;
      font-size: 14px;
    }
    
    .quick-save-indicator {
      display: inline-block;
      padding: 2px 8px;
      background: #4CAF50;
      color: white;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 8px;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }
    
    .quick-save-indicator.show {
      opacity: 1;
      transform: scale(1);
    }
    
    .puzzle-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .puzzle-card:hover {
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    
    .puzzle-card.editing {
      border-color: #000;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    .puzzle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .puzzle-number {
      font-size: 18px;
      font-weight: bold;
      color: #666;
    }
    
    .puzzle-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
    }
    
    .expandable-section {
      margin-top: 15px;
    }
    
    .section-toggle {
      background: none;
      border: none;
      padding: 8px 0;
      width: 100%;
      text-align: left;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: color 0.3s ease;
    }
    
    .section-toggle:hover {
      color: #000;
    }
    
    .section-toggle::after {
      content: 'â–¼';
      font-size: 12px;
      transition: transform 0.3s ease;
    }
    
    .section-toggle.collapsed::after {
      transform: rotate(-90deg);
    }
    
    .section-content {
      padding: 10px 0;
      overflow: hidden;
      max-height: 1000px;
      transition: all 0.3s ease;
    }
    
    .section-content.collapsed {
      max-height: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wedding Puzzle Admin</h1>
    
    <!-- Auth message for non-admin users -->
    <div id="auth-message" style="display: none;">
      You need to be logged in as an admin to access this page. Please <a href="/admin.html">log in</a> first.
    </div>
    
    <div id="admin-panel" style="display: none;">
      <div class="tab-nav">
        <button id="tab-puzzles" class="active">Puzzles</button>
        <button id="tab-players">Players</button>
      </div>
      
      <div id="puzzles-tab" class="tab-content card active">
        <h2>Wedding Puzzles</h2>
        <p>Edit puzzle names, answers, and clues below. Changes are saved automatically.</p>
        <div id="puzzle-path-indicator" class="path-indicator">
          Saving to: primary database path
        </div>
        
        <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
          <h3>Success Messages</h3>
          <p>Edit the messages that appear when users solve puzzles:</p>
          
          <div class="form-group">
            <label for="puzzle-solved-message">Puzzle Solved Message:</label>
            <input type="text" id="puzzle-solved-message" style="width: 100%;" placeholder="Correct! Moving to Puzzle {nextPuzzle}...">
            <small style="color: #666; display: block; margin-top: 5px;">Use {nextPuzzle} to show the next puzzle number</small>
          </div>
          
          <div class="form-group" style="margin-top: 15px;">
            <label for="last-puzzle-message">Last Puzzle Solved Message:</label>
            <input type="text" id="last-puzzle-message" style="width: 100%;" placeholder="Congratulations! You've solved all the puzzles!">
          </div>
          
          <div class="form-group" style="margin-top: 15px;">
            <label for="all-complete-message">All Puzzles Complete Message:</label>
            <input type="text" id="all-complete-message" style="width: 100%;" placeholder="Amazing work! All puzzles completed!">
          </div>
          
          <button id="save-success-messages" class="btn">Save Success Messages</button>
          <span id="success-messages-save-indicator" class="save-indicator">Messages saved!</span>
        </div>
        
        <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
          <h3>Welcome Back Message</h3>
          <p>Edit the message shown to returning users. Use {{name}} for the user's name.</p>
          <div class="form-group">
            <label for="welcome-back-message">Welcome Back Message:</label>
            <textarea id="welcome-back-message" style="width: 100%; min-height: 80px;" placeholder="Welcome back, {{name}}! You can continue your progress."></textarea>
            <small style="color: #666; display: block; margin-top: 5px;">Use {{name}} as a placeholder for the user's name.</small>
          </div>
          <button id="save-welcome-message" class="btn" style="margin-top: 10px;">Save Welcome Message</button>
          <span id="welcome-save-indicator" class="save-indicator">Message saved!</span>
        </div>
        
        <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
          <h3>Welcome Page Content</h3>
          <p>Edit the content that appears on the very first screen for new players.</p>
          
          <div class="form-group" style="margin-top: 15px;">
            <label for="welcome-page-title">Page Title (Browser Tab):</label>
            <input type="text" id="welcome-page-title" style="width: 100%;" placeholder="Wedding Puzzle">
          </div>

          <div class="form-group" style="margin-top: 15px;">
            <label for="welcome-site-header">Site Header Title (Main H1):</label>
            <input type="text" id="welcome-site-header" style="width: 100%;" placeholder="Wedding Puzzle">
          </div>

          <div class="form-group" style="margin-top: 15px;">
            <label for="welcome-page-heading">Welcome Screen Heading (H2):</label>
            <input type="text" id="welcome-page-heading" style="width: 100%;" placeholder="Welcome to the Wedding Puzzle!">
          </div>
          
          <div class="form-group" style="margin-top: 15px;">
            <label for="welcome-page-intro">Welcome Screen Introductory Paragraph:</label>
            <textarea id="welcome-page-intro" style="width: 100%; min-height: 80px;" placeholder="Please enter your information to get started:"></textarea>
          </div>

          <div class="form-group" style="margin-top: 15px;">
            <label for="welcome-name-label">Name Input Label:</label>
            <input type="text" id="welcome-name-label" style="width: 100%;" placeholder="Your Name:">
          </div>

          <div class="form-group" style="margin-top: 15px;">
            <label for="welcome-email-label">Email Input Label:</label>
            <input type="text" id="welcome-email-label" style="width: 100%;" placeholder="Your Email:">
          </div>

          <div class="form-group" style="margin-top: 15px;">
            <label for="welcome-start-button">Start Button Text:</label>
            <input type="text" id="welcome-start-button" style="width: 100%;" placeholder="Start Puzzle">
          </div>
          
          <button id="save-welcome-page-content" class="btn" style="margin-top: 10px;">Save Welcome Page Content</button>
          <span id="welcome-page-save-indicator" class="save-indicator">Content saved!</span>
        </div>

        <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
          <h3>Ending Page Content</h3>
          <p>Create the rich text content that appears when users complete all puzzles:</p>
          
          <div class="editor-container" style="margin-top: 15px;">
            <div id="ending-page-editor"></div>
          </div>
          
          <div class="clue-preview" style="margin-top: 15px;">
            <div class="preview-title">Preview:</div>
            <div id="ending-page-preview"></div>
        </div>
        
          <button id="save-ending-page" class="btn">Save Ending Page</button>
          <span id="ending-page-save-indicator" class="save-indicator">Ending page saved!</span>
        </div>
        
        <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
          <h3>ðŸ§© Crossword Files</h3>
          <p>Upload and manage CFP crossword files for your puzzles. Files are stored in Firebase Database for reliable access.</p>
          
          <div class="form-group">
            <label for="crossword-file-upload">Upload CFP File:</label>
            <input type="file" id="crossword-file-upload" accept=".cfp,.puz,.jpz,.ipuz" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <button id="upload-crossword-btn" class="btn" disabled>Upload Crossword</button>
            <span id="crossword-upload-status" style="margin-left: 10px; color: #666;"></span>
          </div>
          
          <div class="form-group" style="margin-top: 20px;">
            <h4>Available Crossword Files:</h4>
            <div id="crossword-files-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: white;">
              <div style="text-align: center; color: #666; padding: 20px;">Loading crossword files...</div>
            </div>
            <button id="refresh-crosswords-btn" class="btn btn-secondary" style="margin-top: 10px;">Refresh List</button>
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3>Puzzles</h3>
                <button id="add-puzzle-btn" class="btn">Add New Puzzle</button>
        </div>
        
        <div id="puzzles-container">
          <!-- Puzzle cards will be inserted here -->
        </div>
      </div>
      
      <div id="players-tab" class="tab-content card hidden">
        <h2>Players Progress</h2>
        <p>View and manage players' progress through the wedding puzzle.</p>
        <div id="players-path-indicator" class="path-indicator">
          Loading from: all database paths
        </div>
        
        <table id="players-table">
          <thead>
            <tr>
              <th style="width: 25%;">Name</th>
              <th style="width: 25%;">Email</th>
              <th style="width: 10%;">Progress</th>
              <th style="width: 15%;">Current Screen</th>
              <th style="width: 15%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Player rows will be inserted here -->
          </tbody>
        </table>
        
        <div id="player-details" class="player-details hidden">
          <h3 id="details-name">Player Name</h3>
          <p><strong>Email:</strong> <span id="details-email"></span></p>
          <p><strong>Current Screen:</strong> <span id="details-screen"></span></p>
          <p><strong>Progress:</strong> <span id="details-percentage"></span>%</p>
          <p><strong>Data Path:</strong> <span id="details-path"></span></p>
          
          <div class="progress-bar">
            <div id="details-progress-bar" class="progress-bar-fill" style="width: 0%;"></div>
          </div>
          
          <h4 style="margin-top: 20px;">Puzzle Status</h4>
          <div id="details-puzzle-status"></div>
          
          <div style="margin-top: 20px;">
            <button id="details-email-btn" class="btn btn-secondary">Send Hint Email</button>
            <button id="details-back-btn" class="btn">Back to List</button>
          </div>
        </div>
      </div>
      
      <div id="settings-tab" class="tab-content card hidden" style="display: none;">
        <!-- Settings content will be inserted here -->
      </div>
    </div>
  </div>
  
  <!-- Answer Edit Modal -->
  <div id="answer-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Answers</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div id="answers-container">
        <!-- Answer fields will be added here -->
      </div>
      
      <button id="add-answer-btn" class="add-answer-btn">+ Add Another Answer</button>
      
      <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <div class="form-group">
          <label for="answer-wrong-message">Wrong Answer Message:</label>
          <input type="text" id="answer-wrong-message" placeholder="Message shown when all answers are wrong">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "That's not right. Try again!"</small>
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label for="answer-partial-message">Partial Correct Message:</label>
          <input type="text" id="answer-partial-message" placeholder="Message shown when some answers are correct">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "Some answers are wrong. Keep trying!"</small>
        </div>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-answers-btn" class="btn">Save Answers</button>
      </div>
    </div>
  </div>
  
  <!-- Image Edit Modal -->
  <div id="image-modal" class="image-modal">
    <div class="image-modal-content">
      <div class="modal-header">
        <h3>Edit Images</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div id="images-container" class="image-gallery">
        <!-- Image fields will be added here -->
      </div>
      
      <button id="add-image-btn" class="add-image-btn">+ Add Another Image</button>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-images-btn" class="btn">Save Images</button>
      </div>
    </div>
  </div>
  
  <!-- Rich Text Edit Modal -->
  <div id="richtext-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Clue Content</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div class="editor-container">
        <div id="richtext-editor"></div>
      </div>
      
      <div class="clue-preview">
        <div class="preview-title">Preview:</div>
        <div id="richtext-preview"></div>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-richtext-btn" class="btn">Save Content</button>
      </div>
    </div>
  </div>
  
  <!-- Comprehensive Puzzle Edit Modal -->
  <div id="puzzle-edit-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
      <div class="modal-header">
        <h3>Edit Puzzle <span id="edit-puzzle-number"></span></h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div class="tab-nav" style="margin-top: 15px;">
        <button id="puzzle-tab-basic" class="active">Basic Info</button>
        <button id="puzzle-tab-clue">Clue Content</button>
        <button id="puzzle-tab-images">Images</button>
        <button id="puzzle-tab-answers">Answers</button>
        <button id="puzzle-tab-crossword">Crossword</button>
      </div>
      
      <div id="puzzle-basic-tab" class="puzzle-tab-content active">
        <div class="form-group" style="margin-top: 15px;">
          <label for="edit-puzzle-name">Puzzle Name:</label>
          <input type="text" id="edit-puzzle-name" placeholder="Enter puzzle name">
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label for="edit-wrong-answer-message">Wrong Answer Message:</label>
          <input type="text" id="edit-wrong-answer-message" placeholder="Message shown when all answers are wrong">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "That's not right. Try again!"</small>
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label for="edit-partial-correct-message">Partial Correct Message:</label>
          <input type="text" id="edit-partial-correct-message" placeholder="Message shown when some answers are correct">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "Some answers are wrong. Keep trying!"</small>
        </div>
      </div>
      
      <div id="puzzle-clue-tab" class="puzzle-tab-content hidden">
        <div class="editor-container" style="margin-top: 15px;">
          <div id="edit-puzzle-richtext"></div>
        </div>
        
        <div class="clue-preview" style="margin-top: 15px;">
          <div class="preview-title">Preview:</div>
          <div id="edit-puzzle-preview"></div>
        </div>
      </div>
      
      <div id="puzzle-images-tab" class="puzzle-tab-content hidden">
        <div id="edit-puzzle-images" class="image-gallery" style="margin-top: 15px;">
          <!-- Image fields will be added here -->
        </div>
        
        <button id="edit-puzzle-add-image" class="add-image-btn">+ Add Another Image</button>
      </div>
      
      <div id="puzzle-answers-tab" class="puzzle-tab-content hidden">
        <div id="edit-puzzle-answers" style="margin-top: 15px;">
          <!-- Answer fields will be added here -->
        </div>
        
        <button id="edit-puzzle-add-answer" class="add-answer-btn">+ Add Another Answer</button>
      </div>
      
      <div id="puzzle-crossword-tab" class="puzzle-tab-content hidden">
        <div style="margin-top: 15px;">
          <div class="form-group">
            <label>
              <input type="checkbox" id="enable-crossword-mode" style="width: auto; margin-right: 8px;">
              Enable Crossword Mode
            </label>
            <small style="color: #666; display: block; margin-top: 5px;">
              When enabled, this puzzle will display as an interactive crossword instead of regular clue/answer format
            </small>
          </div>
          
          <div id="crossword-settings" class="hidden" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
            <h4 style="margin-top: 0;">Crossword Settings</h4>
            
            <div class="form-group">
              <label for="crossword-file-url">CFP File URL:</label>
              <input type="text" id="crossword-file-url" placeholder="Enter URL to your .cfp crossword file">
              <small style="color: #666; display: block; margin-top: 5px;">
                Upload your .cfp file to a hosting service or put it in the crossword-solver/puzzles/ directory
              </small>
            </div>
            
            <div class="form-group">
              <label for="crossword-title">Crossword Title (optional):</label>
              <input type="text" id="crossword-title" placeholder="Override the title from the CFP file">
            </div>
            
            <div class="form-group">
              <label for="crossword-completion-trigger">Completion Trigger:</label>
              <select id="crossword-completion-trigger" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="fully-solved">Mark puzzle complete when crossword is fully solved</option>
                <option value="manual">Require manual completion (add Submit button)</option>
                <option value="percentage">Mark complete at percentage threshold</option>
              </select>
            </div>
            
            <div id="completion-percentage-setting" class="form-group hidden">
              <label for="completion-percentage">Completion Percentage:</label>
              <input type="number" id="completion-percentage" min="50" max="100" value="80" style="width: 100px;">
              <span>% of crossword must be completed</span>
            </div>
            
            <div class="crossword-preview" style="margin-top: 15px;">
              <h5>Preview:</h5>
              <div id="crossword-preview-container" style="border: 1px solid #ccc; height: 200px; background: #fff; display: flex; align-items: center; justify-content: center; color: #999;">
                <span>Crossword preview will appear here when a valid CFP file is provided</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-puzzle-btn" class="btn">Save Puzzle</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, set, push, get, remove, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-storage.js";
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
        authDomain: "eviltrivia-47664.firebaseapp.com",
        databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
        projectId: "eviltrivia-47664",
        storageBucket: "eviltrivia-47664.appspot.com",
        messagingSenderId: "401826818140",
        appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
        measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    
    // Firebase database URL
    const DB_URL = "https://eviltrivia-47664-default-rtdb.firebaseio.com";
    
    // Database paths for wedding puzzle data
    const DB_PATHS = {
      primary: 'wedding',
      fallback: 'publicAnswers/wedding'
    };
    
    // DOM Elements
    const authMessage = document.getElementById('auth-message');
    const adminPanel = document.getElementById('admin-panel');
    const tabPuzzles = document.getElementById('tab-puzzles');
    const tabPlayers = document.getElementById('tab-players');
    const puzzlesTab = document.getElementById('puzzles-tab');
    const playersTab = document.getElementById('players-tab');
    
    const puzzlesContainer = document.getElementById('puzzles-container');
    const playersTable = document.getElementById('players-table').querySelector('tbody');
    
    const playerDetails = document.getElementById('player-details');
    const detailsName = document.getElementById('details-name');
    const detailsEmail = document.getElementById('details-email');
    const detailsScreen = document.getElementById('details-screen');
    const detailsPercentage = document.getElementById('details-percentage');
    const detailsProgressBar = document.getElementById('details-progress-bar');
    const detailsPuzzleStatus = document.getElementById('details-puzzle-status');
    const detailsEmailBtn = document.getElementById('details-email-btn');
    const detailsBackBtn = document.getElementById('details-back-btn');
    const detailsPath = document.getElementById('details-path');
    
    const puzzlePathIndicator = document.getElementById('puzzle-path-indicator');
    const playersPathIndicator = document.getElementById('players-path-indicator');
    
    const answerModal = document.getElementById('answer-modal');
    const answersContainer = document.getElementById('answers-container');
    const addAnswerBtn = document.getElementById('add-answer-btn');
    const saveAnswersBtn = document.getElementById('save-answers-btn');
    
    const imageModal = document.getElementById('image-modal');
    const imagesContainer = document.getElementById('images-container');
    const addImageBtn = document.getElementById('add-image-btn');
    const saveImagesBtn = document.getElementById('save-images-btn');
    
    const richtextModal = document.getElementById('richtext-modal');
    const richtextPreview = document.getElementById('richtext-preview');
    const saveRichtextBtn = document.getElementById('save-richtext-btn');
    
    const welcomeBackMessage = document.getElementById('welcome-back-message');
    const saveWelcomeMessage = document.getElementById('save-welcome-message');
    const welcomeSaveIndicator = document.getElementById('welcome-save-indicator');
    
    const welcomePageTitle = document.getElementById('welcome-page-title');
    const welcomeSiteHeader = document.getElementById('welcome-site-header');
    const welcomePageHeading = document.getElementById('welcome-page-heading');
    const welcomePageIntro = document.getElementById('welcome-page-intro');
    const welcomeNameLabel = document.getElementById('welcome-name-label');
    const welcomeEmailLabel = document.getElementById('welcome-email-label');
    const welcomeStartButton = document.getElementById('welcome-start-button');
    const saveWelcomePageContent = document.getElementById('save-welcome-page-content');
    const welcomePageSaveIndicator = document.getElementById('welcome-page-save-indicator');
    
    const puzzleSolvedMessage = document.getElementById('puzzle-solved-message');
    const lastPuzzleMessage = document.getElementById('last-puzzle-message');
    const allCompleteMessage = document.getElementById('all-complete-message');
    const saveSuccessMessages = document.getElementById('save-success-messages');
    const successMessagesSaveIndicator = document.getElementById('success-messages-save-indicator');
    
    const saveEndingPage = document.getElementById('save-ending-page');
    const endingPageSaveIndicator = document.getElementById('ending-page-save-indicator');
    const endingPagePreview = document.getElementById('ending-page-preview');
    
    // Rich text editor
    let quill;
    let endingPageQuill;
    
    // Store timeouts for debounced saves
    const saveTimeouts = {};
    
    // Track successful database paths
    let successfulPuzzlePath = null;
    let successfulPlayersPath = null;
    
    // Store current items being edited
    let currentPuzzleBeingEdited = null;
    let currentAnswers = [];
    let currentImages = [];
    let currentClueHtml = '';
    
    // Check if user is logged in and has admin privileges
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("User logged in with UID:", user.uid);
            
            // Check admin status
            const userRef = ref(db, `users/${user.uid}`);
            get(userRef).then((snapshot) => {
                const userData = snapshot.val() || {};
                
                if (userData.role === 'admin') {
                    console.log("Admin access granted via user role");
                    // User is admin, show admin panel
                    authMessage.style.display = 'none';
                    adminPanel.style.display = 'block';
                    
                    // Initialize admin functionality
                    initializeAdmin();
                    
                } else {
                    console.log("User is not an admin");
                    // Not admin, show message
                    authMessage.style.display = 'block';
                    authMessage.innerHTML = 'You do not have admin privileges to access this page.';
                    adminPanel.style.display = 'none';
                }
            }).catch((error) => {
                console.error("Error checking admin status:", error);
                authMessage.style.display = 'block';
                authMessage.innerHTML = `Error checking admin status: ${error.message}`;
                adminPanel.style.display = 'none';
            });
        } else {
            // Not logged in, show message
            authMessage.style.display = 'block';
            authMessage.innerHTML = 'You need to be logged in as an admin to access this page. Please <a href="/admin.html">log in</a> first.';
            adminPanel.style.display = 'none';
        }
    });
    
    // Initialize admin functionality - called after authentication
    function initializeAdmin() {
        // Initialize rich text editor for clues
        quill = new Quill('#richtext-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });
        
        // Update preview when editor content changes
        quill.on('text-change', function() {
            richtextPreview.innerHTML = quill.root.innerHTML;
        });
        
        // Initialize rich text editor for ending page
        endingPageQuill = new Quill('#ending-page-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });
        
        // Update preview when ending page editor content changes
        endingPageQuill.on('text-change', function() {
            endingPagePreview.innerHTML = endingPageQuill.root.innerHTML;
        });
        
        // Load all tabs' data
        loadPuzzles();
        loadPlayers();
        loadWelcomeBackMessage();
        loadSuccessMessages();
        loadEndingPageContent();
        loadWelcomePageContentAdmin();
        initializeCrosswordFileManagement();
        
        // Set up tab switching
        tabPuzzles.addEventListener('click', () => {
            tabPuzzles.classList.add('active');
            tabPlayers.classList.remove('active');
            puzzlesTab.classList.add('active');
            playersTab.classList.remove('active');
            playerDetails.classList.add('hidden');
        });
        
        tabPlayers.addEventListener('click', () => {
            tabPuzzles.classList.remove('active');
            tabPlayers.classList.add('active');
            puzzlesTab.classList.remove('active');
            playersTab.classList.add('active');
        });
        
        // Set up back button
        detailsBackBtn.addEventListener('click', () => {
            document.querySelector('#players-table').parentNode.style.display = 'block';
            playerDetails.classList.add('hidden');
        });
        
        // Set up modal closing
        document.querySelectorAll('.modal-close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                closeAllModals();
            });
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === answerModal) {
                closeModal(answerModal);
            }
            if (e.target === imageModal) {
                closeModal(imageModal);
            }
            if (e.target === richtextModal) {
                closeModal(richtextModal);
            }
            if (e.target === document.getElementById('puzzle-edit-modal')) {
                closeModal(document.getElementById('puzzle-edit-modal'));
            }
        });
        
        // Add answer button
        addAnswerBtn.addEventListener('click', () => {
            addAnswerField({ text: '', questionText: '' });
        });
        
        // Add image button
        addImageBtn.addEventListener('click', () => {
            addImageField({ url: '' });
        });
        
        // Save buttons
        saveAnswersBtn.addEventListener('click', () => {
            saveAnswers();
        });
        
        saveImagesBtn.addEventListener('click', () => {
            saveImages();
        });
        
        saveRichtextBtn.addEventListener('click', () => {
            saveRichtext();
        });
        
        // Add puzzle button
        document.getElementById('add-puzzle-btn').addEventListener('click', () => {
            addNewPuzzleDirectly();
        });
        
        // Welcome back message save button
        saveWelcomeMessage.addEventListener('click', () => {
            saveWelcomeBackMessageData();
        });
        
        saveWelcomePageContent.addEventListener('click', () => {
            saveWelcomePageContentAdmin();
        });
        
        // Success messages save button
        saveSuccessMessages.addEventListener('click', () => {
          saveSuccessMessagesData();
        });
        
        // Ending page save button
        saveEndingPage.addEventListener('click', () => {
          saveEndingPageData();
        });
    }
    
    // Load welcome back message
    async function loadWelcomeBackMessage() {
        try {
            const result = await fetchFromPaths(Object.values(DB_PATHS), 'welcomeBackMessage');
            
            if (result.data) {
                welcomeBackMessage.value = result.data;
            } else {
                // Default message
                welcomeBackMessage.value = "Welcome back! You can continue your puzzle progress.";
            }
        } catch (error) {
            console.error('Error loading welcome back message:', error);
        }
    }
    
    // Save welcome back message
    async function saveWelcomeBackMessageData() {
        try {
            const message = welcomeBackMessage.value.trim();
            
            if (!message) {
                showFeedback('Please enter a welcome back message.', 'error');
                return;
            }
            
            // Save to database
            const result = await saveToDatabase(
                Object.values(DB_PATHS),
                'welcomeBackMessage',
                message,
                'PUT'
            );
            
            if (result.success) {
                // Show save indicator
                welcomeSaveIndicator.classList.add('show');
                setTimeout(() => {
                    welcomeSaveIndicator.classList.remove('show');
                }, 2000);
                
                showSuccessToast('Welcome back message saved!');
            } else {
                showFeedback('Error saving welcome back message. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Error saving welcome back message:', error);
            showFeedback('Error saving welcome back message: ' + error.message, 'error');
        }
    }
    
    // Load welcome page content for admin page
    async function loadWelcomePageContentAdmin() {
      try {
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'welcomePage');
        const defaults = {
          title: 'Wedding Puzzle',
          siteHeader: 'Wedding Puzzle',
          heading: 'Welcome to the Wedding Puzzle!',
          intro: 'Please enter your information to get started:',
          nameLabel: 'Your Name:',
          emailLabel: 'Your Email:',
          startButton: 'Start Puzzle'
        };

        if (result.data) {
          welcomePageTitle.value = result.data.title || defaults.title;
          welcomeSiteHeader.value = result.data.siteHeader || defaults.siteHeader;
          welcomePageHeading.value = result.data.heading || defaults.heading;
          welcomePageIntro.value = result.data.intro || defaults.intro;
          welcomeNameLabel.value = result.data.nameLabel || defaults.nameLabel;
          welcomeEmailLabel.value = result.data.emailLabel || defaults.emailLabel;
          welcomeStartButton.value = result.data.startButton || defaults.startButton;
        } else {
          welcomePageTitle.value = defaults.title;
          welcomeSiteHeader.value = defaults.siteHeader;
          welcomePageHeading.value = defaults.heading;
          welcomePageIntro.value = defaults.intro;
          welcomeNameLabel.value = defaults.nameLabel;
          welcomeEmailLabel.value = defaults.emailLabel;
          welcomeStartButton.value = defaults.startButton;
        }
      } catch (error) {
        console.error('Error loading welcome page content for admin:', error);
      }
    }

    // Save welcome page content from admin page
    async function saveWelcomePageContentAdmin() {
      try {
        const content = {
          title: welcomePageTitle.value.trim(),
          siteHeader: welcomeSiteHeader.value.trim(),
          heading: welcomePageHeading.value.trim(),
          intro: welcomePageIntro.value.trim(),
          nameLabel: welcomeNameLabel.value.trim(),
          emailLabel: welcomeEmailLabel.value.trim(),
          startButton: welcomeStartButton.value.trim()
        };

        if (!content.title || !content.siteHeader || !content.heading || !content.intro || !content.nameLabel || !content.emailLabel || !content.startButton) {
          showFeedback('Please fill in all welcome page content fields.', 'error');
          return;
        }

        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          'welcomePage',
          content,
          'PUT'
        );

        if (result.success) {
          welcomePageSaveIndicator.classList.add('show');
          setTimeout(() => {
            welcomePageSaveIndicator.classList.remove('show');
          }, 2000);
          showSuccessToast('Welcome page content saved!');
        } else {
          showFeedback('Error saving welcome page content. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error saving welcome page content:', error);
        showFeedback('Error saving welcome page content: ' + error.message, 'error');
      }
    }
    
    // Try fetching data from multiple paths
    async function fetchFromPaths(paths, endpoint) {
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`);
          if (response.ok) {
            const data = await response.json();
            return { data, path };
          }
        } catch (error) {
          console.error(`Error fetching from ${path}/${endpoint}:`, error);
        }
      }
      return { data: null, path: null };
    }
    
    // Save data to the database with fallback paths
    async function saveToDatabase(paths, endpoint, data, method = 'PATCH') {
      // Try using previously successful path first
      if (successfulPuzzlePath) {
        try {
          const response = await fetch(`${DB_URL}/${successfulPuzzlePath}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            return { success: true, path: successfulPuzzlePath };
          }
        } catch (error) {
          console.error(`Error saving to ${successfulPuzzlePath}/${endpoint}:`, error);
        }
      }
      
      // Try each path in sequence
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            successfulPuzzlePath = path;
            return { success: true, path };
          }
        } catch (error) {
          console.error(`Error saving to ${path}/${endpoint}:`, error);
        }
      }
      
      return { success: false, path: null };
    }
    
    // Load puzzles data
    async function loadPuzzles() {
      try {
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'answers');
        
        // Set successful path even if data is null
        if (result.path) {
          successfulPuzzlePath = result.path;
          puzzlePathIndicator.textContent = `Saving to: ${successfulPuzzlePath}`;
        }
        
        // Clear container first
        puzzlesContainer.innerHTML = '';
        
        // Initialize data structure
        const puzzlesData = result.data || {};
        
        // For numbered entries (1-10), order by number
        let keys = Object.keys(puzzlesData)
          .filter(key => !isNaN(parseInt(key)) && parseInt(key) > 0) // Exclude puzzle 0
          .map(key => parseInt(key))
          .sort((a, b) => a - b);
        
        // If no keys/puzzles found, initialize with defaults 1-10
        if (keys.length === 0) {
          const defaultPuzzleCount = 10;
          // Create default puzzles
          const defaultPuzzles = {};
          for (let i = 1; i <= defaultPuzzleCount; i++) {
            defaultPuzzles[i] = {
              name: `Puzzle #${i}`,
              clue: '',
              clueHtml: '',
              imageUrls: [],
              answers: [{ text: '', questionText: 'Your Answer:' }]
            };
          }
          
          // Save defaults to database
          if (successfulPuzzlePath) {
            try {
              await fetch(`${DB_URL}/${successfulPuzzlePath}/answers.json`, {
                method: 'PATCH',
                body: JSON.stringify(defaultPuzzles)
              });
            } catch (error) {
              console.error('Error initializing default puzzles:', error);
            }
          }
          
          // Update local data
          keys = Array.from({ length: defaultPuzzleCount }, (_, i) => i + 1);
          Object.assign(puzzlesData, defaultPuzzles);
        }
        
        // Add cards for each puzzle
        keys.forEach(puzzleNum => {
          const puzzleData = puzzlesData[puzzleNum] || { 
            clue: '',
            clueHtml: '',
            imageUrls: [],
            answers: [{ text: '', questionText: 'Your Answer:' }],
            name: `Puzzle #${puzzleNum}`
          };
          
          // Migrate old format to new format if needed
          if (puzzleData && puzzleData.answer && !puzzleData.answers) {
            puzzleData.answers = [{
              text: puzzleData.answer,
              questionText: 'Your Answer:'
            }];
            delete puzzleData.answer;
          }
          
          // Convert single imageUrl to imageUrls array if needed
          if (puzzleData.imageUrl && !puzzleData.imageUrls) {
            puzzleData.imageUrls = puzzleData.imageUrl ? [puzzleData.imageUrl] : [];
          }
          
          // Create puzzle card
          const card = document.createElement('div');
          card.className = 'puzzle-card';
          card.dataset.puzzleNumber = puzzleNum;
          
          // Card header
          const header = document.createElement('div');
          header.className = 'puzzle-header';
          
          const numberDiv = document.createElement('div');
          numberDiv.className = 'puzzle-number';
          numberDiv.textContent = `Puzzle ${puzzleNum}`;
          
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'puzzle-actions';
          
          const editAllBtn = document.createElement('button');
          editAllBtn.className = 'btn btn-sm btn-edit-all';
          editAllBtn.textContent = 'Edit All';
          editAllBtn.style.marginRight = '10px';
          editAllBtn.addEventListener('click', () => {
            openPuzzleEditModal(puzzleNum, puzzleData);
          });
          
          const reorderBtn = document.createElement('button');
          reorderBtn.className = 'btn btn-sm btn-secondary';
          reorderBtn.textContent = 'Reorder';
          reorderBtn.addEventListener('click', () => {
            const newNumber = prompt(`Enter new position for Puzzle ${puzzleNum}:`, puzzleNum);
            if (newNumber && !isNaN(parseInt(newNumber))) {
              reorderPuzzle(puzzleNum, parseInt(newNumber));
            }
          });
          
          actionsDiv.appendChild(editAllBtn);
          actionsDiv.appendChild(reorderBtn);
          header.appendChild(numberDiv);
          header.appendChild(actionsDiv);
          card.appendChild(header);
          
          // Puzzle name section
          const nameSection = document.createElement('div');
          nameSection.className = 'edit-section';
          
          const nameLabel = document.createElement('label');
          nameLabel.className = 'edit-label';
          nameLabel.textContent = 'Puzzle Name';
          
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.className = 'inline-edit';
          nameInput.value = puzzleData.name || `Puzzle #${puzzleNum}`;
          nameInput.placeholder = 'Enter puzzle name';
          
          const nameSaveIndicator = document.createElement('span');
          nameSaveIndicator.className = 'quick-save-indicator';
          nameSaveIndicator.textContent = 'Saved!';
          
          nameInput.addEventListener('input', debounce(() => {
            savePuzzleField(puzzleNum, 'name', nameInput.value, nameSaveIndicator);
          }, 1000));
          
          nameInput.addEventListener('focus', () => nameSection.classList.add('editing'));
          nameInput.addEventListener('blur', () => nameSection.classList.remove('editing'));
          
          nameSection.appendChild(nameLabel);
          nameSection.appendChild(nameInput);
          nameSection.appendChild(nameSaveIndicator);
          card.appendChild(nameSection);
          
          // Clue section
          const clueSection = document.createElement('div');
          clueSection.className = 'expandable-section';
          
          const clueToggle = document.createElement('button');
          clueToggle.className = 'section-toggle collapsed';
          clueToggle.textContent = 'Clue Content';
          
          const clueContent = document.createElement('div');
          clueContent.className = 'section-content collapsed';
          
          const clueEditSection = document.createElement('div');
          clueEditSection.className = 'edit-section';
          
          const cluePreview = document.createElement('div');
          cluePreview.style.padding = '10px';
          cluePreview.style.border = '1px solid #e0e0e0';
          cluePreview.style.borderRadius = '4px';
          cluePreview.style.backgroundColor = '#f9f9f9';
          cluePreview.style.minHeight = '40px';
          cluePreview.style.marginBottom = '10px';
          
          if (puzzleData.clueHtml) {
            cluePreview.innerHTML = puzzleData.clueHtml;
          } else if (puzzleData.clue) {
            cluePreview.textContent = puzzleData.clue;
          } else {
            cluePreview.innerHTML = '<em style="color: #999;">No clue content</em>';
          }
          
          const editClueBtn = document.createElement('button');
          editClueBtn.className = 'btn btn-sm';
          editClueBtn.textContent = 'Edit Rich Content';
          editClueBtn.addEventListener('click', () => {
            openRichtextModal(puzzleNum, puzzleData.clueHtml || puzzleData.clue || '');
          });
          
          clueEditSection.appendChild(cluePreview);
          clueEditSection.appendChild(editClueBtn);
          clueContent.appendChild(clueEditSection);
          
          clueToggle.addEventListener('click', () => {
            clueToggle.classList.toggle('collapsed');
            clueContent.classList.toggle('collapsed');
          });
          
          clueSection.appendChild(clueToggle);
          clueSection.appendChild(clueContent);
          card.appendChild(clueSection);
          
          // Images section
          const imagesSection = document.createElement('div');
          imagesSection.className = 'expandable-section';
          
          const imagesToggle = document.createElement('button');
          imagesToggle.className = 'section-toggle collapsed';
          imagesToggle.textContent = `Images (${puzzleData.imageUrls ? puzzleData.imageUrls.length : 0})`;
          
          const imagesContent = document.createElement('div');
          imagesContent.className = 'section-content collapsed';
          
          const imagesEditSection = document.createElement('div');
          imagesEditSection.className = 'edit-section';
          
          const imagesPreview = document.createElement('div');
          imagesPreview.style.display = 'flex';
          imagesPreview.style.gap = '8px';
          imagesPreview.style.flexWrap = 'wrap';
          imagesPreview.style.marginBottom = '10px';
          
          if (puzzleData.imageUrls && puzzleData.imageUrls.length > 0) {
            puzzleData.imageUrls.slice(0, 3).forEach(url => {
              const img = document.createElement('img');
              img.src = url;
              img.style.width = '60px';
              img.style.height = '60px';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '4px';
              img.style.border = '1px solid #ddd';
              imagesPreview.appendChild(img);
            });
            
            if (puzzleData.imageUrls.length > 3) {
              const moreIndicator = document.createElement('div');
              moreIndicator.style.display = 'flex';
              moreIndicator.style.alignItems = 'center';
              moreIndicator.style.justifyContent = 'center';
              moreIndicator.style.width = '60px';
              moreIndicator.style.height = '60px';
              moreIndicator.style.backgroundColor = '#f0f0f0';
              moreIndicator.style.borderRadius = '4px';
              moreIndicator.style.fontSize = '12px';
              moreIndicator.style.color = '#666';
              moreIndicator.textContent = `+${puzzleData.imageUrls.length - 3}`;
              imagesPreview.appendChild(moreIndicator);
            }
          } else {
            const noImages = document.createElement('em');
            noImages.style.color = '#999';
            noImages.textContent = 'No images';
            imagesPreview.appendChild(noImages);
          }
          
          const editImagesBtn = document.createElement('button');
          editImagesBtn.className = 'btn btn-sm';
          editImagesBtn.textContent = 'Edit Images';
          editImagesBtn.addEventListener('click', () => {
            openImageModal(puzzleNum, puzzleData.imageUrls || []);
          });
          
          imagesEditSection.appendChild(imagesPreview);
          imagesEditSection.appendChild(editImagesBtn);
          imagesContent.appendChild(imagesEditSection);
          
          imagesToggle.addEventListener('click', () => {
            imagesToggle.classList.toggle('collapsed');
            imagesContent.classList.toggle('collapsed');
          });
          
          imagesSection.appendChild(imagesToggle);
          imagesSection.appendChild(imagesContent);
          card.appendChild(imagesSection);
          
          // Answers section
          const answersSection = document.createElement('div');
          answersSection.className = 'expandable-section';
          
          const answersToggle = document.createElement('button');
          answersToggle.className = 'section-toggle collapsed';
          answersToggle.textContent = `Answers (${puzzleData.answers ? puzzleData.answers.length : 0})`;
          
          const answersContent = document.createElement('div');
          answersContent.className = 'section-content collapsed';
          
          const answersEditSection = document.createElement('div');
          answersEditSection.className = 'edit-section';
          
          const answersPreview = document.createElement('div');
          
          if (puzzleData.answers && puzzleData.answers.length > 0) {
            const answersList = document.createElement('ul');
            answersList.style.margin = '0 0 10px 0';
            answersList.style.paddingLeft = '20px';
            
            puzzleData.answers.forEach(answer => {
              const li = document.createElement('li');
              li.innerHTML = `<strong>${answer.questionText || 'Answer'}:</strong> ${answer.text || '<em style="color: #999;">(empty)</em>'}`;
              answersList.appendChild(li);
            });
            
            answersPreview.appendChild(answersList);
          } else {
            const noAnswers = document.createElement('em');
            noAnswers.style.color = '#999';
            noAnswers.textContent = 'No answers defined';
            noAnswers.style.marginBottom = '10px';
            noAnswers.style.display = 'block';
            answersPreview.appendChild(noAnswers);
          }
          
          const editAnswersBtn = document.createElement('button');
          editAnswersBtn.className = 'btn btn-sm';
          editAnswersBtn.textContent = 'Edit Answers';
          editAnswersBtn.addEventListener('click', () => {
            openAnswersModal(puzzleNum, puzzleData.answers || []);
          });
          
          answersEditSection.appendChild(answersPreview);
          answersEditSection.appendChild(editAnswersBtn);
          answersContent.appendChild(answersEditSection);
          
          answersToggle.addEventListener('click', () => {
            answersToggle.classList.toggle('collapsed');
            answersContent.classList.toggle('collapsed');
          });
          
          answersSection.appendChild(answersToggle);
          answersSection.appendChild(answersContent);
          card.appendChild(answersSection);
          
          // Error Messages section
          const messagesSection = document.createElement('div');
          messagesSection.className = 'expandable-section';
          
          const messagesToggle = document.createElement('button');
          messagesToggle.className = 'section-toggle collapsed';
          messagesToggle.textContent = 'Error Messages';
          
          const messagesContent = document.createElement('div');
          messagesContent.className = 'section-content collapsed';
          
          // Wrong answer message
          const wrongMessageSection = document.createElement('div');
          wrongMessageSection.className = 'edit-section';
          
          const wrongLabel = document.createElement('label');
          wrongLabel.className = 'edit-label';
          wrongLabel.textContent = 'Wrong Answer Message';
          
          const wrongInput = document.createElement('input');
          wrongInput.type = 'text';
          wrongInput.className = 'inline-edit';
          wrongInput.value = puzzleData.wrongAnswerMessage || "That's not right. Try again!";
          wrongInput.placeholder = 'Message when all answers are wrong';
          
          const wrongSaveIndicator = document.createElement('span');
          wrongSaveIndicator.className = 'quick-save-indicator';
          wrongSaveIndicator.textContent = 'Saved!';
          
          wrongInput.addEventListener('input', debounce(() => {
            savePuzzleField(puzzleNum, 'wrongAnswerMessage', wrongInput.value, wrongSaveIndicator);
          }, 1000));
          
          wrongInput.addEventListener('focus', () => wrongMessageSection.classList.add('editing'));
          wrongInput.addEventListener('blur', () => wrongMessageSection.classList.remove('editing'));
          
          wrongMessageSection.appendChild(wrongLabel);
          wrongMessageSection.appendChild(wrongInput);
          wrongMessageSection.appendChild(wrongSaveIndicator);
          
          // Partial correct message
          const partialMessageSection = document.createElement('div');
          partialMessageSection.className = 'edit-section';
          
          const partialLabel = document.createElement('label');
          partialLabel.className = 'edit-label';
          partialLabel.textContent = 'Partial Correct Message';
          
          const partialInput = document.createElement('input');
          partialInput.type = 'text';
          partialInput.className = 'inline-edit';
          partialInput.value = puzzleData.partialCorrectMessage || "Some answers are wrong. Keep trying!";
          partialInput.placeholder = 'Message when some answers are correct';
          
          const partialSaveIndicator = document.createElement('span');
          partialSaveIndicator.className = 'quick-save-indicator';
          partialSaveIndicator.textContent = 'Saved!';
          
          partialInput.addEventListener('input', debounce(() => {
            savePuzzleField(puzzleNum, 'partialCorrectMessage', partialInput.value, partialSaveIndicator);
          }, 1000));
          
          partialInput.addEventListener('focus', () => partialMessageSection.classList.add('editing'));
          partialInput.addEventListener('blur', () => partialMessageSection.classList.remove('editing'));
          
          partialMessageSection.appendChild(partialLabel);
          partialMessageSection.appendChild(partialInput);
          partialMessageSection.appendChild(partialSaveIndicator);
          
          messagesContent.appendChild(wrongMessageSection);
          messagesContent.appendChild(partialMessageSection);
          
          messagesToggle.addEventListener('click', () => {
            messagesToggle.classList.toggle('collapsed');
            messagesContent.classList.toggle('collapsed');
          });
          
          messagesSection.appendChild(messagesToggle);
          messagesSection.appendChild(messagesContent);
          card.appendChild(messagesSection);
          
          // Add card to container
          puzzlesContainer.appendChild(card);
        });
        
        if (keys.length === 0) {
          puzzlesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No puzzle data found. Add some puzzles to get started.</div>';
        }
      } catch (error) {
        console.error('Error loading puzzles:', error);
        puzzlesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44;">Error loading puzzles. Please try refreshing the page.</div>';
      }
    }
    
    // Reorder a puzzle by changing its number
    async function reorderPuzzle(oldNumber, newNumber) {
      try {
        if (oldNumber === newNumber) return; // No change needed
        
        // Fetch all puzzle data
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'answers');
        if (!result.data) return;
        
        const puzzlesData = result.data;
        
        // Check if new number is already taken
        if (puzzlesData[newNumber]) {
          // If destination exists, we need to perform a swap operation
          const oldData = { ...puzzlesData[oldNumber] };
          const newData = { ...puzzlesData[newNumber] };
          
          // Update both puzzles
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${oldNumber}`,
            newData,
            'PUT'
          );
          
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${newNumber}`,
            oldData,
            'PUT'
          );
        } else {
          // Simple move operation - copy to new position and delete old
          const puzzleData = { ...puzzlesData[oldNumber] };
          
          // Save at new position
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${newNumber}`,
            puzzleData,
            'PUT'
          );
          
          // Delete from old position
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${oldNumber}`,
            null,
            'PUT'
          );
        }
        
        // Reload puzzles to reflect changes
        await loadPuzzles();
        showSuccessToast('Puzzle reordered successfully!');
      } catch (error) {
        console.error('Error reordering puzzle:', error);
        showFeedback('Error reordering puzzle. Please try again.', 'error');
      }
    }
    
    // Load players data
    async function loadPlayers() {
      try {
        // Try to load from all paths
        const paths = Object.values(DB_PATHS);
        const allPlayers = {};
        
        for (const path of paths) {
          try {
            const response = await fetch(`${DB_URL}/${path}/progress.json`);
            if (response.ok) {
              const data = await response.json();
              
              if (data) {
                Object.keys(data).forEach(userId => {
                  // Add source path to each player record
                  const playerData = data[userId];
                  playerData.sourcePath = path;
                  playerData.userId = userId;
                  
                  // Use userId as the key to avoid duplicates
                  allPlayers[userId] = playerData;
                });
              }
            }
          } catch (error) {
            console.error(`Error fetching players from ${path}:`, error);
          }
        }
        
        // Update players table
        playersTable.innerHTML = '';
        
        if (Object.keys(allPlayers).length === 0) {
          playersTable.innerHTML = '<tr><td colspan="5">No players found yet.</td></tr>';
          return;
        }
        
        // Sort players by most recent first
        const sortedPlayers = Object.values(allPlayers).sort((a, b) => {
          return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
        });
        
        sortedPlayers.forEach(player => {
          const row = document.createElement('tr');
          
          // Name cell
          const nameCell = document.createElement('td');
          nameCell.textContent = player.name || 'Anonymous';
          row.appendChild(nameCell);
          
          // Email cell
          const emailCell = document.createElement('td');
          emailCell.textContent = player.email || 'Not provided';
          row.appendChild(emailCell);
          
          // Progress cell
          const progressCell = document.createElement('td');
          let progressPercentage = 0;
          let statusClass = 'status-0';
          
          if (player.solved && Array.isArray(player.solved)) {
            const solvedCount = player.solved.filter(Boolean).length;
            progressPercentage = Math.round((solvedCount / 10) * 100);
            
            if (progressPercentage === 100) {
              statusClass = 'status-completed';
            } else if (progressPercentage > 0) {
              statusClass = 'status-inprogress';
            }
          }
          
          const statusPill = document.createElement('span');
          statusPill.className = `status-pill ${statusClass}`;
          statusPill.textContent = `${progressPercentage}%`;
          progressCell.appendChild(statusPill);
          row.appendChild(progressCell);
          
          // Current screen cell
          const screenCell = document.createElement('td');
          screenCell.textContent = player.currentScreen || '0';
          row.appendChild(screenCell);
          
          // Actions cell
          const actionsCell = document.createElement('td');
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn btn-icon';
          viewBtn.textContent = 'View';
          viewBtn.addEventListener('click', () => {
            showPlayerDetails(player);
          });
          actionsCell.appendChild(viewBtn);
          row.appendChild(actionsCell);
          
          // Add row to table
          playersTable.appendChild(row);
        });
        
      } catch (error) {
        console.error('Error loading players:', error);
        playersTable.innerHTML = '<tr><td colspan="5">Error loading players. Please try refreshing the page.</td></tr>';
      }
    }
    
    // Show player details
    function showPlayerDetails(player) {
      // Hide the players table parent
      document.querySelector('#players-table').parentNode.style.display = 'none';
      
      // Show details
      playerDetails.classList.remove('hidden');
      
      // Fill in details
      detailsName.textContent = player.name || 'Anonymous';
      detailsEmail.textContent = player.email || 'Not provided';
      detailsScreen.textContent = player.currentScreen || '0';
      detailsPath.textContent = player.sourcePath || 'Unknown';
      
      // Calculate progress percentage
      let progressPercentage = 0;
      if (player.solved && Array.isArray(player.solved)) {
        const solvedCount = player.solved.filter(Boolean).length;
        progressPercentage = Math.round((solvedCount / 10) * 100);
      }
      
      detailsPercentage.textContent = progressPercentage;
      detailsProgressBar.style.width = `${progressPercentage}%`;
      
      // Create puzzle status list
      detailsPuzzleStatus.innerHTML = '';
      if (player.solved && Array.isArray(player.solved)) {
        for (let i = 1; i <= 10; i++) {
          const isSolved = player.solved[i-1] || false;
          
          const statusItem = document.createElement('div');
          statusItem.style.margin = '5px 0';
          
          const statusCircle = document.createElement('span');
          statusCircle.style.display = 'inline-block';
          statusCircle.style.width = '12px';
          statusCircle.style.height = '12px';
          statusCircle.style.borderRadius = '50%';
          statusCircle.style.marginRight = '8px';
          statusCircle.style.backgroundColor = isSolved ? '#4caf50' : '#f44336';
          
          statusItem.appendChild(statusCircle);
          statusItem.appendChild(document.createTextNode(`Puzzle ${i}: ${isSolved ? 'Solved' : 'Not Solved'}`));
          
          detailsPuzzleStatus.appendChild(statusItem);
        }
      } else {
        detailsPuzzleStatus.textContent = 'No puzzle status data available.';
      }
      
      // Set up email button
      detailsEmailBtn.onclick = () => {
        const subject = encodeURIComponent('Wedding Puzzle Hint');
        const body = encodeURIComponent(`Hi ${player.name || 'there'},\n\nHere's a hint for the wedding puzzle you're working on:\n\n[Add your hint here]\n\nBest of luck!\n`);
        window.open(`mailto:${player.email}?subject=${subject}&body=${body}`);
      };
    }
    
    // Save a puzzle field
    async function savePuzzleField(puzzleNum, field, value, saveIndicator) {
      try {
        const data = {};
        data[field] = value;
        
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${puzzleNum}`,
          data
        );
        
        if (result.success && saveIndicator) {
          // Show save indicator
          saveIndicator.classList.add('show');
          setTimeout(() => {
            saveIndicator.classList.remove('show');
          }, 2000);
        } else if (!result.success) {
          console.error(`Failed to save ${field} for puzzle ${puzzleNum}`);
        }
      } catch (error) {
        console.error(`Error saving puzzle field:`, error);
      }
    }
    
    // Open the answers modal
    function openAnswersModal(puzzleNum, answers) {
      currentPuzzleBeingEdited = puzzleNum;
      currentAnswers = [...(answers || [])];
      
      // Clear the container
      answersContainer.innerHTML = '';
      
      // Add fields for each answer
      if (currentAnswers && currentAnswers.length > 0) {
        currentAnswers.forEach(answer => {
          addAnswerField(answer || { text: '', questionText: '' });
        });
      } else {
        // Add at least one empty answer field
        addAnswerField({ text: '', questionText: '' });
      }
      
      // Fetch the current puzzle to get wrong answer messages
      fetch(`${DB_URL}/${successfulPuzzlePath || DB_PATHS.primary}/answers/${puzzleNum}.json`)
        .then(response => response.json())
        .then(puzzleData => {
          // Set wrong answer messages if available
          document.getElementById('answer-wrong-message').value = 
            puzzleData?.wrongAnswerMessage || "That's not right. Try again!";
          document.getElementById('answer-partial-message').value = 
            puzzleData?.partialCorrectMessage || "Some answers are wrong. Keep trying!";
        })
        .catch(error => {
          console.error('Error fetching puzzle data:', error);
          // Use defaults if fetch fails
          document.getElementById('answer-wrong-message').value = "That's not right. Try again!";
          document.getElementById('answer-partial-message').value = "Some answers are wrong. Keep trying!";
        });
      
      // Show the modal
      openModal(answerModal);
    }
    
    // Open the images modal
    function openImageModal(puzzleNum, imageUrls) {
      currentPuzzleBeingEdited = puzzleNum;
      currentImages = [...(imageUrls || [])];
      
      // Clear the container
      imagesContainer.innerHTML = '';
      
      // Add fields for each image
      if (currentImages && currentImages.length > 0) {
        currentImages.forEach(url => {
          addImageField({ url });
        });
      } else {
        // Add at least one empty image field
        addImageField({ url: '' });
      }
      
      // Show the modal
      openModal(imageModal);
    }
    
    // Open the richtext modal
    function openRichtextModal(puzzleNum, content) {
      currentPuzzleBeingEdited = puzzleNum;
      
      // Set editor content
      quill.root.innerHTML = content;
      
      // Update preview
      richtextPreview.innerHTML = content;
      
      // Show the modal
      openModal(richtextModal);
    }
    
    // Close all modals
    function closeAllModals() {
      closeModal(answerModal);
      closeModal(imageModal);
      closeModal(richtextModal);
    }
    
    // Close a specific modal
    function closeModal(modal) {
      modal.classList.remove('visible');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    // Open a specific modal
    function openModal(modal) {
      modal.style.display = 'flex';
      setTimeout(() => {
        modal.classList.add('visible');
      }, 10);
    }
    
    // Add an answer field to the modal
    function addAnswerField(answer = {}) {
      const answerRow = document.createElement('div');
      answerRow.className = 'answer-row';
      
      // Answer text field
      const answerTextGroup = document.createElement('div');
      answerTextGroup.className = 'form-group';
      
      const answerTextLabel = document.createElement('label');
      answerTextLabel.textContent = 'Answer Text:';
      
      const answerTextInput = document.createElement('input');
      answerTextInput.type = 'text';
      answerTextInput.className = 'answer-text';
      answerTextInput.value = (answer && answer.text) || '';
      answerTextInput.placeholder = 'Correct answer text';
      
      answerTextGroup.appendChild(answerTextLabel);
      answerTextGroup.appendChild(answerTextInput);
      
      // Question text field
      const questionTextGroup = document.createElement('div');
      questionTextGroup.className = 'form-group';
      questionTextGroup.style.marginTop = '10px';
      
      const questionTextLabel = document.createElement('label');
      questionTextLabel.textContent = 'Question Text:';
      
      const questionTextInput = document.createElement('input');
      questionTextInput.type = 'text';
      questionTextInput.className = 'question-text';
      questionTextInput.value = (answer && answer.questionText) || 'Your Answer:';
      questionTextInput.placeholder = 'Label for the answer field (e.g., "Your Answer:")';
      
      questionTextGroup.appendChild(questionTextLabel);
      questionTextGroup.appendChild(questionTextInput);
      
      // Alternate spellings field
      const alternateSpellingsGroup = document.createElement('div');
      alternateSpellingsGroup.className = 'form-group';
      alternateSpellingsGroup.style.marginTop = '10px';
      
      const alternateSpellingsLabel = document.createElement('label');
      alternateSpellingsLabel.textContent = 'Alternate Spellings (comma-separated):';
      
      const alternateSpellingsInput = document.createElement('input');
      alternateSpellingsInput.type = 'text';
      alternateSpellingsInput.className = 'alternate-spellings';
      
      // Convert array to comma-separated string for display
      if (answer && answer.alternateSpellings && Array.isArray(answer.alternateSpellings)) {
        alternateSpellingsInput.value = answer.alternateSpellings.join(', ');
      } else {
        alternateSpellingsInput.value = '';
      }
      
      alternateSpellingsInput.placeholder = 'e.g., "new york, newyork, ny" (automatically handles case and spaces)';
      
      const helpText = document.createElement('small');
      helpText.style.color = '#666';
      helpText.style.display = 'block';
      helpText.style.marginTop = '5px';
      helpText.textContent = 'System automatically accepts case variations and space differences. Add other spellings here.';
      
      alternateSpellingsGroup.appendChild(alternateSpellingsLabel);
      alternateSpellingsGroup.appendChild(alternateSpellingsInput);
      alternateSpellingsGroup.appendChild(helpText);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-answer-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this answer';
      removeBtn.addEventListener('click', function() {
        answerRow.style.opacity = '0';
        setTimeout(() => {
          answerRow.remove();
        }, 300);
      });
      
      // Add everything to the row
      answerRow.appendChild(removeBtn);
      answerRow.appendChild(answerTextGroup);
      answerRow.appendChild(questionTextGroup);
      answerRow.appendChild(alternateSpellingsGroup);
      
      // Add row to container
      answersContainer.appendChild(answerRow);
      
      // Focus the new field
      answerTextInput.focus();
    }
    
    // Add an image field to the modal
    function addImageField(image = {}) {
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';
      
      // Image URL field
      const urlLabel = document.createElement('label');
      urlLabel.textContent = 'Image URL:';
      
      const urlInput = document.createElement('input');
      urlInput.type = 'text';
      urlInput.className = 'image-url';
      urlInput.value = (image && image.url) || '';
      urlInput.placeholder = 'Enter image URL here';
      
      // Preview section
      const preview = document.createElement('div');
      preview.className = 'image-preview';
      
      // Check if URL is valid and show preview
      const updatePreview = () => {
        const url = urlInput.value.trim();
        
        // Clear existing content
        preview.innerHTML = '';
        
        if (url) {
          // Try to load image
          const img = document.createElement('img');
          const errorMsg = document.createElement('div');
          errorMsg.className = 'image-preview-error';
          errorMsg.textContent = 'Could not load image';
          
          img.onload = () => {
            // Image loaded successfully
            preview.innerHTML = '';
            preview.appendChild(img);
          };
          
          img.onerror = () => {
            // Image failed to load
            preview.innerHTML = '';
            preview.appendChild(errorMsg);
          };
          
          img.src = url;
        }
      };
      
      // Update preview on input
      urlInput.addEventListener('input', debounce(updatePreview, 500));
      
      // Initial preview
      setTimeout(updatePreview, 100);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-image-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this image';
      removeBtn.addEventListener('click', function() {
        imageItem.style.opacity = '0';
        setTimeout(() => {
          imageItem.remove();
        }, 300);
      });
      
      // Add everything to the item
      imageItem.appendChild(removeBtn);
      imageItem.appendChild(urlLabel);
      imageItem.appendChild(urlInput);
      imageItem.appendChild(preview);
      
      // Add item to container
      imagesContainer.appendChild(imageItem);
      
      // Focus the new field
      urlInput.focus();
    }
    
    // Save answers from the modal
    async function saveAnswers() {
      try {
        // Collect answers from all fields
        const answerRows = answersContainer.querySelectorAll('.answer-row');
        const answers = [];
        
        answerRows.forEach(row => {
          try {
            const answerText = row.querySelector('.answer-text')?.value?.trim() || '';
            const questionText = row.querySelector('.question-text')?.value?.trim() || '';
            const alternateSpellingsText = row.querySelector('.alternate-spellings')?.value?.trim() || '';
            
            if (answerText) {  // Only add if there's an answer text
              const answerObj = {
                text: answerText,
                questionText: questionText || 'Your Answer:'
              };
              
              // Parse alternate spellings
              if (alternateSpellingsText) {
                answerObj.alternateSpellings = alternateSpellingsText
                  .split(',')
                  .map(s => s.trim())
                  .filter(s => s.length > 0);
              }
              
              answers.push(answerObj);
            }
          } catch (err) {
            console.warn('Error processing answer row:', err);
          }
        });
        
        // Make sure we have at least one answer
        if (answers.length === 0) {
          answers.push({
            text: '',
            questionText: 'Your Answer:'
          });
        }
        
        // Get wrong answer messages
        const wrongAnswerMessage = document.getElementById('answer-wrong-message').value.trim();
        const partialCorrectMessage = document.getElementById('answer-partial-message').value.trim();
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          { 
            answers,
            wrongAnswerMessage,
            partialCorrectMessage
          }
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(answerModal);
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Answers saved successfully!');
        } else {
          alert('Error saving answers. Please try again.');
        }
      } catch (error) {
        console.error('Error saving answers:', error);
        alert('Error saving answers. Please try again: ' + error.message);
      }
    }
    
    // Save images from the modal
    async function saveImages() {
      try {
        // Collect image URLs from all fields
        const imageItems = imagesContainer.querySelectorAll('.image-item');
        const imageUrls = [];
        
        imageItems.forEach(item => {
          try {
            const url = item.querySelector('.image-url')?.value?.trim() || '';
            
            if (url) {  // Only add if there's a URL
              imageUrls.push(url);
            }
          } catch (err) {
            console.warn('Error processing image item:', err);
          }
        });
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          { imageUrls }
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(imageModal);
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Images saved successfully!');
        } else {
          alert('Error saving images. Please try again.');
        }
      } catch (error) {
        console.error('Error saving images:', error);
        alert('Error saving images. Please try again: ' + error.message);
      }
    }
    
    // Save richtext content
    async function saveRichtext() {
      try {
        // Get content from editor
        const content = quill.root.innerHTML;
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          { 
            clueHtml: content,
            clue: quill.getText() // Also save plain text version
          }
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(richtextModal);
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Clue content saved successfully!');
        } else {
          alert('Error saving clue content. Please try again.');
        }
      } catch (error) {
        console.error('Error saving clue content:', error);
        alert('Error saving clue content. Please try again: ' + error.message);
      }
    }
    
    // Show a success toast message
    function showSuccessToast(message) {
      const tempMsg = document.createElement('div');
      tempMsg.style.position = 'fixed';
      tempMsg.style.bottom = '20px';
      tempMsg.style.right = '20px';
      tempMsg.style.padding = '10px 20px';
      tempMsg.style.backgroundColor = '#4caf50';
      tempMsg.style.color = 'white';
      tempMsg.style.borderRadius = '4px';
      tempMsg.style.zIndex = '9999';
      tempMsg.textContent = message;
      document.body.appendChild(tempMsg);
      
      setTimeout(() => {
        tempMsg.style.opacity = '0';
        tempMsg.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 500);
      }, 2000);
    }
    
    // Show a feedback toast message
    function showFeedback(message, type) {
      const tempMsg = document.createElement('div');
      tempMsg.style.position = 'fixed';
      tempMsg.style.bottom = '20px';
      tempMsg.style.right = '20px';
      tempMsg.style.padding = '15px 25px';
      tempMsg.style.backgroundColor = type === 'success' ? '#4caf50' : '#f44336';
      tempMsg.style.color = 'white';
      tempMsg.style.borderRadius = '8px';
      tempMsg.style.zIndex = '9999';
      tempMsg.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      tempMsg.style.fontWeight = '500';
      tempMsg.textContent = message;
      document.body.appendChild(tempMsg);
      
      setTimeout(() => {
        tempMsg.style.opacity = '0';
        tempMsg.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 500);
      }, 3000);
    }
    
    // Helper function to format date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      
      try {
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return timestamp;
      }
    }
    
    // Helper for HTML escaping
    function escapeHTML(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Debounce function to limit how often a function is called
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
    
    // Add a new puzzle directly to the table without the form
    async function addNewPuzzleDirectly() {
      try {
        // Get the highest puzzle number currently in use
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'answers');
        const puzzlesData = result.data || {};
        
        const puzzleNumbers = Object.keys(puzzlesData)
          .filter(key => !isNaN(parseInt(key)))
          .map(key => parseInt(key));
        
        // Find the next available number
        const nextNumber = puzzleNumbers.length > 0 ? Math.max(...puzzleNumbers) + 1 : 1;
        
        // Create a default puzzle
        const newPuzzle = {
          name: `Puzzle #${nextNumber}`,
          clue: '',
          imageUrls: [],
          answers: [{ text: '', questionText: 'Your Answer:' }]
        };
        
        // Add to database
        const saveResult = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${nextNumber}`,
          newPuzzle,
          'PUT'
        );
        
        if (saveResult.success) {
          // Update total puzzles count if needed
          const totalPuzzleCount = puzzleNumbers.length + 1;
          await saveToDatabase(
            Object.values(DB_PATHS),
            'totalPuzzles',
            totalPuzzleCount,
            'PUT'
          );
          
          // Reload puzzles to show the new one
          await loadPuzzles();
          showSuccessToast('New puzzle added successfully!');
          
          // Scroll to the bottom of the table to show the new puzzle
          const table = document.getElementById('puzzles-table');
          table.scrollIntoView({ behavior: 'smooth', block: 'end' });
        } else {
          showFeedback('Error adding new puzzle. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error adding new puzzle:', error);
        showFeedback('Error adding new puzzle: ' + error.message, 'error');
      }
    }
    
    // Open comprehensive puzzle edit modal
    function openPuzzleEditModal(puzzleNum, puzzleData) {
      currentPuzzleBeingEdited = puzzleNum;
      
      // Set the puzzle number in the header
      document.getElementById('edit-puzzle-number').textContent = puzzleNum;
      
      // Set up tabs
      document.getElementById('puzzle-tab-basic').classList.add('active');
      document.getElementById('puzzle-tab-clue').classList.remove('active');
      document.getElementById('puzzle-tab-images').classList.remove('active');
      document.getElementById('puzzle-tab-answers').classList.remove('active');
      
      document.getElementById('puzzle-basic-tab').classList.add('active');
      document.getElementById('puzzle-clue-tab').classList.remove('active');
      document.getElementById('puzzle-images-tab').classList.remove('active');
      document.getElementById('puzzle-answers-tab').classList.remove('active');
      
      // Basic info
      document.getElementById('edit-puzzle-name').value = puzzleData.name || `Puzzle #${puzzleNum}`;
      document.getElementById('edit-wrong-answer-message').value = puzzleData.wrongAnswerMessage || "That's not right. Try again!";
      document.getElementById('edit-partial-correct-message').value = puzzleData.partialCorrectMessage || "Some answers are wrong. Keep trying!";
      
      // Set up rich text editor if not already initialized
      let editQuill = Quill.find(document.getElementById('edit-puzzle-richtext'));
      if (!editQuill) {
        editQuill = new Quill('#edit-puzzle-richtext', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline', 'strike'],
              ['blockquote', 'code-block'],
              [{ 'header': 1 }, { 'header': 2 }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'align': [] }],
              ['link', 'image'],
              ['clean']
            ]
          }
        });
        
        // Update preview when editor content changes
        editQuill.on('text-change', function() {
          document.getElementById('edit-puzzle-preview').innerHTML = editQuill.root.innerHTML;
        });
      }
      
      // Set clue content
      editQuill.root.innerHTML = puzzleData.clueHtml || puzzleData.clue || '';
      document.getElementById('edit-puzzle-preview').innerHTML = editQuill.root.innerHTML;
      
      // Set up images
      const imagesContainer = document.getElementById('edit-puzzle-images');
      imagesContainer.innerHTML = '';
      
      // Add fields for each image
      if (puzzleData.imageUrls && puzzleData.imageUrls.length > 0) {
        puzzleData.imageUrls.forEach(url => {
          addImageFieldToEditModal(url);
        });
      } else {
        // Add at least one empty image field
        addImageFieldToEditModal('');
      }
      
      // Set up answers
      const answersContainer = document.getElementById('edit-puzzle-answers');
      answersContainer.innerHTML = '';
      
      // Add fields for each answer
      if (puzzleData.answers && puzzleData.answers.length > 0) {
        puzzleData.answers.forEach(answer => {
          addAnswerFieldToEditModal(answer);
        });
      } else {
        // Add at least one empty answer field
        addAnswerFieldToEditModal({ text: '', questionText: 'Your Answer:' });
      }
      
      // Set up crossword data
      const crosswordData = puzzleData.crossword || {};
      document.getElementById('enable-crossword-mode').checked = crosswordData.enabled || false;
      document.getElementById('crossword-file-url').value = crosswordData.fileUrl || '';
      document.getElementById('crossword-title').value = crosswordData.title || '';
      document.getElementById('crossword-completion-trigger').value = crosswordData.completionTrigger || 'fully-solved';
      document.getElementById('completion-percentage').value = crosswordData.completionPercentage || 80;
      
      // Show/hide crossword settings based on enabled state
      const crosswordSettings = document.getElementById('crossword-settings');
      const completionPercentageSetting = document.getElementById('completion-percentage-setting');
      
      if (crosswordData.enabled) {
        crosswordSettings.classList.remove('hidden');
      } else {
        crosswordSettings.classList.add('hidden');
      }
      
      if (crosswordData.completionTrigger === 'percentage') {
        completionPercentageSetting.classList.remove('hidden');
      } else {
        completionPercentageSetting.classList.add('hidden');
      }
      
      // Update crossword tab in modal header
      document.getElementById('puzzle-tab-crossword').classList.remove('active');
      document.getElementById('puzzle-crossword-tab').classList.remove('active');
      
      // Set up tab switching
      document.getElementById('puzzle-tab-basic').addEventListener('click', function() {
        switchPuzzleTab('basic');
      });
      
      document.getElementById('puzzle-tab-clue').addEventListener('click', function() {
        switchPuzzleTab('clue');
      });
      
      document.getElementById('puzzle-tab-images').addEventListener('click', function() {
        switchPuzzleTab('images');
      });
      
      document.getElementById('puzzle-tab-answers').addEventListener('click', function() {
        switchPuzzleTab('answers');
      });
      
      document.getElementById('puzzle-tab-crossword').addEventListener('click', function() {
        switchPuzzleTab('crossword');
      });
      
      // Set up crossword functionality
      setupCrosswordFunctionality();
      
      // Set up add buttons
      document.getElementById('edit-puzzle-add-image').addEventListener('click', function() {
        addImageFieldToEditModal('');
      });
      
      document.getElementById('edit-puzzle-add-answer').addEventListener('click', function() {
        addAnswerFieldToEditModal({ text: '', questionText: 'Your Answer:' });
      });
      
      // Set up save button
      document.getElementById('save-puzzle-btn').addEventListener('click', function() {
        savePuzzleFromEditModal();
      });
      
      // Show the modal
      openModal(document.getElementById('puzzle-edit-modal'));
    }
    
    // Switch between tabs in the puzzle edit modal
    function switchPuzzleTab(tab) {
      // Remove active class from all tabs
      document.getElementById('puzzle-tab-basic').classList.remove('active');
      document.getElementById('puzzle-tab-clue').classList.remove('active');
      document.getElementById('puzzle-tab-images').classList.remove('active');
      document.getElementById('puzzle-tab-answers').classList.remove('active');
      document.getElementById('puzzle-tab-crossword').classList.remove('active');
      
      document.getElementById('puzzle-basic-tab').classList.remove('active');
      document.getElementById('puzzle-clue-tab').classList.remove('active');
      document.getElementById('puzzle-images-tab').classList.remove('active');
      document.getElementById('puzzle-answers-tab').classList.remove('active');
      document.getElementById('puzzle-crossword-tab').classList.remove('active');
      
      // Add active class to selected tab
      document.getElementById(`puzzle-tab-${tab}`).classList.add('active');
      document.getElementById(`puzzle-${tab}-tab`).classList.add('active');
    }
    
    // Add an image field to the edit modal
    function addImageFieldToEditModal(url) {
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';
      
      // Image URL field
      const urlLabel = document.createElement('label');
      urlLabel.textContent = 'Image URL:';
      
      const urlInput = document.createElement('input');
      urlInput.type = 'text';
      urlInput.className = 'edit-image-url';
      urlInput.value = url || '';
      urlInput.placeholder = 'Enter image URL here';
      
      // Preview section
      const preview = document.createElement('div');
      preview.className = 'image-preview';
      
      // Update preview on input
      urlInput.addEventListener('input', debounce(() => {
        const url = urlInput.value.trim();
        
        // Clear existing content
        preview.innerHTML = '';
        
        if (url) {
          // Try to load image
          const img = document.createElement('img');
          const errorMsg = document.createElement('div');
          errorMsg.className = 'image-preview-error';
          errorMsg.textContent = 'Could not load image';
          
          img.onload = () => {
            preview.innerHTML = '';
            preview.appendChild(img);
          };
          
          img.onerror = () => {
            preview.innerHTML = '';
            preview.appendChild(errorMsg);
          };
          
          img.src = url;
        }
      }, 500));
      
      // Initial preview
      setTimeout(() => {
        const url = urlInput.value.trim();
        if (url) {
          const img = document.createElement('img');
          img.src = url;
          preview.appendChild(img);
        }
      }, 100);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-image-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this image';
      removeBtn.addEventListener('click', function() {
        imageItem.style.opacity = '0';
        setTimeout(() => {
          imageItem.remove();
        }, 300);
      });
      
      // Add everything to the item
      imageItem.appendChild(removeBtn);
      imageItem.appendChild(urlLabel);
      imageItem.appendChild(urlInput);
      imageItem.appendChild(preview);
      
      // Add item to container
      document.getElementById('edit-puzzle-images').appendChild(imageItem);
    }
    
    // Add an answer field to the edit modal
    function addAnswerFieldToEditModal(answer) {
      const answerRow = document.createElement('div');
      answerRow.className = 'answer-row';
      
      // Answer text field
      const answerTextGroup = document.createElement('div');
      answerTextGroup.className = 'form-group';
      
      const answerTextLabel = document.createElement('label');
      answerTextLabel.textContent = 'Answer Text:';
      
      const answerTextInput = document.createElement('input');
      answerTextInput.type = 'text';
      answerTextInput.className = 'edit-answer-text';
      answerTextInput.value = (answer && answer.text) || '';
      answerTextInput.placeholder = 'Correct answer text';
      
      answerTextGroup.appendChild(answerTextLabel);
      answerTextGroup.appendChild(answerTextInput);
      
      // Question text field
      const questionTextGroup = document.createElement('div');
      questionTextGroup.className = 'form-group';
      questionTextGroup.style.marginTop = '10px';
      
      const questionTextLabel = document.createElement('label');
      questionTextLabel.textContent = 'Question Text:';
      
      const questionTextInput = document.createElement('input');
      questionTextInput.type = 'text';
      questionTextInput.className = 'edit-question-text';
      questionTextInput.value = (answer && answer.questionText) || 'Your Answer:';
      questionTextInput.placeholder = 'Label for the answer field (e.g., "Your Answer:")';
      
      questionTextGroup.appendChild(questionTextLabel);
      questionTextGroup.appendChild(questionTextInput);
      
      // Alternate spellings field for edit modal
      const alternateSpellingsGroup = document.createElement('div');
      alternateSpellingsGroup.className = 'form-group';
      alternateSpellingsGroup.style.marginTop = '10px';
      
      const alternateSpellingsLabel = document.createElement('label');
      alternateSpellingsLabel.textContent = 'Alternate Spellings (comma-separated):';
      
      const alternateSpellingsInput = document.createElement('input');
      alternateSpellingsInput.type = 'text';
      alternateSpellingsInput.className = 'edit-alternate-spellings';
      
      // Convert array to comma-separated string for display
      if (answer && answer.alternateSpellings && Array.isArray(answer.alternateSpellings)) {
        alternateSpellingsInput.value = answer.alternateSpellings.join(', ');
      } else {
        alternateSpellingsInput.value = '';
      }
      
      alternateSpellingsInput.placeholder = 'e.g., "new york, newyork, ny" (automatically handles case and spaces)';
      
      const helpText = document.createElement('small');
      helpText.style.color = '#666';
      helpText.style.display = 'block';
      helpText.style.marginTop = '5px';
      helpText.textContent = 'System automatically accepts case variations and space differences. Add other spellings here.';
      
      alternateSpellingsGroup.appendChild(alternateSpellingsLabel);
      alternateSpellingsGroup.appendChild(alternateSpellingsInput);
      alternateSpellingsGroup.appendChild(helpText);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-answer-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this answer';
      removeBtn.addEventListener('click', function() {
        answerRow.style.opacity = '0';
        setTimeout(() => {
          answerRow.remove();
        }, 300);
      });
      
      // Add everything to the row
      answerRow.appendChild(removeBtn);
      answerRow.appendChild(answerTextGroup);
      answerRow.appendChild(questionTextGroup);
      answerRow.appendChild(alternateSpellingsGroup);
      
      // Add row to container
      document.getElementById('edit-puzzle-answers').appendChild(answerRow);
    }
    
    // Save puzzle from edit modal
    async function savePuzzleFromEditModal() {
      try {
        // Get all the data from the modal
        const name = document.getElementById('edit-puzzle-name').value.trim() || `Puzzle #${currentPuzzleBeingEdited}`;
        const wrongAnswerMessage = document.getElementById('edit-wrong-answer-message').value.trim();
        const partialCorrectMessage = document.getElementById('edit-partial-correct-message').value.trim();
        
        // Get clue content
        const editQuill = Quill.find(document.getElementById('edit-puzzle-richtext'));
        const clueHtml = editQuill.root.innerHTML;
        const clue = editQuill.getText().trim();
        
        // Get image URLs
        const imageItems = document.getElementById('edit-puzzle-images').querySelectorAll('.image-item');
        const imageUrls = [];
        
        imageItems.forEach(item => {
          const url = item.querySelector('.edit-image-url')?.value?.trim() || '';
          if (url) {
            imageUrls.push(url);
          }
        });
        
        // Get answers
        const answerRows = document.getElementById('edit-puzzle-answers').querySelectorAll('.answer-row');
        const answers = [];
        
        answerRows.forEach(row => {
          const answerText = row.querySelector('.edit-answer-text')?.value?.trim() || '';
          const questionText = row.querySelector('.edit-question-text')?.value?.trim() || 'Your Answer:';
          const alternateSpellingsText = row.querySelector('.edit-alternate-spellings')?.value?.trim() || '';
          
          if (answerText) {
            const answerObj = {
              text: answerText,
              questionText: questionText
            };
            
            // Parse alternate spellings
            if (alternateSpellingsText) {
              answerObj.alternateSpellings = alternateSpellingsText
                .split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);
            }
            
            answers.push(answerObj);
          }
        });
        
        // Make sure we have at least one answer
        if (answers.length === 0) {
          answers.push({
            text: '',
            questionText: 'Your Answer:'
          });
        }
        
        // Get crossword data
        const enableCrossword = document.getElementById('enable-crossword-mode').checked;
        const crosswordData = {};
        
        if (enableCrossword) {
          crosswordData.enabled = true;
          crosswordData.fileUrl = document.getElementById('crossword-file-url').value.trim();
          crosswordData.title = document.getElementById('crossword-title').value.trim();
          crosswordData.completionTrigger = document.getElementById('crossword-completion-trigger').value;
          
          if (crosswordData.completionTrigger === 'percentage') {
            crosswordData.completionPercentage = parseInt(document.getElementById('completion-percentage').value) || 80;
          }
        } else {
          crosswordData.enabled = false;
        }
        
        // Create complete puzzle data
        const puzzleData = {
          name,
          clueHtml,
          clue,
          imageUrls,
          answers,
          wrongAnswerMessage,
          partialCorrectMessage,
          crossword: crosswordData
        };
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          puzzleData,
          'PUT'
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(document.getElementById('puzzle-edit-modal'));
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Puzzle saved successfully!');
        } else {
          alert('Error saving puzzle. Please try again.');
        }
      } catch (error) {
        console.error('Error saving puzzle:', error);
        alert('Error saving puzzle. Please try again: ' + error.message);
      }
    }
    
    // Load success messages
    async function loadSuccessMessages() {
      try {
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'successMessages');
        
        if (result.data) {
          puzzleSolvedMessage.value = result.data.puzzleSolved || 'Correct! Moving to Puzzle {nextPuzzle}...';
          lastPuzzleMessage.value = result.data.lastPuzzle || 'Congratulations! You\'ve solved all the puzzles!';
          allCompleteMessage.value = result.data.allComplete || 'Amazing work! All puzzles completed!';
        } else {
          // Default messages
          puzzleSolvedMessage.value = 'Correct! Moving to Puzzle {nextPuzzle}...';
          lastPuzzleMessage.value = 'Congratulations! You\'ve solved all the puzzles!';
          allCompleteMessage.value = 'Amazing work! All puzzles completed!';
        }
      } catch (error) {
        console.error('Error loading success messages:', error);
      }
    }
    
    // Save success messages
    async function saveSuccessMessagesData() {
      try {
        const messages = {
          puzzleSolved: puzzleSolvedMessage.value.trim(),
          lastPuzzle: lastPuzzleMessage.value.trim(),
          allComplete: allCompleteMessage.value.trim()
        };
        
        if (!messages.puzzleSolved || !messages.lastPuzzle || !messages.allComplete) {
          showFeedback('Please fill in all success message fields.', 'error');
          return;
        }
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          'successMessages',
          messages,
          'PUT'
        );
        
        if (result.success) {
          // Show save indicator
          successMessagesSaveIndicator.classList.add('show');
          setTimeout(() => {
            successMessagesSaveIndicator.classList.remove('show');
          }, 2000);
          
          showSuccessToast('Success messages saved!');
        } else {
          showFeedback('Error saving success messages. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error saving success messages:', error);
        showFeedback('Error saving success messages: ' + error.message, 'error');
      }
    }
    
    // Load ending page content
    async function loadEndingPageContent() {
      try {
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'endingPageContent');
        
        if (result.data && typeof result.data === 'string') {
          endingPageQuill.root.innerHTML = result.data;
          endingPagePreview.innerHTML = result.data;
        } else {
          // Default ending page content
          const defaultContent = '<h1>Congratulations!</h1><p>You have successfully completed all the puzzles. Well done!</p>';
          endingPageQuill.root.innerHTML = defaultContent;
          endingPagePreview.innerHTML = defaultContent;
        }
      } catch (error) {
        console.error('Error loading ending page content:', error);
      }
    }
    
    // Save ending page content
    async function saveEndingPageData() {
      try {
        const content = endingPageQuill.root.innerHTML;
        
        if (!content || content.trim() === '<p><br></p>') {
          showFeedback('Please enter some ending page content.', 'error');
          return;
        }
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          'endingPageContent',
          content,
          'PUT'
        );
        
        if (result.success) {
          // Show save indicator
          endingPageSaveIndicator.classList.add('show');
          setTimeout(() => {
            endingPageSaveIndicator.classList.remove('show');
          }, 2000);
          
          showSuccessToast('Ending page content saved!');
        } else {
          showFeedback('Error saving ending page content. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error saving ending page content:', error);
        showFeedback('Error saving ending page content: ' + error.message, 'error');
      }
    }
    
    // Set up crossword functionality
    function setupCrosswordFunctionality() {
      try {
        const enableCrosswordCheckbox = document.getElementById('enable-crossword-mode');
        const crosswordSettings = document.getElementById('crossword-settings');
        const crosswordFileUrlInput = document.getElementById('crossword-file-url');
        const completionTriggerSelect = document.getElementById('crossword-completion-trigger');
        const completionPercentageSetting = document.getElementById('completion-percentage-setting');
        const crosswordPreviewContainer = document.getElementById('crossword-preview-container');
        
        // Check if all elements exist
        if (!enableCrosswordCheckbox || !crosswordSettings || !crosswordFileUrlInput || 
            !completionTriggerSelect || !completionPercentageSetting || !crosswordPreviewContainer) {
          console.warn('Some crossword elements not found, skipping crossword setup');
          return;
        }
        
        // Toggle crossword settings visibility
        enableCrosswordCheckbox.addEventListener('change', function() {
          if (this.checked) {
            crosswordSettings.classList.remove('hidden');
          } else {
            crosswordSettings.classList.add('hidden');
            // Clear crossword settings when disabled
            crosswordFileUrlInput.value = '';
            document.getElementById('crossword-title').value = '';
          }
        });
        
        // Toggle completion percentage setting based on trigger selection
        completionTriggerSelect.addEventListener('change', function() {
          if (this.value === 'percentage') {
            completionPercentageSetting.classList.remove('hidden');
          } else {
            completionPercentageSetting.classList.add('hidden');
          }
        });
        
        // Preview crossword when URL changes
        crosswordFileUrlInput.addEventListener('blur', function() {
          const url = this.value.trim();
          if (url) {
            loadCrosswordPreview(url);
          } else {
            resetCrosswordPreview();
          }
        });
        
                // Add button to select from uploaded files (check if it doesn't already exist)
        const existingBtn = crosswordFileUrlInput.parentNode.querySelector('.crossword-file-selector-btn');
        if (!existingBtn) {
          const selectFileBtn = document.createElement('button');
          selectFileBtn.type = 'button';
          selectFileBtn.className = 'btn btn-secondary crossword-file-selector-btn';
          selectFileBtn.style.marginTop = '10px';
          selectFileBtn.textContent = 'Select from Uploaded Files';
          selectFileBtn.addEventListener('click', async function() {
            await showCrosswordFileSelector(crosswordFileUrlInput);
          });
          
          crosswordFileUrlInput.parentNode.appendChild(selectFileBtn);
        }
        
      } catch (error) {
        console.error('Error setting up crossword functionality:', error);
      }
    }
    
    // Initialize crossword file management (using Database instead of Storage)
    async function initializeCrosswordFileManagement() {
      const fileUpload = document.getElementById('crossword-file-upload');
      const uploadBtn = document.getElementById('upload-crossword-btn');
      const uploadStatus = document.getElementById('crossword-upload-status');
      const refreshBtn = document.getElementById('refresh-crosswords-btn');
      
      // Enable upload button when file is selected
      fileUpload.addEventListener('change', function() {
        uploadBtn.disabled = !this.files[0];
        uploadStatus.textContent = '';
      });
      
      // Handle file upload
      uploadBtn.addEventListener('click', async function() {
        const file = fileUpload.files[0];
        if (!file) return;
        
        // Validate file type
        const validExtensions = ['.cfp', '.puz', '.jpz', '.ipuz'];
        const fileName = file.name.toLowerCase();
        const isValidType = validExtensions.some(ext => fileName.endsWith(ext));
        
        if (!isValidType) {
          uploadStatus.textContent = 'âŒ Please select a .cfp, .puz, .jpz, or .ipuz file';
          uploadStatus.style.color = '#f44336';
          return;
        }
        
        uploadStatus.textContent = 'Reading file...';
        uploadStatus.style.color = '#666';
        uploadBtn.disabled = true;
        
        try {
          console.log('Starting upload for file:', file.name);
          
          // Read file content as text
          const fileContent = await file.text();
          console.log('File content read, length:', fileContent.length);
          console.log('File content preview (first 200 chars):', fileContent.substring(0, 200));
          
          // Check for potential issues
          if (fileContent.length > 1000000) { // 1MB limit
            throw new Error('File too large (max 1MB for database storage)');
          }
          
          // Store in Firebase Database instead of Storage
          const fileData = {
            filename: file.name,
            content: fileContent,
            uploadedAt: new Date().toISOString(),
            size: file.size,
            type: file.type || 'application/octet-stream'
          };
          
          console.log('File data to upload:', {
            filename: fileData.filename,
            contentLength: fileData.content.length,
            uploadedAt: fileData.uploadedAt,
            size: fileData.size,
            type: fileData.type
          });
          
          uploadStatus.textContent = 'Saving to database...';
          
          // Try primary path first
          let success = false;
          try {
            // Use a safe key for Firebase (replace problematic characters)
            const safeFileName = file.name.replace(/[.#$\[\]]/g, '_');
            const primaryUrl = `${DB_URL}/wedding/crosswordFiles/${encodeURIComponent(safeFileName)}.json`;
            console.log('Safe filename:', safeFileName);
            console.log('Attempting to save to primary path:', primaryUrl);
            console.log('Request body:', JSON.stringify(fileData, null, 2));
            
            const response = await fetch(primaryUrl, {
              method: 'PUT',
              body: JSON.stringify(fileData),
              headers: {
                'Content-Type': 'application/json'
              }
            });
            if (response.ok) {
              success = true;
              console.log('Saved to primary database path successfully');
              console.log('Response:', await response.text());
            } else {
              const errorText = await response.text();
              console.error(`Primary path failed with status: ${response.status}`);
              console.error('Error response:', errorText);
              throw new Error(`Primary path failed: ${response.status} - ${errorText}`);
            }
          } catch (error) {
            console.warn('Primary path failed, trying fallback:', error);
            
            // Try fallback path
            try {
              const fallbackUrl = `${DB_URL}/publicAnswers/wedding/crosswordFiles/${encodeURIComponent(safeFileName)}.json`;
              console.log('Attempting to save to fallback path:', fallbackUrl);
              const response = await fetch(fallbackUrl, {
                method: 'PUT',
                body: JSON.stringify(fileData),
                headers: {
                  'Content-Type': 'application/json'
                }
              });
              if (response.ok) {
                success = true;
                console.log('Saved to fallback database path successfully');
                console.log('Response:', await response.text());
              } else {
                const errorText = await response.text();
                console.error(`Fallback path also failed with status: ${response.status}`);
                console.error('Fallback error response:', errorText);
                console.error('Both paths failed. Firebase may be rejecting crosswordFiles writes.');
              }
            } catch (fallbackError) {
              console.error('Fallback path error:', fallbackError);
              console.error('Both database paths failed. Check Firebase rules and permissions.');
            }
          }
          
          if (success) {
            uploadStatus.textContent = 'âœ… Upload successful!';
            uploadStatus.style.color = '#4CAF50';
            
            // Clear the file input
            fileUpload.value = '';
            
            // Show success toast
            showSuccessToast(`âœ… ${file.name} uploaded successfully!`);
            
            // Wait a moment then refresh the files list
            setTimeout(async () => {
              await loadCrosswordFilesList();
            }, 500);
          } else {
            uploadStatus.textContent = 'âŒ Upload failed - Database rejected request';
            uploadStatus.style.color = '#f44336';
            console.error('Upload failed: Database returned 400 Bad Request. Check Firebase Realtime Database rules.');
          }
          
        } catch (error) {
          console.error('Error uploading file:', error);
          uploadStatus.textContent = 'âŒ Upload failed: ' + error.message;
          uploadStatus.style.color = '#f44336';
        }
        
        uploadBtn.disabled = false;
      });
      
      // Handle refresh button
      refreshBtn.addEventListener('click', loadCrosswordFilesList);
      
      // Load initial files list
      await loadCrosswordFilesList();
    }
    
    // Make loadCrosswordFilesList available globally for retry button
    window.loadCrosswordFilesList = loadCrosswordFilesList;
    
    // Load crossword files list from Firebase Database
    async function loadCrosswordFilesList() {
      const filesList = document.getElementById('crossword-files-list');
      
      try {
        filesList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Loading crossword files...</div>';
        
        console.log('Attempting to list files from Firebase Database...');
        
        // Try primary path first
        let response = null;
        let filesData = null;
        let usingPath = '';
        
        try {
          const primaryUrl = `${DB_URL}/wedding/crosswordFiles.json`;
          console.log('Attempting to load from primary path:', primaryUrl);
          response = await fetch(primaryUrl);
          if (response.ok) {
            filesData = await response.json();
            usingPath = 'wedding/crosswordFiles';
            console.log('Loaded from primary path:', usingPath, 'Data:', filesData);
          } else {
            console.warn('Primary path response not ok:', response.status);
          }
        } catch (error) {
          console.warn('Primary path failed:', error);
        }
        
        // Try fallback path if primary failed
        if (!filesData) {
          try {
            const fallbackUrl = `${DB_URL}/publicAnswers/wedding/crosswordFiles.json`;
            console.log('Attempting to load from fallback path:', fallbackUrl);
            response = await fetch(fallbackUrl);
            if (response.ok) {
              filesData = await response.json();
              usingPath = 'publicAnswers/wedding/crosswordFiles';
              console.log('Loaded from fallback path:', usingPath, 'Data:', filesData);
            } else {
              console.warn('Fallback path response not ok:', response.status);
            }
          } catch (error) {
            console.warn('Fallback path failed:', error);
          }
        }
        
        if (!filesData || Object.keys(filesData).length === 0) {
          filesList.innerHTML = `
            <div style="text-align: center; color: #666; padding: 20px;">
              <p>No crossword files uploaded yet.</p>
              <p><small>Upload a .cfp, .puz, .jpz, or .ipuz file using the form above.</small></p>
            </div>
          `;
          return;
        }
        
        filesList.innerHTML = '';
        
        // Convert filesData object to array and sort by upload date
        const files = Object.entries(filesData)
          .map(([key, data]) => ({ key, ...data }))
          .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
        
        console.log(`Found ${files.length} files in database:`, files.map(f => f.filename));
        
        for (const fileData of files) {
          const fileName = fileData.filename;
          const uploadDate = new Date(fileData.uploadedAt).toLocaleDateString();
          const fileSize = fileData.size ? `${Math.round(fileData.size / 1024)}KB` : 'Unknown size';
          
          // Create data URL for the file content
          const dataUrl = `data:${fileData.type};charset=utf-8,${encodeURIComponent(fileData.content)}`;
          
          const fileItem = document.createElement('div');
          fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;';
          
          fileItem.innerHTML = `
            <div>
              <strong>${fileName}</strong>
              <br><small style="color: #666;">Uploaded: ${uploadDate} â€¢ Size: ${fileSize}</small>
              <br><small style="color: #666;">Click "Use This File" to copy content URL</small>
            </div>
            <div>
              <button class="btn btn-sm" onclick="copyToClipboard('${dataUrl}', '${fileName}')" style="margin-right: 5px;">Use This File</button>
              <button class="btn btn-sm btn-danger" onclick="deleteCrosswordFile('${fileName}')">Delete</button>
            </div>
          `;
          
          filesList.appendChild(fileItem);
        }
        
        console.log(`Loaded ${files.length} crossword files from database`);
        
      } catch (error) {
        console.error('Error loading crossword files:', error);
        
        filesList.innerHTML = `
          <div style="text-align: center; color: #f44336; padding: 20px;">
            <p><strong>Error loading crossword files</strong></p>
            <p>${error.message}</p>
            <button onclick="loadCrosswordFilesList()" style="margin-top: 10px; padding: 5px 10px;">Retry</button>
          </div>
        `;
      }
    }
    
    // Copy Firebase URL to clipboard and update crossword input
    window.copyToClipboard = function(url, fileName) {
      // Try to find an open crossword URL input and fill it
      const crosswordUrlInput = document.getElementById('crossword-file-url');
      if (crosswordUrlInput) {
        crosswordUrlInput.value = url;
        showSuccessToast(`âœ… ${fileName} URL copied to crossword settings!`);
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
          showSuccessToast(`âœ… ${fileName} URL copied to clipboard!`);
        }).catch(() => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = url;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showSuccessToast(`âœ… ${fileName} URL copied!`);
        });
      }
    };
    
    // Delete crossword file from Firebase Database
    window.deleteCrosswordFile = async function(fileName) {
      if (!confirm(`Are you sure you want to delete "${fileName}"?`)) return;
      
      try {
        console.log('Deleting file:', fileName);
        
        // Try primary path first
        let success = false;
        try {
          const response = await fetch(`${DB_URL}/wedding/crosswordFiles/${encodeURIComponent(fileName)}.json`, {
            method: 'DELETE'
          });
          if (response.ok) {
            success = true;
            console.log('Deleted from primary path');
          }
        } catch (error) {
          console.warn('Primary delete failed:', error);
        }
        
        // Try fallback path if primary failed
        if (!success) {
          const response = await fetch(`${DB_URL}/publicAnswers/wedding/crosswordFiles/${encodeURIComponent(fileName)}.json`, {
            method: 'DELETE'
          });
          if (response.ok) {
            success = true;
            console.log('Deleted from fallback path');
          }
        }
        
        if (success) {
          showSuccessToast(`âœ… ${fileName} deleted successfully!`);
          await loadCrosswordFilesList();
        } else {
          throw new Error('Failed to delete from both primary and fallback paths');
        }
        
      } catch (error) {
        console.error('Error deleting file:', error);
        alert('Error deleting file: ' + error.message);
      }
    };
    
    // Show crossword file selector
    async function showCrosswordFileSelector(targetInput) {
      try {
        console.log('Loading crossword files for selection...');
        
        // Try primary path first
        let response = null;
        let filesData = null;
        
        try {
          response = await fetch(`${DB_URL}/wedding/crosswordFiles.json`);
          if (response.ok) {
            filesData = await response.json();
            console.log('Loaded files from primary path');
          }
        } catch (error) {
          console.warn('Primary path failed:', error);
        }
        
        // Try fallback path if primary failed
        if (!filesData) {
          try {
            response = await fetch(`${DB_URL}/publicAnswers/wedding/crosswordFiles.json`);
            if (response.ok) {
              filesData = await response.json();
              console.log('Loaded files from fallback path');
            }
          } catch (error) {
            console.warn('Fallback path failed:', error);
          }
        }
        
        if (!filesData || Object.keys(filesData).length === 0) {
          alert('No crossword files uploaded yet. Please upload a CFP file first.');
          return;
        }
        
        // Convert to array and sort by upload date (newest first)
        const files = Object.entries(filesData)
          .map(([key, data]) => ({ key, ...data }))
          .sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
        
        let fileOptions = 'Select a crossword file:\n\n';
        
        for (let i = 0; i < files.length; i++) {
          const fileData = files[i];
          const uploadDate = new Date(fileData.uploadedAt).toLocaleDateString();
          fileOptions += `${i + 1}. ${fileData.filename} (${uploadDate})\n`;
        }
        
        const selection = prompt(fileOptions + '\nEnter the number of the file you want to use:');
        const index = parseInt(selection) - 1;
        
        if (index >= 0 && index < files.length) {
          const selectedFile = files[index];
          // Create data URL for the file content
          const dataUrl = `data:${selectedFile.type};charset=utf-8,${encodeURIComponent(selectedFile.content)}`;
          
          targetInput.value = dataUrl;
          loadCrosswordPreview(dataUrl, selectedFile.filename);
          showSuccessToast(`âœ… Selected: ${selectedFile.filename}`);
        }
        
      } catch (error) {
        console.error('Error loading crossword files:', error);
        alert('Error loading crossword files: ' + error.message);
      }
    }
    
    // Load crossword preview
    async function loadCrosswordPreview(url, fileName = null) {
      const previewContainer = document.getElementById('crossword-preview-container');
      
      try {
        previewContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%;"><span>Loading crossword preview...</span></div>';
        
        // Determine file name from URL or parameter
        let displayName = 'crossword file';
        if (fileName) {
          displayName = fileName;
        } else if (url.startsWith('data:')) {
          displayName = 'uploaded crossword data';
        } else {
          displayName = url.split('/').pop();
        }
        
        // For now, show a simple preview message
        // In a full implementation, you'd load and parse the CFP file
        setTimeout(() => {
          previewContainer.innerHTML = `
            <div style="padding: 20px; text-align: center;">
              <h6 style="margin: 0; color: #333;">Crossword Preview</h6>
              <p style="margin: 5px 0; color: #666; font-size: 12px;">Source: ${displayName}</p>
              <div style="margin: 10px 0; color: #999; font-size: 11px;">
                âœ“ File format supported<br>
                âœ“ Cheat protection enabled<br>
                âœ“ Mobile responsive design<br>
                âœ“ Stored in Firebase Database
              </div>
              <small style="color: #999;">Full preview available when puzzle is published</small>
            </div>
          `;
        }, 1000);
        
      } catch (error) {
        console.error('Error loading crossword preview:', error);
        previewContainer.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #e53935;">
            <span>Error loading crossword preview</span><br>
            <small>Please check the file and try again</small>
          </div>
        `;
      }
    }
    
    // Reset crossword preview
    function resetCrosswordPreview() {
      document.getElementById('crossword-preview-container').innerHTML = 
        '<span>Crossword preview will appear here when a valid CFP file is provided</span>';
    }
  </script>
</body>
</html> 