<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wedding Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Add rich text editor dependencies -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2rem;
      font-weight: bold;
    }
    
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #333;
    }
    
    #auth-message {
      text-align: center;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #f44336;
    }
    
    .tab-nav {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    
    .tab-nav button {
      background: none;
      border: none;
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-nav button.active {
      color: #000;
      border-bottom-color: #000;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: bold;
      color: #333;
      border-bottom: 2px solid #ddd;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    tr:hover {
      background-color: #f9f9f9;
    }
    
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    input:focus, textarea:focus {
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      outline: none;
    }
    
    textarea {
      min-height: 100px;
      font-family: inherit;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .btn-secondary {
      background-color: #666;
    }
    
    .btn-danger {
      background-color: #f44336;
    }
    
    .btn-success {
      background-color: #4CAF50;
    }
    
    .btn-icon {
      padding: 6px 10px;
      margin-left: 5px;
    }
    
    .status-pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: white;
      background-color: #999;
    }
    
    .status-pill.status-0 {
      background-color: #f44336; /* Not started */
    }
    
    .status-pill.status-solved {
      background-color: #4caf50; /* Solved */
    }
    
    .status-pill.status-inprogress {
      background-color: #2196f3; /* In progress */
    }
    
    .status-pill.status-completed {
      background-color: #9c27b0; /* All completed */
    }
    
    .player-details {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      margin-top: 20px;
      animation: fadeIn 0.5s ease;
    }
    
    .progress-bar {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #4caf50;
      transition: width 0.5s ease;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal.visible {
      opacity: 1;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal.visible .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-close {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .save-indicator {
      font-size: 12px;
      color: #4caf50;
      margin-left: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .save-indicator.show {
      opacity: 1;
    }
    
    .error-indicator {
      color: #f44336;
      font-size: 12px;
      margin-top: 5px;
    }
    
    .path-indicator {
      font-size: 12px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .answer-row {
      background-color: #f8f8f8;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 10px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .answer-row:hover {
      background-color: #f0f0f0;
    }
    
    .remove-answer-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remove-answer-btn:hover {
      background: #ff1744;
    }
    
    .add-answer-btn {
      margin-top: 10px;
      background-color: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-answer-btn:hover {
      background-color: #bdbdbd;
    }
    
    .global-settings {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
    }
    
    .image-gallery {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .image-item {
      position: relative;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      width: calc(50% - 10px);
      box-sizing: border-box;
    }
    
    .image-item input {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .image-item img {
      max-width: 100%;
      max-height: 100px;
      display: block;
      margin: 5px auto;
      border-radius: 4px;
    }
    
    .image-item .image-preview-error {
      color: #f44336;
      font-size: 12px;
      text-align: center;
      padding: 5px;
    }
    
    .add-image-btn {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-image-btn:hover {
      background-color: #bdbdbd;
    }
    
    .remove-image-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remove-image-btn:hover {
      background: #ff1744;
    }
    
    .editor-container {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .ql-editor {
      min-height: 150px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .ql-toolbar.ql-snow {
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
      background-color: #f9f9f9;
    }
    
    .clue-preview {
      margin-top: 10px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }
    
    .preview-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .image-modal.visible {
      opacity: 1;
      display: flex;
    }
    
    .image-modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .image-modal.visible .image-modal-content {
      transform: translateY(0);
    }
    
    @media (max-width: 768px) {
      .tab-nav {
        flex-direction: column;
      }
      
      .tab-nav button {
        width: 100%;
        text-align: left;
        margin-bottom: 5px;
      }
      
      .image-item {
        width: 100%;
      }
      
      .container {
        padding: 10px;
        margin: 10px auto;
      }
      
      .card {
        padding: 15px;
      }
      
      table th, table td {
        padding: 8px;
      }
    }
    
    .puzzle-tab-content {
      display: none;
      padding: 15px 0;
    }
    
    .puzzle-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .puzzle-preview {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .puzzle-preview-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .puzzle-preview-label {
      font-weight: bold;
      min-width: 80px;
    }
    
    .puzzle-preview-thumbnail {
      max-width: 60px;
      max-height: 60px;
      object-fit: contain;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-edit-all {
      background-color: #2196F3;
    }
    
    .btn-edit-all:hover {
      background-color: #0b7dda;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wedding Puzzle Admin</h1>
    
    <!-- Auth message for non-admin users -->
    <div id="auth-message" style="display: none;">
      You need to be logged in as an admin to access this page. Please <a href="/admin.html">log in</a> first.
    </div>
    
    <div id="admin-panel" style="display: none;">
      <div class="tab-nav">
        <button id="tab-puzzles" class="active">Puzzles</button>
        <button id="tab-players">Players</button>
      </div>
      
      <div id="puzzles-tab" class="tab-content card active">
        <h2>Wedding Puzzles</h2>
        <p>Edit puzzle names, answers, and clues below. Changes are saved automatically.</p>
        <div id="puzzle-path-indicator" class="path-indicator">
          Saving to: primary database path
        </div>
        
        <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
          <h3>Completion Message</h3>
          <p>Edit the message that appears when users solve all puzzles:</p>
          <div class="form-group">
            <textarea id="completion-message" rows="3" style="width: 100%;" placeholder="Congratulations! You've completed all puzzles!"></textarea>
          </div>
          <button id="save-completion-message" class="btn">Save Message</button>
          <span id="completion-save-indicator" class="save-indicator">Message saved!</span>
        </div>
        
        <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
          <h3>Welcome Back Message</h3>
          <p>Edit the message that appears when users return to continue the puzzle:</p>
          <div class="form-group">
            <textarea id="welcome-back-message" rows="3" style="width: 100%;" placeholder="Welcome back! You can continue your puzzle progress."></textarea>
          </div>
          <button id="save-welcome-message" class="btn">Save Message</button>
          <span id="welcome-save-indicator" class="save-indicator">Message saved!</span>
        </div>
        
        <table id="puzzles-table">
          <thead>
            <tr>
              <th style="width: 5%;">#</th>
              <th style="width: 20%;">Name</th>
              <th style="width: 45%;">Preview</th>
              <th style="width: 30%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Puzzle rows will be inserted here -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" style="text-align: center; padding: 20px;">
                <button id="add-puzzle-btn" class="btn">Add New Puzzle</button>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <div id="players-tab" class="tab-content card hidden">
        <h2>Players Progress</h2>
        <p>View and manage players' progress through the wedding puzzle.</p>
        <div id="players-path-indicator" class="path-indicator">
          Loading from: all database paths
        </div>
        
        <table id="players-table">
          <thead>
            <tr>
              <th style="width: 25%;">Name</th>
              <th style="width: 25%;">Email</th>
              <th style="width: 10%;">Progress</th>
              <th style="width: 15%;">Current Screen</th>
              <th style="width: 15%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Player rows will be inserted here -->
          </tbody>
        </table>
        
        <div id="player-details" class="player-details hidden">
          <h3 id="details-name">Player Name</h3>
          <p><strong>Email:</strong> <span id="details-email"></span></p>
          <p><strong>Current Screen:</strong> <span id="details-screen"></span></p>
          <p><strong>Progress:</strong> <span id="details-percentage"></span>%</p>
          <p><strong>Data Path:</strong> <span id="details-path"></span></p>
          
          <div class="progress-bar">
            <div id="details-progress-bar" class="progress-bar-fill" style="width: 0%;"></div>
          </div>
          
          <h4 style="margin-top: 20px;">Puzzle Status</h4>
          <div id="details-puzzle-status"></div>
          
          <div style="margin-top: 20px;">
            <button id="details-email-btn" class="btn btn-secondary">Send Hint Email</button>
            <button id="details-back-btn" class="btn">Back to List</button>
          </div>
        </div>
      </div>
      
      <div id="settings-tab" class="tab-content card hidden" style="display: none;">
        <!-- Settings content will be inserted here -->
      </div>
    </div>
  </div>
  
  <!-- Answer Edit Modal -->
  <div id="answer-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Answers</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div id="answers-container">
        <!-- Answer fields will be added here -->
      </div>
      
      <button id="add-answer-btn" class="add-answer-btn">+ Add Another Answer</button>
      
      <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <div class="form-group">
          <label for="answer-wrong-message">Wrong Answer Message:</label>
          <input type="text" id="answer-wrong-message" placeholder="Message shown when all answers are wrong">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "That's not right. Try again!"</small>
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label for="answer-partial-message">Partial Correct Message:</label>
          <input type="text" id="answer-partial-message" placeholder="Message shown when some answers are correct">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "Some answers are wrong. Keep trying!"</small>
        </div>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-answers-btn" class="btn">Save Answers</button>
      </div>
    </div>
  </div>
  
  <!-- Image Edit Modal -->
  <div id="image-modal" class="image-modal">
    <div class="image-modal-content">
      <div class="modal-header">
        <h3>Edit Images</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div id="images-container" class="image-gallery">
        <!-- Image fields will be added here -->
      </div>
      
      <button id="add-image-btn" class="add-image-btn">+ Add Another Image</button>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-images-btn" class="btn">Save Images</button>
      </div>
    </div>
  </div>
  
  <!-- Rich Text Edit Modal -->
  <div id="richtext-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Clue Content</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div class="editor-container">
        <div id="richtext-editor"></div>
      </div>
      
      <div class="clue-preview">
        <div class="preview-title">Preview:</div>
        <div id="richtext-preview"></div>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-richtext-btn" class="btn">Save Content</button>
      </div>
    </div>
  </div>
  
  <!-- Comprehensive Puzzle Edit Modal -->
  <div id="puzzle-edit-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; width: 90%;">
      <div class="modal-header">
        <h3>Edit Puzzle <span id="edit-puzzle-number"></span></h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div class="tab-nav" style="margin-top: 15px;">
        <button id="puzzle-tab-basic" class="active">Basic Info</button>
        <button id="puzzle-tab-clue">Clue Content</button>
        <button id="puzzle-tab-images">Images</button>
        <button id="puzzle-tab-answers">Answers</button>
      </div>
      
      <div id="puzzle-basic-tab" class="puzzle-tab-content active">
        <div class="form-group" style="margin-top: 15px;">
          <label for="edit-puzzle-name">Puzzle Name:</label>
          <input type="text" id="edit-puzzle-name" placeholder="Enter puzzle name">
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label for="edit-wrong-answer-message">Wrong Answer Message:</label>
          <input type="text" id="edit-wrong-answer-message" placeholder="Message shown when all answers are wrong">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "That's not right. Try again!"</small>
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
          <label for="edit-partial-correct-message">Partial Correct Message:</label>
          <input type="text" id="edit-partial-correct-message" placeholder="Message shown when some answers are correct">
          <small style="color: #666; display: block; margin-top: 5px;">Default: "Some answers are wrong. Keep trying!"</small>
        </div>
      </div>
      
      <div id="puzzle-clue-tab" class="puzzle-tab-content hidden">
        <div class="editor-container" style="margin-top: 15px;">
          <div id="edit-puzzle-richtext"></div>
        </div>
        
        <div class="clue-preview" style="margin-top: 15px;">
          <div class="preview-title">Preview:</div>
          <div id="edit-puzzle-preview"></div>
        </div>
      </div>
      
      <div id="puzzle-images-tab" class="puzzle-tab-content hidden">
        <div id="edit-puzzle-images" class="image-gallery" style="margin-top: 15px;">
          <!-- Image fields will be added here -->
        </div>
        
        <button id="edit-puzzle-add-image" class="add-image-btn">+ Add Another Image</button>
      </div>
      
      <div id="puzzle-answers-tab" class="puzzle-tab-content hidden">
        <div id="edit-puzzle-answers" style="margin-top: 15px;">
          <!-- Answer fields will be added here -->
        </div>
        
        <button id="edit-puzzle-add-answer" class="add-answer-btn">+ Add Another Answer</button>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-puzzle-btn" class="btn">Save Puzzle</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, set, push, get, remove, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
        authDomain: "eviltrivia-47664.firebaseapp.com",
        databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
        projectId: "eviltrivia-47664",
        storageBucket: "eviltrivia-47664.appspot.com",
        messagingSenderId: "401826818140",
        appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
        measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    // Firebase database URL
    const DB_URL = "https://eviltrivia-47664-default-rtdb.firebaseio.com";
    
    // Database paths for wedding puzzle data
    const DB_PATHS = {
      primary: 'wedding',
      fallback: 'publicAnswers/wedding'
    };
    
    // DOM Elements
    const authMessage = document.getElementById('auth-message');
    const adminPanel = document.getElementById('admin-panel');
    const tabPuzzles = document.getElementById('tab-puzzles');
    const tabPlayers = document.getElementById('tab-players');
    const puzzlesTab = document.getElementById('puzzles-tab');
    const playersTab = document.getElementById('players-tab');
    
    const puzzlesTable = document.getElementById('puzzles-table').querySelector('tbody');
    const playersTable = document.getElementById('players-table').querySelector('tbody');
    
    const playerDetails = document.getElementById('player-details');
    const detailsName = document.getElementById('details-name');
    const detailsEmail = document.getElementById('details-email');
    const detailsScreen = document.getElementById('details-screen');
    const detailsPercentage = document.getElementById('details-percentage');
    const detailsProgressBar = document.getElementById('details-progress-bar');
    const detailsPuzzleStatus = document.getElementById('details-puzzle-status');
    const detailsEmailBtn = document.getElementById('details-email-btn');
    const detailsBackBtn = document.getElementById('details-back-btn');
    const detailsPath = document.getElementById('details-path');
    
    const puzzlePathIndicator = document.getElementById('puzzle-path-indicator');
    const playersPathIndicator = document.getElementById('players-path-indicator');
    
    const answerModal = document.getElementById('answer-modal');
    const answersContainer = document.getElementById('answers-container');
    const addAnswerBtn = document.getElementById('add-answer-btn');
    const saveAnswersBtn = document.getElementById('save-answers-btn');
    
    const imageModal = document.getElementById('image-modal');
    const imagesContainer = document.getElementById('images-container');
    const addImageBtn = document.getElementById('add-image-btn');
    const saveImagesBtn = document.getElementById('save-images-btn');
    
    const richtextModal = document.getElementById('richtext-modal');
    const richtextPreview = document.getElementById('richtext-preview');
    const saveRichtextBtn = document.getElementById('save-richtext-btn');
    
    const completionMessage = document.getElementById('completion-message');
    const saveCompletionMessage = document.getElementById('save-completion-message');
    const completionSaveIndicator = document.getElementById('completion-save-indicator');
    
    const welcomeBackMessage = document.getElementById('welcome-back-message');
    const saveWelcomeMessage = document.getElementById('save-welcome-message');
    const welcomeSaveIndicator = document.getElementById('welcome-save-indicator');
    
    // Rich text editor
    let quill;
    
    // Store timeouts for debounced saves
    const saveTimeouts = {};
    
    // Track successful database paths
    let successfulPuzzlePath = null;
    let successfulPlayersPath = null;
    
    // Store current items being edited
    let currentPuzzleBeingEdited = null;
    let currentAnswers = [];
    let currentImages = [];
    let currentClueHtml = '';
    
    // Check if user is logged in and has admin privileges
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("User logged in with UID:", user.uid);
            
            // Check admin status
            const userRef = ref(db, `users/${user.uid}`);
            get(userRef).then((snapshot) => {
                const userData = snapshot.val() || {};
                
                if (userData.role === 'admin') {
                    console.log("Admin access granted via user role");
                    // User is admin, show admin panel
                    authMessage.style.display = 'none';
                    adminPanel.style.display = 'block';
                    
                    // Initialize admin functionality
                    initializeAdmin();
                    
                } else {
                    console.log("User is not an admin");
                    // Not admin, show message
                    authMessage.style.display = 'block';
                    authMessage.innerHTML = 'You do not have admin privileges to access this page.';
                    adminPanel.style.display = 'none';
                }
            }).catch((error) => {
                console.error("Error checking admin status:", error);
                authMessage.style.display = 'block';
                authMessage.innerHTML = `Error checking admin status: ${error.message}`;
                adminPanel.style.display = 'none';
            });
        } else {
            // Not logged in, show message
            authMessage.style.display = 'block';
            authMessage.innerHTML = 'You need to be logged in as an admin to access this page. Please <a href="/admin.html">log in</a> first.';
            adminPanel.style.display = 'none';
        }
    });
    
    // Initialize admin functionality - called after authentication
    function initializeAdmin() {
        // Initialize rich text editor
        quill = new Quill('#richtext-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });
        
        // Update preview when editor content changes
        quill.on('text-change', function() {
            richtextPreview.innerHTML = quill.root.innerHTML;
        });
        
        // Load all tabs' data
        loadPuzzles();
        loadPlayers();
        loadCompletionMessage();
        loadWelcomeBackMessage();
        
        // Set up tab switching
        tabPuzzles.addEventListener('click', () => {
            tabPuzzles.classList.add('active');
            tabPlayers.classList.remove('active');
            puzzlesTab.classList.add('active');
            playersTab.classList.remove('active');
            playerDetails.classList.add('hidden');
        });
        
        tabPlayers.addEventListener('click', () => {
            tabPuzzles.classList.remove('active');
            tabPlayers.classList.add('active');
            puzzlesTab.classList.remove('active');
            playersTab.classList.add('active');
        });
        
        // Set up back button
        detailsBackBtn.addEventListener('click', () => {
            document.querySelector('#players-table').parentNode.style.display = 'block';
            playerDetails.classList.add('hidden');
        });
        
        // Set up modal closing
        document.querySelectorAll('.modal-close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                closeAllModals();
            });
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === answerModal) {
                closeModal(answerModal);
            }
            if (e.target === imageModal) {
                closeModal(imageModal);
            }
            if (e.target === richtextModal) {
                closeModal(richtextModal);
            }
            if (e.target === document.getElementById('puzzle-edit-modal')) {
                closeModal(document.getElementById('puzzle-edit-modal'));
            }
        });
        
        // Add answer button
        addAnswerBtn.addEventListener('click', () => {
            addAnswerField({ text: '', questionText: '' });
        });
        
        // Add image button
        addImageBtn.addEventListener('click', () => {
            addImageField({ url: '' });
        });
        
        // Save buttons
        saveAnswersBtn.addEventListener('click', () => {
            saveAnswers();
        });
        
        saveImagesBtn.addEventListener('click', () => {
            saveImages();
        });
        
        saveRichtextBtn.addEventListener('click', () => {
            saveRichtext();
        });
        
        // Add puzzle button
        document.getElementById('add-puzzle-btn').addEventListener('click', () => {
            addNewPuzzleDirectly();
        });
        
        // Completion message save button
        saveCompletionMessage.addEventListener('click', () => {
            saveCompletionMessageData();
        });
        
        // Welcome back message save button
        saveWelcomeMessage.addEventListener('click', () => {
            saveWelcomeBackMessageData();
        });
    }
    
    // Load completion message
    async function loadCompletionMessage() {
        try {
            const result = await fetchFromPaths(Object.values(DB_PATHS), 'completionMessage');
            
            if (result.data) {
                completionMessage.value = result.data;
            } else {
                // Default message
                completionMessage.value = "Congratulations! You've completed all the puzzles!";
            }
        } catch (error) {
            console.error('Error loading completion message:', error);
        }
    }
    
    // Save completion message
    async function saveCompletionMessageData() {
        try {
            const message = completionMessage.value.trim();
            
            if (!message) {
                showFeedback('Please enter a completion message.', 'error');
                return;
            }
            
            // Save to database
            const result = await saveToDatabase(
                Object.values(DB_PATHS),
                'completionMessage',
                message,
                'PUT'
            );
            
            if (result.success) {
                // Show save indicator
                completionSaveIndicator.classList.add('show');
                setTimeout(() => {
                    completionSaveIndicator.classList.remove('show');
                }, 2000);
                
                showSuccessToast('Completion message saved!');
            } else {
                showFeedback('Error saving completion message. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Error saving completion message:', error);
            showFeedback('Error saving completion message: ' + error.message, 'error');
        }
    }
    
    // Load welcome back message
    async function loadWelcomeBackMessage() {
        try {
            const result = await fetchFromPaths(Object.values(DB_PATHS), 'welcomeBackMessage');
            
            if (result.data) {
                welcomeBackMessage.value = result.data;
            } else {
                // Default message
                welcomeBackMessage.value = "Welcome back! You can continue your puzzle progress.";
            }
        } catch (error) {
            console.error('Error loading welcome back message:', error);
        }
    }
    
    // Save welcome back message
    async function saveWelcomeBackMessageData() {
        try {
            const message = welcomeBackMessage.value.trim();
            
            if (!message) {
                showFeedback('Please enter a welcome back message.', 'error');
                return;
            }
            
            // Save to database
            const result = await saveToDatabase(
                Object.values(DB_PATHS),
                'welcomeBackMessage',
                message,
                'PUT'
            );
            
            if (result.success) {
                // Show save indicator
                welcomeSaveIndicator.classList.add('show');
                setTimeout(() => {
                    welcomeSaveIndicator.classList.remove('show');
                }, 2000);
                
                showSuccessToast('Welcome back message saved!');
            } else {
                showFeedback('Error saving welcome back message. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Error saving welcome back message:', error);
            showFeedback('Error saving welcome back message: ' + error.message, 'error');
        }
    }
    
    // Try fetching data from multiple paths
    async function fetchFromPaths(paths, endpoint) {
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`);
          if (response.ok) {
            const data = await response.json();
            return { data, path };
          }
        } catch (error) {
          console.error(`Error fetching from ${path}/${endpoint}:`, error);
        }
      }
      return { data: null, path: null };
    }
    
    // Save data to the database with fallback paths
    async function saveToDatabase(paths, endpoint, data, method = 'PATCH') {
      // Try using previously successful path first
      if (successfulPuzzlePath) {
        try {
          const response = await fetch(`${DB_URL}/${successfulPuzzlePath}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            return { success: true, path: successfulPuzzlePath };
          }
        } catch (error) {
          console.error(`Error saving to ${successfulPuzzlePath}/${endpoint}:`, error);
        }
      }
      
      // Try each path in sequence
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            successfulPuzzlePath = path;
            return { success: true, path };
          }
        } catch (error) {
          console.error(`Error saving to ${path}/${endpoint}:`, error);
        }
      }
      
      return { success: false, path: null };
    }
    
    // Load puzzles data
    async function loadPuzzles() {
      try {
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'answers');
        
        // Set successful path even if data is null
        if (result.path) {
          successfulPuzzlePath = result.path;
          puzzlePathIndicator.textContent = `Saving to: ${successfulPuzzlePath}`;
        }
        
        // Clear table first
        puzzlesTable.innerHTML = '';
        
        // Initialize data structure
        const puzzlesData = result.data || {};
        
        // For numbered entries (1-10), order by number
        let keys = Object.keys(puzzlesData)
          .filter(key => !isNaN(parseInt(key)) && parseInt(key) > 0) // Exclude puzzle 0
          .map(key => parseInt(key))
          .sort((a, b) => a - b);
        
        // If no keys/puzzles found, initialize with defaults 1-10
        if (keys.length === 0) {
          const defaultPuzzleCount = 10;
          // Create default puzzles
          const defaultPuzzles = {};
          for (let i = 1; i <= defaultPuzzleCount; i++) {
            defaultPuzzles[i] = {
              name: `Puzzle #${i}`,
              clue: '',
              clueHtml: '',
              imageUrls: [],
              answers: [{ text: '', questionText: 'Your Answer:' }]
            };
          }
          
          // Save defaults to database
          if (successfulPuzzlePath) {
            try {
              await fetch(`${DB_URL}/${successfulPuzzlePath}/answers.json`, {
                method: 'PATCH',
                body: JSON.stringify(defaultPuzzles)
              });
            } catch (error) {
              console.error('Error initializing default puzzles:', error);
            }
          }
          
          // Update local data
          keys = Array.from({ length: defaultPuzzleCount }, (_, i) => i + 1);
          Object.assign(puzzlesData, defaultPuzzles);
        }
        
        // Add rows for each puzzle
        keys.forEach(puzzleNum => {
          // Initialize puzzleData if it's null or undefined
          const puzzleData = puzzlesData[puzzleNum] || { 
            clue: '',
            clueHtml: '',
            imageUrls: [],
            answers: [{ text: '', questionText: 'Your Answer:' }],
            name: `Puzzle #${puzzleNum}`
          };
          
          // Create table row
          const row = document.createElement('tr');
          row.dataset.puzzleNumber = puzzleNum;
          
          // Migrate old format to new format if needed
          if (puzzleData && puzzleData.answer && !puzzleData.answers) {
            puzzleData.answers = [{
              text: puzzleData.answer,
              questionText: 'Your Answer:'
            }];
            delete puzzleData.answer;
          }
          
          // Convert single imageUrl to imageUrls array if needed
          if (puzzleData.imageUrl && !puzzleData.imageUrls) {
            puzzleData.imageUrls = puzzleData.imageUrl ? [puzzleData.imageUrl] : [];
          }
          
          // Add puzzle number cell - make it editable
          const numCell = document.createElement('td');
          const numInput = document.createElement('input');
          numInput.type = 'number';
          numInput.min = '1';
          numInput.style.width = '100%';
          numInput.value = puzzleNum;
          numInput.className = 'puzzle-number-input';
          numInput.addEventListener('change', () => {
            const newNumber = parseInt(numInput.value);
            if (!isNaN(newNumber) && newNumber > 0) {
              reorderPuzzle(puzzleNum, newNumber);
            }
          });
          numCell.appendChild(numInput);
          row.appendChild(numCell);
          
          // Add name cell
          const nameCell = document.createElement('td');
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.value = puzzleData.name || `Puzzle #${puzzleNum}`;
          nameInput.placeholder = 'Puzzle Name';
          nameInput.addEventListener('input', debounce(() => {
            savePuzzleField(puzzleNum, 'name', nameInput.value);
          }, 1000));
          nameCell.appendChild(nameInput);
          row.appendChild(nameCell);
          
          // Add preview cell
          const previewCell = document.createElement('td');
          const previewContainer = document.createElement('div');
          previewContainer.className = 'puzzle-preview';
          
          // Preview clue
          const cluePreview = document.createElement('div');
          cluePreview.className = 'puzzle-preview-item';
          
          const clueLabel = document.createElement('div');
          clueLabel.className = 'puzzle-preview-label';
          clueLabel.textContent = 'Clue:';
          
          const clueText = document.createElement('div');
          clueText.className = 'puzzle-preview-text';
          if (puzzleData.clueHtml) {
            clueText.innerHTML = puzzleData.clueHtml.length > 100 
              ? puzzleData.clueHtml.substring(0, 100) + '...' 
              : puzzleData.clueHtml;
          } else {
            clueText.textContent = puzzleData.clue 
              ? (puzzleData.clue.length > 100 ? puzzleData.clue.substring(0, 100) + '...' : puzzleData.clue) 
              : 'No clue provided';
          }
          
          cluePreview.appendChild(clueLabel);
          cluePreview.appendChild(clueText);
          previewContainer.appendChild(cluePreview);
          
          // Preview images
          if (puzzleData.imageUrls && puzzleData.imageUrls.length > 0) {
            const imagesPreview = document.createElement('div');
            imagesPreview.className = 'puzzle-preview-item';
            
            const imagesLabel = document.createElement('div');
            imagesLabel.className = 'puzzle-preview-label';
            imagesLabel.textContent = 'Images:';
            
            const imagesContainer = document.createElement('div');
            imagesContainer.style.display = 'flex';
            imagesContainer.style.gap = '5px';
            imagesContainer.style.flexWrap = 'wrap';
            
            // Show up to 3 thumbnails
            const maxThumbnails = Math.min(3, puzzleData.imageUrls.length);
            
            for (let i = 0; i < maxThumbnails; i++) {
              const thumbnail = document.createElement('img');
              thumbnail.className = 'puzzle-preview-thumbnail';
              thumbnail.src = puzzleData.imageUrls[i];
              thumbnail.alt = 'Image thumbnail';
              imagesContainer.appendChild(thumbnail);
            }
            
            // Show count if more than shown
            if (puzzleData.imageUrls.length > maxThumbnails) {
              const countLabel = document.createElement('div');
              countLabel.textContent = `+${puzzleData.imageUrls.length - maxThumbnails} more`;
              countLabel.style.fontSize = '12px';
              imagesContainer.appendChild(countLabel);
            }
            
            imagesPreview.appendChild(imagesLabel);
            imagesPreview.appendChild(imagesContainer);
            previewContainer.appendChild(imagesPreview);
          }
          
          // Preview answers
          const answersPreview = document.createElement('div');
          answersPreview.className = 'puzzle-preview-item';
          
          const answersLabel = document.createElement('div');
          answersLabel.className = 'puzzle-preview-label';
          answersLabel.textContent = 'Answers:';
          
          const answersContainer = document.createElement('div');
          
          if (puzzleData.answers && puzzleData.answers.length > 0) {
            const answersList = document.createElement('ul');
            answersList.style.margin = '0';
            answersList.style.paddingLeft = '20px';
            
            // Show all answers (they're typically short)
            puzzleData.answers.forEach(answer => {
              const answerItem = document.createElement('li');
              answerItem.textContent = answer.text || '(empty)';
              answersList.appendChild(answerItem);
            });
            
            answersContainer.appendChild(answersList);
          } else {
            answersContainer.textContent = 'No answers defined';
          }
          
          answersPreview.appendChild(answersLabel);
          answersPreview.appendChild(answersContainer);
          previewContainer.appendChild(answersPreview);
          
          // Preview error messages
          if (puzzleData.wrongAnswerMessage || puzzleData.partialCorrectMessage) {
            const messagesPreview = document.createElement('div');
            messagesPreview.className = 'puzzle-preview-item';
            
            const messagesLabel = document.createElement('div');
            messagesLabel.className = 'puzzle-preview-label';
            messagesLabel.textContent = 'Messages:';
            
            const messagesContainer = document.createElement('div');
            messagesContainer.style.fontSize = '0.85rem';
            
            if (puzzleData.wrongAnswerMessage) {
              const wrongMsg = document.createElement('div');
              wrongMsg.innerHTML = `<strong>Wrong:</strong> "${puzzleData.wrongAnswerMessage}"`;
              messagesContainer.appendChild(wrongMsg);
            }
            
            if (puzzleData.partialCorrectMessage) {
              const partialMsg = document.createElement('div');
              partialMsg.innerHTML = `<strong>Partial:</strong> "${puzzleData.partialCorrectMessage}"`;
              partialMsg.style.marginTop = '5px';
              messagesContainer.appendChild(partialMsg);
            }
            
            messagesPreview.appendChild(messagesLabel);
            messagesPreview.appendChild(messagesContainer);
            previewContainer.appendChild(messagesPreview);
          }
          
          previewCell.appendChild(previewContainer);
          row.appendChild(previewCell);
          
          // Add actions cell
          const actionsCell = document.createElement('td');
          const actionButtons = document.createElement('div');
          actionButtons.className = 'action-buttons';
          
          // Edit All button
          const editAllBtn = document.createElement('button');
          editAllBtn.className = 'btn btn-edit-all';
          editAllBtn.textContent = 'Edit All';
          editAllBtn.addEventListener('click', () => {
            openPuzzleEditModal(puzzleNum, puzzleData);
          });
          
          // Individual edit buttons
          const editClueBtn = document.createElement('button');
          editClueBtn.className = 'btn btn-icon';
          editClueBtn.textContent = 'Edit Clue';
          editClueBtn.addEventListener('click', () => {
            openRichtextModal(puzzleNum, puzzleData.clueHtml || puzzleData.clue || '');
          });
          
          const editImagesBtn = document.createElement('button');
          editImagesBtn.className = 'btn btn-icon';
          editImagesBtn.textContent = 'Edit Images';
          editImagesBtn.addEventListener('click', () => {
            openImageModal(puzzleNum, puzzleData.imageUrls || []);
          });
          
          const editAnswersBtn = document.createElement('button');
          editAnswersBtn.className = 'btn btn-icon';
          editAnswersBtn.textContent = 'Edit Answers';
          editAnswersBtn.addEventListener('click', () => {
            openAnswersModal(puzzleNum, puzzleData.answers || []);
          });
          
          actionButtons.appendChild(editAllBtn);
          actionButtons.appendChild(editClueBtn);
          actionButtons.appendChild(editImagesBtn);
          actionButtons.appendChild(editAnswersBtn);
          
          actionsCell.appendChild(actionButtons);
          row.appendChild(actionsCell);
          
          // Add row to table
          puzzlesTable.appendChild(row);
        });
        
        if (keys.length === 0) {
          puzzlesTable.innerHTML = '<tr><td colspan="4">No puzzle data found. Add some puzzles to get started.</td></tr>';
        }
      } catch (error) {
        console.error('Error loading puzzles:', error);
        puzzlesTable.innerHTML = '<tr><td colspan="4">Error loading puzzles. Please try refreshing the page.</td></tr>';
      }
    }
    
    // Reorder a puzzle by changing its number
    async function reorderPuzzle(oldNumber, newNumber) {
      try {
        if (oldNumber === newNumber) return; // No change needed
        
        // Fetch all puzzle data
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'answers');
        if (!result.data) return;
        
        const puzzlesData = result.data;
        
        // Check if new number is already taken
        if (puzzlesData[newNumber]) {
          // If destination exists, we need to perform a swap operation
          const oldData = { ...puzzlesData[oldNumber] };
          const newData = { ...puzzlesData[newNumber] };
          
          // Update both puzzles
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${oldNumber}`,
            newData,
            'PUT'
          );
          
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${newNumber}`,
            oldData,
            'PUT'
          );
        } else {
          // Simple move operation - copy to new position and delete old
          const puzzleData = { ...puzzlesData[oldNumber] };
          
          // Save at new position
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${newNumber}`,
            puzzleData,
            'PUT'
          );
          
          // Delete from old position
          await saveToDatabase(
            Object.values(DB_PATHS),
            `answers/${oldNumber}`,
            null,
            'PUT'
          );
        }
        
        // Reload puzzles to reflect changes
        await loadPuzzles();
        showSuccessToast('Puzzle reordered successfully!');
      } catch (error) {
        console.error('Error reordering puzzle:', error);
        showFeedback('Error reordering puzzle. Please try again.', 'error');
      }
    }
    
    // Load players data
    async function loadPlayers() {
      try {
        // Try to load from all paths
        const paths = Object.values(DB_PATHS);
        const allPlayers = {};
        
        for (const path of paths) {
          try {
            const response = await fetch(`${DB_URL}/${path}/progress.json`);
            if (response.ok) {
              const data = await response.json();
              
              if (data) {
                Object.keys(data).forEach(userId => {
                  // Add source path to each player record
                  const playerData = data[userId];
                  playerData.sourcePath = path;
                  playerData.userId = userId;
                  
                  // Use userId as the key to avoid duplicates
                  allPlayers[userId] = playerData;
                });
              }
            }
          } catch (error) {
            console.error(`Error fetching players from ${path}:`, error);
          }
        }
        
        // Update players table
        playersTable.innerHTML = '';
        
        if (Object.keys(allPlayers).length === 0) {
          playersTable.innerHTML = '<tr><td colspan="5">No players found yet.</td></tr>';
          return;
        }
        
        // Sort players by most recent first
        const sortedPlayers = Object.values(allPlayers).sort((a, b) => {
          return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
        });
        
        sortedPlayers.forEach(player => {
          const row = document.createElement('tr');
          
          // Name cell
          const nameCell = document.createElement('td');
          nameCell.textContent = player.name || 'Anonymous';
          row.appendChild(nameCell);
          
          // Email cell
          const emailCell = document.createElement('td');
          emailCell.textContent = player.email || 'Not provided';
          row.appendChild(emailCell);
          
          // Progress cell
          const progressCell = document.createElement('td');
          let progressPercentage = 0;
          let statusClass = 'status-0';
          
          if (player.solved && Array.isArray(player.solved)) {
            const solvedCount = player.solved.filter(Boolean).length;
            progressPercentage = Math.round((solvedCount / 10) * 100);
            
            if (progressPercentage === 100) {
              statusClass = 'status-completed';
            } else if (progressPercentage > 0) {
              statusClass = 'status-inprogress';
            }
          }
          
          const statusPill = document.createElement('span');
          statusPill.className = `status-pill ${statusClass}`;
          statusPill.textContent = `${progressPercentage}%`;
          progressCell.appendChild(statusPill);
          row.appendChild(progressCell);
          
          // Current screen cell
          const screenCell = document.createElement('td');
          screenCell.textContent = player.currentScreen || '0';
          row.appendChild(screenCell);
          
          // Actions cell
          const actionsCell = document.createElement('td');
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn btn-icon';
          viewBtn.textContent = 'View';
          viewBtn.addEventListener('click', () => {
            showPlayerDetails(player);
          });
          actionsCell.appendChild(viewBtn);
          row.appendChild(actionsCell);
          
          // Add row to table
          playersTable.appendChild(row);
        });
        
      } catch (error) {
        console.error('Error loading players:', error);
        playersTable.innerHTML = '<tr><td colspan="5">Error loading players. Please try refreshing the page.</td></tr>';
      }
    }
    
    // Show player details
    function showPlayerDetails(player) {
      // Hide the players table parent
      document.querySelector('#players-table').parentNode.style.display = 'none';
      
      // Show details
      playerDetails.classList.remove('hidden');
      
      // Fill in details
      detailsName.textContent = player.name || 'Anonymous';
      detailsEmail.textContent = player.email || 'Not provided';
      detailsScreen.textContent = player.currentScreen || '0';
      detailsPath.textContent = player.sourcePath || 'Unknown';
      
      // Calculate progress percentage
      let progressPercentage = 0;
      if (player.solved && Array.isArray(player.solved)) {
        const solvedCount = player.solved.filter(Boolean).length;
        progressPercentage = Math.round((solvedCount / 10) * 100);
      }
      
      detailsPercentage.textContent = progressPercentage;
      detailsProgressBar.style.width = `${progressPercentage}%`;
      
      // Create puzzle status list
      detailsPuzzleStatus.innerHTML = '';
      if (player.solved && Array.isArray(player.solved)) {
        for (let i = 1; i <= 10; i++) {
          const isSolved = player.solved[i-1] || false;
          
          const statusItem = document.createElement('div');
          statusItem.style.margin = '5px 0';
          
          const statusCircle = document.createElement('span');
          statusCircle.style.display = 'inline-block';
          statusCircle.style.width = '12px';
          statusCircle.style.height = '12px';
          statusCircle.style.borderRadius = '50%';
          statusCircle.style.marginRight = '8px';
          statusCircle.style.backgroundColor = isSolved ? '#4caf50' : '#f44336';
          
          statusItem.appendChild(statusCircle);
          statusItem.appendChild(document.createTextNode(`Puzzle ${i}: ${isSolved ? 'Solved' : 'Not Solved'}`));
          
          detailsPuzzleStatus.appendChild(statusItem);
        }
      } else {
        detailsPuzzleStatus.textContent = 'No puzzle status data available.';
      }
      
      // Set up email button
      detailsEmailBtn.onclick = () => {
        const subject = encodeURIComponent('Wedding Puzzle Hint');
        const body = encodeURIComponent(`Hi ${player.name || 'there'},\n\nHere's a hint for the wedding puzzle you're working on:\n\n[Add your hint here]\n\nBest of luck!\n`);
        window.open(`mailto:${player.email}?subject=${subject}&body=${body}`);
      };
    }
    
    // Save a puzzle field
    async function savePuzzleField(puzzleNum, field, value) {
      try {
        const data = {};
        data[field] = value;
        
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${puzzleNum}`,
          data
        );
        
        if (result.success) {
          // Show save indicator
          const row = document.querySelector(`tr[data-puzzle-number="${puzzleNum}"]`);
          let saveIndicator = row.querySelector('.save-indicator');
          
          if (!saveIndicator) {
            saveIndicator = document.createElement('span');
            saveIndicator.className = 'save-indicator';
            saveIndicator.textContent = 'Saved!';
            row.appendChild(saveIndicator);
          }
          
          saveIndicator.classList.add('show');
          setTimeout(() => {
            saveIndicator.classList.remove('show');
          }, 2000);
        } else {
          console.error(`Failed to save ${field} for puzzle ${puzzleNum}`);
        }
      } catch (error) {
        console.error(`Error saving puzzle field:`, error);
      }
    }
    
    // Open the answers modal
    function openAnswersModal(puzzleNum, answers) {
      currentPuzzleBeingEdited = puzzleNum;
      currentAnswers = [...(answers || [])];
      
      // Clear the container
      answersContainer.innerHTML = '';
      
      // Add fields for each answer
      if (currentAnswers && currentAnswers.length > 0) {
        currentAnswers.forEach(answer => {
          addAnswerField(answer || { text: '', questionText: '' });
        });
      } else {
        // Add at least one empty answer field
        addAnswerField({ text: '', questionText: '' });
      }
      
      // Fetch the current puzzle to get wrong answer messages
      fetch(`${DB_URL}/${successfulPuzzlePath || DB_PATHS.primary}/answers/${puzzleNum}.json`)
        .then(response => response.json())
        .then(puzzleData => {
          // Set wrong answer messages if available
          document.getElementById('answer-wrong-message').value = 
            puzzleData?.wrongAnswerMessage || "That's not right. Try again!";
          document.getElementById('answer-partial-message').value = 
            puzzleData?.partialCorrectMessage || "Some answers are wrong. Keep trying!";
        })
        .catch(error => {
          console.error('Error fetching puzzle data:', error);
          // Use defaults if fetch fails
          document.getElementById('answer-wrong-message').value = "That's not right. Try again!";
          document.getElementById('answer-partial-message').value = "Some answers are wrong. Keep trying!";
        });
      
      // Show the modal
      openModal(answerModal);
    }
    
    // Open the images modal
    function openImageModal(puzzleNum, imageUrls) {
      currentPuzzleBeingEdited = puzzleNum;
      currentImages = [...(imageUrls || [])];
      
      // Clear the container
      imagesContainer.innerHTML = '';
      
      // Add fields for each image
      if (currentImages && currentImages.length > 0) {
        currentImages.forEach(url => {
          addImageField({ url });
        });
      } else {
        // Add at least one empty image field
        addImageField({ url: '' });
      }
      
      // Show the modal
      openModal(imageModal);
    }
    
    // Open the richtext modal
    function openRichtextModal(puzzleNum, content) {
      currentPuzzleBeingEdited = puzzleNum;
      
      // Set editor content
      quill.root.innerHTML = content;
      
      // Update preview
      richtextPreview.innerHTML = content;
      
      // Show the modal
      openModal(richtextModal);
    }
    
    // Close all modals
    function closeAllModals() {
      closeModal(answerModal);
      closeModal(imageModal);
      closeModal(richtextModal);
    }
    
    // Close a specific modal
    function closeModal(modal) {
      modal.classList.remove('visible');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    // Open a specific modal
    function openModal(modal) {
      modal.style.display = 'flex';
      setTimeout(() => {
        modal.classList.add('visible');
      }, 10);
    }
    
    // Add an answer field to the modal
    function addAnswerField(answer = {}) {
      const answerRow = document.createElement('div');
      answerRow.className = 'answer-row';
      
      // Answer text field
      const answerTextGroup = document.createElement('div');
      answerTextGroup.className = 'form-group';
      
      const answerTextLabel = document.createElement('label');
      answerTextLabel.textContent = 'Answer Text:';
      
      const answerTextInput = document.createElement('input');
      answerTextInput.type = 'text';
      answerTextInput.className = 'answer-text';
      answerTextInput.value = (answer && answer.text) || '';
      answerTextInput.placeholder = 'Correct answer text';
      
      answerTextGroup.appendChild(answerTextLabel);
      answerTextGroup.appendChild(answerTextInput);
      
      // Question text field
      const questionTextGroup = document.createElement('div');
      questionTextGroup.className = 'form-group';
      questionTextGroup.style.marginTop = '10px';
      
      const questionTextLabel = document.createElement('label');
      questionTextLabel.textContent = 'Question Text:';
      
      const questionTextInput = document.createElement('input');
      questionTextInput.type = 'text';
      questionTextInput.className = 'question-text';
      questionTextInput.value = (answer && answer.questionText) || 'Your Answer:';
      questionTextInput.placeholder = 'Label for the answer field (e.g., "Your Answer:")';
      
      questionTextGroup.appendChild(questionTextLabel);
      questionTextGroup.appendChild(questionTextInput);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-answer-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this answer';
      removeBtn.addEventListener('click', function() {
        answerRow.style.opacity = '0';
        setTimeout(() => {
          answerRow.remove();
        }, 300);
      });
      
      // Add everything to the row
      answerRow.appendChild(removeBtn);
      answerRow.appendChild(answerTextGroup);
      answerRow.appendChild(questionTextGroup);
      
      // Add row to container
      answersContainer.appendChild(answerRow);
      
      // Focus the new field
      answerTextInput.focus();
    }
    
    // Add an image field to the modal
    function addImageField(image = {}) {
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';
      
      // Image URL field
      const urlLabel = document.createElement('label');
      urlLabel.textContent = 'Image URL:';
      
      const urlInput = document.createElement('input');
      urlInput.type = 'text';
      urlInput.className = 'image-url';
      urlInput.value = (image && image.url) || '';
      urlInput.placeholder = 'Enter image URL here';
      
      // Preview section
      const preview = document.createElement('div');
      preview.className = 'image-preview';
      
      // Check if URL is valid and show preview
      const updatePreview = () => {
        const url = urlInput.value.trim();
        
        // Clear existing content
        preview.innerHTML = '';
        
        if (url) {
          // Try to load image
          const img = document.createElement('img');
          const errorMsg = document.createElement('div');
          errorMsg.className = 'image-preview-error';
          errorMsg.textContent = 'Could not load image';
          
          img.onload = () => {
            // Image loaded successfully
            preview.innerHTML = '';
            preview.appendChild(img);
          };
          
          img.onerror = () => {
            // Image failed to load
            preview.innerHTML = '';
            preview.appendChild(errorMsg);
          };
          
          img.src = url;
        }
      };
      
      // Update preview on input
      urlInput.addEventListener('input', debounce(updatePreview, 500));
      
      // Initial preview
      setTimeout(updatePreview, 100);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-image-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this image';
      removeBtn.addEventListener('click', function() {
        imageItem.style.opacity = '0';
        setTimeout(() => {
          imageItem.remove();
        }, 300);
      });
      
      // Add everything to the item
      imageItem.appendChild(removeBtn);
      imageItem.appendChild(urlLabel);
      imageItem.appendChild(urlInput);
      imageItem.appendChild(preview);
      
      // Add item to container
      imagesContainer.appendChild(imageItem);
      
      // Focus the new field
      urlInput.focus();
    }
    
    // Save answers from the modal
    async function saveAnswers() {
      try {
        // Collect answers from all fields
        const answerRows = answersContainer.querySelectorAll('.answer-row');
        const answers = [];
        
        answerRows.forEach(row => {
          try {
            const answerText = row.querySelector('.answer-text')?.value?.trim() || '';
            const questionText = row.querySelector('.question-text')?.value?.trim() || '';
            
            if (answerText) {  // Only add if there's an answer text
              answers.push({
                text: answerText,
                questionText: questionText || 'Your Answer:'
              });
            }
          } catch (err) {
            console.warn('Error processing answer row:', err);
          }
        });
        
        // Make sure we have at least one answer
        if (answers.length === 0) {
          answers.push({
            text: '',
            questionText: 'Your Answer:'
          });
        }
        
        // Get wrong answer messages
        const wrongAnswerMessage = document.getElementById('answer-wrong-message').value.trim();
        const partialCorrectMessage = document.getElementById('answer-partial-message').value.trim();
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          { 
            answers,
            wrongAnswerMessage,
            partialCorrectMessage
          }
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(answerModal);
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Answers saved successfully!');
        } else {
          alert('Error saving answers. Please try again.');
        }
      } catch (error) {
        console.error('Error saving answers:', error);
        alert('Error saving answers. Please try again: ' + error.message);
      }
    }
    
    // Save images from the modal
    async function saveImages() {
      try {
        // Collect image URLs from all fields
        const imageItems = imagesContainer.querySelectorAll('.image-item');
        const imageUrls = [];
        
        imageItems.forEach(item => {
          try {
            const url = item.querySelector('.image-url')?.value?.trim() || '';
            
            if (url) {  // Only add if there's a URL
              imageUrls.push(url);
            }
          } catch (err) {
            console.warn('Error processing image item:', err);
          }
        });
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          { imageUrls }
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(imageModal);
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Images saved successfully!');
        } else {
          alert('Error saving images. Please try again.');
        }
      } catch (error) {
        console.error('Error saving images:', error);
        alert('Error saving images. Please try again: ' + error.message);
      }
    }
    
    // Save richtext content
    async function saveRichtext() {
      try {
        // Get content from editor
        const content = quill.root.innerHTML;
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          { 
            clueHtml: content,
            clue: quill.getText() // Also save plain text version
          }
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(richtextModal);
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Clue content saved successfully!');
        } else {
          alert('Error saving clue content. Please try again.');
        }
      } catch (error) {
        console.error('Error saving clue content:', error);
        alert('Error saving clue content. Please try again: ' + error.message);
      }
    }
    
    // Show a success toast message
    function showSuccessToast(message) {
      const tempMsg = document.createElement('div');
      tempMsg.style.position = 'fixed';
      tempMsg.style.bottom = '20px';
      tempMsg.style.right = '20px';
      tempMsg.style.padding = '10px 20px';
      tempMsg.style.backgroundColor = '#4caf50';
      tempMsg.style.color = 'white';
      tempMsg.style.borderRadius = '4px';
      tempMsg.style.zIndex = '9999';
      tempMsg.textContent = message;
      document.body.appendChild(tempMsg);
      
      setTimeout(() => {
        tempMsg.style.opacity = '0';
        tempMsg.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 500);
      }, 2000);
    }
    
    // Show a feedback toast message
    function showFeedback(message, type) {
      const tempMsg = document.createElement('div');
      tempMsg.style.position = 'fixed';
      tempMsg.style.bottom = '20px';
      tempMsg.style.right = '20px';
      tempMsg.style.padding = '15px 25px';
      tempMsg.style.backgroundColor = type === 'success' ? '#4caf50' : '#f44336';
      tempMsg.style.color = 'white';
      tempMsg.style.borderRadius = '8px';
      tempMsg.style.zIndex = '9999';
      tempMsg.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      tempMsg.style.fontWeight = '500';
      tempMsg.textContent = message;
      document.body.appendChild(tempMsg);
      
      setTimeout(() => {
        tempMsg.style.opacity = '0';
        tempMsg.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
          document.body.removeChild(tempMsg);
        }, 500);
      }, 3000);
    }
    
    // Helper function to format date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      
      try {
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return timestamp;
      }
    }
    
    // Helper for HTML escaping
    function escapeHTML(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Debounce function to limit how often a function is called
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
    
    // Add a new puzzle directly to the table without the form
    async function addNewPuzzleDirectly() {
      try {
        // Get the highest puzzle number currently in use
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'answers');
        const puzzlesData = result.data || {};
        
        const puzzleNumbers = Object.keys(puzzlesData)
          .filter(key => !isNaN(parseInt(key)))
          .map(key => parseInt(key));
        
        // Find the next available number
        const nextNumber = puzzleNumbers.length > 0 ? Math.max(...puzzleNumbers) + 1 : 1;
        
        // Create a default puzzle
        const newPuzzle = {
          name: `Puzzle #${nextNumber}`,
          clue: '',
          imageUrls: [],
          answers: [{ text: '', questionText: 'Your Answer:' }]
        };
        
        // Add to database
        const saveResult = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${nextNumber}`,
          newPuzzle,
          'PUT'
        );
        
        if (saveResult.success) {
          // Update total puzzles count if needed
          const totalPuzzleCount = puzzleNumbers.length + 1;
          await saveToDatabase(
            Object.values(DB_PATHS),
            'totalPuzzles',
            totalPuzzleCount,
            'PUT'
          );
          
          // Reload puzzles to show the new one
          await loadPuzzles();
          showSuccessToast('New puzzle added successfully!');
          
          // Scroll to the bottom of the table to show the new puzzle
          const table = document.getElementById('puzzles-table');
          table.scrollIntoView({ behavior: 'smooth', block: 'end' });
        } else {
          showFeedback('Error adding new puzzle. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error adding new puzzle:', error);
        showFeedback('Error adding new puzzle: ' + error.message, 'error');
      }
    }
    
    // Open comprehensive puzzle edit modal
    function openPuzzleEditModal(puzzleNum, puzzleData) {
      currentPuzzleBeingEdited = puzzleNum;
      
      // Set the puzzle number in the header
      document.getElementById('edit-puzzle-number').textContent = puzzleNum;
      
      // Set up tabs
      document.getElementById('puzzle-tab-basic').classList.add('active');
      document.getElementById('puzzle-tab-clue').classList.remove('active');
      document.getElementById('puzzle-tab-images').classList.remove('active');
      document.getElementById('puzzle-tab-answers').classList.remove('active');
      
      document.getElementById('puzzle-basic-tab').classList.add('active');
      document.getElementById('puzzle-clue-tab').classList.remove('active');
      document.getElementById('puzzle-images-tab').classList.remove('active');
      document.getElementById('puzzle-answers-tab').classList.remove('active');
      
      // Basic info
      document.getElementById('edit-puzzle-name').value = puzzleData.name || `Puzzle #${puzzleNum}`;
      document.getElementById('edit-wrong-answer-message').value = puzzleData.wrongAnswerMessage || "That's not right. Try again!";
      document.getElementById('edit-partial-correct-message').value = puzzleData.partialCorrectMessage || "Some answers are wrong. Keep trying!";
      
      // Set up rich text editor if not already initialized
      let editQuill = Quill.find(document.getElementById('edit-puzzle-richtext'));
      if (!editQuill) {
        editQuill = new Quill('#edit-puzzle-richtext', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline', 'strike'],
              ['blockquote', 'code-block'],
              [{ 'header': 1 }, { 'header': 2 }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'align': [] }],
              ['link', 'image'],
              ['clean']
            ]
          }
        });
        
        // Update preview when editor content changes
        editQuill.on('text-change', function() {
          document.getElementById('edit-puzzle-preview').innerHTML = editQuill.root.innerHTML;
        });
      }
      
      // Set clue content
      editQuill.root.innerHTML = puzzleData.clueHtml || puzzleData.clue || '';
      document.getElementById('edit-puzzle-preview').innerHTML = editQuill.root.innerHTML;
      
      // Set up images
      const imagesContainer = document.getElementById('edit-puzzle-images');
      imagesContainer.innerHTML = '';
      
      // Add fields for each image
      if (puzzleData.imageUrls && puzzleData.imageUrls.length > 0) {
        puzzleData.imageUrls.forEach(url => {
          addImageFieldToEditModal(url);
        });
      } else {
        // Add at least one empty image field
        addImageFieldToEditModal('');
      }
      
      // Set up answers
      const answersContainer = document.getElementById('edit-puzzle-answers');
      answersContainer.innerHTML = '';
      
      // Add fields for each answer
      if (puzzleData.answers && puzzleData.answers.length > 0) {
        puzzleData.answers.forEach(answer => {
          addAnswerFieldToEditModal(answer);
        });
      } else {
        // Add at least one empty answer field
        addAnswerFieldToEditModal({ text: '', questionText: 'Your Answer:' });
      }
      
      // Set up tab switching
      document.getElementById('puzzle-tab-basic').addEventListener('click', function() {
        switchPuzzleTab('basic');
      });
      
      document.getElementById('puzzle-tab-clue').addEventListener('click', function() {
        switchPuzzleTab('clue');
      });
      
      document.getElementById('puzzle-tab-images').addEventListener('click', function() {
        switchPuzzleTab('images');
      });
      
      document.getElementById('puzzle-tab-answers').addEventListener('click', function() {
        switchPuzzleTab('answers');
      });
      
      // Set up add buttons
      document.getElementById('edit-puzzle-add-image').addEventListener('click', function() {
        addImageFieldToEditModal('');
      });
      
      document.getElementById('edit-puzzle-add-answer').addEventListener('click', function() {
        addAnswerFieldToEditModal({ text: '', questionText: 'Your Answer:' });
      });
      
      // Set up save button
      document.getElementById('save-puzzle-btn').addEventListener('click', function() {
        savePuzzleFromEditModal();
      });
      
      // Show the modal
      openModal(document.getElementById('puzzle-edit-modal'));
    }
    
    // Switch between tabs in the puzzle edit modal
    function switchPuzzleTab(tab) {
      // Remove active class from all tabs
      document.getElementById('puzzle-tab-basic').classList.remove('active');
      document.getElementById('puzzle-tab-clue').classList.remove('active');
      document.getElementById('puzzle-tab-images').classList.remove('active');
      document.getElementById('puzzle-tab-answers').classList.remove('active');
      
      document.getElementById('puzzle-basic-tab').classList.remove('active');
      document.getElementById('puzzle-clue-tab').classList.remove('active');
      document.getElementById('puzzle-images-tab').classList.remove('active');
      document.getElementById('puzzle-answers-tab').classList.remove('active');
      
      // Add active class to selected tab
      document.getElementById(`puzzle-tab-${tab}`).classList.add('active');
      document.getElementById(`puzzle-${tab}-tab`).classList.add('active');
    }
    
    // Add an image field to the edit modal
    function addImageFieldToEditModal(url) {
      const imageItem = document.createElement('div');
      imageItem.className = 'image-item';
      
      // Image URL field
      const urlLabel = document.createElement('label');
      urlLabel.textContent = 'Image URL:';
      
      const urlInput = document.createElement('input');
      urlInput.type = 'text';
      urlInput.className = 'edit-image-url';
      urlInput.value = url || '';
      urlInput.placeholder = 'Enter image URL here';
      
      // Preview section
      const preview = document.createElement('div');
      preview.className = 'image-preview';
      
      // Update preview on input
      urlInput.addEventListener('input', debounce(() => {
        const url = urlInput.value.trim();
        
        // Clear existing content
        preview.innerHTML = '';
        
        if (url) {
          // Try to load image
          const img = document.createElement('img');
          const errorMsg = document.createElement('div');
          errorMsg.className = 'image-preview-error';
          errorMsg.textContent = 'Could not load image';
          
          img.onload = () => {
            preview.innerHTML = '';
            preview.appendChild(img);
          };
          
          img.onerror = () => {
            preview.innerHTML = '';
            preview.appendChild(errorMsg);
          };
          
          img.src = url;
        }
      }, 500));
      
      // Initial preview
      setTimeout(() => {
        const url = urlInput.value.trim();
        if (url) {
          const img = document.createElement('img');
          img.src = url;
          preview.appendChild(img);
        }
      }, 100);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-image-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this image';
      removeBtn.addEventListener('click', function() {
        imageItem.style.opacity = '0';
        setTimeout(() => {
          imageItem.remove();
        }, 300);
      });
      
      // Add everything to the item
      imageItem.appendChild(removeBtn);
      imageItem.appendChild(urlLabel);
      imageItem.appendChild(urlInput);
      imageItem.appendChild(preview);
      
      // Add item to container
      document.getElementById('edit-puzzle-images').appendChild(imageItem);
    }
    
    // Add an answer field to the edit modal
    function addAnswerFieldToEditModal(answer) {
      const answerRow = document.createElement('div');
      answerRow.className = 'answer-row';
      
      // Answer text field
      const answerTextGroup = document.createElement('div');
      answerTextGroup.className = 'form-group';
      
      const answerTextLabel = document.createElement('label');
      answerTextLabel.textContent = 'Answer Text:';
      
      const answerTextInput = document.createElement('input');
      answerTextInput.type = 'text';
      answerTextInput.className = 'edit-answer-text';
      answerTextInput.value = (answer && answer.text) || '';
      answerTextInput.placeholder = 'Correct answer text';
      
      answerTextGroup.appendChild(answerTextLabel);
      answerTextGroup.appendChild(answerTextInput);
      
      // Question text field
      const questionTextGroup = document.createElement('div');
      questionTextGroup.className = 'form-group';
      questionTextGroup.style.marginTop = '10px';
      
      const questionTextLabel = document.createElement('label');
      questionTextLabel.textContent = 'Question Text:';
      
      const questionTextInput = document.createElement('input');
      questionTextInput.type = 'text';
      questionTextInput.className = 'edit-question-text';
      questionTextInput.value = (answer && answer.questionText) || 'Your Answer:';
      questionTextInput.placeholder = 'Label for the answer field (e.g., "Your Answer:")';
      
      questionTextGroup.appendChild(questionTextLabel);
      questionTextGroup.appendChild(questionTextInput);
      
      // Remove button
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-answer-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.title = 'Remove this answer';
      removeBtn.addEventListener('click', function() {
        answerRow.style.opacity = '0';
        setTimeout(() => {
          answerRow.remove();
        }, 300);
      });
      
      // Add everything to the row
      answerRow.appendChild(removeBtn);
      answerRow.appendChild(answerTextGroup);
      answerRow.appendChild(questionTextGroup);
      
      // Add row to container
      document.getElementById('edit-puzzle-answers').appendChild(answerRow);
    }
    
    // Save puzzle from edit modal
    async function savePuzzleFromEditModal() {
      try {
        // Get all the data from the modal
        const name = document.getElementById('edit-puzzle-name').value.trim() || `Puzzle #${currentPuzzleBeingEdited}`;
        const wrongAnswerMessage = document.getElementById('edit-wrong-answer-message').value.trim();
        const partialCorrectMessage = document.getElementById('edit-partial-correct-message').value.trim();
        
        // Get clue content
        const editQuill = Quill.find(document.getElementById('edit-puzzle-richtext'));
        const clueHtml = editQuill.root.innerHTML;
        const clue = editQuill.getText().trim();
        
        // Get image URLs
        const imageItems = document.getElementById('edit-puzzle-images').querySelectorAll('.image-item');
        const imageUrls = [];
        
        imageItems.forEach(item => {
          const url = item.querySelector('.edit-image-url')?.value?.trim() || '';
          if (url) {
            imageUrls.push(url);
          }
        });
        
        // Get answers
        const answerRows = document.getElementById('edit-puzzle-answers').querySelectorAll('.answer-row');
        const answers = [];
        
        answerRows.forEach(row => {
          const answerText = row.querySelector('.edit-answer-text')?.value?.trim() || '';
          const questionText = row.querySelector('.edit-question-text')?.value?.trim() || 'Your Answer:';
          
          if (answerText) {
            answers.push({
              text: answerText,
              questionText: questionText
            });
          }
        });
        
        // Make sure we have at least one answer
        if (answers.length === 0) {
          answers.push({
            text: '',
            questionText: 'Your Answer:'
          });
        }
        
        // Create complete puzzle data
        const puzzleData = {
          name,
          clueHtml,
          clue,
          imageUrls,
          answers,
          wrongAnswerMessage,
          partialCorrectMessage
        };
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          `answers/${currentPuzzleBeingEdited}`,
          puzzleData,
          'PUT'
        );
        
        if (result.success) {
          // Close modal and refresh data
          closeModal(document.getElementById('puzzle-edit-modal'));
          loadPuzzles();
          
          // Show a temporary success message
          showSuccessToast('Puzzle saved successfully!');
        } else {
          alert('Error saving puzzle. Please try again.');
        }
      } catch (error) {
        console.error('Error saving puzzle:', error);
        alert('Error saving puzzle. Please try again: ' + error.message);
      }
    }
  </script>
</body>
</html> 