<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Wedding Admin</title>
  <script src="/js/components/autoload-banner.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      margin-top: 60px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2rem;
      font-weight: bold;
    }
    
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #333;
    }
    
    .tab-nav {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    
    .tab-nav button {
      background: none;
      border: none;
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-nav button.active {
      color: #000;
      border-bottom-color: #000;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: bold;
      color: #333;
      border-bottom: 2px solid #ddd;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    tr:hover {
      background-color: #f9f9f9;
    }
    
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    textarea {
      min-height: 100px;
      font-family: inherit;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
      opacity: 0.9;
    }
    
    .btn-secondary {
      background-color: #666;
    }
    
    .status-pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: white;
      background-color: #999;
    }
    
    .status-pill.status-0 {
      background-color: #f44336; /* Not started */
    }
    
    .status-pill.status-solved {
      background-color: #4caf50; /* Solved */
    }
    
    .status-pill.status-inprogress {
      background-color: #2196f3; /* In progress */
    }
    
    .status-pill.status-completed {
      background-color: #9c27b0; /* All completed */
    }
    
    .player-details {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .progress-bar {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #4caf50;
      transition: width 0.3s ease;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-close {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .save-indicator {
      font-size: 12px;
      color: #4caf50;
      margin-left: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .save-indicator.show {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .tab-nav {
        flex-direction: column;
      }
      
      .tab-nav button {
        width: 100%;
        text-align: left;
        margin-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wedding Puzzle Admin</h1>
    
    <div id="loading-screen">
      <div class="loader"></div>
      <p style="text-align: center; color: #666;">Loading admin panel...</p>
    </div>
    
    <div id="not-admin-screen" class="card hidden">
      <h2>Access Denied</h2>
      <p>You do not have permission to access this page. Please log in with an admin account.</p>
      <a href="/account" class="btn">Go to Account</a>
    </div>
    
    <div id="admin-panel" class="hidden">
      <div class="tab-nav">
        <button id="tab-puzzles" class="active">Puzzles</button>
        <button id="tab-players">Players</button>
      </div>
      
      <div id="puzzles-tab" class="tab-content card active">
        <h2>Wedding Puzzles</h2>
        <p>Edit puzzle answers and clues below. Changes are saved automatically.</p>
        
        <table id="puzzles-table">
          <thead>
            <tr>
              <th style="width: 10%;">#</th>
              <th style="width: 35%;">Answer</th>
              <th style="width: 45%;">Clue</th>
              <th style="width: 10%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Puzzle rows will be inserted here -->
          </tbody>
        </table>
      </div>
      
      <div id="players-tab" class="tab-content card hidden">
        <h2>Players Progress</h2>
        <p>View and manage players' progress through the wedding puzzle.</p>
        
        <table id="players-table">
          <thead>
            <tr>
              <th style="width: 25%;">Name</th>
              <th style="width: 25%;">Email</th>
              <th style="width: 10%;">Progress</th>
              <th style="width: 15%;">Current Screen</th>
              <th style="width: 15%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Player rows will be inserted here -->
          </tbody>
        </table>
        
        <div id="player-details" class="player-details hidden">
          <h3 id="details-name">Player Name</h3>
          <p><strong>Email:</strong> <span id="details-email"></span></p>
          <p><strong>Current Screen:</strong> <span id="details-screen"></span></p>
          <p><strong>Progress:</strong> <span id="details-percentage"></span>%</p>
          
          <div class="progress-bar">
            <div id="details-progress-bar" class="progress-bar-fill" style="width: 0%;"></div>
          </div>
          
          <h4 style="margin-top: 20px;">Puzzle Status</h4>
          <div id="details-puzzle-status"></div>
          
          <div style="margin-top: 20px;">
            <button id="details-email-btn" class="btn btn-secondary">Send Hint Email</button>
            <button id="details-back-btn" class="btn">Back to List</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Player Detail Modal -->
  <div id="player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Player Details</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.firebaseapp.com",
      messagingSenderId: "401826818140",
      appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
      measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // DOM Elements
    const loadingScreen = document.getElementById('loading-screen');
    const notAdminScreen = document.getElementById('not-admin-screen');
    const adminPanel = document.getElementById('admin-panel');
    
    const tabPuzzles = document.getElementById('tab-puzzles');
    const tabPlayers = document.getElementById('tab-players');
    const puzzlesTab = document.getElementById('puzzles-tab');
    const playersTab = document.getElementById('players-tab');
    
    const puzzlesTable = document.getElementById('puzzles-table').querySelector('tbody');
    const playersTable = document.getElementById('players-table').querySelector('tbody');
    
    const playerDetails = document.getElementById('player-details');
    const detailsName = document.getElementById('details-name');
    const detailsEmail = document.getElementById('details-email');
    const detailsScreen = document.getElementById('details-screen');
    const detailsPercentage = document.getElementById('details-percentage');
    const detailsProgressBar = document.getElementById('details-progress-bar');
    const detailsPuzzleStatus = document.getElementById('details-puzzle-status');
    const detailsEmailBtn = document.getElementById('details-email-btn');
    const detailsBackBtn = document.getElementById('details-back-btn');
    
    // Modal elements
    const playerModal = document.getElementById('player-modal');
    const modalClose = document.querySelector('.modal-close');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    
    // Store timeouts for debounced saves
    const saveTimeouts = {};
    
    // Helper function to format date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Check if user is admin
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
          const userData = userSnapshot.val() || {};
          
          // Check if user has admin role (supports both array and string format)
          let isAdmin = false;
          if (userData.roles && Array.isArray(userData.roles)) {
            isAdmin = userData.roles.includes('admin');
          } else if (userData.role) {
            isAdmin = userData.role === 'admin';
          }
          
          if (isAdmin) {
            // User is admin, show admin panel
            loadingScreen.classList.add('hidden');
            notAdminScreen.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            
            // Load data
            loadPuzzles();
            loadPlayers();
          } else {
            // Not an admin
            loadingScreen.classList.add('hidden');
            notAdminScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
          }
        } catch (error) {
          console.error('Error checking admin status:', error);
          loadingScreen.classList.add('hidden');
          notAdminScreen.classList.remove('hidden');
        }
      } else {
        // Not logged in
        window.location.href = '/account';
      }
    });
    
    // Tab navigation
    tabPuzzles.addEventListener('click', () => {
      tabPuzzles.classList.add('active');
      tabPlayers.classList.remove('active');
      puzzlesTab.classList.add('active');
      playersTab.classList.remove('active');
      playerDetails.classList.add('hidden');
    });
    
    tabPlayers.addEventListener('click', () => {
      tabPuzzles.classList.remove('active');
      tabPlayers.classList.add('active');
      puzzlesTab.classList.remove('active');
      playersTab.classList.add('active');
    });
    
    // Load puzzles
    async function loadPuzzles() {
      try {
        // Clear table first
        puzzlesTable.innerHTML = '';
        
        // Get answers data
        const answersRef = db.ref('wedding/answers');
        const snapshot = await answersRef.once('value');
        const data = snapshot.val() || {};
        
        // Create rows for puzzles 1-10
        for (let i = 1; i <= 10; i++) {
          const puzzle = data[i] || { answer: '', clue: '' };
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>#${i}</td>
            <td>
              <input 
                type="text" 
                data-puzzle="${i}" 
                data-field="answer" 
                value="${escapeHTML(puzzle.answer || '')}" 
                placeholder="Enter answer..."
              >
              <span class="save-indicator" id="save-answer-${i}">Saved ✓</span>
            </td>
            <td>
              <textarea 
                data-puzzle="${i}" 
                data-field="clue" 
                placeholder="Enter clue text..."
              >${escapeHTML(puzzle.clue || '')}</textarea>
              <span class="save-indicator" id="save-clue-${i}">Saved ✓</span>
            </td>
            <td>
              <input 
                type="text" 
                data-puzzle="${i}" 
                data-field="imageUrl" 
                value="${escapeHTML(puzzle.imageUrl || '')}" 
                placeholder="Image URL (optional)"
                style="margin-bottom: 5px;"
              >
              <span class="save-indicator" id="save-image-${i}">Saved ✓</span>
            </td>
          `;
          
          puzzlesTable.appendChild(row);
        }
        
        // Add event listeners for inputs
        const inputs = puzzlesTable.querySelectorAll('input, textarea');
        inputs.forEach(input => {
          input.addEventListener('input', handlePuzzleChange);
        });
        
      } catch (error) {
        console.error('Error loading puzzles:', error);
        alert('Error loading puzzles. Please try again.');
      }
    }
    
    // Handle changes to puzzle data
    function handlePuzzleChange(e) {
      const puzzle = e.target.dataset.puzzle;
      const field = e.target.dataset.field;
      const value = e.target.value;
      
      // Clear any existing timeout for this field
      if (saveTimeouts[`${puzzle}-${field}`]) {
        clearTimeout(saveTimeouts[`${puzzle}-${field}`]);
      }
      
      // Debounce save (wait 500ms after typing stops)
      saveTimeouts[`${puzzle}-${field}`] = setTimeout(() => {
        savePuzzleData(puzzle, field, value);
      }, 500);
    }
    
    // Save puzzle data to database
    async function savePuzzleData(puzzle, field, value) {
      try {
        const updateData = {};
        updateData[field] = value;
        
        await db.ref(`wedding/answers/${puzzle}`).update(updateData);
        
        // Show saved indicator
        const indicator = document.getElementById(`save-${field}-${puzzle}`);
        indicator.classList.add('show');
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
        
      } catch (error) {
        console.error('Error saving puzzle data:', error);
        alert(`Error saving ${field} for puzzle #${puzzle}. Please try again.`);
      }
    }
    
    // Load players
    async function loadPlayers() {
      try {
        // Clear table first
        playersTable.innerHTML = '';
        
        // Get progress data
        const progressRef = db.ref('wedding/progress');
        const snapshot = await progressRef.once('value');
        const data = snapshot.val() || {};
        
        // No players yet
        if (!snapshot.exists()) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="5" style="text-align: center;">No players have started the puzzle yet.</td>
          `;
          playersTable.appendChild(row);
          return;
        }
        
        // Create rows for each player
        Object.entries(data).forEach(([userId, player]) => {
          if (!player || !player.name) return; // Skip invalid entries
          
          // Calculate completion percentage
          const currentScreen = player.currentScreen || 0;
          const solvedCount = player.solved ? player.solved.filter(Boolean).length : 0;
          const percentage = Math.round((solvedCount / 10) * 100);
          
          // Get status label
          let status = 'Not Started';
          let statusClass = 'status-0';
          
          if (currentScreen === 11) {
            status = 'Completed';
            statusClass = 'status-completed';
          } else if (currentScreen > 1) {
            status = 'In Progress';
            statusClass = 'status-inprogress';
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(player.name)}</td>
            <td>${escapeHTML(player.email || 'No email')}</td>
            <td>
              <div class="progress-bar" style="width: 100%; margin: 0;">
                <div class="progress-bar-fill" style="width: ${percentage}%;"></div>
              </div>
              <div style="text-align: center; font-size: 12px; margin-top: 4px;">${percentage}%</div>
            </td>
            <td>
              <span class="status-pill ${statusClass}">${status}</span>
              <div style="font-size: 12px; margin-top: 4px;">Screen ${currentScreen}</div>
            </td>
            <td>
              <button class="btn btn-secondary view-player" data-id="${userId}">View Details</button>
            </td>
          `;
          
          playersTable.appendChild(row);
        });
        
        // Add event listeners for view buttons
        const viewButtons = playersTable.querySelectorAll('.view-player');
        viewButtons.forEach(button => {
          button.addEventListener('click', () => {
            const userId = button.dataset.id;
            viewPlayerDetails(userId);
          });
        });
        
      } catch (error) {
        console.error('Error loading players:', error);
        alert('Error loading players. Please try again.');
      }
    }
    
    // View player details
    async function viewPlayerDetails(userId) {
      try {
        // Hide player list, show details
        document.querySelector('#players-table').parentNode.style.display = 'none';
        playerDetails.classList.remove('hidden');
        
        // Get player data
        const playerRef = db.ref(`wedding/progress/${userId}`);
        const snapshot = await playerRef.once('value');
        const player = snapshot.val();
        
        if (!player) {
          alert('Player data not found.');
          return;
        }
        
        // Calculate completion
        const currentScreen = player.currentScreen || 0;
        const solvedCount = player.solved ? player.solved.filter(Boolean).length : 0;
        const percentage = Math.round((solvedCount / 10) * 100);
        
        // Update details view
        detailsName.textContent = player.name || 'Unknown Player';
        detailsEmail.textContent = player.email || 'No email provided';
        detailsScreen.textContent = currentScreen;
        detailsPercentage.textContent = percentage;
        detailsProgressBar.style.width = `${percentage}%`;
        
        // Email button
        detailsEmailBtn.onclick = () => {
          const subject = encodeURIComponent('Wedding Puzzle Hint');
          const body = encodeURIComponent(`Hi ${player.name},\n\nHere's a hint for puzzle #${currentScreen}:\n\n[Insert your hint here]\n\nGood luck!\n\n`);
          window.open(`mailto:${player.email}?subject=${subject}&body=${body}`);
        };
        
        // Create puzzle status entries
        detailsPuzzleStatus.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
          const solved = player.solved && player.solved[i-1];
          const statusClass = solved ? 'status-solved' : (i < currentScreen ? 'status-solved' : 'status-0');
          const statusText = solved ? 'Solved' : (i < currentScreen ? 'Completed' : 'Not Started');
          
          const item = document.createElement('div');
          item.style.margin = '8px 0';
          item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>Puzzle #${i}</span>
              <span class="status-pill ${statusClass}">${statusText}</span>
            </div>
          `;
          
          detailsPuzzleStatus.appendChild(item);
        }
        
      } catch (error) {
        console.error('Error loading player details:', error);
        alert('Error loading player details. Please try again.');
      }
    }
    
    // Back button for player details
    detailsBackBtn.addEventListener('click', () => {
      document.querySelector('#players-table').parentNode.style.display = 'block';
      playerDetails.classList.add('hidden');
    });
    
    // Modal close button
    modalClose.addEventListener('click', () => {
      playerModal.style.display = 'none';
    });
    
    // Click outside modal to close
    window.addEventListener('click', (event) => {
      if (event.target === playerModal) {
        playerModal.style.display = 'none';
      }
    });
    
    // Utility to escape HTML
    function escapeHTML(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html> 