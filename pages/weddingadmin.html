<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wedding Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Add rich text editor dependencies -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2rem;
      font-weight: bold;
    }
    
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #333;
    }
    
    #auth-message {
      text-align: center;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #f44336;
    }
    
    .tab-nav {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    
    .tab-nav button {
      background: none;
      border: none;
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-nav button.active {
      color: #000;
      border-bottom-color: #000;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: bold;
      color: #333;
      border-bottom: 2px solid #ddd;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    tr:hover {
      background-color: #f9f9f9;
    }
    
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    input:focus, textarea:focus {
      border-color: #000;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      outline: none;
    }
    
    textarea {
      min-height: 100px;
      font-family: inherit;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .btn-secondary {
      background-color: #666;
    }
    
    .btn-danger {
      background-color: #f44336;
    }
    
    .btn-success {
      background-color: #4CAF50;
    }
    
    .btn-icon {
      padding: 6px 10px;
      margin-left: 5px;
    }
    
    .status-pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: white;
      background-color: #999;
    }
    
    .status-pill.status-0 {
      background-color: #f44336; /* Not started */
    }
    
    .status-pill.status-solved {
      background-color: #4caf50; /* Solved */
    }
    
    .status-pill.status-inprogress {
      background-color: #2196f3; /* In progress */
    }
    
    .status-pill.status-completed {
      background-color: #9c27b0; /* All completed */
    }
    
    .player-details {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      margin-top: 20px;
      animation: fadeIn 0.5s ease;
    }
    
    .progress-bar {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #4caf50;
      transition: width 0.5s ease;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal.visible {
      opacity: 1;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal.visible .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-close {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .save-indicator {
      font-size: 12px;
      color: #4caf50;
      margin-left: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .save-indicator.show {
      opacity: 1;
    }
    
    .error-indicator {
      color: #f44336;
      font-size: 12px;
      margin-top: 5px;
    }
    
    .path-indicator {
      font-size: 12px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .answer-row {
      background-color: #f8f8f8;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 10px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .answer-row:hover {
      background-color: #f0f0f0;
    }
    
    .remove-answer-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remove-answer-btn:hover {
      background: #ff1744;
    }
    
    .add-answer-btn {
      margin-top: 10px;
      background-color: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-answer-btn:hover {
      background-color: #bdbdbd;
    }
    
    .global-settings {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
    }
    
    .image-gallery {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .image-item {
      position: relative;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      width: calc(50% - 10px);
      box-sizing: border-box;
    }
    
    .image-item input {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .image-item img {
      max-width: 100%;
      max-height: 100px;
      display: block;
      margin: 5px auto;
      border-radius: 4px;
    }
    
    .image-item .image-preview-error {
      color: #f44336;
      font-size: 12px;
      text-align: center;
      padding: 5px;
    }
    
    .add-image-btn {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-image-btn:hover {
      background-color: #bdbdbd;
    }
    
    .remove-image-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .remove-image-btn:hover {
      background: #ff1744;
    }
    
    .editor-container {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .ql-editor {
      min-height: 150px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .ql-toolbar.ql-snow {
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
      background-color: #f9f9f9;
    }
    
    .clue-preview {
      margin-top: 10px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }
    
    .preview-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1100;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .image-modal.visible {
      opacity: 1;
      display: flex;
    }
    
    .image-modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .image-modal.visible .image-modal-content {
      transform: translateY(0);
    }
    
    @media (max-width: 768px) {
      .tab-nav {
        flex-direction: column;
      }
      
      .tab-nav button {
        width: 100%;
        text-align: left;
        margin-bottom: 5px;
      }
      
      .image-item {
        width: 100%;
      }
      
      .container {
        padding: 10px;
        margin: 10px auto;
      }
      
      .card {
        padding: 15px;
      }
      
      table th, table td {
        padding: 8px;
      }
    }
    
    /* Authentication message styling */
    body.not-admin .admin-panel {
      display: none;
    }
    
    #auth-message {
      display: none;
      text-align: center;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #f44336;
    }
    
    body.not-admin #auth-message {
      display: block;
    }
    
    /* Toast messages */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 300px;
    }
    
    .toast {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 10px;
      color: white;
      animation: fadeIn 0.3s ease;
      position: relative;
    }
    
    .toast.success {
      background-color: #4CAF50;
    }
    
    .toast.error {
      background-color: #F44336;
    }
    
    .toast.warning {
      background-color: #FF9800;
    }
    
    .toast.info {
      background-color: #2196F3;
    }
    
    .toast-close {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
    }
    
    .toast-close:hover {
      opacity: 1;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form feedback */
    .feedback-message {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 4px;
      display: inline-block;
    }
    
    .feedback-message.success {
      background-color: #e8f5e9;
      color: #4CAF50;
    }
    
    .feedback-message.error {
      background-color: #ffebee;
      color: #F44336;
    }
    
    .feedback-message.warning {
      background-color: #fff8e1;
      color: #FF9800;
    }
  </style>
</head>
<body>
  <div id="auth-message">
    <h2>Admin Authentication Required</h2>
    <p>You must be logged in as an administrator to access this page.</p>
  </div>
  
  <div class="admin-panel container">
    <h1>Wedding Puzzle Admin</h1>
    
    <div class="row mb-4">
      <div class="col">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Custom Messages</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="welcome-message" class="form-label">Welcome Back Message</label>
              <textarea id="welcome-message" class="form-control" rows="2" 
                        placeholder="Welcome back, {{name}}! Continue your puzzle journey."></textarea>
              <small class="text-muted">Use {{name}} as a placeholder for the user's name.</small>
            </div>
            <button id="save-message-btn" class="btn btn-primary">Save Message</button>
            <div id="message-feedback" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mb-4">
      <div class="col">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Error Messages</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="error-message-puzzle" class="form-label">Select Puzzle</label>
              <select id="error-message-puzzle" class="form-select">
                <option value="">Select a puzzle...</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="error-message" class="form-label">Custom Error Message</label>
              <textarea id="error-message" class="form-control" rows="2" 
                        placeholder="That's not quite right. Try again!"></textarea>
              <small class="text-muted">This message will be shown when users answer incorrectly.</small>
            </div>
            <button id="save-error-message-btn" class="btn btn-primary">Save Error Message</button>
            <div id="error-message-feedback" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mb-4">
      <div class="col">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Add New Puzzle</h5>
          </div>
          <div class="card-body">
            <button id="add-puzzle-btn" class="btn btn-primary">Add New Puzzle</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-nav">
      <button id="tab-puzzles" class="active">Puzzles</button>
      <button id="tab-players">Players</button>
    </div>
    
    <div id="puzzles-tab" class="tab-content card active">
      <h2>Wedding Puzzles</h2>
      <p>Edit puzzle names, answers, and clues below. Changes are saved automatically.</p>
      <div id="puzzle-path-indicator" class="path-indicator">
        Saving to: primary database path
      </div>
      
      <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
        <h3>Completion Message</h3>
        <p>Edit the message that appears when users solve all puzzles:</p>
        <div class="form-group">
          <textarea id="completion-message" rows="3" style="width: 100%;" placeholder="Congratulations! You've completed all puzzles!"></textarea>
        </div>
        <button id="save-completion-message" class="btn">Save Message</button>
        <span id="completion-save-indicator" class="save-indicator">Message saved!</span>
      </div>
      
      <div class="global-settings" style="margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 8px;">
        <h3>Welcome Back Message</h3>
        <p>Edit the message that appears when users return to continue the puzzle:</p>
        <div class="form-group">
          <textarea id="welcome-back-message" rows="3" style="width: 100%;" placeholder="Welcome back! You can continue your puzzle progress."></textarea>
        </div>
        <button id="save-welcome-message" class="btn">Save Message</button>
        <span id="welcome-save-indicator" class="save-indicator">Message saved!</span>
      </div>
      
      <table id="puzzles-table">
        <thead>
          <tr>
            <th style="width: 5%;">#</th>
            <th style="width: 15%;">Name</th>
            <th style="width: 30%;">Clue</th>
            <th style="width: 20%;">Images</th>
            <th style="width: 30%;">Answers</th>
          </tr>
        </thead>
        <tbody>
          <!-- Puzzle rows will be inserted here -->
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5" style="text-align: center; padding: 20px;">
              <button id="add-puzzle-btn" class="btn">Add New Puzzle</button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <div id="players-tab" class="tab-content card hidden">
      <h2>Players Progress</h2>
      <p>View and manage players' progress through the wedding puzzle.</p>
      <div id="players-path-indicator" class="path-indicator">
        Loading from: all database paths
      </div>
      
      <table id="players-table">
        <thead>
          <tr>
            <th style="width: 25%;">Name</th>
            <th style="width: 25%;">Email</th>
            <th style="width: 10%;">Progress</th>
            <th style="width: 15%;">Current Screen</th>
            <th style="width: 15%;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Player rows will be inserted here -->
        </tbody>
      </table>
      
      <div id="player-details" class="player-details hidden">
        <h3 id="details-name">Player Name</h3>
        <p><strong>Email:</strong> <span id="details-email"></span></p>
        <p><strong>Current Screen:</strong> <span id="details-screen"></span></p>
        <p><strong>Progress:</strong> <span id="details-percentage"></span>%</p>
        <p><strong>Data Path:</strong> <span id="details-path"></span></p>
        
        <div class="progress-bar">
          <div id="details-progress-bar" class="progress-bar-fill" style="width: 0%;"></div>
        </div>
        
        <h4 style="margin-top: 20px;">Puzzle Status</h4>
        <div id="details-puzzle-status"></div>
        
        <div style="margin-top: 20px;">
          <button id="details-email-btn" class="btn btn-secondary">Send Hint Email</button>
          <button id="details-back-btn" class="btn">Back to List</button>
        </div>
      </div>
    </div>
    
    <div id="settings-tab" class="tab-content card hidden" style="display: none;">
      <!-- Settings content will be inserted here -->
    </div>
  </div>
  
  <!-- Answer Edit Modal -->
  <div id="answer-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Answers</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div id="answers-container">
        <!-- Answer fields will be added here -->
      </div>
      
      <button id="add-answer-btn" class="add-answer-btn">+ Add Another Answer</button>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-answers-btn" class="btn">Save Answers</button>
      </div>
    </div>
  </div>
  
  <!-- Image Edit Modal -->
  <div id="image-modal" class="image-modal">
    <div class="image-modal-content">
      <div class="modal-header">
        <h3>Edit Images</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div id="images-container" class="image-gallery">
        <!-- Image fields will be added here -->
      </div>
      
      <button id="add-image-btn" class="add-image-btn">+ Add Another Image</button>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-images-btn" class="btn">Save Images</button>
      </div>
    </div>
  </div>
  
  <!-- Rich Text Edit Modal -->
  <div id="richtext-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Clue Content</h3>
        <button class="modal-close">&times;</button>
      </div>
      
      <div class="editor-container">
        <div id="richtext-editor"></div>
      </div>
      
      <div class="clue-preview">
        <div class="preview-title">Preview:</div>
        <div id="richtext-preview"></div>
      </div>
      
      <div style="margin-top: 20px; text-align: right;">
        <button id="save-richtext-btn" class="btn">Save Content</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getDatabase, ref, set, push, get, remove, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js";
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAKt7T5eCCMsxLB0LGZ7Hp351Fez9TNCos",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.appspot.com",
      messagingSenderId: "1022219978689",
      appId: "1:1022219978689:web:56b68f67c4c8176b4fd7f7",
      measurementId: "G-8C08ZN7ZDW"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    // Constants for database paths and URLs
    const DB_PATHS = {
      primary: 'wedding',
      fallback: 'publicAnswers/wedding'
    };
    
    const DB_URL = "https://eviltrivia-47664-default-rtdb.firebaseio.com";
    
    // DOM elements
    const authMessage = document.getElementById('auth-message');
    const adminPanel = document.getElementById('admin-panel');
    const tabPuzzles = document.getElementById('tab-puzzles');
    const tabPlayers = document.getElementById('tab-players');
    const puzzlesTab = document.getElementById('puzzles-tab');
    const playersTab = document.getElementById('players-tab');
    
    const puzzlesTable = document.getElementById('puzzles-table').querySelector('tbody');
    const playersTable = document.getElementById('players-table').querySelector('tbody');
    
    const playerDetails = document.getElementById('player-details');
    const detailsName = document.getElementById('details-name');
    const detailsEmail = document.getElementById('details-email');
    const detailsScreen = document.getElementById('details-screen');
    const detailsPercentage = document.getElementById('details-percentage');
    const detailsProgressBar = document.getElementById('details-progress-bar');
    const detailsPuzzleStatus = document.getElementById('details-puzzle-status');
    const detailsEmailBtn = document.getElementById('details-email-btn');
    const detailsBackBtn = document.getElementById('details-back-btn');
    const detailsPath = document.getElementById('details-path');
    
    const puzzlePathIndicator = document.getElementById('puzzle-path-indicator');
    const playersPathIndicator = document.getElementById('players-path-indicator');
    
    const answerModal = document.getElementById('answer-modal');
    const answersContainer = document.getElementById('answers-container');
    const addAnswerBtn = document.getElementById('add-answer-btn');
    const saveAnswersBtn = document.getElementById('save-answers-btn');
    
    const imageModal = document.getElementById('image-modal');
    const imagesContainer = document.getElementById('images-container');
    const addImageBtn = document.getElementById('add-image-btn');
    const saveImagesBtn = document.getElementById('save-images-btn');
    
    const richtextModal = document.getElementById('richtext-modal');
    const richtextPreview = document.getElementById('richtext-preview');
    const saveRichtextBtn = document.getElementById('save-richtext-btn');
    
    const completionMessage = document.getElementById('completion-message');
    const saveCompletionMessage = document.getElementById('save-completion-message');
    const completionSaveIndicator = document.getElementById('completion-save-indicator');
    
    const welcomeBackMessage = document.getElementById('welcome-back-message');
    const saveWelcomeMessage = document.getElementById('save-welcome-message');
    const welcomeSaveIndicator = document.getElementById('welcome-save-indicator');
    
    // Rich text editor
    let quill;
    
    // Store timeouts for debounced saves
    const saveTimeouts = {};
    
    // Track successful database paths
    let successfulPuzzlePath = null;
    let successfulPlayersPath = null;
    
    // Store current items being edited
    let currentPuzzleBeingEdited = null;
    let currentAnswers = [];
    let currentImages = [];
    let currentClueHtml = '';
    
    // Check if user is logged in and has admin privileges
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("User logged in with UID:", user.uid);
        
        // Check admin status
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then((snapshot) => {
          const userData = snapshot.val() || {};
          
          if (userData.role === 'admin') {
            console.log("Admin access granted via user role");
            // User is admin, show admin panel
            authMessage.style.display = 'none';
            adminPanel.style.display = 'block';
            
            // Initialize admin functionality
            initializeAdmin();
            
          } else {
            console.log("User is not an admin");
            // Not admin, show message
            authMessage.style.display = 'block';
            authMessage.innerHTML = 'You do not have admin privileges to access this page.';
            adminPanel.style.display = 'none';
          }
        }).catch((error) => {
          console.error("Error checking admin status:", error);
          authMessage.style.display = 'block';
          authMessage.innerHTML = `Error checking admin status: ${error.message}`;
          adminPanel.style.display = 'none';
        });
      } else {
        // Not logged in, show message
        authMessage.style.display = 'block';
        authMessage.innerHTML = 'You need to be logged in as an admin to access this page. Please <a href="/admin.html">log in</a> first.';
        adminPanel.style.display = 'none';
      }
    });
    
    // Initialize admin functionality - called after authentication
    function initializeAdmin() {
      // Initialize rich text editor
      quill = new Quill('#richtext-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            ['link', 'image'],
            ['clean']
          ]
        }
      });
      
      // Update preview when editor content changes
      quill.on('text-change', function() {
        richtextPreview.innerHTML = quill.root.innerHTML;
      });
      
      // Load all tabs' data
      loadPuzzles();
      loadPlayers();
      loadCompletionMessage();
      loadWelcomeBackMessage();
      
      // Set up tab switching
      tabPuzzles.addEventListener('click', () => {
        tabPuzzles.classList.add('active');
        tabPlayers.classList.remove('active');
        puzzlesTab.classList.add('active');
        playersTab.classList.remove('active');
        playerDetails.classList.add('hidden');
      });
      
      tabPlayers.addEventListener('click', () => {
        tabPuzzles.classList.remove('active');
        tabPlayers.classList.add('active');
        puzzlesTab.classList.remove('active');
        playersTab.classList.add('active');
      });
      
      // Set up back button
      detailsBackBtn.addEventListener('click', () => {
        document.querySelector('#players-table').parentNode.style.display = 'block';
        playerDetails.classList.add('hidden');
      });
      
      // Set up modal closing
      document.querySelectorAll('.modal-close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
          closeAllModals();
        });
      });
      
      // Close modals when clicking outside
      window.addEventListener('click', (e) => {
        if (e.target === answerModal) {
          closeModal(answerModal);
        }
        if (e.target === imageModal) {
          closeModal(imageModal);
        }
        if (e.target === richtextModal) {
          closeModal(richtextModal);
        }
      });
      
      // Add answer button
      addAnswerBtn.addEventListener('click', () => {
        addAnswerField({ text: '', questionText: '' });
      });
      
      // Add image button
      addImageBtn.addEventListener('click', () => {
        addImageField({ url: '' });
      });
      
      // Save buttons
      saveAnswersBtn.addEventListener('click', () => {
        saveAnswers();
      });
      
      saveImagesBtn.addEventListener('click', () => {
        saveImages();
      });
      
      saveRichtextBtn.addEventListener('click', () => {
        saveRichtext();
      });
      
      // Add puzzle button
      document.getElementById('add-puzzle-btn').addEventListener('click', () => {
        addNewPuzzleDirectly();
      });
      
      // Completion message save button
      saveCompletionMessage.addEventListener('click', () => {
        saveCompletionMessageData();
      });
      
      // Welcome back message save button
      saveWelcomeMessage.addEventListener('click', () => {
        saveWelcomeBackMessageData();
      });
    }
    
    // Load completion message
    async function loadCompletionMessage() {
      try {
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'completionMessage');
        
        if (result.data) {
          completionMessage.value = result.data;
        } else {
          // Default message
          completionMessage.value = "Congratulations! You've completed all the puzzles!";
        }
      } catch (error) {
        console.error('Error loading completion message:', error);
      }
    }
    
    // Save completion message
    async function saveCompletionMessageData() {
      try {
        const message = completionMessage.value.trim();
        
        if (!message) {
          showFeedback('Please enter a completion message.', 'error');
          return;
        }
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          'completionMessage',
          message,
          'PUT'
        );
        
        if (result.success) {
          // Show save indicator
          completionSaveIndicator.classList.add('show');
          setTimeout(() => {
            completionSaveIndicator.classList.remove('show');
          }, 2000);
          
          showSuccessToast('Completion message saved!');
        } else {
          showFeedback('Error saving completion message. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error saving completion message:', error);
        showFeedback('Error saving completion message: ' + error.message, 'error');
      }
    }
    
    // Load welcome back message
    async function loadWelcomeBackMessage() {
      try {
        const result = await fetchFromPaths(Object.values(DB_PATHS), 'welcomeBackMessage');
        
        if (result.data) {
          welcomeBackMessage.value = result.data;
        } else {
          // Default message
          welcomeBackMessage.value = "Welcome back! You can continue your puzzle progress.";
        }
      } catch (error) {
        console.error('Error loading welcome back message:', error);
      }
    }
    
    // Save welcome back message
    async function saveWelcomeBackMessageData() {
      try {
        const message = welcomeBackMessage.value.trim();
        
        if (!message) {
          showFeedback('Please enter a welcome back message.', 'error');
          return;
        }
        
        // Save to database
        const result = await saveToDatabase(
          Object.values(DB_PATHS),
          'welcomeBackMessage',
          message,
          'PUT'
        );
        
        if (result.success) {
          // Show save indicator
          welcomeSaveIndicator.classList.add('show');
          setTimeout(() => {
            welcomeSaveIndicator.classList.remove('show');
          }, 2000);
          
          showSuccessToast('Welcome back message saved!');
        } else {
          showFeedback('Error saving welcome back message. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Error saving welcome back message:', error);
        showFeedback('Error saving welcome back message: ' + error.message, 'error');
      }
    }
    
    // Try fetching data from multiple paths
    async function fetchFromPaths(paths, endpoint) {
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`);
          if (response.ok) {
            const data = await response.json();
            return { data, path };
          }
        } catch (error) {
          console.error(`Error fetching from ${path}/${endpoint}:`, error);
        }
      }
      return { data: null, path: null };
    }
    
    // Save data to the database with fallback paths
    async function saveToDatabase(paths, endpoint, data, method = 'PATCH') {
      // Try using previously successful path first
      if (successfulPuzzlePath) {
        try {
          const response = await fetch(`${DB_URL}/${successfulPuzzlePath}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            return { success: true, path: successfulPuzzlePath };
          }
        } catch (error) {
          console.error(`Error saving to ${successfulPuzzlePath}/${endpoint}:`, error);
        }
      }
      
      // Try each path in sequence
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            successfulPuzzlePath = path;
            return { success: true, path };
          }
        } catch (error) {
          console.error(`Error saving to ${path}/${endpoint}:`, error);
        }
      }
      
      return { success: false, path: null };
    }
    
    // Load puzzles data
    async function loadPuzzles() {
      try {
        // Clear existing options in the select elements
        puzzleSelect.innerHTML = '<option value="">Select a puzzle...</option>';
        errorMessagePuzzleEl.innerHTML = '<option value="">Select a puzzle...</option>';
        
        // Try primary path first
        const response = await fetch(`${DB_URL}/${DB_PATHS.primary}/puzzles.json`);
        
        if (response.ok) {
          const puzzles = await response.json();
          
          if (puzzles) {
            Object.keys(puzzles).forEach(key => {
              const puzzle = puzzles[key];
              
              // Add to the main puzzle select
              const option = document.createElement('option');
              option.value = key;
              option.textContent = `${key}: ${puzzle.title || 'Untitled'} (${puzzle.difficulty || 'No difficulty'})`;
              puzzleSelect.appendChild(option);
              
              // Add to the error message puzzle select
              const errorOption = document.createElement('option');
              errorOption.value = key;
              errorOption.textContent = `${key}: ${puzzle.title || 'Untitled'} (${puzzle.difficulty || 'No difficulty'})`;
              errorMessagePuzzleEl.appendChild(errorOption);
            });
            
            showFeedback('Puzzles loaded successfully.', 'success');
          } else {
            showFeedback('No puzzles found.', 'warning');
          }
        } else {
          throw new Error('Could not load puzzles from primary path');
        }
      } catch (error) {
        console.error('Error loading puzzles:', error);
        
        try {
          // Try fallback path
          const fallbackResponse = await fetch(`${DB_URL}/${DB_PATHS.fallback}/puzzles.json`);
          
          if (fallbackResponse.ok) {
            const puzzles = await fallbackResponse.json();
            
            if (puzzles) {
              Object.keys(puzzles).forEach(key => {
                const puzzle = puzzles[key];
                
                // Add to the main puzzle select
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${key}: ${puzzle.title || 'Untitled'} (${puzzle.difficulty || 'No difficulty'})`;
                puzzleSelect.appendChild(option);
                
                // Add to the error message puzzle select
                const errorOption = document.createElement('option');
                errorOption.value = key;
                errorOption.textContent = `${key}: ${puzzle.title || 'Untitled'} (${puzzle.difficulty || 'No difficulty'})`;
                errorMessagePuzzleEl.appendChild(errorOption);
              });
              
              showFeedback('Puzzles loaded successfully from fallback path.', 'success');
            } else {
              showFeedback('No puzzles found in fallback path.', 'warning');
            }
          } else {
            showFeedback('Could not load puzzles from any path.', 'error');
          }
        } catch (fallbackError) {
          console.error('Error loading puzzles from fallback path:', fallbackError);
          showFeedback('Failed to load puzzles. Check your connection and try again.', 'error');
        }
      }
    }
    
    // Load welcome message
    async function loadWelcomeMessage() {
      try {
        // Try primary path first
        const response = await fetch(`${DB_URL}/${DB_PATHS.primary}/welcomeBackMessage.json`);
        
        if (response.ok) {
          const message = await response.json();
          
          if (message) {
            welcomeMessageEl.value = message;
          }
        } else {
          // Try fallback path
          const fallbackResponse = await fetch(`${DB_URL}/${DB_PATHS.fallback}/welcomeBackMessage.json`);
          
          if (fallbackResponse.ok) {
            const message = await fallbackResponse.json();
            
            if (message) {
              welcomeMessageEl.value = message;
            }
          }
        }
      } catch (error) {
        console.error('Error loading welcome message:', error);
      }
    }
    
    // Save welcome message
    async function saveWelcomeMessage() {
      const message = welcomeMessageEl.value.trim();
      
      if (!message) {
        showFeedback('Please enter a welcome message.', 'error', messageFeedbackEl);
        return;
      }
      
      try {
        // Try primary path first
        const response = await fetch(`${DB_URL}/${DB_PATHS.primary}/welcomeBackMessage.json`, {
          method: 'PUT',
          body: JSON.stringify(message)
        });
        
        if (response.ok) {
          showFeedback('Welcome message saved successfully.', 'success', messageFeedbackEl);
        } else {
          throw new Error('Could not save to primary path');
        }
      } catch (error) {
        console.error('Error saving welcome message to primary path:', error);
        
        try {
          // Try fallback path
          const fallbackResponse = await fetch(`${DB_URL}/${DB_PATHS.fallback}/welcomeBackMessage.json`, {
            method: 'PUT',
            body: JSON.stringify(message)
          });
          
          if (fallbackResponse.ok) {
            showFeedback('Welcome message saved to fallback path.', 'success', messageFeedbackEl);
          } else {
            showFeedback('Could not save welcome message to any path.', 'error', messageFeedbackEl);
          }
        } catch (fallbackError) {
          console.error('Error saving welcome message to fallback path:', fallbackError);
          showFeedback('Failed to save welcome message. Check your connection and try again.', 'error', messageFeedbackEl);
        }
      }
    }
    
    // Load error message for a specific puzzle
    async function loadErrorMessage(puzzleId) {
      if (!puzzleId) return;
      
      try {
        // Try primary path first
        const response = await fetch(`${DB_URL}/${DB_PATHS.primary}/errorMessages/${puzzleId}.json`);
        
        if (response.ok) {
          const message = await response.json();
          
          if (message) {
            errorMessageEl.value = message;
          } else {
            errorMessageEl.value = '';
          }
        } else {
          // Try fallback path
          const fallbackResponse = await fetch(`${DB_URL}/${DB_PATHS.fallback}/errorMessages/${puzzleId}.json`);
          
          if (fallbackResponse.ok) {
            const message = await fallbackResponse.json();
            
            if (message) {
              errorMessageEl.value = message;
            } else {
              errorMessageEl.value = '';
            }
          } else {
            errorMessageEl.value = '';
          }
        }
      } catch (error) {
        console.error('Error loading error message:', error);
        errorMessageEl.value = '';
      }
    }
    
    // Save error message for a specific puzzle
    async function saveErrorMessage() {
      const puzzleId = errorMessagePuzzleEl.value;
      const message = errorMessageEl.value.trim();
      
      if (!puzzleId) {
        showFeedback('Please select a puzzle.', 'error', errorMessageFeedbackEl);
        return;
      }
      
      try {
        // Try primary path first
        const response = await fetch(`${DB_URL}/${DB_PATHS.primary}/errorMessages/${puzzleId}.json`, {
          method: 'PUT',
          body: JSON.stringify(message)
        });
        
        if (response.ok) {
          showFeedback('Error message saved successfully.', 'success', errorMessageFeedbackEl);
        } else {
          throw new Error('Could not save to primary path');
        }
      } catch (error) {
        console.error('Error saving error message to primary path:', error);
        
        try {
          // Try fallback path
          const fallbackResponse = await fetch(`${DB_URL}/${DB_PATHS.fallback}/errorMessages/${puzzleId}.json`, {
            method: 'PUT',
            body: JSON.stringify(message)
          });
          
          if (fallbackResponse.ok) {
            showFeedback('Error message saved to fallback path.', 'success', errorMessageFeedbackEl);
          } else {
            showFeedback('Could not save error message to any path.', 'error', errorMessageFeedbackEl);
          }
        } catch (fallbackError) {
          console.error('Error saving error message to fallback path:', fallbackError);
          showFeedback('Failed to save error message. Check your connection and try again.', 'error', errorMessageFeedbackEl);
        }
      }
    }
    
    // Event listeners for welcome message
    saveMessageBtn.addEventListener('click', saveWelcomeMessage);
    
    // Event listeners for error messages
    errorMessagePuzzleEl.addEventListener('change', () => {
      loadErrorMessage(errorMessagePuzzleEl.value);
    });
    
    saveErrorMessageBtn.addEventListener('click', saveErrorMessage);
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkAdminAccess().then(isAdmin => {
        if (isAdmin) {
          loadPuzzles();
          loadWelcomeMessage();
          document.body.classList.remove('not-admin');
        } else {
          document.body.classList.add('not-admin');
        }
      });
    });
    
    // Format a date for display
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Escape HTML to prevent XSS
    function escapeHTML(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html> 