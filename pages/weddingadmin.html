<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - Wedding Puzzle Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    
    .card-title {
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
      font-size: 1.5em;
      color: #333;
      display: flex;
      align-items: center;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
      opacity: 0.9;
    }
    
    .btn-secondary {
      background-color: #6c757d;
    }
    
    .btn-danger {
      background-color: #dc3545;
    }
    
    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 500;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }
    
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .tab-nav button {
      background: none;
      border: none;
      padding: 10px 20px;
      margin-right: 5px;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
    }
    
    .tab-nav button.active {
      color: #000;
      border-bottom: 3px solid #000;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .puzzle-form {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .puzzle-form label {
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .puzzle-form input, 
    .puzzle-form textarea {
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .puzzle-form textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
    }
    
    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    
    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .player-row {
      cursor: pointer;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }
    
    .modal-title {
      margin: 0;
      font-size: 1.5em;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Auth check message -->
  <div id="auth-check" class="alert alert-danger hidden container" style="margin-top: 20px;">
    You need to be an admin to access this page. Redirecting to home...
  </div>
  
  <!-- Main content (only shown to admins) -->
  <div id="main-content" class="hidden">
    <div class="container">
      <h1>Wedding Puzzle Admin</h1>
      
      <div class="tab-nav">
        <button id="tab-puzzles" class="active">Puzzles</button>
        <button id="tab-players">Players</button>
      </div>
      
      <!-- Puzzles Tab -->
      <div id="puzzles-content" class="tab-content active">
        <div class="card">
          <h2 class="card-title">Manage Puzzles</h2>
          
          <div id="puzzles-loading" class="loader"></div>
          
          <div id="puzzles-list" class="hidden">
            <!-- Puzzle forms will be generated here -->
          </div>
          
          <div id="save-status" class="alert hidden"></div>
        </div>
      </div>
      
      <!-- Players Tab -->
      <div id="players-content" class="tab-content">
        <div class="card">
          <h2 class="card-title">Manage Players</h2>
          
          <div id="players-loading" class="loader"></div>
          
          <div id="players-list" class="hidden">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Progress</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="players-table-body">
                <!-- Player rows will be generated here -->
              </tbody>
            </table>
          </div>
          
          <div id="no-players" class="hidden alert alert-danger">
            No players have registered yet.
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Player Details Modal -->
  <div id="player-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Player Details</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div id="player-details">
        <div id="player-info">
          <p><strong>Name:</strong> <span id="modal-player-name"></span></p>
          <p><strong>Email:</strong> <span id="modal-player-email"></span></p>
          <p><strong>Current Screen:</strong> <span id="modal-current-screen"></span></p>
        </div>
        
        <h4>Progress</h4>
        <table>
          <thead>
            <tr>
              <th>Puzzle</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="progress-table-body">
            <!-- Progress rows will be generated here -->
          </tbody>
        </table>
        
        <div style="margin-top: 20px;">
          <button id="send-hint-btn" class="btn">Send Hint Email</button>
          <button id="reset-player-btn" class="btn btn-danger" style="margin-left: 10px;">Reset Progress</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.firebasestorage.app",
      messagingSenderId: "401826818140",
      appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
      measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // Elements
    const authCheck = document.getElementById('auth-check');
    const mainContent = document.getElementById('main-content');
    
    const tabPuzzles = document.getElementById('tab-puzzles');
    const tabPlayers = document.getElementById('tab-players');
    const puzzlesContent = document.getElementById('puzzles-content');
    const playersContent = document.getElementById('players-content');
    
    const puzzlesLoading = document.getElementById('puzzles-loading');
    const puzzlesList = document.getElementById('puzzles-list');
    const saveStatus = document.getElementById('save-status');
    
    const playersLoading = document.getElementById('players-loading');
    const playersList = document.getElementById('players-list');
    const noPlayers = document.getElementById('no-players');
    const playersTableBody = document.getElementById('players-table-body');
    
    const playerModal = document.getElementById('player-modal');
    const closeModal = document.querySelector('.close-modal');
    const modalPlayerName = document.getElementById('modal-player-name');
    const modalPlayerEmail = document.getElementById('modal-player-email');
    const modalCurrentScreen = document.getElementById('modal-current-screen');
    const progressTableBody = document.getElementById('progress-table-body');
    const sendHintBtn = document.getElementById('send-hint-btn');
    const resetPlayerBtn = document.getElementById('reset-player-btn');
    
    // State
    let selectedPlayerId = '';
    let saveTimers = {};
    
    // Check if user is authenticated and an admin
    auth.onAuthStateChanged(async user => {
      if (user) {
        console.log('User authenticated:', user.uid);
        
        // Check if user is an admin
        const userRef = db.ref(`users/${user.uid}`);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val() || {};
        
        let isAdmin = false;
        
        // Check for admin role in the roles array
        if (userData.roles && Array.isArray(userData.roles)) {
          isAdmin = userData.roles.includes('admin');
        } 
        // Check for legacy role string
        else if (userData.role === 'admin') {
          isAdmin = true;
        }
        
        if (isAdmin) {
          console.log('User is an admin. Showing admin dashboard.');
          authCheck.classList.add('hidden');
          mainContent.classList.remove('hidden');
          
          // Load initial data
          loadPuzzles();
          loadPlayers();
        } else {
          console.log('User is not an admin. Redirecting.');
          authCheck.classList.remove('hidden');
          
          // Redirect after a short delay
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        }
      } else {
        console.log('User not authenticated. Redirecting to login.');
        window.location.href = '/account.html?returnUrl=/weddingadmin.html';
      }
    });
    
    // Tab navigation
    tabPuzzles.addEventListener('click', () => {
      tabPuzzles.classList.add('active');
      tabPlayers.classList.remove('active');
      puzzlesContent.classList.add('active');
      playersContent.classList.remove('active');
    });
    
    tabPlayers.addEventListener('click', () => {
      tabPuzzles.classList.remove('active');
      tabPlayers.classList.add('active');
      puzzlesContent.classList.remove('active');
      playersContent.classList.add('active');
    });
    
    // Modal handling
    closeModal.addEventListener('click', () => {
      playerModal.style.display = 'none';
    });
    
    window.addEventListener('click', event => {
      if (event.target === playerModal) {
        playerModal.style.display = 'none';
      }
    });
    
    // Load puzzles data
    async function loadPuzzles() {
      puzzlesLoading.classList.remove('hidden');
      puzzlesList.classList.add('hidden');
      
      try {
        const ref = db.ref('wedding/answers');
        const snapshot = await ref.once('value');
        const puzzles = snapshot.val() || {};
        
        // Create form for each puzzle (1-10)
        let html = '';
        for (let i = 1; i <= 10; i++) {
          const puzzle = puzzles[i] || { answer: '', clue: '' };
          
          html += `
            <div class="puzzle-form" data-puzzle="${i}">
              <h3>Puzzle ${i}</h3>
              
              <label for="answer-${i}">Answer (case-insensitive):</label>
              <input type="text" id="answer-${i}" class="puzzle-answer" value="${escapeHtml(puzzle.answer || '')}" data-puzzle="${i}">
              
              <label for="clue-${i}">Clue Text:</label>
              <textarea id="clue-${i}" class="puzzle-clue" data-puzzle="${i}">${
                typeof puzzle.clue === 'string' 
                  ? escapeHtml(puzzle.clue) 
                  : (puzzle.clue && puzzle.clue.text 
                      ? escapeHtml(puzzle.clue.text) 
                      : '')
              }</textarea>
              
              <label for="image-${i}">Image URL (optional):</label>
              <input type="text" id="image-${i}" class="puzzle-image" value="${
                puzzle.clue && puzzle.clue.imageUrl 
                  ? escapeHtml(puzzle.clue.imageUrl) 
                  : ''
              }" data-puzzle="${i}">
              
              <div style="margin-top: 10px;">
                <button class="btn save-puzzle" data-puzzle="${i}">Save</button>
                <span class="save-indicator" data-puzzle="${i}" style="margin-left: 10px; font-size: 12px; color: #666;"></span>
              </div>
            </div>
          `;
        }
        
        puzzlesList.innerHTML = html;
        
        // Add event listeners to inputs and save buttons
        document.querySelectorAll('.puzzle-answer, .puzzle-clue, .puzzle-image').forEach(input => {
          input.addEventListener('input', handlePuzzleInput);
        });
        
        document.querySelectorAll('.save-puzzle').forEach(button => {
          button.addEventListener('click', handlePuzzleSave);
        });
        
        puzzlesLoading.classList.add('hidden');
        puzzlesList.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading puzzles:', error);
        puzzlesLoading.classList.add('hidden');
        showAlert('Error loading puzzles: ' + error.message, 'danger');
      }
    }
    
    // Handle puzzle form input changes (debounced save)
    function handlePuzzleInput(e) {
      const puzzleId = e.target.getAttribute('data-puzzle');
      const saveIndicator = document.querySelector(`.save-indicator[data-puzzle="${puzzleId}"]`);
      
      // Clear previous timer
      if (saveTimers[puzzleId]) {
        clearTimeout(saveTimers[puzzleId]);
      }
      
      saveIndicator.textContent = 'Changes not saved';
      saveIndicator.style.color = '#dc3545';
      
      // Set a new timer for 1.5 seconds delay
      saveTimers[puzzleId] = setTimeout(() => {
        const saveButton = document.querySelector(`.save-puzzle[data-puzzle="${puzzleId}"]`);
        saveButton.click();
      }, 1500);
    }
    
    // Handle puzzle save button click
    async function handlePuzzleSave(e) {
      const puzzleId = e.target.getAttribute('data-puzzle');
      const saveIndicator = document.querySelector(`.save-indicator[data-puzzle="${puzzleId}"]`);
      
      // Clear save timer
      if (saveTimers[puzzleId]) {
        clearTimeout(saveTimers[puzzleId]);
        delete saveTimers[puzzleId];
      }
      
      saveIndicator.textContent = 'Saving...';
      
      try {
        const answerInput = document.getElementById(`answer-${puzzleId}`);
        const clueInput = document.getElementById(`clue-${puzzleId}`);
        const imageInput = document.getElementById(`image-${puzzleId}`);
        
        const answer = answerInput.value.trim();
        const clueText = clueInput.value.trim();
        const imageUrl = imageInput.value.trim();
        
        let clueData;
        if (imageUrl) {
          // Complex clue with image
          clueData = {
            text: clueText,
            imageUrl: imageUrl
          };
        } else {
          // Simple text clue
          clueData = clueText;
        }
        
        // Save to Firebase
        await db.ref(`wedding/answers/${puzzleId}`).set({
          answer: answer,
          clue: clueData
        });
        
        saveIndicator.textContent = 'Saved';
        saveIndicator.style.color = '#28a745';
        
        // Clear saved indicator after 3 seconds
        setTimeout(() => {
          if (saveIndicator.textContent === 'Saved') {
            saveIndicator.textContent = '';
          }
        }, 3000);
      } catch (error) {
        console.error('Error saving puzzle:', error);
        saveIndicator.textContent = 'Error saving';
        saveIndicator.style.color = '#dc3545';
      }
    }
    
    // Load players data
    async function loadPlayers() {
      playersLoading.classList.remove('hidden');
      playersList.classList.add('hidden');
      noPlayers.classList.add('hidden');
      
      try {
        const ref = db.ref('wedding/progress');
        const snapshot = await ref.once('value');
        const players = snapshot.val() || {};
        
        const playerIds = Object.keys(players);
        
        if (playerIds.length === 0) {
          playersLoading.classList.add('hidden');
          noPlayers.classList.remove('hidden');
          return;
        }
        
        // Create table rows for each player
        let html = '';
        for (const playerId of playerIds) {
          const player = players[playerId];
          
          if (!player.name) continue; // Skip incomplete entries
          
          // Calculate completion percentage
          const completedPuzzles = player.solved ? 
            player.solved.filter(Boolean).length - 1 : 0; // Adjust for index 0
          const percentage = ((completedPuzzles / 10) * 100).toFixed(0);
          
          html += `
            <tr class="player-row" data-id="${playerId}">
              <td>${escapeHtml(player.name)}</td>
              <td>${escapeHtml(player.email || 'No email')}</td>
              <td>
                <div style="display: flex; align-items: center;">
                  <div style="width: 70%; background-color: #e9ecef; border-radius: 4px; height: 10px; margin-right: 10px;">
                    <div style="width: ${percentage}%; background-color: #28a745; height: 100%; border-radius: 4px;"></div>
                  </div>
                  <span>${percentage}% (${completedPuzzles}/10)</span>
                </div>
              </td>
              <td>
                <button class="btn btn-sm view-player" data-id="${playerId}">View Details</button>
              </td>
            </tr>
          `;
        }
        
        playersTableBody.innerHTML = html;
        
        // Add event listeners to player rows and view buttons
        document.querySelectorAll('.player-row').forEach(row => {
          row.addEventListener('click', e => {
            if (!e.target.classList.contains('btn')) {
              const playerId = row.getAttribute('data-id');
              openPlayerModal(playerId, players[playerId]);
            }
          });
        });
        
        document.querySelectorAll('.view-player').forEach(button => {
          button.addEventListener('click', e => {
            e.stopPropagation();
            const playerId = button.getAttribute('data-id');
            openPlayerModal(playerId, players[playerId]);
          });
        });
        
        playersLoading.classList.add('hidden');
        playersList.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading players:', error);
        playersLoading.classList.add('hidden');
        playersList.classList.add('hidden');
        noPlayers.classList.remove('hidden');
        noPlayers.textContent = 'Error loading players: ' + error.message;
      }
    }
    
    // Open player details modal
    function openPlayerModal(playerId, playerData) {
      selectedPlayerId = playerId;
      
      modalPlayerName.textContent = playerData.name || 'Unknown';
      modalPlayerEmail.textContent = playerData.email || 'No email';
      modalCurrentScreen.textContent = playerData.currentScreen || '0';
      
      // Create progress table
      let html = '';
      for (let i = 1; i <= 10; i++) {
        const solved = playerData.solved && playerData.solved[i];
        const currentPuzzle = playerData.currentScreen === i;
        
        html += `
          <tr>
            <td>Puzzle ${i}</td>
            <td>
              ${solved 
                ? '<span style="color: #28a745;">✓ Solved</span>' 
                : (currentPuzzle 
                  ? '<span style="color: #fd7e14;">● Current</span>' 
                  : '<span style="color: #dc3545;">✗ Not Solved</span>')}
            </td>
          </tr>
        `;
      }
      progressTableBody.innerHTML = html;
      
      // Set up email button
      sendHintBtn.onclick = () => {
        const subject = encodeURIComponent(`Wedding Puzzle Hint for ${playerData.name}`);
        const body = encodeURIComponent(
          `Hi ${playerData.name},\n\nHere's a hint for puzzle ${playerData.currentScreen}:\n\n[Insert hint here]\n\nGood luck!\n\nThe Evil Trivia Team`
        );
        window.open(`mailto:${playerData.email}?subject=${subject}&body=${body}`);
      };
      
      // Set up reset button
      resetPlayerBtn.onclick = async () => {
        if (confirm(`Are you sure you want to reset progress for ${playerData.name}?`)) {
          try {
            await db.ref(`wedding/progress/${playerId}`).update({
              currentScreen: 0,
              solved: Array(11).fill(false)
            });
            
            // Close modal and refresh player list
            playerModal.style.display = 'none';
            loadPlayers();
            
            showAlert('Player progress has been reset.', 'success');
          } catch (error) {
            console.error('Error resetting player:', error);
            showAlert('Error resetting player: ' + error.message, 'danger');
          }
        }
      };
      
      // Show modal
      playerModal.style.display = 'flex';
    }
    
    // Helper function to show alerts
    function showAlert(message, type) {
      saveStatus.textContent = message;
      saveStatus.className = `alert alert-${type}`;
      saveStatus.classList.remove('hidden');
      
      // Hide after 5 seconds
      setTimeout(() => {
        saveStatus.classList.add('hidden');
      }, 5000);
    }
    
    // Helper function to escape HTML
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html> 