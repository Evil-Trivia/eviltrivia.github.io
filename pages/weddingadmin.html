<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wedding Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2rem;
      font-weight: bold;
    }
    
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #333;
    }
    
    .tab-nav {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    
    .tab-nav button {
      background: none;
      border: none;
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab-nav button.active {
      color: #000;
      border-bottom-color: #000;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th {
      background-color: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: bold;
      color: #333;
      border-bottom: 2px solid #ddd;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    tr:hover {
      background-color: #f9f9f9;
    }
    
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    textarea {
      min-height: 100px;
      font-family: inherit;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 16px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
      opacity: 0.9;
    }
    
    .btn-secondary {
      background-color: #666;
    }
    
    .status-pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: white;
      background-color: #999;
    }
    
    .status-pill.status-0 {
      background-color: #f44336; /* Not started */
    }
    
    .status-pill.status-solved {
      background-color: #4caf50; /* Solved */
    }
    
    .status-pill.status-inprogress {
      background-color: #2196f3; /* In progress */
    }
    
    .status-pill.status-completed {
      background-color: #9c27b0; /* All completed */
    }
    
    .player-details {
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .progress-bar {
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #4caf50;
      transition: width 0.3s ease;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-close {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .save-indicator {
      font-size: 12px;
      color: #4caf50;
      margin-left: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .save-indicator.show {
      opacity: 1;
    }
    
    .error-indicator {
      color: #f44336;
      font-size: 12px;
      margin-top: 5px;
    }
    
    .path-indicator {
      font-size: 12px;
      color: #666;
      margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
      .tab-nav {
        flex-direction: column;
      }
      
      .tab-nav button {
        width: 100%;
        text-align: left;
        margin-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wedding Puzzle Admin</h1>
    
    <div id="admin-panel">
      <div class="tab-nav">
        <button id="tab-puzzles" class="active">Puzzles</button>
        <button id="tab-players">Players</button>
      </div>
      
      <div id="puzzles-tab" class="tab-content card active">
        <h2>Wedding Puzzles</h2>
        <p>Edit puzzle answers and clues below. Changes are saved automatically.</p>
        <div id="puzzle-path-indicator" class="path-indicator">
          Saving to: primary database path
        </div>
        
        <table id="puzzles-table">
          <thead>
            <tr>
              <th style="width: 10%;">#</th>
              <th style="width: 35%;">Answer</th>
              <th style="width: 45%;">Clue</th>
              <th style="width: 10%;">Image URL</th>
            </tr>
          </thead>
          <tbody>
            <!-- Puzzle rows will be inserted here -->
          </tbody>
        </table>
      </div>
      
      <div id="players-tab" class="tab-content card hidden">
        <h2>Players Progress</h2>
        <p>View and manage players' progress through the wedding puzzle.</p>
        <div id="players-path-indicator" class="path-indicator">
          Loading from: all database paths
        </div>
        
        <table id="players-table">
          <thead>
            <tr>
              <th style="width: 25%;">Name</th>
              <th style="width: 25%;">Email</th>
              <th style="width: 10%;">Progress</th>
              <th style="width: 15%;">Current Screen</th>
              <th style="width: 15%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Player rows will be inserted here -->
          </tbody>
        </table>
        
        <div id="player-details" class="player-details hidden">
          <h3 id="details-name">Player Name</h3>
          <p><strong>Email:</strong> <span id="details-email"></span></p>
          <p><strong>Current Screen:</strong> <span id="details-screen"></span></p>
          <p><strong>Progress:</strong> <span id="details-percentage"></span>%</p>
          <p><strong>Data Path:</strong> <span id="details-path"></span></p>
          
          <div class="progress-bar">
            <div id="details-progress-bar" class="progress-bar-fill" style="width: 0%;"></div>
          </div>
          
          <h4 style="margin-top: 20px;">Puzzle Status</h4>
          <div id="details-puzzle-status"></div>
          
          <div style="margin-top: 20px;">
            <button id="details-email-btn" class="btn btn-secondary">Send Hint Email</button>
            <button id="details-back-btn" class="btn">Back to List</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Firebase DB URL
    const DB_URL = "https://eviltrivia-47664-default-rtdb.firebaseio.com";
    
    // Database paths for wedding puzzle data
    const DB_PATHS = {
      primary: 'wedding',
      fallback: 'publicAnswers/wedding'
    };
    
    // DOM Elements
    const tabPuzzles = document.getElementById('tab-puzzles');
    const tabPlayers = document.getElementById('tab-players');
    const puzzlesTab = document.getElementById('puzzles-tab');
    const playersTab = document.getElementById('players-tab');
    
    const puzzlesTable = document.getElementById('puzzles-table').querySelector('tbody');
    const playersTable = document.getElementById('players-table').querySelector('tbody');
    
    const playerDetails = document.getElementById('player-details');
    const detailsName = document.getElementById('details-name');
    const detailsEmail = document.getElementById('details-email');
    const detailsScreen = document.getElementById('details-screen');
    const detailsPercentage = document.getElementById('details-percentage');
    const detailsProgressBar = document.getElementById('details-progress-bar');
    const detailsPuzzleStatus = document.getElementById('details-puzzle-status');
    const detailsEmailBtn = document.getElementById('details-email-btn');
    const detailsBackBtn = document.getElementById('details-back-btn');
    const detailsPath = document.getElementById('details-path');
    
    const puzzlePathIndicator = document.getElementById('puzzle-path-indicator');
    const playersPathIndicator = document.getElementById('players-path-indicator');
    
    // Store timeouts for debounced saves
    const saveTimeouts = {};
    
    // Track successful database paths
    let successfulPuzzlePath = null;
    let successfulPlayersPath = null;
    
    // Helper function to format date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      
      try {
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return timestamp;
      }
    }
    
    // Helper for HTML escaping
    function escapeHTML(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Load both tabs' data
      loadPuzzles();
      loadPlayers();
      
      // Set up tab switching
      tabPuzzles.addEventListener('click', () => {
        tabPuzzles.classList.add('active');
        tabPlayers.classList.remove('active');
        puzzlesTab.classList.add('active');
        playersTab.classList.remove('active');
        playerDetails.classList.add('hidden');
      });
      
      tabPlayers.addEventListener('click', () => {
        tabPuzzles.classList.remove('active');
        tabPlayers.classList.add('active');
        puzzlesTab.classList.remove('active');
        playersTab.classList.add('active');
      });
      
      // Set up back button
      detailsBackBtn.addEventListener('click', () => {
        document.querySelector('#players-table').parentNode.style.display = 'block';
        playerDetails.classList.add('hidden');
      });
    });
    
    // Try fetching data from multiple paths
    async function fetchFromPaths(paths, endpoint) {
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`);
          if (response.ok) {
            const data = await response.json();
            return { data, path };
          }
        } catch (error) {
          console.error(`Error fetching from ${path}/${endpoint}:`, error);
        }
      }
      return { data: null, path: null };
    }
    
    // Save data to the database with fallback paths
    async function saveToDatabase(paths, endpoint, data, method = 'PATCH') {
      // Try using previously successful path first
      if (successfulPuzzlePath) {
        try {
          const response = await fetch(`${DB_URL}/${successfulPuzzlePath}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            return { success: true, path: successfulPuzzlePath };
          }
        } catch (error) {
          console.error(`Error saving to ${successfulPuzzlePath}/${endpoint}:`, error);
        }
      }
      
      // Try each path in sequence
      for (const path of paths) {
        try {
          const response = await fetch(`${DB_URL}/${path}/${endpoint}.json`, {
            method,
            body: JSON.stringify(data)
          });
          
          if (response.ok) {
            successfulPuzzlePath = path;
            return { success: true, path };
          }
        } catch (error) {
          console.error(`Error saving to ${path}/${endpoint}:`, error);
        }
      }
      
      return { success: false, path: null };
    }
    
    // Load puzzles
    async function loadPuzzles() {
      try {
        // Clear table first
        puzzlesTable.innerHTML = '';
        
        // Try multiple database paths for puzzles
        const paths = [DB_PATHS.primary, DB_PATHS.fallback];
        const { data, path } = await fetchFromPaths(paths, 'answers');
        
        if (path) {
          successfulPuzzlePath = path;
          puzzlePathIndicator.textContent = `Loaded from: ${path}/answers`;
        } else {
          puzzlePathIndicator.textContent = 'Warning: Could not load puzzle data from any path';
        }
        
        const puzzles = data || {};
        
        // Create rows for puzzles 1-10
        for (let i = 1; i <= 10; i++) {
          const puzzle = puzzles[i] || { answer: '', clue: '', imageUrl: '' };
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>#${i}</td>
            <td>
              <input 
                type="text" 
                data-puzzle="${i}" 
                data-field="answer" 
                value="${escapeHTML(puzzle.answer || '')}" 
                placeholder="Enter answer...">
              <span class="save-indicator" id="save-answer-${i}">Saved ✓</span>
            </td>
            <td>
              <textarea 
                data-puzzle="${i}" 
                data-field="clue" 
                placeholder="Enter clue text...">${escapeHTML(puzzle.clue || '')}</textarea>
              <span class="save-indicator" id="save-clue-${i}">Saved ✓</span>
            </td>
            <td>
              <input 
                type="text" 
                data-puzzle="${i}" 
                data-field="imageUrl" 
                value="${escapeHTML(puzzle.imageUrl || '')}" 
                placeholder="Image URL (optional)">
              <span class="save-indicator" id="save-image-${i}">Saved ✓</span>
            </td>
          `;
          
          puzzlesTable.appendChild(row);
        }
        
        // Add event listeners for inputs
        const inputs = puzzlesTable.querySelectorAll('input, textarea');
        inputs.forEach(input => {
          input.addEventListener('input', handlePuzzleChange);
        });
        
      } catch (error) {
        console.error('Error loading puzzles:', error);
        puzzlesTable.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; color: #f44336;">
              Error loading puzzles. Please refresh the page.
            </td>
          </tr>
        `;
      }
    }
    
    // Handle changes to puzzle data
    function handlePuzzleChange(e) {
      const puzzle = e.target.dataset.puzzle;
      const field = e.target.dataset.field;
      const value = e.target.value;
      
      // Clear any existing timeout for this field
      if (saveTimeouts[`${puzzle}-${field}`]) {
        clearTimeout(saveTimeouts[`${puzzle}-${field}`]);
      }
      
      // Debounce save (wait 500ms after typing stops)
      saveTimeouts[`${puzzle}-${field}`] = setTimeout(() => {
        savePuzzleData(puzzle, field, value);
      }, 500);
    }
    
    // Save puzzle data to database
    async function savePuzzleData(puzzle, field, value) {
      try {
        const updateData = {};
        updateData[field] = value;
        
        // Try saving to multiple paths
        const paths = [DB_PATHS.primary, DB_PATHS.fallback];
        const { success, path } = await saveToDatabase(paths, `answers/${puzzle}`, updateData);
        
        if (success) {
          // Show saved indicator
          const indicator = document.getElementById(`save-${field}-${puzzle}`);
          indicator.classList.add('show');
          setTimeout(() => {
            indicator.classList.remove('show');
          }, 2000);
          
          // Update path indicator
          puzzlePathIndicator.textContent = `Saved to: ${path}/answers`;
        } else {
          throw new Error('Failed to save to any path');
        }
      } catch (error) {
        console.error(`Error saving puzzle ${puzzle} ${field}:`, error);
        
        // Show error if save failed
        const indicator = document.getElementById(`save-${field}-${puzzle}`);
        indicator.textContent = 'Error! ⚠️';
        indicator.style.color = '#f44336';
        indicator.classList.add('show');
        
        setTimeout(() => {
          indicator.textContent = 'Saved ✓';
          indicator.style.color = '#4caf50';
          indicator.classList.remove('show');
        }, 3000);
      }
    }
    
    // Load players data from multiple database paths
    async function loadPlayers() {
      try {
        // Clear table first
        playersTable.innerHTML = '';
        
        // Show loading row
        playersTable.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center;">
              <div class="loader"></div>
              <p>Loading players from all database paths...</p>
            </td>
          </tr>
        `;
        
        // Get players data from multiple paths
        const paths = [DB_PATHS.primary, DB_PATHS.fallback];
        let allPlayers = {};
        let successfulPaths = [];
        
        // Try each path
        for (const path of paths) {
          try {
            const response = await fetch(`${DB_URL}/${path}/progress.json`);
            
            if (response.ok) {
              const data = await response.json();
              
              if (data) {
                // Mark each player with the path it came from
                Object.keys(data).forEach(userId => {
                  if (data[userId]) {
                    allPlayers[userId] = { 
                      ...data[userId],
                      _dataPath: path
                    };
                  }
                });
                
                successfulPaths.push(path);
              }
            }
          } catch (error) {
            console.error(`Error loading players from ${path}:`, error);
          }
        }
        
        // Update path indicator
        if (successfulPaths.length > 0) {
          playersPathIndicator.textContent = `Loaded from: ${successfulPaths.join(', ')}`;
          successfulPlayersPath = successfulPaths[0]; // Set the first successful path as default
        } else {
          playersPathIndicator.textContent = 'Warning: Could not load player data from any path';
        }
        
        // Clear table for fresh content
        playersTable.innerHTML = '';
        
        // Handle empty data
        if (Object.keys(allPlayers).length === 0) {
          playersTable.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center;">
                No players found yet. Players will appear here when they start the puzzle.
              </td>
            </tr>
          `;
          return;
        }
        
        // Create rows for players
        Object.entries(allPlayers).forEach(([userId, player]) => {
          if (!player.name || !player.currentScreen) return; // Skip invalid entries
          
          // Calculate progress percentage
          const progress = player.currentScreen > 10 ? 100 : (player.currentScreen - 1) * 10;
          
          // Determine status
          let statusClass = 'status-inprogress';
          let statusText = 'In Progress';
          
          if (player.currentScreen > 10) {
            statusClass = 'status-completed';
            statusText = 'Completed';
          } else if (player.currentScreen === 1) {
            statusClass = 'status-0';
            statusText = 'Not Started';
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${escapeHTML(player.name)}</td>
            <td>${escapeHTML(player.email)}</td>
            <td>
              <div class="status-pill ${statusClass}">${statusText}</div>
            </td>
            <td>${player.currentScreen > 10 ? 'Complete' : `Puzzle #${player.currentScreen}`}</td>
            <td>
              <button class="btn" data-userid="${userId}">View Details</button>
            </td>
          `;
          
          // Store the player data as a data attribute for easy access
          row.dataset.player = JSON.stringify(player);
          row.dataset.userId = userId;
          
          playersTable.appendChild(row);
        });
        
        // Add event listeners for detail buttons
        const detailButtons = playersTable.querySelectorAll('button');
        detailButtons.forEach(button => {
          button.addEventListener('click', showPlayerDetails);
        });
        
      } catch (error) {
        console.error('Error loading players:', error);
        playersTable.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: #f44336;">
              Error loading players. Please refresh the page.
            </td>
          </tr>
        `;
      }
    }
    
    // Show player details
    function showPlayerDetails(e) {
      try {
        const button = e.target;
        const userId = button.dataset.userid;
        
        // Find the row with this player's data
        const row = button.closest('tr');
        if (!row || !row.dataset.player) {
          console.error('Player data not found');
          return;
        }
        
        // Parse the player data
        const player = JSON.parse(row.dataset.player);
        
        // Hide the players table
        document.querySelector('#players-table').parentNode.style.display = 'none';
        
        // Calculate progress percentage
        const progress = player.currentScreen > 10 ? 100 : (player.currentScreen - 1) * 10;
        
        // Update the details panel
        detailsName.textContent = player.name || 'Unknown Player';
        detailsEmail.textContent = player.email || 'No email provided';
        detailsScreen.textContent = player.currentScreen > 10 ? 'Completed All Puzzles' : `Puzzle #${player.currentScreen}`;
        detailsPercentage.textContent = progress;
        detailsProgressBar.style.width = `${progress}%`;
        detailsPath.textContent = player._dataPath || 'Unknown';
        
        // Create puzzle status display
        detailsPuzzleStatus.innerHTML = '';
        
        for (let i = 1; i <= 10; i++) {
          const solved = player.solved && player.solved[i-1];
          const current = player.currentScreen === i;
          
          let statusClass = 'status-0';
          let statusText = 'Not Attempted';
          
          if (solved) {
            statusClass = 'status-solved';
            statusText = 'Solved';
          } else if (current) {
            statusClass = 'status-inprogress';
            statusText = 'Current';
          }
          
          const puzzleStatusEl = document.createElement('div');
          puzzleStatusEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Puzzle #${i}</span>
              <span class="status-pill ${statusClass}">${statusText}</span>
            </div>
          `;
          
          detailsPuzzleStatus.appendChild(puzzleStatusEl);
        }
        
        // Set up email button
        detailsEmailBtn.onclick = () => {
          const subject = 'Your Wedding Puzzle Hint';
          const body = `Hi ${player.name},\n\nHere's a hint for your current puzzle (#${player.currentScreen}):\n\n[Add your hint here]\n\nGood luck!`;
          window.location.href = `mailto:${player.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        };
        
        // Store the userId for later use
        playerDetails.dataset.userId = userId;
        playerDetails.dataset.path = player._dataPath || DB_PATHS.primary;
        
        // Show the details panel
        playerDetails.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error showing player details:', error);
        alert('Error loading player details. Please try again.');
      }
    }
    
    // Reset a player's progress
    async function resetPlayerProgress(userId, path) {
      if (!confirm('Are you sure you want to reset this player\'s progress? This cannot be undone.')) {
        return;
      }
      
      try {
        // Get current player data
        const response = await fetch(`${DB_URL}/${path}/progress/${userId}.json`);
        const player = await response.json();
        
        if (!player) {
          throw new Error('Player data not found');
        }
        
        // Update with reset values
        const resetData = {
          ...player,
          currentScreen: 1,
          solved: [false, false, false, false, false, false, false, false, false, false]
        };
        
        // Save the reset data
        await fetch(`${DB_URL}/${path}/progress/${userId}.json`, {
          method: 'PUT',
          body: JSON.stringify(resetData)
        });
        
        alert('Player progress has been reset.');
        loadPlayers();
        playerDetails.classList.add('hidden');
        
      } catch (error) {
        console.error('Error resetting player progress:', error);
        alert('Error resetting player progress. Please try again.');
      }
    }
  </script>
</body>
</html> 