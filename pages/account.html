<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - My Account</title>
  <script src="/js/components/autoload-banner.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      margin-top: 60px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .account-section {
      margin: 20px auto;
      max-width: 900px;
    }
    
    .account-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    @media (max-width: 768px) {
      .account-cards {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card-title {
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      font-size: 1.5em;
      color: #333;
    }
    
    .card-title img {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 20px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
    }
    
    .btn-patreon {
      background-color: #FF424D;
    }
    
    .btn-patreon:hover {
      background-color: #E13641;
    }
    
    .profile-info {
      margin: 20px 0;
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .profile-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 20px;
      background-color: #f5f5f5;
    }
    
    .membership-badge {
      display: inline-block;
      padding: 5px 10px;
      background-color: #000000;
      color: white;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    #firebaseui-auth-container {
      margin: 20px 0;
    }
    
    .login-btn {
      display: block;
      margin: 20px auto;
      transition: transform 0.2s;
    }
    
    .login-btn:hover {
      transform: scale(1.05);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .info-row {
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding: 5px 0;
    }
    
    .info-row strong {
      color: #666;
    }
    
    .card-content {
      min-height: 200px;
      position: relative;
    }
    
    .not-logged-in-message {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>My Account</h1>
    
    <section class="account-section">
      <div class="account-cards">
        <!-- Evil Trivia Account Card -->
        <div class="card">
          <h2 class="card-title">
            <img src="/images/evil_trivia_icon.png" alt="Evil Trivia Icon">
            Evil Trivia Account
          </h2>
          
          <div class="card-content">
            <!-- Loading State -->
            <div id="trivia-loading" class="loader"></div>
            
            <!-- Not Logged In State -->
            <div id="trivia-not-logged-in" class="hidden">
              <div class="not-logged-in-message">
                <div id="initial-auth-choice" style="text-align: center; margin-bottom: 30px;">
                  <h3 style="margin-top: 0;">Choose an Option</h3>
                  <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
                    <button id="show-login-option" class="btn" style="flex: 1; max-width: 150px;">Log In</button>
                    <button id="show-signup-option" class="btn" style="flex: 1; max-width: 150px;">Sign Up</button>
                  </div>
                </div>
                
                <!-- Simple Login Form -->
                <div id="login-form-section" style="display: none;">
                  <h3 style="margin-top: 0; text-align: center;">Log In</h3>
                  <div style="margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; text-align: left;">
                    <p style="margin: 0 0 8px 0;"><strong>Welcome back!</strong> Enter your credentials to sign in.</p>
                  </div>
                  
                  <form id="login-form" style="text-align: left;">
                    <div style="margin-bottom: 15px;">
                      <label for="login-email" style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                      <input type="email" id="login-email" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" required>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                      <label for="login-password" style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                      <input type="password" id="login-password" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" required>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Log In</button>
                    <p id="login-error" style="color: red; margin-top: 10px; display: none; background-color: #ffeeee; padding: 8px; border-radius: 4px;"></p>
                  </form>
                  
                  <p style="margin-top: 20px; text-align: center;">
                    <a href="#" id="back-to-options" style="color: #333; text-decoration: underline;">Back to options</a>
                  </p>
                </div>
                
                <!-- Registration Form -->
                <div id="signup-form-section" style="display: none;">
                  <h3 style="margin-top: 0; text-align: center;">Create an Account</h3>
                  <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f8f8; border-left: 3px solid #333; font-size: 14px; color: #666;">
                    <strong>Note:</strong> Evil Trivia is invite-only. You will need a valid registration code.
                  </div>
                  
                  <form id="signup-form" style="text-align: left;">
                    <div style="margin-bottom: 15px;">
                      <label for="signup-code" style="display: block; margin-bottom: 5px; font-weight: bold;">Registration Code:</label>
                      <input type="text" id="signup-code" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" required>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                      <label for="signup-email" style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                      <input type="email" id="signup-email" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" required>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                      <label for="signup-password" style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                      <input type="password" id="signup-password" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" minlength="6" required>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                      <label for="signup-confirm" style="display: block; margin-bottom: 5px; font-weight: bold;">Confirm Password:</label>
                      <input type="password" id="signup-confirm" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;" minlength="6" required>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Create Account</button>
                    <p id="signup-error" style="color: red; margin-top: 10px; display: none; background-color: #ffeeee; padding: 8px; border-radius: 4px;"></p>
                  </form>
                  
                  <p style="margin-top: 20px; text-align: center;">
                    <a href="#" id="back-to-options-from-signup" style="color: #333; text-decoration: underline;">Back to options</a>
                  </p>
                </div>
              </div>
            </div>
            
            <!-- Logged In State -->
            <div id="trivia-logged-in" class="hidden">
              <div class="profile-header">
                <img id="trivia-profile-pic" src="/images/default_profile.png" alt="Profile Picture" class="profile-pic">
                <div>
                  <h3 id="trivia-name">Loading...</h3>
                  <p id="trivia-email">loading@example.com</p>
                  <div id="trivia-role-badge" class="membership-badge">Member</div>
                  <div id="user-roles-container" style="margin-top: 10px;"></div>
                </div>
              </div>
              
              <div class="profile-info">
                <div class="info-row">
                  <strong>Member Since:</strong>
                  <span id="trivia-join-date">January 1, 2023</span>
                </div>
                <div class="info-row">
                  <strong>Last Login:</strong>
                  <span id="trivia-last-login">Today</span>
                </div>
              </div>
              
              <button id="logout-btn" class="btn">Sign Out</button>
            </div>
          </div>
        </div>
        
        <!-- Patreon Account Card -->
        <div id="patreon-card" class="card" style="display: none;">
          <h2 class="card-title">
            <img src="/images/patreon_icon.png" alt="Patreon Icon">
            Patreon Membership
          </h2>
          
          <div class="card-content">
            <!-- Loading State -->
            <div id="patreon-loading" class="loader"></div>
            
            <!-- Not Connected State -->
            <div id="patreon-not-connected" class="hidden">
              <div class="not-logged-in-message">
                <p>Connect your Patreon account to access exclusive content.</p>
                <a id="patreon-login-btn" href="#" class="login-btn">
                  <img
                    src="https://c5.patreon.com/external/logo/login_with_patreon@2x.png"
                    width="272" 
                    height="44"
                    alt="Login with Patreon"
                  />
                </a>
              </div>
            </div>
            
            <!-- Connected State -->
            <div id="patreon-connected" class="hidden">
              <div class="profile-header">
                <img id="patreon-profile-pic" src="/images/default_profile.png" alt="Patreon Profile" class="profile-pic">
                <div>
                  <h3 id="patreon-name">Loading...</h3>
                  <p id="patreon-email">loading@example.com</p>
                  <div id="patreon-tier-badge" class="membership-badge">Supporter</div>
                </div>
              </div>
              
              <div class="profile-info">
                <div class="info-row">
                  <strong>Membership Tier:</strong>
                  <span id="patreon-tier">Supporter</span>
                </div>
                <div class="info-row">
                  <strong>Monthly Pledge:</strong>
                  $<span id="patreon-pledge">5.00</span>
                </div>
                <div class="info-row">
                  <strong>Status:</strong>
                  <span id="patreon-status">Active</span>
                </div>
              </div>
              
              <div class="center">
                <a href="https://www.patreon.com/EvilTrivia/membership" target="_blank" class="btn btn-patreon">Manage Membership</a>
                <button id="disconnect-patreon-btn" class="btn" style="margin-top: 10px; background-color: #ff424d33; color: #FF424D; border: 1px solid #FF424D;">Disconnect Patreon</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.firebasestorage.app",
      messagingSenderId: "401826818140",
      appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
      measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // Your Cloud Function URL 
    const firebaseFunctionUrl = "https://patreonauth-vapvabofwq-uc.a.run.app";
    
    // DOM Elements
    const triviaLoading = document.getElementById('trivia-loading');
    const triviaNotLoggedIn = document.getElementById('trivia-not-logged-in');
    const triviaLoggedIn = document.getElementById('trivia-logged-in');
    
    const patreonLoading = document.getElementById('patreon-loading');
    const patreonNotConnected = document.getElementById('patreon-not-connected');
    const patreonConnected = document.getElementById('patreon-connected');
    const patreonLoginBtn = document.getElementById('patreon-login-btn');
    
    const logoutBtn = document.getElementById('logout-btn');
    
    // UI Elements for Trivia account
    const triviaProfilePic = document.getElementById('trivia-profile-pic');
    const triviaName = document.getElementById('trivia-name');
    const triviaEmail = document.getElementById('trivia-email');
    const triviaRoleBadge = document.getElementById('trivia-role-badge');
    const triviaJoinDate = document.getElementById('trivia-join-date');
    const triviaLastLogin = document.getElementById('trivia-last-login');
    
    // UI Elements for Patreon account
    const patreonProfilePic = document.getElementById('patreon-profile-pic');
    const patreonName = document.getElementById('patreon-name');
    const patreonEmail = document.getElementById('patreon-email');
    const patreonTierBadge = document.getElementById('patreon-tier-badge');
    const patreonTier = document.getElementById('patreon-tier');
    const patreonPledge = document.getElementById('patreon-pledge');
    const patreonStatus = document.getElementById('patreon-status');
    
    // Add disconnect Patreon button
    const disconnectPatreonBtn = document.getElementById('disconnect-patreon-btn');
    
    // Format date in a readable format
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
    
    // Display the Evil Trivia user info
    async function displayTriviaUserInfo(user) {
      try {
        console.log('Fetching user data for:', user.uid);
        
        // Get user profile from database
        const snapshot = await db.ref(`users/${user.uid}`).once('value');
        const userData = snapshot.val() || {};
        console.log('User data from database:', userData);
        
        // Update UI elements
        const fullName = userData.firstName && userData.lastName 
          ? `${userData.firstName} ${userData.lastName}`
          : userData.firstName || user.displayName || user.email.split('@')[0];
        
        triviaName.textContent = fullName;
        triviaEmail.textContent = user.email || 'No email provided';
        
        // Set profile picture
        triviaProfilePic.src = userData.photoURL || user.photoURL || '/images/default_profile.png';
        
        // Get user roles - handle both new array format and legacy string format
        let userRoles = [];
        if (userData.roles && Array.isArray(userData.roles)) {
            userRoles = userData.roles;
        } else if (userData.role && typeof userData.role === 'string') {
            userRoles = [userData.role];
        }
        
        // Set role badge with proper styling based on primary role (first in array)
        const primaryRole = userRoles.length > 0 ? userRoles[0] : 'member';
        triviaRoleBadge.textContent = primaryRole.charAt(0).toUpperCase() + primaryRole.slice(1);
        
        // Apply special styling for different roles
        if (userRoles.includes('admin')) {
            triviaRoleBadge.style.backgroundColor = '#FF0000';
        } else if (userRoles.includes('grader')) {
            triviaRoleBadge.style.backgroundColor = '#0066CC';
        } else if (userRoles.includes('patron')) {
            triviaRoleBadge.style.backgroundColor = '#FF424D'; // Patreon color
        } else {
            triviaRoleBadge.style.backgroundColor = '#000000';
        }
        
        // Display all roles in the user-roles-container
        const userRolesContainer = document.getElementById('user-roles-container');
        userRolesContainer.innerHTML = '';
        
        if (userRoles.length > 1) {
          const roleLabel = document.createElement('div');
          roleLabel.textContent = 'Additional Roles:';
          roleLabel.style.fontWeight = 'bold';
          roleLabel.style.marginBottom = '5px';
          userRolesContainer.appendChild(roleLabel);
          
          // Skip the primary role since it's already displayed in the badge
          for (let i = 1; i < userRoles.length; i++) {
            const role = userRoles[i];
            const roleBadge = document.createElement('div');
            roleBadge.className = 'membership-badge';
            roleBadge.textContent = role.charAt(0).toUpperCase() + role.slice(1);
            roleBadge.style.marginRight = '5px';
            roleBadge.style.display = 'inline-block';
            
            // Set badge color based on role
            if (role === 'admin') {
              roleBadge.style.backgroundColor = '#FF0000';
            } else if (role === 'grader') {
              roleBadge.style.backgroundColor = '#0066CC';
            } else if (role === 'patron') {
              roleBadge.style.backgroundColor = '#FF424D';
            } else {
              roleBadge.style.backgroundColor = '#000000';
            }
            
            userRolesContainer.appendChild(roleBadge);
          }
        }
        
        // Set join date
        const joinDate = userData.createdAt || user.metadata.creationTime;
        triviaJoinDate.textContent = formatDate(joinDate);
        
        // Set last login
        triviaLastLogin.textContent = formatDate(user.metadata.lastSignInTime);
        
        // Show the logged in state
        triviaLoading.classList.add('hidden');
        triviaNotLoggedIn.classList.add('hidden');
        triviaLoggedIn.classList.remove('hidden');
        
        // Check for Patreon connection or patron role
        if (userData.patreonId || userRoles.includes('patron')) {
          loadPatreonData(userData.patreonId);
        } else {
          // No Patreon connection
          patreonLoading.classList.add('hidden');
          patreonNotConnected.classList.remove('hidden');
          patreonConnected.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('Error loading user data:', error);
        triviaLoading.classList.add('hidden');
        triviaNotLoggedIn.classList.remove('hidden');
      }
    }
    
    // Load Patreon user data
    async function loadPatreonData(patreonId) {
      try {
        console.log('Loading Patreon data for ID:', patreonId);
        
        // Get Patreon user info from the database
        let patreonUserData = null;
        try {
          const snapshot = await db.ref(`patreonUsers/${patreonId}`).once('value');
          patreonUserData = snapshot.val();
          console.log('Patreon data from database:', patreonUserData);
        } catch (dbError) {
          console.warn('Could not access patreonUsers database:', dbError.message);
          // This might happen if the user doesn't have permission to access patreonUsers node
          // We'll fall back to localStorage-only data
        }
        
        if (!patreonUserData) {
          console.log('No Patreon data found in Firebase, checking localStorage');
          // No Patreon data found in Firebase
          if (localStorage.getItem('patreonAuthenticated') === 'true') {
            console.log('Patreon authenticated via localStorage');
            
            // Check if we have any saved Patreon user info
            const savedName = localStorage.getItem('patreonFullName');
            const savedEmail = localStorage.getItem('patreonEmail');
            const savedTier = localStorage.getItem('patreonTier');
            const savedImageUrl = localStorage.getItem('patreonImageUrl');
            const savedPledgeAmount = localStorage.getItem('patreonPledgeAmount');
            
            // We have authentication from localStorage, show connected state with available info
            patreonName.textContent = savedName || 'Patreon User';
            patreonEmail.textContent = savedEmail || 'Authenticated via Patreon';
            patreonTier.textContent = savedTier || 'Connected';
            patreonTierBadge.textContent = savedTier || 'Connected';
            patreonPledge.textContent = savedPledgeAmount || '0.00';
            patreonStatus.textContent = 'Active'; // If we have localStorage auth, user is likely active
            
            // Set profile picture if available
            if (savedImageUrl) {
              patreonProfilePic.src = savedImageUrl;
            }
            
            // Show the connected state
            patreonLoading.classList.add('hidden');
            patreonNotConnected.classList.add('hidden');
            patreonConnected.classList.remove('hidden');
            return;
          } else {
            // No patreon data anywhere, show not connected
            patreonLoading.classList.add('hidden');
            patreonNotConnected.classList.remove('hidden');
            patreonConnected.classList.add('hidden');
            return;
          }
        }
        
        console.log('Found Patreon user data:', patreonUserData);
        
        // Save essential Patreon info to localStorage for fallback
        localStorage.setItem('patreonFullName', patreonUserData.fullName || '');
        localStorage.setItem('patreonEmail', patreonUserData.email || '');
        localStorage.setItem('patreonImageUrl', patreonUserData.imageUrl || '');
        
        if (patreonUserData.pledgeAmountDollars) {
          localStorage.setItem('patreonPledgeAmount', patreonUserData.pledgeAmountDollars);
        } else if (patreonUserData.membershipData && patreonUserData.membershipData.attributes) {
          const attrs = patreonUserData.membershipData.attributes;
          localStorage.setItem('patreonTier', attrs.patron_status || 'Connected');
          
          // If we have the pledge amount in cents, convert and store
          if (attrs.currently_entitled_amount_cents) {
            const amountDollars = (attrs.currently_entitled_amount_cents / 100).toFixed(2);
            localStorage.setItem('patreonPledgeAmount', amountDollars);
          }
        }
        
        // Update Patreon UI elements
        patreonName.textContent = patreonUserData.fullName || 'Patron';
        patreonEmail.textContent = patreonUserData.email || 'No email provided';
        
        // Set profile picture
        patreonProfilePic.src = patreonUserData.imageUrl || '/images/default_profile.png';
        
        // Membership info
        const membership = patreonUserData.membershipData || {};
        const attributes = membership.attributes || {};
        
        // Set tier info
        const patronStatus = attributes.patron_status || 'Connected';
        patreonTier.textContent = patronStatus;
        patreonTierBadge.textContent = patronStatus;
        
        // Set pledge amount
        const pledgeAmountCents = patreonUserData.pledgeAmountCents || 
                                attributes.currently_entitled_amount_cents || 0;
        patreonPledge.textContent = patreonUserData.pledgeAmountDollars || 
                                  (pledgeAmountCents / 100).toFixed(2);
        
        // Set status
        patreonStatus.textContent = patreonUserData.isActiveMember ? 'Active' : 'Inactive';
        
        // Show the connected state
        patreonLoading.classList.add('hidden');
        patreonNotConnected.classList.add('hidden');
        patreonConnected.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading Patreon data:', error);
        
        // Check if we have a localStorage backup
        if (localStorage.getItem('patreonAuthenticated') === 'true') {
          console.log('Falling back to localStorage Patreon authentication');
          
          // Check for saved Patreon info
          const savedName = localStorage.getItem('patreonFullName');
          const savedEmail = localStorage.getItem('patreonEmail');
          const savedTier = localStorage.getItem('patreonTier');
          const savedImageUrl = localStorage.getItem('patreonImageUrl');
          const savedPledgeAmount = localStorage.getItem('patreonPledgeAmount');
          
          // Show available information
          patreonName.textContent = savedName || 'Patreon User';
          patreonEmail.textContent = savedEmail || 'Error loading full details';
          patreonTier.textContent = savedTier || 'Connected';
          patreonTierBadge.textContent = savedTier || 'Connected';
          
          if (savedImageUrl) {
            patreonProfilePic.src = savedImageUrl;
          }
          
          patreonPledge.textContent = savedPledgeAmount || '0.00';
          patreonStatus.textContent = 'Active'; // Default to active if authenticated
          
          patreonLoading.classList.add('hidden');
          patreonNotConnected.classList.add('hidden');
          patreonConnected.classList.remove('hidden');
        } else {
          patreonLoading.classList.add('hidden');
          patreonNotConnected.classList.remove('hidden');
          patreonConnected.classList.add('hidden');
        }
      }
    }
    
    // Handle Evil Trivia login button
    document.getElementById('show-login-option').addEventListener('click', (e) => {
      e.preventDefault();
      // Ensure the login section is visible
      document.getElementById('login-form-section').style.display = 'block';
      document.getElementById('signup-form-section').style.display = 'none';
      
      // Focus on the FirebaseUI container
      document.getElementById('firebaseui-auth-container').scrollIntoView({ behavior: 'smooth' });
      
      // Start the UI with our config
      ui.start('#firebaseui-auth-container', uiConfig);
    });
    
    // Handle Patreon login button
    patreonLoginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      
      // Store the current auth state in localStorage
      const isLoggedIn = !!auth.currentUser;
      localStorage.setItem('wasLoggedInBeforePatreon', isLoggedIn ? 'true' : 'false');
      
      // Show loading state
      patreonLoading.classList.remove('hidden');
      patreonNotConnected.classList.add('hidden');
      
      // Redirect to Patreon OAuth
      window.location.href = `https://patreonauth-vapvabofwq-uc.a.run.app/auth/patreon?returnUrl=${encodeURIComponent(window.location.href)}`;
    });
    
    // Handle logout
    logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        console.log('User signed out');
        // Don't redirect, just refresh the page
        window.location.reload();
      }).catch(error => {
        console.error('Sign out error:', error);
      });
    });
    
    // Handle Patreon disconnect
    disconnectPatreonBtn.addEventListener('click', async () => {
      try {
        // Check if user is signed in
        if (auth.currentUser) {
          // Get patreon ID
          const snapshot = await db.ref(`users/${auth.currentUser.uid}/patreonId`).once('value');
          const patreonId = snapshot.val();
          
          if (patreonId) {
            // Remove the connection in Firebase
            await db.ref(`users/${auth.currentUser.uid}/patreonId`).remove();
            try {
              await db.ref(`patreonUsers/${patreonId}/firebaseUid`).remove();
            } catch (error) {
              console.warn('Could not remove firebaseUid from patreonUsers, may lack permission:', error.message);
            }
          } else {
            console.warn('No Patreon ID found in user data, but disconnect was attempted');
          }
        } else {
          console.log('No user is signed in, but disconnect was attempted');
        }
        
        // Always remove from local storage regardless of signed in state
        localStorage.removeItem('patreonUserId');
        localStorage.removeItem('patreonAuthenticated');
        
        console.log('Patreon account disconnected');
        
        // Refresh the page to update UI
        window.location.reload();
      } catch (error) {
        console.error('Error disconnecting Patreon account:', error);
      }
    });
    
    // Listen for auth state changes
    auth.onAuthStateChanged(async (user) => {
      // First, check for "Not Authorized" message and replace it if found
      if (document.body.innerText.includes('Not Authorized') && 
          document.body.innerText.includes('is not authorized to view the requested page')) {
        console.log('Detected "Not Authorized" message - replacing with login form');
        
        // Reload the page instead of trying to modify DOM - this is simpler and more reliable
        window.location.href = window.location.pathname;
        return;
      }
      
      if (user) {
        // User is signed in
        console.log('User is signed in:', user.uid);
        
        // Show Patreon card when user is logged in
        document.getElementById('patreon-card').style.display = 'block';
        
        try {
          // Check if user exists in our database (is authorized)
          const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
          
          if (!userSnapshot.exists()) {
            console.warn('User authenticated but not found in database - creating minimal record');
            // Create a minimal user record if they don't exist in our database
            await db.ref(`users/${user.uid}`).set({
              email: user.email,
              role: 'member', // Default role
              createdAt: new Date().toISOString()
            });
          }
          
          // Display Evil Trivia user info
          await displayTriviaUserInfo(user);
          
          // Check for Patreon connection
          const userData = userSnapshot.val() || {};
          if (userData.patreonId) {
            console.log('User has Patreon connection:', userData.patreonId);
            loadPatreonData(userData.patreonId);
          } else {
            // Also check localStorage for Patreon ID as fallback
            const patreonId = localStorage.getItem('patreonUserId');
            if (patreonId) {
              console.log('Found Patreon ID in localStorage:', patreonId);
              
              // Update user data with Patreon ID if not already set
              if (!userData.patreonId) {
                console.log('Updating user with Patreon ID from localStorage');
                await db.ref(`users/${user.uid}/patreonId`).set(patreonId);
              }
              
              // Load Patreon data
              loadPatreonData(patreonId);
            } else {
              // No Patreon connection
              patreonLoading.classList.add('hidden');
              patreonNotConnected.classList.remove('hidden');
              patreonConnected.classList.add('hidden');
            }
          }
        } catch (error) {
          console.error('Error checking user authorization:', error);
          // Show login section in case of error
          triviaLoading.classList.add('hidden');
          triviaLoggedIn.classList.add('hidden');
          triviaNotLoggedIn.classList.remove('hidden');
        }
      } else {
        // User is signed out, show sign-in options for both services
        console.log('User is signed out, showing sign-in options');
        
        // Hide Patreon card when user is not logged in
        document.getElementById('patreon-card').style.display = 'none';
        
        // Show Evil Trivia sign-in option
        triviaLoading.classList.add('hidden');
        triviaLoggedIn.classList.add('hidden');
        triviaNotLoggedIn.classList.remove('hidden');
        
        // Ensure initial options view is shown by default
        document.getElementById('initial-auth-choice').style.display = 'block';
        document.getElementById('login-form-section').style.display = 'none';
        document.getElementById('signup-form-section').style.display = 'none';
      }
    });
    
    // Check for Patreon auth callback
    function checkUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const authSuccess = urlParams.get('auth_success');
      const patreonId = urlParams.get('patreon_id');
      const firebaseToken = urlParams.get('firebase_token');
      const tokenError = urlParams.get('token_error');
      
      // Additional Patreon user information that might be included
      const patreonName = urlParams.get('patreon_name');
      const patreonEmail = urlParams.get('patreon_email');
      const patreonImage = urlParams.get('patreon_image');
      const patreonTier = urlParams.get('patreon_tier');
      const patreonPledge = urlParams.get('patreon_pledge');
      
      if (authSuccess === 'true' && patreonId) {
        console.log('Patreon auth successful with ID:', patreonId);
        // Store Patreon ID
        localStorage.setItem('patreonUserId', patreonId);
        localStorage.setItem('patreonAuthenticated', 'true');
        
        // Store additional Patreon user info if available
        if (patreonName) localStorage.setItem('patreonFullName', patreonName);
        if (patreonEmail) localStorage.setItem('patreonEmail', patreonEmail);
        if (patreonImage) localStorage.setItem('patreonImageUrl', patreonImage);
        if (patreonTier) localStorage.setItem('patreonTier', patreonTier);
        if (patreonPledge) localStorage.setItem('patreonPledgeAmount', patreonPledge);
        
        // Check if user was logged in before Patreon redirect
        const wasLoggedIn = localStorage.getItem('wasLoggedInBeforePatreon') === 'true';
        localStorage.removeItem('wasLoggedInBeforePatreon'); // Clean up
        
        // If we have a Firebase token, sign in with it
        if (firebaseToken) {
          auth.signInWithCustomToken(firebaseToken)
            .then(() => {
              console.log('Signed in with custom token');
              // Immediately check for user data
              if (auth.currentUser) {
                displayTriviaUserInfo(auth.currentUser);
              }
            })
            .catch(error => {
              console.error('Error signing in with custom token:', error);
              handleTokenError(patreonId);
            });
        } else if (tokenError === 'true') {
          // Handle the case where the server couldn't generate a token
          console.log('Server could not generate a custom token, using fallback authentication');
          handleTokenError(patreonId);
        } else if (!wasLoggedIn) {
          // User wasn't logged in before and we don't have a token
          // Just load Patreon data without Evil Trivia login
          console.log('Loading Patreon data for non-logged-in user');
          patreonLoading.classList.remove('hidden');
          loadPatreonData(patreonId);
        }
        
        // Clean URL parameters
        const newUrl = new URL(window.location.href);
        newUrl.search = '';
        window.history.replaceState({}, document.title, newUrl.toString());
      }
    }
    
    // Handle the case where we can't get a custom token but still have Patreon auth
    async function handleTokenError(patreonId) {
      // Check if user is already signed in
      if (auth.currentUser) {
        // Add patreonId to user data
        try {
          // Get current user data to update roles
          const userSnapshot = await db.ref(`users/${auth.currentUser.uid}`).once('value');
          const userData = userSnapshot.val() || {};
          
          // Prepare user roles update
          let userRoles = [];
          if (userData.roles && Array.isArray(userData.roles)) {
            userRoles = userData.roles;
          } else if (userData.role && typeof userData.role === 'string') {
            userRoles = [userData.role];
          }
          
          // Add 'patron' role if not already present
          if (!userRoles.includes('patron')) {
            userRoles.push('patron');
          }
          
          // Update user data with Patreon ID and roles
          await db.ref(`users/${auth.currentUser.uid}`).update({
            patreonId: patreonId,
            roles: userRoles,
            role: userRoles[0] // Keep the first role as primary for backward compatibility
          });
          
          console.log('Added Patreon ID to existing user and updated roles');
          displayTriviaUserInfo(auth.currentUser);
        } catch (error) {
          console.error('Error updating user data:', error);
        }
      } else {
        // No user is signed in
        const wasLoggedIn = localStorage.getItem('wasLoggedInBeforePatreon') === 'true';
        localStorage.removeItem('wasLoggedInBeforePatreon'); // Clean up
        
        if (wasLoggedIn) {
          // User was logged in before, but now they're not
          // Store the Patreon ID in localStorage and refresh the page
          localStorage.setItem('pendingPatreonConnect', 'true');
          localStorage.setItem('pendingPatreonId', patreonId);
          window.location.reload();
        } else {
          // User was not logged in before, just show Patreon data
          console.log('User was not logged in before, showing Patreon data without login');
          loadPatreonData(patreonId);
        }
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Show login state by default
      triviaLoading.classList.add('hidden');
      triviaLoggedIn.classList.add('hidden');
      triviaNotLoggedIn.classList.remove('hidden');
      
      // Ensure initial options view is shown
      document.getElementById('initial-auth-choice').style.display = 'block';
      document.getElementById('login-form-section').style.display = 'none';
      document.getElementById('signup-form-section').style.display = 'none';
      
      // Check URL parameters for auth callbacks
      checkUrlParams();
      
      // Check for pending Patreon connection
      const pendingPatreonConnect = localStorage.getItem('pendingPatreonConnect');
      const pendingPatreonId = localStorage.getItem('pendingPatreonId');
      
      if (pendingPatreonConnect === 'true' && pendingPatreonId && auth.currentUser) {
        // Connect Patreon ID to current user
        db.ref(`users/${auth.currentUser.uid}`).once('value')
          .then(userSnapshot => {
            const userData = userSnapshot.val() || {};
            
            // Prepare user roles update
            let userRoles = [];
            if (userData.roles && Array.isArray(userData.roles)) {
              userRoles = userData.roles;
            } else if (userData.role && typeof userData.role === 'string') {
              userRoles = [userData.role];
            }
            
            // Add 'patron' role if not already present
            if (!userRoles.includes('patron')) {
              userRoles.push('patron');
            }
            
            // Update user data with Patreon ID and roles
            return db.ref(`users/${auth.currentUser.uid}`).update({
              patreonId: pendingPatreonId,
              roles: userRoles,
              role: userRoles[0] // Keep the first role as primary for backward compatibility
            });
          })
          .then(() => {
            console.log('Connected pending Patreon ID to user and updated roles');
            // Clear pending flags
            localStorage.removeItem('pendingPatreonConnect');
            localStorage.removeItem('pendingPatreonId');
            // Refresh user info
            displayTriviaUserInfo(auth.currentUser);
          })
          .catch(error => {
            console.error('Error connecting Patreon ID:', error);
          });
      }
      
      // Set up navigation between forms
      document.getElementById('show-login-option').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('initial-auth-choice').style.display = 'none';
        document.getElementById('login-form-section').style.display = 'block';
      });
      
      document.getElementById('show-signup-option').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('initial-auth-choice').style.display = 'none';
        document.getElementById('signup-form-section').style.display = 'block';
      });
      
      document.getElementById('back-to-options').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('login-form-section').style.display = 'none';
        document.getElementById('initial-auth-choice').style.display = 'block';
      });
      
      document.getElementById('back-to-options-from-signup').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('signup-form-section').style.display = 'none';
        document.getElementById('initial-auth-choice').style.display = 'block';
      });
      
      // Handle login form submission
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const emailInput = document.getElementById('login-email');
        const passwordInput = document.getElementById('login-password');
        const errorElement = document.getElementById('login-error');
        
        // Clear previous errors
        errorElement.style.display = 'none';
        
        // Get form values
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        
        // Validate inputs
        if (!email || !password) {
          errorElement.textContent = 'Please enter your email and password';
          errorElement.style.display = 'block';
          return;
        }
        
        try {
          // Sign in with Firebase
          await auth.signInWithEmailAndPassword(email, password);
          console.log('Login successful');
          
          // Auth state listener will handle UI updates
          emailInput.value = '';
          passwordInput.value = '';
        } catch (error) {
          console.error('Login error:', error);
          errorElement.textContent = error.message;
          errorElement.style.display = 'block';
        }
      });
      
      // Handle registration form submission
      document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const codeInput = document.getElementById('signup-code');
        const emailInput = document.getElementById('signup-email');
        const passwordInput = document.getElementById('signup-password');
        const confirmInput = document.getElementById('signup-confirm');
        const errorElement = document.getElementById('signup-error');
        
        // Clear previous errors
        errorElement.style.display = 'none';
        
        // Get form values
        const registrationCode = codeInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const confirm = confirmInput.value;
        
        // Validate inputs
        if (!registrationCode || !email || !password || !confirm) {
          errorElement.textContent = 'Please fill in all fields';
          errorElement.style.display = 'block';
          return;
        }
        
        if (password.length < 6) {
          errorElement.textContent = 'Password must be at least 6 characters';
          errorElement.style.display = 'block';
          return;
        }
        
        if (password !== confirm) {
          errorElement.textContent = 'Passwords do not match';
          errorElement.style.display = 'block';
          return;
        }
        
        try {
          // Check if the registration code is valid
          let role = null;
          let roles = [];
          
          // Get the known registration codes from the database
          const codesSnapshot = await db.ref('adminSettings/registrationCodes').once('value');
          const registrationCodes = codesSnapshot.exists() ? codesSnapshot.val() : {
            admin: 'leoisbritish',
            grader: 'lemon',
            patron: 'gram',
            tools: 'toolbox'
          };
          
          // Check if the entered code matches any of the known codes
          if (registrationCode === registrationCodes.admin) {
            role = 'admin';
            roles = ['admin'];
          } else if (registrationCode === registrationCodes.grader) {
            role = 'grader';
            roles = ['grader'];
          } else if (registrationCode === registrationCodes.patron) {
            role = 'patron';
            roles = ['patron'];
          } else if (registrationCode === registrationCodes.tools) {
            role = 'tools';
            roles = ['tools'];
          } else {
            errorElement.textContent = 'Invalid registration code';
            errorElement.style.display = 'block';
            return;
          }
          
          // Create the user account
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          
          // Store user data in database with the appropriate role
          await db.ref(`users/${userCredential.user.uid}`).set({
            email: email,
            role: role, // For backward compatibility
            roles: roles, // New roles array for multiple roles
            firstName: email.split('@')[0],
            createdAt: new Date().toISOString()
          });
          
          console.log('Account created successfully with role:', role);
          
          // The auth state change listener will handle UI updates
          // Reset form
          codeInput.value = '';
          emailInput.value = '';
          passwordInput.value = '';
          confirmInput.value = '';
          
        } catch (error) {
          console.error('Registration error:', error);
          errorElement.textContent = error.message;
          errorElement.style.display = 'block';
        }
      });
    });
  </script>
</body>
</html>
