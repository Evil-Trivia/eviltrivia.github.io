<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evil Trivia - My Account</title>
  <script src="/autoload-banner.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFCC00;
      margin-top: 60px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .account-section {
      margin: 20px auto;
      max-width: 900px;
    }
    
    .account-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    @media (max-width: 768px) {
      .account-cards {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card-title {
      margin-top: 0;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      font-size: 1.5em;
      color: #333;
    }
    
    .card-title img {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 20px;
      background-color: #000000;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    
    .btn:hover {
      background-color: #333333;
    }
    
    .btn-patreon {
      background-color: #FF424D;
    }
    
    .btn-patreon:hover {
      background-color: #E13641;
    }
    
    .profile-info {
      margin: 20px 0;
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .profile-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 20px;
      background-color: #f5f5f5;
    }
    
    .membership-badge {
      display: inline-block;
      padding: 5px 10px;
      background-color: #000000;
      color: white;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000000;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    #firebaseui-auth-container {
      margin: 20px 0;
    }
    
    .login-btn {
      display: block;
      margin: 20px auto;
      transition: transform 0.2s;
    }
    
    .login-btn:hover {
      transform: scale(1.05);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .info-row {
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding: 5px 0;
    }
    
    .info-row strong {
      color: #666;
    }
    
    .card-content {
      min-height: 200px;
      position: relative;
    }
    
    .not-logged-in-message {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>My Account</h1>
    
    <section class="account-section">
      <div class="account-cards">
        <!-- Evil Trivia Account Card -->
        <div class="card">
          <h2 class="card-title">
            <img src="/images/evil_trivia_icon.png" alt="Evil Trivia Icon">
            Evil Trivia Account
          </h2>
          
          <div class="card-content">
            <!-- Loading State -->
            <div id="trivia-loading" class="loader"></div>
            
            <!-- Not Logged In State -->
            <div id="trivia-not-logged-in" class="hidden">
              <div class="not-logged-in-message">
                <p>Sign in to access your Evil Trivia account.</p>
                <div id="firebaseui-auth-container"></div>
                <button id="trivia-login-btn" class="btn">Sign In</button>
              </div>
            </div>
            
            <!-- Logged In State -->
            <div id="trivia-logged-in" class="hidden">
              <div class="profile-header">
                <img id="trivia-profile-pic" src="/images/default_profile.png" alt="Profile Picture" class="profile-pic">
                <div>
                  <h3 id="trivia-name">Loading...</h3>
                  <p id="trivia-email">loading@example.com</p>
                  <div id="trivia-role-badge" class="membership-badge">Member</div>
                </div>
              </div>
              
              <div class="profile-info">
                <div class="info-row">
                  <strong>Member Since:</strong>
                  <span id="trivia-join-date">January 1, 2023</span>
                </div>
                <div class="info-row">
                  <strong>Last Login:</strong>
                  <span id="trivia-last-login">Today</span>
                </div>
              </div>
              
              <button id="logout-btn" class="btn">Sign Out</button>
            </div>
          </div>
        </div>
        
        <!-- Patreon Account Card -->
        <div class="card">
          <h2 class="card-title">
            <img src="/images/patreon_icon.png" alt="Patreon Icon">
            Patreon Membership
          </h2>
          
          <div class="card-content">
            <!-- Loading State -->
            <div id="patreon-loading" class="loader"></div>
            
            <!-- Not Connected State -->
            <div id="patreon-not-connected" class="hidden">
              <div class="not-logged-in-message">
                <p>Connect your Patreon account to access exclusive content.</p>
                <a id="patreon-login-btn" href="#" class="login-btn">
                  <img
                    src="https://c5.patreon.com/external/logo/login_with_patreon@2x.png"
                    width="272" 
                    height="44"
                    alt="Login with Patreon"
                  />
                </a>
              </div>
            </div>
            
            <!-- Connected State -->
            <div id="patreon-connected" class="hidden">
              <div class="profile-header">
                <img id="patreon-profile-pic" src="/images/default_profile.png" alt="Patreon Profile" class="profile-pic">
                <div>
                  <h3 id="patreon-name">Loading...</h3>
                  <p id="patreon-email">loading@example.com</p>
                  <div id="patreon-tier-badge" class="membership-badge">Supporter</div>
                </div>
              </div>
              
              <div class="profile-info">
                <div class="info-row">
                  <strong>Membership Tier:</strong>
                  <span id="patreon-tier">Supporter</span>
                </div>
                <div class="info-row">
                  <strong>Monthly Pledge:</strong>
                  $<span id="patreon-pledge">5.00</span>
                </div>
                <div class="info-row">
                  <strong>Status:</strong>
                  <span id="patreon-status">Active</span>
                </div>
              </div>
              
              <div class="center">
                <a href="https://www.patreon.com/EvilTrivia/membership" target="_blank" class="btn btn-patreon">Manage Membership</a>
                <button id="disconnect-patreon-btn" class="btn" style="margin-top: 10px; background-color: #ff424d33; color: #FF424D; border: 1px solid #FF424D;">Disconnect Patreon</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBruAY3SH0eO000LrYqwcOGXNaUuznoMkc",
      authDomain: "eviltrivia-47664.firebaseapp.com",
      databaseURL: "https://eviltrivia-47664-default-rtdb.firebaseio.com",
      projectId: "eviltrivia-47664",
      storageBucket: "eviltrivia-47664.firebasestorage.app",
      messagingSenderId: "401826818140",
      appId: "1:401826818140:web:c1df0bf4c602cc48231e99",
      measurementId: "G-2W6RK96Y34"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // Your Cloud Function URL 
    const firebaseFunctionUrl = "https://patreonauth-vapvabofwq-uc.a.run.app";
    
    // DOM Elements
    const triviaLoading = document.getElementById('trivia-loading');
    const triviaNotLoggedIn = document.getElementById('trivia-not-logged-in');
    const triviaLoggedIn = document.getElementById('trivia-logged-in');
    const triviaLoginBtn = document.getElementById('trivia-login-btn');
    
    const patreonLoading = document.getElementById('patreon-loading');
    const patreonNotConnected = document.getElementById('patreon-not-connected');
    const patreonConnected = document.getElementById('patreon-connected');
    const patreonLoginBtn = document.getElementById('patreon-login-btn');
    
    const logoutBtn = document.getElementById('logout-btn');
    
    // UI Elements for Trivia account
    const triviaProfilePic = document.getElementById('trivia-profile-pic');
    const triviaName = document.getElementById('trivia-name');
    const triviaEmail = document.getElementById('trivia-email');
    const triviaRoleBadge = document.getElementById('trivia-role-badge');
    const triviaJoinDate = document.getElementById('trivia-join-date');
    const triviaLastLogin = document.getElementById('trivia-last-login');
    
    // UI Elements for Patreon account
    const patreonProfilePic = document.getElementById('patreon-profile-pic');
    const patreonName = document.getElementById('patreon-name');
    const patreonEmail = document.getElementById('patreon-email');
    const patreonTierBadge = document.getElementById('patreon-tier-badge');
    const patreonTier = document.getElementById('patreon-tier');
    const patreonPledge = document.getElementById('patreon-pledge');
    const patreonStatus = document.getElementById('patreon-status');
    
    // Add disconnect Patreon button
    const disconnectPatreonBtn = document.getElementById('disconnect-patreon-btn');
    
    // Initialize FirebaseUI for Auth
    const ui = new firebaseui.auth.AuthUI(auth);
    
    // Firebase Auth UI configuration
    const uiConfig = {
      signInOptions: [
        firebase.auth.EmailAuthProvider.PROVIDER_ID,
        firebase.auth.GoogleAuthProvider.PROVIDER_ID
      ],
      callbacks: {
        signInSuccessWithAuthResult: function(authResult, redirectUrl) {
          // Don't redirect after sign-in
          return false;
        }
      }
    };
    
    // Format date in a readable format
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
    
    // Display the Evil Trivia user info
    async function displayTriviaUserInfo(user) {
      try {
        // Get user profile from database
        const snapshot = await db.ref(`users/${user.uid}`).once('value');
        const userData = snapshot.val() || {};
        
        // Update UI elements
        triviaName.textContent = userData.displayName || user.displayName || 'Evil Trivia User';
        triviaEmail.textContent = user.email || 'No email provided';
        
        // Set profile picture
        triviaProfilePic.src = userData.photoURL || user.photoURL || '/images/default_profile.png';
        
        // Set role badge
        const role = userData.role || 'member';
        triviaRoleBadge.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        
        // Set join date
        const joinDate = userData.createdAt || user.metadata.creationTime;
        triviaJoinDate.textContent = formatDate(joinDate);
        
        // Set last login
        triviaLastLogin.textContent = formatDate(user.metadata.lastSignInTime);
        
        // Show the logged in state
        triviaLoading.classList.add('hidden');
        triviaNotLoggedIn.classList.add('hidden');
        triviaLoggedIn.classList.remove('hidden');
        
        // Check for Patreon connection
        if (userData.patreonId) {
          loadPatreonData(userData.patreonId);
        } else {
          // No Patreon connection
          patreonLoading.classList.add('hidden');
          patreonNotConnected.classList.remove('hidden');
          patreonConnected.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('Error loading user data:', error);
        triviaLoading.classList.add('hidden');
        triviaNotLoggedIn.classList.remove('hidden');
      }
    }
    
    // Load Patreon user data
    async function loadPatreonData(patreonId) {
      try {
        console.log('Loading Patreon data for ID:', patreonId);
        
        // Get Patreon user info from the database
        let patreonUserData = null;
        try {
          const snapshot = await db.ref(`patreonUsers/${patreonId}`).once('value');
          patreonUserData = snapshot.val();
          console.log('Patreon data from database:', patreonUserData);
        } catch (dbError) {
          console.warn('Could not access patreonUsers database:', dbError.message);
          // This might happen if the user doesn't have permission to access patreonUsers node
          // We'll fall back to localStorage-only data
        }
        
        if (!patreonUserData) {
          console.log('No Patreon data found in Firebase, checking localStorage');
          // No Patreon data found in Firebase
          if (localStorage.getItem('patreonAuthenticated') === 'true') {
            console.log('Patreon authenticated via localStorage');
            // We have authentication from localStorage, show minimal connected state
            patreonName.textContent = 'Patreon User';
            patreonEmail.textContent = 'Authenticated via Patreon';
            patreonTier.textContent = 'Unknown';
            patreonTierBadge.textContent = 'Connected';
            patreonPledge.textContent = '0.00';
            patreonStatus.textContent = 'Status Unknown';
            
            // Show the connected state with limited info
            patreonLoading.classList.add('hidden');
            patreonNotConnected.classList.add('hidden');
            patreonConnected.classList.remove('hidden');
            return;
          } else {
            // No patreon data anywhere, show not connected
            patreonLoading.classList.add('hidden');
            patreonNotConnected.classList.remove('hidden');
            patreonConnected.classList.add('hidden');
            return;
          }
        }
        
        console.log('Found Patreon user data:', patreonUserData);
        
        // Update Patreon UI elements
        patreonName.textContent = patreonUserData.fullName || 'Patron';
        patreonEmail.textContent = patreonUserData.email || 'No email provided';
        
        // Set profile picture
        patreonProfilePic.src = patreonUserData.imageUrl || '/images/default_profile.png';
        
        // Membership info
        const membership = patreonUserData.membershipData || {};
        const attributes = membership.attributes || {};
        
        // Set tier info
        const patronStatus = attributes.patron_status || 'Not Active';
        patreonTier.textContent = patronStatus;
        patreonTierBadge.textContent = patronStatus;
        
        // Set pledge amount
        const pledgeAmountCents = attributes.currently_entitled_amount_cents || 0;
        patreonPledge.textContent = (pledgeAmountCents / 100).toFixed(2);
        
        // Set status
        patreonStatus.textContent = patreonUserData.isActiveMember ? 'Active' : 'Inactive';
        
        // Show the connected state
        patreonLoading.classList.add('hidden');
        patreonNotConnected.classList.add('hidden');
        patreonConnected.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading Patreon data:', error);
        
        // Check if we have a localStorage backup
        if (localStorage.getItem('patreonAuthenticated') === 'true') {
          console.log('Falling back to localStorage Patreon authentication');
          // Show minimal connected state
          patreonName.textContent = 'Patreon User';
          patreonEmail.textContent = 'Error loading full details';
          patreonTier.textContent = 'Unknown';
          patreonTierBadge.textContent = 'Connected';
          patreonPledge.textContent = '0.00';
          patreonStatus.textContent = 'Status Unknown';
          
          patreonLoading.classList.add('hidden');
          patreonNotConnected.classList.add('hidden');
          patreonConnected.classList.remove('hidden');
        } else {
          patreonLoading.classList.add('hidden');
          patreonNotConnected.classList.remove('hidden');
          patreonConnected.classList.add('hidden');
        }
      }
    }
    
    // Handle Evil Trivia login button
    triviaLoginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      // Instead of redirecting to login page, show the FirebaseUI
      triviaNotLoggedIn.classList.remove('hidden');
      ui.start('#firebaseui-auth-container', uiConfig);
    });
    
    // Handle Patreon login button
    patreonLoginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      
      // Store the current auth state in localStorage
      const isLoggedIn = !!auth.currentUser;
      localStorage.setItem('wasLoggedInBeforePatreon', isLoggedIn ? 'true' : 'false');
      
      // Show loading state
      patreonLoading.classList.remove('hidden');
      patreonNotConnected.classList.add('hidden');
      
      // Redirect to Patreon OAuth
      window.location.href = `https://patreonauth-vapvabofwq-uc.a.run.app/auth/patreon?returnUrl=${encodeURIComponent(window.location.href)}`;
    });
    
    // Handle logout
    logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => {
        console.log('User signed out');
        // Don't redirect, just refresh the page
        window.location.reload();
      }).catch(error => {
        console.error('Sign out error:', error);
      });
    });
    
    // Handle Patreon disconnect
    disconnectPatreonBtn.addEventListener('click', async () => {
      try {
        // Check if user is signed in
        if (auth.currentUser) {
          // Get patreon ID
          const snapshot = await db.ref(`users/${auth.currentUser.uid}/patreonId`).once('value');
          const patreonId = snapshot.val();
          
          if (patreonId) {
            // Remove the connection in Firebase
            await db.ref(`users/${auth.currentUser.uid}/patreonId`).remove();
            try {
              await db.ref(`patreonUsers/${patreonId}/firebaseUid`).remove();
            } catch (error) {
              console.warn('Could not remove firebaseUid from patreonUsers, may lack permission:', error.message);
            }
          } else {
            console.warn('No Patreon ID found in user data, but disconnect was attempted');
          }
        } else {
          console.log('No user is signed in, but disconnect was attempted');
        }
        
        // Always remove from local storage regardless of signed in state
        localStorage.removeItem('patreonUserId');
        localStorage.removeItem('patreonAuthenticated');
        
        console.log('Patreon account disconnected');
        
        // Refresh the page to update UI
        window.location.reload();
      } catch (error) {
        console.error('Error disconnecting Patreon account:', error);
      }
    });
    
    // Listen for auth state changes
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // User is signed in
        console.log('User is signed in:', user.uid);
        
        // Display Evil Trivia user info
        await displayTriviaUserInfo(user);
        
        // Also check for Patreon ID in localStorage as a fallback
        const patreonId = localStorage.getItem('patreonUserId');
        if (patreonId) {
          console.log('Found Patreon ID in localStorage:', patreonId);
          // First check if user already has patreonId in their data
          const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
          const userData = userSnapshot.val() || {};
          
          if (!userData.patreonId) {
            // Update user data with Patreon ID
            console.log('Updating user with Patreon ID from localStorage');
            await db.ref(`users/${user.uid}/patreonId`).set(patreonId);
          }
          
          // Ensure we load Patreon data
          loadPatreonData(patreonId);
        }
      } else {
        // User is signed out, show sign-in options for both services
        console.log('User is signed out, showing sign-in options');
        
        // Show Evil Trivia sign-in option
        triviaLoading.classList.add('hidden');
        triviaLoggedIn.classList.add('hidden');
        triviaNotLoggedIn.classList.remove('hidden');
        
        // Initialize FirebaseUI auth
        ui.start('#firebaseui-auth-container', uiConfig);
        
        // Check if there's a Patreon connection in localStorage
        const patreonId = localStorage.getItem('patreonUserId');
        const patreonAuthenticated = localStorage.getItem('patreonAuthenticated');
        
        if (patreonId && patreonAuthenticated === 'true') {
          console.log('Found Patreon connection in localStorage while not logged in');
          // Load Patreon data for the non-logged-in user
          loadPatreonData(patreonId);
        } else {
          // No Patreon connection, show not connected state
          patreonLoading.classList.add('hidden');
          patreonConnected.classList.add('hidden');
          patreonNotConnected.classList.remove('hidden');
        }
      }
    });
    
    // Check for Patreon auth callback
    function checkUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const authSuccess = urlParams.get('auth_success');
      const patreonId = urlParams.get('patreon_id');
      const firebaseToken = urlParams.get('firebase_token');
      const tokenError = urlParams.get('token_error');
      
      if (authSuccess === 'true' && patreonId) {
        console.log('Patreon auth successful with ID:', patreonId);
        // Store Patreon ID
        localStorage.setItem('patreonUserId', patreonId);
        localStorage.setItem('patreonAuthenticated', 'true');
        
        // Check if user was logged in before Patreon redirect
        const wasLoggedIn = localStorage.getItem('wasLoggedInBeforePatreon') === 'true';
        localStorage.removeItem('wasLoggedInBeforePatreon'); // Clean up
        
        // If we have a Firebase token, sign in with it
        if (firebaseToken) {
          auth.signInWithCustomToken(firebaseToken)
            .then(() => {
              console.log('Signed in with custom token');
              // Immediately check for user data
              if (auth.currentUser) {
                displayTriviaUserInfo(auth.currentUser);
              }
            })
            .catch(error => {
              console.error('Error signing in with custom token:', error);
              handleTokenError(patreonId);
            });
        } else if (tokenError === 'true') {
          // Handle the case where the server couldn't generate a token
          console.log('Server could not generate a custom token, using fallback authentication');
          handleTokenError(patreonId);
        } else if (!wasLoggedIn) {
          // User wasn't logged in before and we don't have a token
          // Just load Patreon data without Evil Trivia login
          console.log('Loading Patreon data for non-logged-in user');
          patreonLoading.classList.remove('hidden');
          loadPatreonData(patreonId);
        }
        
        // Clean URL parameters
        const newUrl = new URL(window.location.href);
        newUrl.search = '';
        window.history.replaceState({}, document.title, newUrl.toString());
      }
    }
    
    // Handle the case where we can't get a custom token but still have Patreon auth
    async function handleTokenError(patreonId) {
      // Check if user is already signed in
      if (auth.currentUser) {
        // Add patreonId to user data
        try {
          await db.ref(`users/${auth.currentUser.uid}/patreonId`).set(patreonId);
          console.log('Added Patreon ID to existing user');
          displayTriviaUserInfo(auth.currentUser);
        } catch (error) {
          console.error('Error updating user data:', error);
        }
      } else {
        // No user is signed in
        const wasLoggedIn = localStorage.getItem('wasLoggedInBeforePatreon') === 'true';
        localStorage.removeItem('wasLoggedInBeforePatreon'); // Clean up
        
        if (wasLoggedIn) {
          // User was logged in before, but now they're not
          // Store the Patreon ID in localStorage and refresh the page
          localStorage.setItem('pendingPatreonConnect', 'true');
          localStorage.setItem('pendingPatreonId', patreonId);
          window.location.reload();
        } else {
          // User was not logged in before, just show Patreon data
          console.log('User was not logged in before, showing Patreon data without login');
          loadPatreonData(patreonId);
        }
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Check URL parameters for auth callbacks
      checkUrlParams();
      
      // Check for pending Patreon connection
      const pendingPatreonConnect = localStorage.getItem('pendingPatreonConnect');
      const pendingPatreonId = localStorage.getItem('pendingPatreonId');
      
      if (pendingPatreonConnect === 'true' && pendingPatreonId && auth.currentUser) {
        // Connect Patreon ID to current user
        db.ref(`users/${auth.currentUser.uid}/patreonId`).set(pendingPatreonId)
          .then(() => {
            console.log('Connected pending Patreon ID to user');
            // Clear pending flags
            localStorage.removeItem('pendingPatreonConnect');
            localStorage.removeItem('pendingPatreonId');
            // Refresh user info
            displayTriviaUserInfo(auth.currentUser);
          })
          .catch(error => {
            console.error('Error connecting Patreon ID:', error);
          });
      }
    });
  </script>
</body>
</html>
